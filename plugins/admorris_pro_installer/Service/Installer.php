<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro_installer\Service; use JTL\Plugin\PluginInterface; use JTL\Shop; use JTL\Plugin\InstallCode; use JTL\Mapper\PluginValidation; use Plugin\admorris_pro_installer\Traits\PrettyContextLoggerTrait; use Psr\Log\LoggerInterface; class Installer { use PrettyContextLoggerTrait; use \Plugin\admorris_pro_installer\Traits\IoRequestTrait; public const MARKER_EXTRACTED = "\x2e\x61\144\x6d\x70\x72\157\x5f\145\170\x74\x72\x61\143\164\x65\144"; public const MARKER_UPDATED = "\56\x61\144\155\x70\162\157\137\165\160\144\x61\164\145\144"; public function __construct(private PluginInterface $plugin) { $this->initPrettyLogger($plugin->getLogger()); } public function handle() : InstallerState { goto Ctf2h; lGqWt: $state->installed = true; $state->success = \__("\151\156\163\x74\x61\154\154\x65\162\x2e\151\x6e\163\x74\x61\154\154\x65\x64"); U1vXG: GD8y5: return $state; goto gObOU; Ctf2h: $state = $this->buildBaseState(); $action = $_GET["\141\143\x74\x69\157\x6e"] ?? ''; if ($action === "\x64\x6f\167\156\154\x6f\141\x64" && !$state->extracted && !$state->installed && $state->license?->isOk()) { goto mjVSR; } if ($action === "\x75\160\x64\141\164\145" && $state->extracted && !$state->installed && $state->license?->isOk()) { goto jO7Vt; } goto GD8y5; mjVSR: $state->phase = "\144\x6f\167\156\x6c\x6f\x61\144\x69\x6e\147"; if (!($state->downloadLink && $this->downloadAndExtract($state->downloadLink, $state))) { goto LxXBl; } $state->extracted = true; $state->success = \__("\151\156\163\x74\x61\154\x6c\x65\x72\56\x65\170\164\x72\x61\143\164\x65\x64"); goto ObfJo; ObfJo: LxXBl: goto GD8y5; jO7Vt: $state->phase = "\165\x70\x64\x61\x74\151\156\x67"; $updateCode = $this->runUpdater(); if (\in_array($updateCode, [InstallCode::OK, InstallCode::OK_LEGACY], true)) { goto YZqo5; } $state->error = (new PluginValidation())->map($updateCode); goto U1vXG; YZqo5: $this->writeMarker(self::MARKER_UPDATED); goto lGqWt; gObOU: } private function buildBaseState() : InstallerState { goto EGcUU; EGcUU: $licenseApi = new LicenseApi(); $license = $licenseApi->verify(); $state = new InstallerState(); $state->shopVersion = \APPLICATION_VERSION; $state->license = $license; $state->installed = $this->isUpdated(); $state->extracted = $this->isExtracted(); if (!$license->isOk()) { goto tDsBq; } $state->downloadLink = $license->downloadLink; tDsBq: goto Z809s; Z809s: if ($state->installed) { goto LQMGi; } if ($state->extracted) { goto SbimI; } if ($license->isOk()) { goto qe8OZ; } $state->phase = "\x6c\x69\x63\145\156\x73\145"; goto quXOI; LQMGi: $state->phase = "\144\x6f\156\145"; $state->success = \__("\x69\156\x73\164\141\x6c\x6c\x65\162\56\151\x6e\163\164\141\154\154\x65\x64"); goto quXOI; SbimI: goto lFuyl; lFuyl: $state->phase = "\162\145\141\x64\x79\55\165\160\144\141\164\145"; goto quXOI; qe8OZ: $state->phase = "\162\145\141\x64\171\x2d\x64\157\x77\156\x6c\x6f\141\x64"; quXOI: return $state; goto CXPC5; CXPC5: } public function apiState() : array { return $this->stateToArray($this->buildBaseState()); } public function apiDownload() : array { goto uYfpM; rUC49: if (!$state->extracted) { goto FaKVA; } return $this->stateToArray($state); FaKVA: $state->phase = "\144\157\x77\156\154\157\x61\144\151\x6e\147"; if (!($state->downloadLink && $this->downloadAndExtract($state->downloadLink, $state))) { goto qXHYl; } $state->extracted = true; $state->success = \__("\151\156\x73\x74\x61\x6c\x6c\x65\x72\x2e\x65\x78\164\x72\x61\143\x74\145\144"); $rebuilt = $this->buildBaseState(); $rebuilt->success = $state->success; $rebuilt->downloadSize = $state->downloadSize; goto FCwu1; FCwu1: $rebuilt->zipPath = $state->zipPath; $state = $rebuilt; qXHYl: return $this->stateToArray($state); goto FHeHk; uYfpM: $state = $this->buildBaseState(); $pluginDir = $this->pluginRoot(); if (!($state->installed || is_dir($pluginDir) || is_file($pluginDir))) { goto jHSot; } $state->error = \__("\x69\156\x73\164\x61\154\x6c\x65\x72\x2e\141\x6c\162\x65\x61\144\x79\137\160\162\x65\x73\x65\x6e\164"); return $this->stateToArray($state); jHSot: if (!(!$state->license || !$state->license->isOk())) { goto YVrM4; } $state->error = $state->error ?: \__("\x69\x6e\x73\164\141\154\x6c\145\162\x2e\154\151\x63\x65\x6e\x73\x65\137\156\157\164\137\x6f\153"); return $this->stateToArray($state); YVrM4: goto rUC49; FHeHk: } public function apiUpdate() : array { $state = $this->buildBaseState(); if (!$state->installed) { goto IL_Wn; } return $this->stateToArray($state); IL_Wn: if ($state->extracted) { goto B0EBg; } $state->error = \__("\x69\156\x73\164\141\x6c\154\145\162\56\156\157\164\x5f\145\x78\x74\162\x61\x63\x74\145\144"); return $this->stateToArray($state); B0EBg: $state->phase = "\165\x70\x64\x61\164\x69\156\x67"; $updateCode = $this->runUpdater(); if (\in_array($updateCode, [InstallCode::OK, InstallCode::OK_LEGACY], true)) { goto lbo35; } $state->error = (new PluginValidation())->map($updateCode); $this->log->error("\111\x6e\x73\164\x61\154\x6c\x65\x72\72\x20\151\156\x73\x74\x61\x6c\154\x20\146\x61\x69\x6c\x65\x64", ["\143\157\x64\x65" => $updateCode, "\x65\x72\162\x6f\x72" => $state->error]); goto yEl3o; lbo35: $this->writeMarker(self::MARKER_UPDATED); $state = $this->buildBaseState(); yEl3o: return $this->stateToArray($state); } public function apiUninstall() : array { try { $db = \JTL\Shop::Container()->getDB(); $cache = \JTL\Shop::Container()->getCache(); $uninstaller = new \JTL\Plugin\Admin\Installation\Uninstaller($db, $cache); $code = $uninstaller->uninstall($this->plugin->getID(), false, null, true, true); if (!\in_array($code, [\JTL\Plugin\InstallCode::OK, \JTL\Plugin\InstallCode::OK_LEGACY], true)) { goto kCE2f; } return ["\x73\x75\x63\143\x65\x73\163" => \__("\x69\156\163\164\141\154\154\x65\162\x2e\165\x6e\151\x6e\163\x74\141\x6c\154\145\x64")]; kCE2f: $msg = (new \JTL\Mapper\PluginValidation())->map($code); return ["\x65\x72\x72\x6f\x72" => $msg ?: "\125\x6e\151\x6e\163\164\141\x6c\154\40\146\x61\151\154\x65\144"]; } catch (\Throwable $e) { $this->log->error("\x49\x6e\163\x74\x61\154\154\145\162\x3a\x20\x73\145\x6c\146\x2d\165\x6e\151\156\x73\164\141\154\154\x20\x66\x61\x69\154\145\x64", ["\145\170\x63\145\x70\164\x69\157\156" => $e]); return ["\145\162\x72\x6f\x72" => $e->getMessage() ?: "\x45\170\x63\145\160\x74\151\x6f\x6e\x20\x64\x75\x72\x69\x6e\147\x20\x75\x6e\x69\x6e\163\x74\141\154\x6c"]; } } private function stateToArray(InstallerState $state) : array { return ["\x70\x68\141\163\x65" => $state->phase, "\144\x6f\x77\156\x6c\x6f\141\144\x4c\151\x6e\x6b" => $state->downloadLink, "\145\162\x72\157\x72" => $state->error, "\163\x75\x63\x63\145\163\163" => $state->success, "\163\x68\x6f\x70\x56\145\162\x73\151\157\156" => $state->shopVersion, "\x64\157\167\x6e\154\x6f\141\x64\x53\x69\172\145" => $state->downloadSize, "\145\170\x74\x72\x61\143\164\145\144" => $state->extracted, "\151\156\x73\164\x61\154\154\x65\x64" => $state->installed, "\x6c\x69\x63\x65\156\163\x65" => $state->license ? ["\x73\164\141\164\165\163" => $state->license->status, "\x64\x6f\x77\156\x6c\x6f\x61\144\x4c\151\x6e\153" => $state->license->downloadLink ?? null] : null, "\x61\144\x6d\x50\x72\x6f\102\x61\143\x6b\145\156\144\x55\162\x6c" => $this->getAdmProBackendUrl()]; } private function getAdmProBackendUrl() : ?string { try { $plugin = \JTL\Plugin\Helper::getPluginById("\141\144\x6d\x6f\x72\162\x69\163\x5f\160\162\x6f"); if (!$plugin) { goto Jha5K; } return $plugin->getPaths()->getBackendURL(); Jha5K: } catch (\Throwable $e) { } return null; } private function pluginRoot() : string { return \PFAD_ROOT . "\160\154\x75\147\x69\x6e\x73\57\141\x64\x6d\x6f\x72\x72\151\x73\x5f\160\162\x6f\57"; } private function markerPath(string $marker) : string { return $this->pluginRoot() . $marker; } private function writeMarker(string $marker) : void { @file_put_contents($this->markerPath($marker), (string) time()); } private function isExtracted() : bool { return is_file($this->markerPath(self::MARKER_EXTRACTED)); } private function isUpdated() : bool { return is_file($this->markerPath(self::MARKER_UPDATED)); } private function downloadAndExtract(string $downloadLink, InstallerState $state) : bool { $ok = $this->download($downloadLink, $state); if ($ok) { goto YAlr3; } return false; YAlr3: $ok = $this->extract($downloadLink, $state); if (!$ok) { goto fdiNR; } $this->writeMarker(self::MARKER_EXTRACTED); fdiNR: return $ok; } private function download(string $downloadLink, InstallerState $state) : bool { goto nL9si; X3dX3: $size = @filesize($zipPath); if (!($size === false || $size < 1024)) { goto ODjE2; } $state->error = "\132\151\160\40\172\x75\x20\x6b\x6c\x65\151\156\40\57\x20\172\151\160\40\x74\157\x6f\x20\163\x6d\x61\154\x6c"; @unlink($zipPath); return false; ODjE2: $state->downloadSize = $size; $state->zipPath = $zipPath; return true; goto nyk1q; bGhVz: goto PJiEl; spacj: $state->error = "\x44\x6f\167\x6e\x6c\x6f\141\x64\40\106\145\x68\x6c\145\162\x3a\40" . curl_error($ch); PJiEl: curl_close($ch); fclose($fh); if ($ok) { goto lFn7l; } @unlink($zipPath); return false; lFn7l: goto X3dX3; nL9si: $downloadDir = __DIR__ . "\x2f\144\157\167\156\154\157\141\144"; if (!(!is_dir($downloadDir) && !@mkdir($downloadDir, 0755, true))) { goto ZlNOJ; } $state->error = \__("\151\x6e\163\164\x61\154\x6c\145\162\56\143\x61\x6e\156\x6f\x74\x5f\143\x72\x65\141\164\x65\137\x64\x6f\167\156\x6c\157\141\144\x5f\x64\x69\162"); return false; ZlNOJ: $zipPath = $downloadDir . "\57" . $downloadLink . "\x2e\x7a\x69\x70"; $fh = @fopen($zipPath, "\167"); if ($fh) { goto ixi7r; } $state->error = "\113\141\x6e\x6e\x20\x5a\151\x70\40\x6e\x69\x63\x68\x74\40\163\x63\150\162\x65\x69\142\x65\156\x20\x2f\40\x43\x61\156\156\x6f\x74\40\167\162\151\164\145\x20\x7a\x69\160"; return false; goto UDv4J; UDv4J: ixi7r: $ch = curl_init(); curl_setopt_array($ch, [CURLOPT_URL => "\150\x74\x74\x70\163\x3a\57\x2f\141\x64\x6d\x6f\x72\162\151\x73\56\143\x6f\x6d\57\160\x72\x6f\x2f\x66\x69\x6c\145\x73\57" . $downloadLink . "\56\x7a\x69\x70", CURLOPT_FAILONERROR => true, CURLOPT_FOLLOWLOCATION => true, CURLOPT_RETURNTRANSFER => false, CURLOPT_FILE => $fh, CURLOPT_CONNECTTIMEOUT => 20, CURLOPT_TIMEOUT => 240, CURLOPT_USERAGENT => "\x61\144\155\x6f\x72\x72\151\x73\x2d\x70\x72\x6f\x2d\x69\x6e\163\164\141\154\x6c\x65\162"]); $ok = curl_exec($ch); if ($ok === false) { goto spacj; } $code = (int) curl_getinfo($ch, CURLINFO_HTTP_CODE); if (!($code !== 200)) { goto Fux6M; } $state->error = "\x48\124\x54\x50\x20\123\164\x61\164\x75\163\40" . $code; $ok = false; Fux6M: goto bGhVz; nyk1q: } private function extract(string $downloadLink, InstallerState $state) : bool { $extractor = new ResourceExtractor(zipPath: (string) $state->zipPath, pluginDir: $this->pluginRoot(), log: $this->log, rootPath: rtrim(\PFAD_ROOT, "\57") . "\57"); $ok = $extractor->run($state); if ($ok) { goto bQeT0; } $this->log->error("\x49\156\x73\164\141\154\154\x65\162\72\40\x65\x78\164\x72\141\x63\x74\x69\x6f\156\x20\x66\141\151\154\x65\144\x20\166\x69\141\40\122\x65\x73\x6f\x75\x72\143\145\105\x78\164\162\x61\143\x74\157\x72", ["\145\162\x72\157\x72" => $state->error]); goto RvRG3; bQeT0: $this->log->debug("\111\156\163\164\x61\154\154\145\162\72\x20\x65\170\x74\162\x61\143\164\x69\157\156\40\x66\x69\156\151\x73\150\145\144\x20\163\x75\143\143\x65\163\163\x66\x75\154\x6c\171\x20\x76\151\x61\x20\x52\145\163\x6f\165\x72\x63\145\x45\x78\x74\162\141\143\x74\157\x72"); RvRG3: return $ok; } private function runUpdater() : int { $db = Shop::Container()->getDB(); $cache = Shop::Container()->getCache(); $parser = new \JTL\XMLParser(); $installer = new \JTL\Plugin\Admin\Installation\Installer($db, new \JTL\Plugin\Admin\Installation\Uninstaller($db, $cache), new \JTL\Plugin\Admin\Validation\LegacyPluginValidator($db, $parser), new \JTL\Plugin\Admin\Validation\PluginValidator($db, $parser)); $installer->setDir("\x61\x64\155\157\162\x72\151\163\x5f\160\x72\157"); $code = $installer->prepare(); $this->log->debug("\x49\156\163\164\141\x6c\154\x65\x72\x3a\x20\162\165\x6e\x55\x70\x64\x61\x74\145\x72\x20\x66\x69\x6e\x69\163\x68\145\x64", ["\x63\157\144\145" => $code]); return $code; } private function deleteFolder(string $dir) : void { if (is_dir($dir)) { goto HTNz6; } return; HTNz6: $items = scandir($dir); if (!($items === false)) { goto H22gq; } return; H22gq: foreach ($items as $item) { if (!($item === "\x2e" || $item === "\x2e\56")) { goto hzJQK; } goto FhuTP; hzJQK: $path = $dir . DIRECTORY_SEPARATOR . $item; if (is_dir($path)) { goto D4ZVv; } @unlink($path); goto F3eVx; D4ZVv: $this->deleteFolder($path); F3eVx: FhuTP: } y6ZZS: @rmdir($dir); } private function fsDebugInfo(string $path) : array { @clearstatcache(true, $path); $exists = file_exists($path); $parent = dirname($path); return ["\x70\141\x74\150" => $path, "\145\170\151\163\164\x73" => $exists, "\151\163\137\144\x69\x72" => is_dir($path), "\151\163\137\167\x72\151\164\141\x62\x6c\145" => @is_writable($path), "\x69\x73\137\x72\x65\141\144\141\x62\154\x65" => @is_readable($path), "\157\167\156\x65\x72" => $exists ? @fileowner($path) : null, "\x67\x72\x6f\165\160" => $exists ? @filegroup($path) : null, "\160\145\x72\x6d\163" => $exists ? substr(sprintf("\x25\x6f", @fileperms($path)), -4) : null, "\160\141\x72\x65\x6e\x74" => ["\x70\141\164\x68" => $parent, "\145\x78\x69\163\x74\163" => file_exists($parent), "\x69\x73\137\144\x69\x72" => is_dir($parent), "\x69\163\x5f\x77\162\x69\164\x61\x62\154\x65" => @is_writable($parent), "\x69\163\x5f\162\145\141\144\x61\142\154\145" => @is_readable($parent), "\x70\x65\x72\155\163" => file_exists($parent) ? substr(sprintf("\45\x6f", @fileperms($parent)), -4) : null]]; } public function renderAdminMenuTab(string $tabName, int $menuID, \JTL\Smarty\JTLSmarty $smarty) : string { $state = $this->handle(); $smarty->assign("\151\156\163\x74\141\154\x6c\x65\162\x53\164\141\x74\145", $state); $smarty->assign("\x62\x61\163\145\x55\162\154", $this->adminBaseUrl()); $smarty->assign("\x61\144\155\x69\x6e\125\162\154", $this->plugin->getPaths()->getAdminURL()); $smarty->assign("\x69\156\163\164\x61\x6c\x6c\145\x72\123\x74\x61\x74\145\112\163\x6f\156", json_encode($this->stateToArray($state), JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES)); $version = $this->plugin->getMeta()?->getVersion() ?? "\144\x65\166"; $smarty->assign("\x70\x6c\165\147\x69\x6e\126\x65\x72\163\151\157\156", $version); $tpl = $this->plugin->getPaths()->getAdminPath() . "\151\x6e\x73\164\141\154\154\x65\x72\56\x74\160\x6c"; return $smarty->fetch($tpl); } private function adminBaseUrl() : string { return $this->plugin->getPaths()->getBackendURL(); } }