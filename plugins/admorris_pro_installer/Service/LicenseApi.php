<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro_installer\Service; use JTL\Shop; class LicenseApi { public const STATUS_OK = "\157\153"; public const STATUS_NEEDS_MATCH = "\156\x6f\x5f\x76\x65\162\163\x69\157\156\x5f\x6d\x61\164\x63\x68"; public const STATUS_INVALID = "\151\x6e\166\x61\154\151\144\x5f\x6c\151\143\x65\x6e\163\145"; public const STATUS_ERROR = "\145\162\162\x6f\162"; public function __construct(private readonly string $primaryUrl = "\x68\x74\x74\x70\x73\x3a\57\x2f\141\144\155\157\x72\x72\151\x73\56\x63\x6f\x6d\57\x6c\x69\172\145\x6e\x7a\160\x72\x75\x65\146\x75\156\x67\57\x76\x32\57", private readonly ?string $testUrl = "\150\x74\x74\160\x73\x3a\57\57\x61\x64\x6d\x6f\162\162\151\x73\x2d\x70\x72\157\55\x61\x70\x69\56\144\x64\x65\x76\x2e\163\x69\x74\145\x2f\166\62\57") { } public function verify() : LicenseResult { goto K37rD; Wx_E6: $phpVersion = PHP_VERSION; $apiKey = crypt($domainNoWww, "\x61\144\x6d"); $postData = http_build_query(["\x64" => $domainNoWww, "\x61\x6b" => $apiKey, "\163\x76" => $shopVersion, "\x70\150\x70" => $phpVersion], '', "\46"); $ch = curl_init(); curl_setopt_array($ch, [CURLOPT_URL => $apiUrl, CURLOPT_POST => true, CURLOPT_RETURNTRANSFER => true, CURLOPT_POSTFIELDS => $postData, CURLOPT_CONNECTTIMEOUT => 15, CURLOPT_TIMEOUT => 10, CURLOPT_USERAGENT => "\x61\144\155\157\x72\162\151\163\x2d\160\x72\157\55\151\x6e\x73\164\x61\154\154\x65\162\55\154\x69\x63\x65\156\x73\145"]); $raw = curl_exec($ch); $err = curl_error($ch); $code = (int) curl_getinfo($ch, CURLINFO_HTTP_CODE); curl_close($ch); if (!($raw === false || $code >= 400)) { goto ubuhR; } goto J5iSk; J5iSk: return new LicenseResult(self::STATUS_ERROR, null, null, null, "\x48\124\124\120\x20" . $code . "\x20" . $err); ubuhR: $data = json_decode($raw, true); if (\is_array($data)) { goto RY_1V; } return new LicenseResult(self::STATUS_ERROR, null, null, null, "\111\x6e\166\x61\154\x69\x64\40\112\123\117\x4e\40\x72\x65\x73\160\157\x6e\x73\145"); RY_1V: $statusCode = (string) ($data["\163\164\141\164\165\163\143\x6f\144\145"] ?? ''); if (!($statusCode === "\x32\60\60" || $statusCode === "\x31\60\x30")) { goto GDjJo; } $download = $data["\144\154"] ?? ''; if (!($download === "\113\126")) { goto nw_NT; } goto d1b5O; d1b5O: return new LicenseResult(self::STATUS_NEEDS_MATCH, null, null, null, null); nw_NT: return new LicenseResult(self::STATUS_OK, $download, $data["\x74"] ?? null, $data["\145"] ?? null, null); GDjJo: return new LicenseResult(self::STATUS_INVALID, null, null, null, null); goto X3ObZ; K37rD: $apiUrl = $this->primaryUrl; if (!(defined("\101\104\x4d\x4f\122\x52\x49\x53\x5f\x50\x52\x4f\x5f\124\x45\123\124\x5f\x41\x50\x49") && constant("\x41\104\x4d\x4f\x52\122\111\123\137\x50\122\117\137\124\105\x53\x54\x5f\101\120\x49") === true && $this->testUrl)) { goto LoZu7; } $apiUrl = $this->testUrl; LoZu7: $domain = $_SERVER["\x53\x45\122\x56\x45\x52\x5f\x4e\101\115\x45"] ?? ''; if (!($domain === '')) { goto NzwLy; } $domain = "\164\x65\x73\x74\165\x6d\147\x65\142\165\x6e\x67"; NzwLy: $domainNoWww = str_replace("\167\167\x77\x2e", '', $domain); $shopVersion = \APPLICATION_VERSION; goto Wx_E6; X3ObZ: } } class LicenseResult { public function __construct(public string $status, public ?string $downloadLink, public ?string $template, public ?string $e, public ?string $errorMessage) { } public function isOk() : bool { return $this->status === LicenseApi::STATUS_OK; } public function needsVersionMatch() : bool { return $this->status === LicenseApi::STATUS_NEEDS_MATCH; } public function isInvalid() : bool { return $this->status === LicenseApi::STATUS_INVALID; } }