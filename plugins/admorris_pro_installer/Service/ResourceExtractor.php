<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro_installer\Service; use ZipArchive; class ResourceExtractor { public function __construct(private readonly string $zipPath, private readonly string $pluginDir, private readonly \Psr\Log\LoggerInterface $log, private readonly string $rootPath) { } public function run(InstallerState $state) : bool { goto PsFX7; PsFX7: if (is_readable($this->zipPath)) { goto BW_tM; } $state->error = "\x5a\x69\x70\x20\156\x69\x63\x68\164\40\x6c\x65\x73\x62\141\x72\x20\57\x20\172\x69\x70\40\x6e\x6f\x74\x20\x72\x65\141\x64\x61\142\x6c\145"; return false; BW_tM: $zip = new ZipArchive(); if (!($zip->open($this->zipPath) !== true)) { goto C7z6d; } $state->error = "\x5a\x69\160\40\x6b\141\156\156\40\156\151\143\150\x74\40\x67\145\303\xb6\146\x66\156\145\164\x20\167\x65\162\x64\x65\156\40\57\x20\x63\141\x6e\x6e\x6f\164\40\157\x70\145\156\x20\172\151\160"; return false; C7z6d: $tempPluginDir = $this->rootPath . "\x70\x6c\x75\x67\151\x6e\x73\x2f\x61\144\155\x6f\x72\162\151\163\137\160\162\x6f\137\x74\x6d\x70\137" . bin2hex(random_bytes(3)); goto VPKGz; b2nK_: $this->overwriteGfx($zip); $backupRoot = $this->rootPath . "\x61\144\155\157\162\x72\x69\x73\137\160\x72\x6f\x5f\142\x61\x63\153\165\160\x73"; $pluginBackupsRoot = $backupRoot . "\x2f\160\x6c\x75\147\151\156\137\142\x61\143\x6b\165\x70\163"; $this->ensureDir($backupRoot, "\142\141\x63\153\x75\160\40\162\157\157\164"); $this->ensureDir($pluginBackupsRoot, "\160\154\165\x67\x69\x6e\x5f\x62\x61\x63\x6b\x75\x70\x73"); $zip->close(); if (!function_exists("\157\160\143\x61\143\x68\x65\137\x72\x65\163\145\x74")) { goto ZQRtB; } @opcache_reset(); ZQRtB: return true; goto DSMJO; qfJHY: if (is_dir($mediaImageDir)) { goto dLF7H; } if (!@mkdir($mediaImageDir, 0755, true)) { goto uZezt; } $this->log->debug("\x52\x65\x73\x6f\x75\162\x63\x65\105\x78\164\x72\x61\x63\164\x6f\x72\x3a\40\143\x72\x65\141\164\145\x64\40\155\145\144\151\141\x2f\151\155\x61\x67\x65\40\x64\x69\162\x65\x63\x74\157\162\x79", ["\144\151\x72" => $mediaImageDir]); goto i2qx9; dLF7H: $this->log->info("\x52\145\163\157\165\162\x63\x65\105\x78\164\x72\x61\143\x74\157\162\x3a\40\x6d\x65\144\x69\x61\57\x69\x6d\x61\x67\x65\x20\x61\154\162\145\x61\144\171\40\145\170\151\x73\164\163", ["\x64\x69\162" => $mediaImageDir]); goto i2qx9; uZezt: $this->log->error("\122\145\x73\x6f\x75\x72\x63\x65\105\170\x74\162\141\x63\164\157\162\x3a\x20\143\141\156\x6e\x6f\x74\40\143\162\145\141\x74\x65\x20\x6d\x65\x64\151\x61\x2f\x69\x6d\x61\x67\145\40\144\x69\x72\145\x63\164\157\162\x79", ["\144\x69\162" => $mediaImageDir]); i2qx9: goto b2nK_; Rprt2: @rmdir($this->pluginDir); gPelp: LRxGs: if (@rename($tempPluginDir, $this->pluginDir)) { goto oE1Aw; } $state->error = "\120\x6c\x75\x67\151\x6e\55\126\145\162\172\145\151\x63\x68\156\151\163\x20\153\141\156\x6e\x20\156\151\143\x68\x74\40\x76\145\x72\x73\x63\150\157\142\x65\x6e\x20\x77\145\x72\144\x65\156\40\57\x20\143\x61\x6e\156\x6f\164\x20\x6d\x6f\166\145\40\x70\x6c\x75\147\151\156\x20\144\151\162\x65\143\x74\157\x72\x79"; $this->purgeDirectory($tempPluginDir); @rmdir($tempPluginDir); $zip->close(); return false; oE1Aw: goto spSi6; spSi6: $this->log->debug("\122\x65\163\157\165\x72\143\145\105\x78\164\x72\x61\143\x74\x6f\162\72\x20\x70\154\165\147\151\x6e\x20\144\x65\160\x6c\x6f\171\145\x64", ["\160\154\165\x67\x69\156\104\151\x72" => $this->pluginDir]); $tempTemplateDir = $this->rootPath . "\164\145\155\160\x6c\141\164\x65\163\x2f\141\144\155\157\162\162\x69\163\x5f\x70\162\x6f\137\164\155\160\x5f" . bin2hex(random_bytes(3)); $finalTemplateDir = $this->rootPath . "\164\145\155\x70\154\x61\164\x65\163\x2f\x61\x64\x6d\157\162\162\x69\163\x5f\x70\x72\x6f"; if (!$this->subtreeExists($zip, "\164\145\155\160\x6c\141\x74\x65\x73\57\x61\144\x6d\x6f\162\x72\x69\x73\137\160\162\157\57")) { goto tZCee; } if (!$this->extractSubtree($zip, "\x74\145\155\x70\x6c\141\x74\x65\x73\x2f\x61\144\155\x6f\162\162\151\x73\137\x70\x72\x6f\57", $tempTemplateDir, $state)) { goto cBKPt; } if (!is_dir($finalTemplateDir)) { goto nLyU5; } $this->log->info("\122\145\x73\x6f\165\162\x63\145\x45\170\164\162\141\143\x74\157\162\72\40\164\x65\x6d\160\154\141\164\145\40\x64\x69\162\x65\x63\x74\157\162\171\x20\x65\170\x69\163\x74\163\40\55\40\x62\141\143\153\x69\x6e\147\x20\x75\x70", ["\144\151\x72" => $finalTemplateDir]); $this->backupExistingDir($finalTemplateDir, "\x74\145\x6d\160\154\141\x74\145\137\x62\141\x63\x6b\x75\x70"); nLyU5: if (!@rename($tempTemplateDir, $finalTemplateDir)) { goto Gf1Y7; } goto i7M7J; VPKGz: if ($this->extractSubtree($zip, "\160\154\165\147\151\x6e\x73\57\141\144\155\157\162\x72\151\163\x5f\x70\162\x6f\57", $tempPluginDir, $state)) { goto yo9sY; } $zip->close(); return false; yo9sY: $this->log->debug("\122\x65\x73\157\165\162\143\145\105\170\x74\162\141\x63\x74\157\162\72\40\160\154\x75\147\151\156\40\163\165\142\164\162\x65\145\40\145\x78\x74\162\x61\143\164\145\x64", ["\x74\145\155\160\x50\154\165\147\151\x6e\104\151\162" => $tempPluginDir]); if (!is_dir($this->pluginDir)) { goto LRxGs; } $this->log->debug("\x52\x65\163\x6f\165\162\x63\145\105\x78\x74\162\x61\x63\x74\x6f\162\x3a\40\x62\x61\143\x6b\151\x6e\x67\40\x75\x70\x20\145\x78\151\x73\x74\x69\x6e\147\40\160\x6c\x75\x67\151\x6e\x20\x64\151\162\145\x63\164\x6f\162\171", ["\144\x69\162" => $this->pluginDir]); if ($this->backupExistingDir($this->pluginDir, "\x61\x64\155\x6f\x72\162\151\163\x5f\160\162\x6f\137\142\x61\x63\x6b\x75\x70")) { goto gPelp; } $this->log->error("\x52\x65\x73\157\165\162\x63\145\105\x78\x74\162\x61\x63\164\157\162\x3a\x20\x70\x6c\165\x67\x69\156\x20\x62\x61\x63\153\x75\160\40\x66\141\151\154\x65\x64\54\x20\x61\x74\x74\x65\x6d\160\164\x69\156\x67\x20\x70\165\x72\x67\x65\x20\x66\x61\x6c\x6c\142\x61\x63\x6b", ["\144\151\162" => $this->pluginDir]); $this->purgeDirectory($this->pluginDir); goto Rprt2; i7M7J: $this->log->debug("\x52\x65\163\x6f\x75\162\x63\145\105\x78\164\x72\141\x63\x74\x6f\x72\72\40\x74\145\155\160\154\x61\x74\x65\x20\x64\145\x70\154\x6f\171\x65\x64", ["\144\x69\x72" => $finalTemplateDir]); goto dVlh7; Gf1Y7: $this->log->error("\x52\145\x73\157\x75\162\143\145\105\x78\x74\x72\141\x63\164\x6f\x72\x3a\x20\146\x61\151\154\145\x64\40\x74\157\x20\x6d\x6f\166\145\40\164\x65\x6d\x70\x6c\x61\x74\x65\40\144\151\x72\x65\x63\164\157\162\x79\40\151\156\164\157\x20\160\x6c\x61\x63\x65", ["\146\162\x6f\155" => $tempTemplateDir, "\x74\x6f" => $finalTemplateDir, "\145\x72\x72\x6f\x72" => error_get_last()["\155\145\163\163\141\x67\x65"] ?? null]); $this->purgeDirectory($tempTemplateDir); @rmdir($tempTemplateDir); dVlh7: cBKPt: tZCee: $mediaImageDir = $this->rootPath . "\x6d\145\144\x69\141\x2f\x69\x6d\141\147\x65"; goto qfJHY; DSMJO: } private function extractSubtree(ZipArchive $zip, string $prefix, string $targetRoot, InstallerState $state) : bool { goto HsWZh; gezGZ: goto Yd1Wo; RVLWv: $inner = substr($name, strlen($prefix)); if (!($inner === '')) { goto yEjtQ; } goto Yd1Wo; yEjtQ: if ($created) { goto Qtbs9; } if (@mkdir($targetRoot, 0755, true)) { goto b3Ksw; } $state->error = "\124\x65\155\x70\x2d\x56\145\162\x7a\145\x69\143\x68\156\x69\x73\40\x46\145\150\154\x65\162\40\50" . $targetRoot . "\x29"; return false; goto lT8Mq; WmRqb: nhQEx: $dir = dirname($destPath); if (!(!is_dir($dir) && !@mkdir($dir, 0755, true))) { goto MwR25; } $state->error = "\155\x6b\144\x69\x72\40\x66\145\x68\x6c\x67\x65\x73\143\x68\x6c\x61\147\x65\x6e\x3a\40" . $dir; return false; MwR25: $stream = $zip->getStream($name); if (!($stream === false)) { goto ebl23; } $state->error = "\114\x65\163\x65\x6e\x20\146\x65\150\154\x67\x65\x73\x63\x68\x6c\141\147\145\156\72\x20" . $name; return false; goto JeKWq; lT8Mq: b3Ksw: $created = true; Qtbs9: $destPath = $targetRoot . "\x2f" . $inner; if (!str_ends_with($name, "\57")) { goto nhQEx; } if (!(!is_dir($destPath) && !@mkdir($destPath, 0755, true))) { goto WdADz; } $state->error = "\155\x6b\144\x69\162\x20\x66\x65\x68\154\x67\145\x73\143\150\154\x61\x67\145\156\72\x20" . $destPath; return false; WdADz: goto Yd1Wo; goto WmRqb; VcNYK: Yd1Wo: $i++; goto x0_Tc; KrA5Q: return true; goto kkTAV; JeKWq: ebl23: $out = @fopen($destPath, "\x77"); if (!($out === false)) { goto uXkD2; } fclose($stream); $state->error = "\x53\143\x68\162\x65\x69\x62\x65\156\40\146\x65\150\x6c\x67\x65\x73\x63\150\154\x61\147\x65\x6e\x3a\x20" . $destPath; return false; uXkD2: stream_copy_to_stream($stream, $out); fclose($stream); fclose($out); goto VcNYK; HsWZh: $created = false; $i = 0; x0_Tc: if (!($i < $zip->numFiles)) { goto KrA5Q; } $name = $zip->getNameIndex($i); if (!($name === null)) { goto fxf4z; } goto Yd1Wo; fxf4z: $name = str_replace("\134\134", "\x2f", $name); if (str_starts_with($name, $prefix)) { goto RVLWv; } goto gezGZ; kkTAV: } private function subtreeExists(ZipArchive $zip, string $prefix) : bool { $i = 0; w9Mxo: if (!($i < $zip->numFiles)) { goto wmira; } $name = $zip->getNameIndex($i); if (!($name === null)) { goto jFiho; } goto sFN10; jFiho: if (!str_starts_with(str_replace("\x5c\134", "\57", $name), $prefix)) { goto LdGlT; } return true; LdGlT: sFN10: $i++; goto w9Mxo; wmira: return false; } private function overwriteGfx(ZipArchive $zip) : void { goto SXeWC; SXeWC: $prefix = "\x67\146\x78\x2f"; $i = 0; x09zX: if (!($i < $zip->numFiles)) { goto Ppy34; } $name = $zip->getNameIndex($i); if (!($name === null)) { goto SOUo_; } goto ltrVK; SOUo_: $name = str_replace("\134\134", "\x2f", $name); if (str_starts_with($name, $prefix)) { goto DwCou; } goto Fz0iZ; UsufU: $targetPath = $this->rootPath . "\x67\x66\170\57" . $inner; $dir = dirname($targetPath); if (!(!is_dir($dir) && !@mkdir($dir, 0755, true))) { goto gJ1eV; } $this->log->error("\122\x65\x73\157\165\162\143\145\105\x78\x74\162\141\x63\164\157\x72\x3a\40\143\141\x6e\156\x6f\x74\40\143\162\145\x61\164\145\40\x67\x66\170\x20\x74\141\162\147\145\x74\40\144\151\162", ["\x64\x69\x72" => $dir]); goto ltrVK; gJ1eV: $stream = $zip->getStream($name); if (!($stream === false)) { goto RD6lB; } $this->log->error("\x52\x65\x73\x6f\x75\162\143\145\105\x78\x74\x72\x61\143\x74\x6f\162\x3a\x20\x63\141\156\x6e\157\x74\40\x72\145\x61\144\40\x67\146\x78\40\x66\x69\x6c\x65", ["\145\156\x74\x72\171" => $name]); goto ltrVK; goto nGn1h; JFqfx: ltrVK: $i++; goto x09zX; Ppy34: goto kKDZA; Fz0iZ: goto ltrVK; DwCou: if (!str_ends_with($name, "\57")) { goto fhyRf; } $targetDir = $this->rootPath . rtrim($name, "\x2f"); if (!(!is_dir($targetDir) && !@mkdir($targetDir, 0755, true))) { goto Y2QXe; } $this->log->error("\122\x65\163\157\165\x72\x63\x65\x45\x78\x74\x72\141\143\x74\x6f\x72\72\x20\143\x61\156\156\157\164\40\143\162\145\x61\x74\145\40\147\146\x78\x20\163\165\142\144\151\162\x65\x63\x74\x6f\x72\171", ["\x64\x69\x72" => $targetDir]); Y2QXe: goto ltrVK; fhyRf: $inner = substr($name, strlen($prefix)); goto UsufU; nGn1h: RD6lB: $out = @fopen($targetPath, "\x77"); if (!($out === false)) { goto Y_LiB; } fclose($stream); $this->log->error("\x52\145\163\157\165\162\143\x65\x45\x78\164\x72\141\x63\x74\157\162\x3a\x20\143\x61\156\x6e\157\164\x20\x77\162\151\x74\x65\x20\147\x66\x78\x20\146\x69\154\145", ["\164\141\x72\147\x65\x74" => $targetPath]); goto ltrVK; Y_LiB: stream_copy_to_stream($stream, $out); fclose($stream); fclose($out); goto JFqfx; kKDZA: } private function ensureDir(string $dir, string $label) : void { if (!is_dir($dir)) { goto MIHY8; } $this->log->info("\122\145\163\x6f\165\x72\x63\145\x45\170\x74\x72\141\x63\164\x6f\162\72\x20" . $label . "\x20\x61\x6c\162\x65\141\144\171\40\145\x78\151\163\x74\x73", ["\x64\x69\162" => $dir]); return; MIHY8: if (@mkdir($dir, 0755, true)) { goto uRy6X; } $this->log->error("\122\145\163\x6f\165\162\x63\145\x45\x78\x74\162\141\x63\164\x6f\162\x3a\40\146\141\151\154\145\144\x20\164\x6f\x20\x63\x72\x65\x61\164\145\40" . $label . "\40\x64\x69\162\145\x63\x74\x6f\162\171", ["\x64\151\162" => $dir]); goto Sw04O; uRy6X: $this->log->debug("\x52\145\x73\x6f\x75\162\143\145\x45\170\x74\x72\x61\x63\164\x6f\x72\72\40\143\162\145\x61\164\x65\144\x20" . $label . "\40\x64\151\x72\x65\143\164\x6f\x72\171", ["\144\151\162" => $dir]); Sw04O: } private function backupExistingDir(string $dir, string $baseName) : bool { $backupRoot = $this->rootPath . "\x61\x64\155\x6f\162\x72\x69\163\137\160\x72\x6f\x5f\142\x61\143\x6b\165\160\x73"; $this->ensureDir($backupRoot, "\142\x61\143\x6b\165\160\40\162\157\x6f\x74"); $target = $backupRoot . "\x2f" . $baseName; if (!is_dir($target)) { goto PPlrV; } $target .= "\x5f" . date("\x59\155\x64\x5f\x48\151\x73"); PPlrV: if (!@rename($dir, $target)) { goto PF7Rg; } $this->log->debug("\x52\145\163\157\x75\162\x63\x65\x45\x78\164\x72\x61\143\x74\157\x72\x3a\x20\144\x69\162\145\x63\x74\x6f\162\171\x20\155\157\x76\145\144\x20\x74\157\x20\142\x61\143\x6b\x75\160", ["\x66\x72\157\155" => $dir, "\x74\x6f" => $target]); return true; PF7Rg: $err = error_get_last()["\x6d\x65\163\163\x61\x67\145"] ?? null; $this->log->error("\x52\x65\x73\x6f\165\x72\x63\145\105\x78\x74\x72\x61\143\164\157\162\72\40\x64\151\x72\145\x63\x74\x20\x72\x65\x6e\141\x6d\x65\x20\164\x6f\x20\x62\141\143\153\x75\160\x20\146\141\x69\154\x65\144\40\55\x20\x61\164\x74\145\x6d\160\x74\151\156\147\x20\x63\x6f\x70\x79\40\x66\141\154\154\142\141\x63\153", ["\x66\x72\157\155" => $dir, "\x74\x6f" => $target, "\145\162\162\x6f\x72" => $err]); if ($this->copyDirectory($dir, $target)) { goto BkiFg; } $this->log->error("\122\145\163\157\x75\x72\x63\x65\105\170\164\x72\141\x63\x74\x6f\x72\72\x20\x63\x6f\x70\171\40\146\x61\x6c\154\142\141\x63\153\x20\146\141\x69\154\x65\x64", ["\x66\162\x6f\x6d" => $dir, "\x74\x6f" => $target]); return false; BkiFg: $this->purgeDirectory($dir); @rmdir($dir); return true; } private function copyDirectory(string $src, string $dst) : bool { if (is_dir($src)) { goto MjGhy; } return false; MjGhy: if (!(!is_dir($dst) && !@mkdir($dst, 0755, true))) { goto DLQ8N; } return false; DLQ8N: $items = scandir($src); if (!($items === false)) { goto VFTa5; } return false; VFTa5: foreach ($items as $item) { if (!($item === "\x2e" || $item === "\56\56")) { goto nYvPY; } goto doprr; nYvPY: $from = $src . DIRECTORY_SEPARATOR . $item; $to = $dst . DIRECTORY_SEPARATOR . $item; if (is_dir($from)) { goto YQqQZ; } if (@copy($from, $to)) { goto lueJE; } return false; lueJE: goto q6p4s; YQqQZ: if ($this->copyDirectory($from, $to)) { goto JKZk2; } return false; JKZk2: q6p4s: doprr: } U2JBd: return true; } private function purgeDirectory(string $dir) : void { if (is_dir($dir)) { goto QS0BC; } return; QS0BC: $items = scandir($dir); if (!($items === false)) { goto hkNGU; } return; hkNGU: foreach ($items as $item) { if (!($item === "\56" || $item === "\56\x2e")) { goto H4GoF; } goto OdPmu; H4GoF: $path = $dir . DIRECTORY_SEPARATOR . $item; if (is_dir($path)) { goto gZPmK; } @unlink($path); goto XCxi9; gZPmK: $this->purgeDirectory($path); XCxi9: OdPmu: } n6RpH: } }