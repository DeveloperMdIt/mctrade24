<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro\enhancedEcommerceTracking; use JTL\Shop; use Plugin\admorris_pro\ConsentManagerIntegration; class EnhancedEcommerceConsent { public $plugin; public static function handleConsent($newSettings) { $settingsValues = $newSettings["\166\x61\154\x75\145\x73"]; $isActive = $newSettings["\x61\143\x74\151\x76\x65"]; $settings = ["\147\x65\156\145\x72\141\x6c" => ["\141\143\164\151\166\145" => $isActive], "\x61\156\x61\x6c\x79\164\151\x63\x73" => ["\x61\143\164\151\166\x65" => $settingsValues["\141\156\x61\x6c\171\x74\151\x63\163\137\141\x63\x74\151\166\x65"], "\157\164\x68\145\x72\103\157\156\163\x65\156\x74\163" => ["\141\x64\x73" => $settingsValues["\x67\x74\155\137\x61\x64\163"]]], "\141\144\x73" => ["\141\x63\x74\x69\x76\145" => $settingsValues["\141\144\163\137\x61\143\x74\151\x76\145"]], "\x74\141\x67\x2d\x6d\141\156\x61\147\x65\x72" => ["\141\143\x74\151\x76\x65" => $settingsValues["\147\x74\155\x5f\141\143\164\x69\166\x65"], "\157\164\150\x65\x72\103\157\156\x73\x65\x6e\164\163" => ["\x61\x64\163" => $settingsValues["\x67\x74\155\137\141\x64\163"], "\x61\x6e\141\x6c\x79\164\151\x63\163" => $settingsValues["\x67\164\x6d\x5f\x61\x6e\141\x6c\171\x74\151\143\163"]]]]; $analyticsConsentItemExists = ["\164\171\160\x65" => "\x61\x6e\141\x6c\x79\164\x69\x63\x73", "\143\x6f\156\163\145\x6e\164\105\170\151\163\164\163" => Shop::Container()->getDB()->select("\164\143\157\x6e\163\x65\156\x74", "\151\x74\x65\x6d\111\104", GoogleAnalytics::CONSENT_KEY)]; $adsConsentItemExists = ["\164\x79\160\x65" => "\141\144\x73", "\143\157\x6e\163\145\x6e\x74\105\x78\151\163\x74\163" => Shop::Container()->getDB()->select("\164\x63\157\x6e\163\x65\156\x74", "\x69\x74\145\155\x49\104", GoogleAds::CONSENT_KEY)]; $tagManagerConsentItemExists = ["\164\x79\x70\145" => "\x74\141\147\55\x6d\141\x6e\141\147\x65\x72", "\143\157\156\x73\145\156\x74\x45\x78\151\x73\164\x73" => Shop::Container()->getDB()->select("\164\143\x6f\156\x73\145\156\164", "\x69\x74\x65\155\111\104", GoogleTagManager::CONSENT_KEY)]; $consentItems = ["\141\x6e\x61\154\x79\164\151\143\163" => $analyticsConsentItemExists, "\141\144\x73" => $adsConsentItemExists, "\164\141\147\x2d\155\141\156\141\x67\145\x72" => $tagManagerConsentItemExists]; $consentSettingsAndItems = array_merge_recursive($consentItems, $settings); foreach ($consentSettingsAndItems as $key => $settingAndItem) { $additionalConsentsSet = false; if (!($settingAndItem["\x61\143\x74\151\x76\145"] === true && $key !== "\x67\145\x6e\145\162\x61\x6c")) { goto ebHZj; } if ($settingAndItem["\x63\x6f\x6e\x73\x65\x6e\164\x45\170\151\163\164\x73"]) { goto YZiNN; } self::registerConsent($settingAndItem["\x74\x79\x70\145"]); YZiNN: ebHZj: if (!($settingAndItem["\x61\143\x74\151\x76\145"] === false || $consentSettingsAndItems["\147\x65\x6e\145\x72\x61\x6c"]["\x61\143\x74\151\x76\x65"] === false && $key !== "\x67\145\x6e\x65\162\141\x6c")) { goto Ru7P2; } if (!$settingAndItem["\143\157\x6e\x73\x65\156\x74\105\x78\x69\x73\164\163"]) { goto oeUm2; } self::unregisterConsent($settingAndItem["\164\x79\160\145"]); oeUm2: if (!(isset($settingAndItem["\157\164\150\145\x72\103\x6f\x6e\x73\145\x6e\164\163"]) && !$additionalConsentsSet)) { goto FAr9m; } self::updateAdditionalConsents("\165\156\162\x65\147\151\x73\164\x65\162\101\154\x6c", $settingAndItem, $consentSettingsAndItems); $additionalConsentsSet = true; FAr9m: Ru7P2: if (!(isset($settingAndItem["\157\x74\x68\145\x72\103\x6f\x6e\x73\x65\x6e\x74\x73"]) && !$additionalConsentsSet)) { goto sJwBl; } self::updateAdditionalConsents("\x6d\151\x73\143", $settingAndItem, $consentSettingsAndItems); sJwBl: bnVu8: } Rywd8: return true; } private static function updateAdditionalConsents($type, $array, $allConsents) { foreach ($array["\x6f\164\150\x65\162\103\x6f\156\163\145\156\x74\x73"] as $key => $otherConsent) { $consentItem = $allConsents[$key]; $hasConsent = $consentItem["\143\x6f\156\x73\x65\156\x74\105\x78\151\x73\x74\163"]; $needsConsent = $consentItem["\141\143\x74\x69\x76\x65"]; $unregisterAll = $type === "\x75\156\x72\145\147\151\163\x74\x65\162\101\154\x6c" ? true : false; if ($otherConsent === true && !$hasConsent && !$needsConsent && !$unregisterAll) { goto NzG7W; } if ($otherConsent === false && $hasConsent && !$needsConsent && !$unregisterAll) { goto QoD7T; } if ($unregisterAll && $hasConsent && !$needsConsent) { goto kagxX; } goto ekIc_; NzG7W: self::registerConsent($key); goto ekIc_; QoD7T: self::unregisterConsent($key); goto ekIc_; kagxX: self::unregisterConsent($key); ekIc_: Kuna9: } G8i8o: } public static function registerConsent($type) { $hiddenName = null; $localizations = []; switch ($type) { case "\x61\156\x61\154\x79\x74\x69\143\163": $hiddenName = "\141\x6e\x61\154\171\x74\151\x63\x73"; $localizations = ["\x67\145\162" => ["\x6c\x61\156\147\x75\x61\x67\x65\x49\x64" => "\147\x65\x72", "\x63\157\157\x6b\151\x65\104\145\163\143\x72\x69\160\164\x69\157\x6e" => "\123\x74\141\x74\151\163\164\x69\153\163\157\146\164\167\141\x72\145\x20\172\165\x72\x20\101\x6e\x61\154\171\163\145\x20\x76\157\156\x20\102\145\163\165\x63\150\x65\x72\144\x61\164\145\x6e", "\x63\157\x6f\x6b\151\145\x50\x75\162\160\x6f\163\x65" => "\x41\156\141\x6c\171\163\x65", "\160\x72\x69\x76\x61\x63\171\120\157\x6c\151\x63\171" => "\150\164\x74\160\163\72\x2f\x2f\160\157\x6c\151\x63\x69\145\163\56\x67\157\x6f\147\154\145\56\x63\157\155\57\160\x72\x69\166\141\143\x79\x3f\150\x6c\x3d\x64\x65", "\x63\157\157\x6b\x69\x65\x54\151\x74\154\x65" => "\x47\157\157\147\x6c\145\x20\101\156\x61\x6c\x79\164\x69\x63\x73"], "\145\156\x67" => ["\x6c\x61\x6e\147\165\x61\147\x65\x49\144" => "\x65\x6e\147", "\x63\x6f\x6f\x6b\151\145\104\x65\163\143\162\x69\160\x74\x69\157\156" => "\123\x74\141\x74\151\x73\164\x69\143\x61\x6c\x20\163\157\x66\164\x77\141\162\145\40\146\157\162\40\141\x6e\x61\154\171\x7a\x69\156\x67\40\166\151\x73\x69\x74\x6f\162\x20\x64\141\x74\x61", "\143\157\x6f\x6b\151\x65\x50\165\162\x70\157\x73\x65" => "\x41\x6e\x61\154\x79\x74\151\x63\x73", "\x70\162\151\x76\x61\x63\171\x50\x6f\x6c\x69\x63\171" => "\x68\164\x74\x70\163\72\57\57\x70\x6f\154\x69\143\x69\145\163\x2e\147\x6f\x6f\147\154\145\x2e\143\x6f\155\x2f\x70\162\151\x76\141\x63\x79\x3f\150\x6c\x3d\x65\156", "\143\x6f\157\153\151\145\x54\151\164\x6c\x65" => "\107\x6f\157\147\154\x65\40\x41\156\141\x6c\171\x74\x69\143\x73"]]; goto v8R4c; case "\141\x64\163": $hiddenName = "\141\144\x73"; $localizations = ["\147\x65\x72" => ["\154\x61\x6e\x67\x75\x61\147\x65\111\144" => "\147\x65\162", "\x63\x6f\157\153\x69\145\x44\145\x73\x63\x72\151\x70\164\x69\157\x6e" => "\123\164\x61\x74\151\163\x74\151\x6b\163\x6f\x66\164\167\141\x72\x65\40\172\x75\x72\40\x41\x6e\x61\154\x79\163\145\x20\x76\157\156\x20\x42\145\x73\165\143\150\145\162\x64\x61\x74\145\156", "\x63\157\157\153\x69\145\120\165\x72\160\x6f\x73\145" => "\x41\x6e\141\154\x79\163\145", "\x70\162\x69\166\141\143\171\120\x6f\154\151\x63\171" => "\x68\x74\164\160\163\72\57\x2f\160\x6f\x6c\151\x63\x69\145\163\x2e\147\x6f\x6f\x67\154\x65\56\143\x6f\155\57\x70\x72\151\166\x61\x63\x79\77\x68\x6c\75\x64\x65", "\143\157\x6f\x6b\151\145\x54\151\x74\x6c\145" => "\107\x6f\157\147\x6c\x65\x20\101\x64\163"], "\145\x6e\x67" => ["\154\x61\x6e\147\165\141\147\145\x49\144" => "\x65\x6e\147", "\143\x6f\x6f\x6b\x69\x65\104\x65\163\x63\162\151\160\164\x69\157\x6e" => "\x53\x74\141\x74\151\x73\164\151\x63\x61\x6c\x20\x73\157\146\164\x77\x61\x72\x65\40\146\157\162\x20\141\156\x61\154\x79\x7a\x69\156\147\x20\x76\x69\163\151\164\157\x72\x20\x64\x61\x74\x61", "\x63\x6f\x6f\153\x69\145\120\165\162\160\x6f\x73\145" => "\101\x6e\x61\x6c\x79\164\x69\143\163", "\x70\162\x69\x76\141\x63\x79\x50\157\x6c\x69\143\171" => "\x68\164\164\x70\163\72\57\x2f\x70\157\x6c\151\143\x69\x65\163\56\x67\157\157\x67\x6c\145\x2e\x63\x6f\155\x2f\x70\x72\x69\x76\141\143\171\77\150\x6c\75\x65\x6e", "\143\x6f\157\153\x69\145\x54\x69\164\154\x65" => "\107\157\x6f\x67\154\145\40\101\144\163"]]; goto v8R4c; case "\164\141\x67\x2d\x6d\141\x6e\141\147\145\162": $hiddenName = "\x74\x61\x67\x2d\155\x61\x6e\x61\x67\x65\162"; $localizations = ["\x67\x65\x72" => ["\x6c\141\x6e\x67\165\x61\x67\145\x49\144" => "\x67\145\162", "\x63\x6f\x6f\x6b\x69\145\104\x65\x73\143\x72\x69\160\164\151\x6f\156" => "\123\164\x61\164\x69\163\164\151\x6b\163\157\x66\x74\167\141\x72\x65\x20\172\x75\162\40\101\x6e\x61\x6c\x79\x73\x65\x20\166\157\x6e\x20\x42\145\x73\x75\143\150\145\x72\144\x61\x74\145\156", "\143\157\157\x6b\x69\x65\x50\165\x72\x70\x6f\x73\145" => "\101\x6e\141\154\171\163\145", "\x70\x72\151\166\141\143\x79\120\157\x6c\x69\143\171" => "\150\x74\164\160\163\x3a\57\57\160\x6f\x6c\x69\143\x69\x65\x73\x2e\x67\x6f\157\147\x6c\145\x2e\x63\157\155\57\160\x72\x69\x76\141\x63\171\77\150\x6c\75\x64\145", "\143\157\157\x6b\151\x65\124\151\x74\x6c\x65" => "\x47\157\157\147\x6c\145\x20\x54\141\147\40\115\141\156\141\147\x65\162"], "\145\x6e\x67" => ["\154\141\x6e\147\x75\141\147\145\111\144" => "\145\x6e\147", "\143\157\x6f\x6b\151\145\104\145\163\x63\162\151\160\x74\151\157\x6e" => "\123\164\141\164\x69\x73\164\x69\x63\x61\154\x20\163\x6f\x66\x74\167\x61\162\x65\x20\x66\157\x72\40\x61\156\141\154\171\172\151\156\147\x20\166\151\163\x69\164\x6f\x72\x20\x64\x61\164\141", "\143\x6f\x6f\153\151\145\x50\165\x72\x70\x6f\x73\x65" => "\101\x6e\x61\x6c\x79\x74\151\143\x73", "\x70\x72\x69\x76\141\x63\x79\120\157\154\151\143\171" => "\150\x74\164\x70\x73\x3a\57\x2f\160\157\x6c\x69\x63\x69\145\x73\x2e\x67\157\x6f\x67\154\x65\56\x63\157\155\x2f\160\162\151\x76\141\143\171\x3f\x68\154\75\x65\x6e", "\x63\x6f\x6f\x6b\151\x65\124\x69\x74\x6c\145" => "\107\x6f\157\x67\154\x65\x20\x54\141\x67\x20\115\141\156\x61\x67\x65\x72"]]; goto v8R4c; } Y1RJH: v8R4c: ConsentManagerIntegration::registerConsentItem(["\x68\x69\144\x64\145\156\x4e\141\x6d\145" => $hiddenName, "\143\x6f\155\x70\x61\x6e\171" => "\107\157\157\x67\154\145\x20\x49\156\143\x2e", "\141\143\x74\151\166\145" => 1, "\154\x6f\143\x61\x6c\151\x7a\x61\164\x69\x6f\156" => $localizations]); } public static function unregisterConsent($type) { $consentSetting = Shop::Container()->getDB()->select("\x74\143\x6f\x6e\163\145\156\164", "\151\164\x65\x6d\111\x44", "\x61\144\x6d\157\162\x72\x69\163\x2d" . $type); if (!$consentSetting) { goto ZhWjj; } ConsentManagerIntegration::unregisterConsentItem($consentSetting->id); ZhWjj: } }