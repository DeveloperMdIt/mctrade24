<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro\enhancedEcommerceTracking; use JTL\Cart\CartItem; use JTL\Catalog\Product\Artikel; use JTL\Shop; use JTL\Session\Frontend; use JTL\Checkout\Bestellung; use JTL\Helpers\Tax; use JTL\Plugin\PluginInterface; use JTL\Smarty\JTLSmarty; use Plugin\admorris_pro\Models\EnhancedEcommerceTrackingModel; abstract class AbstractEcommerceTracking { protected array $scriptTypes = []; protected array $scripts = []; protected string $scriptTagInner; protected bool $includeTax; protected bool $includeShipping; const CONSENT_KEY = "\141\144\x6d\157\x72\x72\x69\x73\x2d\145\x6e\150\141\x6e\143\x65\144\x2d\145\143\x6f\155\155\x65\162\x63\x65\x2d\164\x72\141\x63\153\x69\x6e\147"; public function __construct(protected string $id, protected EnhancedEcommerceTrackingModel $settings, protected Payload $payload, protected bool $consentManagerActive, protected bool $hasConsent, protected int $pageType, protected JTLSmarty $smarty, protected PluginInterface $plugin) { $this->includeTax = $settings->include_tax === "\x31"; $this->includeShipping = $settings->cart_sum_total === "\x31"; $this->scriptTagInner = $this->getScriptTagInner(); $this->init(); $this->populateScripts(); } public function init() { $pageType = $this->pageType; $this->addScriptType("\x67\145\x6e\145\x72\x61\154"); if (!($pageType === PAGE_ARTIKEL || $pageType === PAGE_ARTIKELLISTE)) { goto QnRJk; } if (!($pageType === PAGE_ARTIKEL && $this->settings->product)) { goto Q30Zw; } $this->addScriptType("\x76\x69\145\x77"); Q30Zw: if (!$this->settings->cart) { goto pqx21; } $this->addScriptType("\x63\141\162\x74\101\x64\x64"); pqx21: QnRJk: if (!($pageType === PAGE_WARENKORB && $this->settings->cart)) { goto u00lm; } $this->addScriptType("\143\141\x72\164"); u00lm: if (!($pageType === PAGE_BESTELLVORGANG && $this->settings->checkout)) { goto nxwCd; } $this->addScriptType("\143\x68\x65\143\153\x6f\x75\x74"); nxwCd: if (!($pageType === PAGE_BESTELLABSCHLUSS)) { goto RW2nw; } $this->addScriptType("\x70\165\162\x63\x68\x61\x73\x65"); RW2nw: } protected function activateScripts() : bool { if (!(!$this->consentManagerActive || $this->hasConsent)) { goto Qjo4S; } return true; Qjo4S: return false; } protected function getScriptTagInner($type = "\141\160\x70\154\x69\143\141\164\x69\157\x6e\57\x6a\141\166\x61\163\143\x72\151\x70\164") : string { if (!$this->settings->advanced_consent_mode) { goto K7seH; } return "\x20\x74\171\160\145\75\x22{$type}\42"; K7seH: if (!$this->activateScripts()) { goto VmPmW; } return "\40\x74\171\160\x65\x3d\x22" . $type . "\x22\40\x64\141\164\x61\55\x6e\x61\155\x65\x3d\x22" . static::CONSENT_KEY . "\42\x20"; VmPmW: return "\x20\144\x61\x74\x61\x2d\x6e\141\155\145\75\42" . static::CONSENT_KEY . "\x22\40\164\171\160\145\x3d\42\164\145\x78\x74\57\160\154\141\151\x6e\42\40\144\x61\164\x61\x2d\x74\171\160\145\75\42" . $type . "\x22\40"; } public function setScript(string $type, ScriptWrapper|array $script) : void { if (!is_array($script)) { goto kMq6K; } foreach ($script as $scriptKey => $scriptValue) { $this->scripts[$type . $scriptKey] = $scriptValue; bYf9O: } YEj8p: return; kMq6K: $this->scripts[$type] = $script; } public function getScriptTypes() { return $this->scriptTypes; } public function setScripts(array $scripts) { $this->scripts = $scripts; } public function getScripts() : array { return $this->scripts; } public function getID() { if (!(get_class($this) === GoogleAnalytics::class && defined("\101\104\x4d\117\122\x52\x49\123\137\120\122\x4f\x5f\105\x4e\x48\x41\x4e\103\105\104\x5f\x45\x43\117\x4d\x4d\x45\x52\103\105\x5f\x4d\125\114\x54\111\x44\117\x4d\101\x49\116\137\101\116\x41\114\131\124\111\x43\x53\137\111\x44"))) { goto hgVAJ; } $mdIds = \ADMORRIS_PRO_ENHANCED_ECOMMERCE_MULTIDOMAIN_ANALYTICS_ID; if (!(is_array($mdIds) && array_key_exists($_SERVER["\110\124\x54\x50\x5f\x48\x4f\123\124"], $mdIds))) { goto if4qA; } return $mdIds[$_SERVER["\x48\x54\x54\x50\137\110\x4f\123\124"]]; if4qA: hgVAJ: return $this->id; } protected function getScriptUrl() : string { $url = $this->getMultidomainScriptUrl(); if (empty($url)) { goto ie6ys; } return $url; ie6ys: return $this->settings->server_url == '' ? "\150\x74\x74\x70\163\72\57\57\167\x77\167\56\147\x6f\x6f\147\154\145\164\x61\x67\155\x61\x6e\x61\x67\x65\162\56\x63\157\x6d" : $this->settings->server_url; } protected function getMultidomainScriptUrl() : ?string { if (defined("\x41\104\x4d\x4f\122\122\111\123\137\x50\122\117\x5f\105\116\110\101\116\x43\105\104\x5f\x45\103\x4f\x4d\115\x45\x52\x43\x45\x5f\x4d\125\x4c\x54\x49\x44\x4f\115\x41\111\x4e\x5f\x53\x45\x52\126\105\122\x5f\x55\122\114")) { goto fbist; } return null; fbist: $md_serverUrlArray = \ADMORRIS_PRO_ENHANCED_ECOMMERCE_MULTIDOMAIN_SERVER_URL; if (is_array($md_serverUrlArray) && array_key_exists($_SERVER["\x48\124\124\x50\137\x48\x4f\x53\124"], $md_serverUrlArray)) { goto jEIDu; } return null; jEIDu: if (!(strpos($md_serverUrlArray[$_SERVER["\110\x54\x54\120\x5f\x48\117\x53\x54"]], "\x68\164\164\160\163\72\57\x2f") !== 0)) { goto oqZrz; } return "\150\164\x74\x70\x73\72\x2f\x2f" . $md_serverUrlArray[$_SERVER["\x48\124\x54\120\137\x48\117\123\124"]]; oqZrz: return $md_serverUrlArray[$_SERVER["\110\x54\124\120\137\110\x4f\x53\x54"]]; } protected function populateScripts() : void { $scripts = $this->getScriptTypes(); foreach ($scripts as $scriptType) { $function = "\x67\x65\164" . ucfirst($scriptType) . "\x53\x63\162\151\x70\x74"; if (!(!method_exists($this, $function) || $this->isTagManagerClass() && $scriptType !== "\147\145\156\x65\162\141\x6c" && $this->analyticsEnabled())) { goto yiIfn; } goto YDm5D; yiIfn: $script = $this->{$function}(); if (!empty($script)) { goto SEf9j; } goto YDm5D; SEf9j: $this->setScript($scriptType, $script); YDm5D: } b7tj1: } private function addScriptType($typeNeeded) { $this->scriptTypes[] = $typeNeeded; } protected function wrapScript($selector, $manipulation, $script) : ScriptWrapper { return new ScriptWrapper($selector, $manipulation, $script); } protected function analyticsEnabled() { return $this->settings->analytics_active && !empty($this->settings->analytics_id); } protected function adsEnabled() { return $this->settings->ads_active && !empty($this->settings->ads_id); } protected function isTagManagerClass() : bool { return get_class($this) === GoogleTagManager::class; } }