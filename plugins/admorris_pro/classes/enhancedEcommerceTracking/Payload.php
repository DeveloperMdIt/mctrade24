<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro\enhancedEcommerceTracking; use JTL\Shop; use JTL\Helpers\Tax; use JTL\Cart\CartItem; use JTL\Session\Frontend; use JTL\Smarty\JTLSmarty; use JTL\Checkout\Bestellung; use JTL\Catalog\Product\Artikel; use Plugin\admorris_pro\Models\EnhancedEcommerceTrackingModel; class Payload { public function __construct(private int $pageType, private EnhancedEcommerceTrackingModel $settings, private JTLSmarty $smarty, private bool $addWrapper = false) { } protected function createArticlePayload(string $action) : array { goto JDxDa; Kc0JE: $item->item_category = $category; $item->brand = ''; if (empty($article)) { goto GCnbZ; } $showMatrix = $this->smarty->getTemplateVars("\x73\150\x6f\x77\115\x61\x74\162\151\170"); $createItem = function ($article) use($category) { $item = new \stdClass(); $item->id = $article->kArtikel; $item->item_id = $article->cArtNr; $item->item_name = $article->cName; $item->price = $article->Preise->fVKNetto; $item->item_category = $category; $item->brand = $article->cHersteller; return $item; }; if ($showMatrix && $article->nIstVater === 1 && count($article->oVariationKombiKinderAssoc_arr) > 0) { goto OgCL_; } $item = $createItem($article); goto ND2cF; OgCL_: $items = array_reduce($article->oVariationKombiKinderAssoc_arr, function ($carry, $child) use($createItem) { $carry[] = $createItem($child); return $carry; }, []); goto PFrZj; PFrZj: ND2cF: GCnbZ: $payload = ["\x63\x75\x72\x72\145\156\143\x79" => Frontend::getCurrency()->getName(), "\x76\141\154\165\145" => Frontend::getCurrency()->getConversionFactor(), "\151\x74\145\155\163" => $items ?? [$item]]; if (!($action === "\x76\x69\x65\x77" && $this->pageType === PAGE_ARTIKEL)) { goto P7ZzL; } $payload["\166\141\x6c\x75\x65"] = $article->Preise->{$priceType} * Frontend::getCurrency()->getConversionFactor(); P7ZzL: if (!($action === "\143\141\x72\164\55\141\x64\144" || $action === "\143\141\162\x74\55\x72\145\155\x6f\166\x65")) { goto IAagB; } $payload["\x69\164\145\155\x73"] = array_map(function ($item) { $item->quantity = null; return $item; }, $payload["\x69\x74\x65\155\163"]); IAagB: return $payload; goto jYKII; JDxDa: if (!($this->pageType === PAGE_ARTIKEL)) { goto nN7si; } $article = $this->smarty->getTemplateVars("\101\162\164\151\153\x65\x6c"); nN7si: $priceType = $this->settings->includeTax() ? "\x66\126\x4b\x42\162\x75\164\164\157" : "\146\126\x4b\x4e\145\164\164\157"; $category = $this->smarty->getTemplateVars("\101\x6b\164\x75\145\154\154\x65\113\x61\164\x65\x67\157\162\x69\145")->getCategoryPath(); $category = end($category); $item = new \stdClass(); $item->item_id = 0; $item->item_name = ''; $item->price = 0; goto Kc0JE; jYKII: } public function getArticlePayload(string $action) : string { $payloadArray = $this->createArticlePayload($action); if (!$this->addWrapper) { goto ogWyU; } $payloadArray = $this->wrap($payloadArray); ogWyU: return json_encode($payloadArray); } protected function createTransactionPayload($order, $firm, $type) { goto cQ4MT; xLBTd: if ($this->settings->includeTax()) { goto W7iHy; } $orderValue = fn($order) => ($order->fGesamtsummeNetto + $order->fGuthaben) * $order->fWaehrungsFaktor; goto LxBh0; W7iHy: $orderValue = fn($order) => $order->fGesamtsumme * $order->fWaehrungsFaktor; LxBh0: RZdhi: if ($this->settings->includeTax()) { goto JZNWh; } $shippingProperty = "\x66\126\x65\x72\x73\141\156\x64\116\x65\x74\x74\x6f"; $itemValue = fn($item) => $item->fPreis; goto kRGsO; kRGsO: goto yH8gi; JZNWh: $shippingProperty = "\x66\126\145\x72\x73\x61\156\144"; $itemValue = fn($item) => Tax::getGross($item->fPreis, CartItem::getTaxRate($item)); yH8gi: if ($type === "\x61\x6e\x61\154\171\164\151\x63\163") { goto CgTRb; } if ($type === "\x61\144\163") { goto OpA37; } goto SYK14; CgTRb: $items = array_filter(array_map(function ($cartItem) use($order, $itemValue) { if (!($cartItem->nPosTyp == 1)) { goto nBcI3; } $item = ["\151\144" => $cartItem->cArtNr, "\x6e\x61\x6d\x65" => $cartItem->cName, "\143\x61\x74\145\147\157\x72\171" => $cartItem->Category ?? '', "\x71\x75\141\156\x74\x69\164\x79" => str_replace("\54", "\x2e", $cartItem->nAnzahl), "\x70\162\x69\143\145" => $itemValue($cartItem) * $order->fWaehrungsFaktor]; return $item; nBcI3: }, $order->Positionen)); goto eqi9K; cQ4MT: $payload = null; if ($this->settings->includeShipping()) { goto TUBBf; } if ($this->settings->includeTax()) { goto BWpMi; } $orderValue = fn($order) => ($order->fWarensummeNetto + $order->fGuthaben) * $order->fWaehrungsFaktor; goto GmNZH; BWpMi: $orderValue = fn($order) => ($order->fWarensumme + $order->fGuthaben) * $order->fWaehrungsFaktor; GmNZH: goto RZdhi; TUBBf: goto xLBTd; eqi9K: $payload = ["\164\162\141\156\x73\x61\x63\164\x69\x6f\156\137\151\144" => $order->cBestellNr, "\x61\146\146\151\154\151\141\x74\151\x6f\x6e" => $firm, "\x76\141\154\165\145" => $orderValue($order), "\143\165\162\162\x65\156\143\171" => Frontend::getCurrency()->getName(), "\x74\x61\x78" => $order->fSteuern * $order->fWaehrungsFaktor, "\163\150\x69\160\x70\151\x6e\x67" => $order->{$shippingProperty} * $order->fWaehrungsFaktor, "\151\164\145\x6d\163" => $items]; goto SYK14; OpA37: $payload = ["\x73\x65\156\144\x5f\x74\157" => $this->settings->ads_id . "\x2f" . $this->settings->ads_conversion_label, "\x76\141\154\165\x65" => $orderValue($order), "\x63\165\x72\162\x65\156\x63\x79" => Frontend::getCurrency()->getName(), "\164\x72\141\156\163\x61\x63\x74\151\157\156\137\151\x64" => $order->cBestellNr]; SYK14: return $payload; goto fd19b; fd19b: } public function getTransactionPayload($order, $firm, $type) : ?string { if (!empty($order->kBestellung)) { goto mr17N; } return null; mr17N: $payload = $this->createTransactionPayload($order, $firm, $type); if (!($order->fWarensummeNetto === 0.0)) { goto GGfnK; } $currentOrder = new Bestellung($order->kBestellung, true); $payload = $this->createTransactionPayload($currentOrder, $firm, $type); GGfnK: if (!$this->addWrapper) { goto moMu7; } $payload = $this->wrap($payload); moMu7: return json_encode($payload, JSON_UNESCAPED_SLASHES); } public static function createArticleData(Artikel|array $products) { $dataMapper = function ($product) { return (object) ["\x69\x64" => $product->kArtikel, "\151\x74\x65\155\137\x69\144" => $product->cArtNr, "\151\x74\x65\155\x5f\156\141\155\x65" => $product->cName, "\142\x72\x61\x6e\x64" => $product->cHersteller, "\x70\x72\151\x63\x65" => $product->Preise->fVKNetto]; }; if (is_array($products)) { goto TI7vR; } $products = [$products]; TI7vR: $variations = array_map($dataMapper, $products); return array_values($variations); } protected function wrap(array $payload) : array { $payloadNew = []; $payloadNew["\x65\x63\157\155\x6d\145\x72\143\x65"] = $payload; return $payloadNew; } }