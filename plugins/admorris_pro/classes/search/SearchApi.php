<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro\search; use JTL\Events\Dispatcher; use JTL\Plugin\PluginInterface; use JTL\Shop; use Laminas\Diactoros\Response\JsonResponse; use Plugin\admorris_pro\controller\AbstractHookController; use Plugin\admorris_pro\StatusRequest; class SearchApi extends AbstractHookController { private SearchConfigDTO $searchConfig; protected string $configKey = "\141\x64\x6d\157\162\x72\x69\163\x5f\160\162\x6f\137\163\145\x61\x72\x63\x68\x5f\x61\143\x74\x69\x76\145"; public function __construct(PluginInterface $plugin, Dispatcher $dispatcher, StatusRequest $statusRequest) { parent::__construct($plugin, $dispatcher, $statusRequest); } protected function init() : void { $this->initSearchConfig(); $this->dispatcher->hookInto(\HOOK_ROUTER_PRE_DISPATCH, function ($args) { $router = $args["\x72\x6f\165\164\x65\x72"]; $router->addRoute("\141\144\155\157\162\162\151\x73\x2d\x73\155\x61\162\164\163\x65\141\162\143\150\x2d\x73\x75\147\147\145\163\x74", $this->getSearchSuggestion(...)); }); $this->dispatcher->hookInto(\HOOK_IO_HANDLE_REQUEST_ADMIN, function ($args) { $io = $args["\x69\157"]; $io->register("\x61\x64\x6d\x53\x65\x61\162\143\x68\122\145\x73\x65\164\104\102", $this->searchResetDB(...)); }); } private function initSearchConfig() { $this->searchConfig = $this->statusRequest->getSearchConfig(); } private function getSearchSuggestion($searchdata = null) { goto WxEyX; WxEyX: $searchInput = null; if (is_array($searchdata) && isset($searchdata["\x73\145\141\162\x63\x68\111\156\x70\x75\x74"])) { goto irCl8; } if (isset($_POST["\x73\x65\x61\162\143\150\x49\x6e\160\x75\x74"])) { goto flCH_; } if (isset($_GET["\x73\x65\x61\162\143\150\x49\156\160\x75\x74"])) { goto Unthi; } $jsonInput = file_get_contents("\x70\x68\160\72\57\57\151\156\x70\x75\164"); if (!$jsonInput) { goto WYDuK; } $jsonData = json_decode($jsonInput, true); if (!isset($jsonData["\x73\x65\141\x72\143\x68\x49\156\x70\x75\x74"])) { goto Emn2b; } $searchInput = $jsonData["\163\145\x61\162\x63\x68\111\x6e\x70\x75\164"]; Emn2b: goto gX15W; gX15W: WYDuK: goto jFvNJ; irCl8: $searchInput = $searchdata["\163\145\141\162\x63\150\x49\x6e\x70\165\164"]; goto jFvNJ; flCH_: $searchInput = $_POST["\x73\145\141\162\x63\150\111\x6e\x70\x75\164"]; goto jFvNJ; Unthi: $searchInput = $_GET["\163\145\141\162\143\x68\111\156\x70\165\164"]; goto BXELi; BXELi: jFvNJ: if (!empty($searchInput)) { goto ji8ps; } return new JsonResponse(["\145\162\x72\x6f\162" => "\116\157\40\163\145\141\162\143\150\40\x69\x6e\160\165\164\x20\160\x72\x6f\x76\x69\144\x65\x64"], 400); ji8ps: try { $searchResult = $this->postRequest($searchInput); $decodedResult = json_decode($searchResult, true); if (!(json_last_error() !== JSON_ERROR_NONE)) { goto ixkOG; } return new JsonResponse(["\145\x72\162\x6f\162" => "\111\156\166\x61\154\x69\144\x20\x72\145\163\160\157\x6e\163\145\40\x66\162\x6f\x6d\40\163\145\x61\162\143\150\40\x73\x65\162\166\x65\x72", "\162\141\167\x5f\162\x65\163\160\x6f\x6e\x73\x65" => $searchResult], 500); ixkOG: return new JsonResponse($decodedResult); } catch (\Throwable $th) { return new JsonResponse(["\145\x72\162\157\x72" => $th->getMessage()], 500); } goto ZrJ4v; ZrJ4v: } public function postRequest($data) { $kSprache = $_SESSION["\x6b\x53\x70\162\141\143\150\145"]; $postUrl = $this->searchConfig->suchIndex . "\x5f" . $kSprache . "\57\137\x73\x65\x61\x72\x63\150\77\160\162\145\x74\164\171\46\x66\151\x6c\x74\x65\162\x5f\160\x61\164\x68\75\x68\151\164\x73\x2e\x68\151\164\163\x2e\x5f\163\157\165\x72\x63\x65"; $postData = $this->getDataSearchSuggestion($data); $header = array("\x63\157\156\x74\145\156\164\x2d\x74\171\160\145\x3a\40\x61\x70\160\154\151\143\x61\164\151\157\x6e\x2f\152\x73\157\156"); $curl = curl_init(); curl_setopt($curl, CURLOPT_URL, $this->searchConfig->urlBase . $postUrl); curl_setopt($curl, CURLOPT_HTTPHEADER, $header); curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1); curl_setopt($curl, CURLOPT_POST, true); curl_setopt($curl, CURLOPT_POSTFIELDS, $postData); $response = curl_exec($curl); curl_close($curl); return $response; } private function getDataSearchSuggestion($data) { $result = ''; $varkombi_handling = Shop::Container()->getDB()->select("\164\x70\154\x75\x67\151\156\145\151\156\163\x74\x65\x6c\154\165\x6e\x67\145\x6e", "\x63\x4e\x61\x6d\x65", "\x61\x64\155\x6f\x72\x72\151\x73\x5f\x70\x72\157\x5f\163\x65\x61\x72\x63\x68\137\x76\141\x72\x6b\x6f\155\x62\x69\x5f\x68\141\x6e\144\x6c\151\156\147"); $varkombi_handling = $varkombi_handling->cWert; $kKundengruppe = $_SESSION["\113\165\x6e\x64\x65\156\x67\162\165\160\x70\145"]->getID(); if ($varkombi_handling === "\61") { goto z03FH; } if ($varkombi_handling === "\x32") { goto s4U35; } if (!($varkombi_handling === "\x33")) { goto dF5rr; } $result = "\x7b\xa\x20\x20\40\40\x20\40\x20\x20\42\137\x73\157\x75\162\143\145\x22\x3a\x20\x5b\x20\x22\x63\x4e\x61\x6d\x65\42\x2c\40\x22\143\123\x65\x6f\x22\x20\135\x2c\xa\x20\x20\x20\x20\40\40\40\40\40\x20\40\x20\42\161\165\x65\x72\x79\x22\x3a\40\173\xa\x20\x20\x20\40\x20\40\x20\40\40\x20\x20\x20\x20\40\x20\x20\42\142\x6f\x6f\x6c\x22\72\40\x7b\12\40\x20\40\x20\40\40\x20\40\40\40\x20\40\x20\40\40\40\40\x20\40\x20\x22\x6d\165\163\164\x22\x3a\x20\173\12\40\40\x20\40\x20\x20\40\x20\40\x20\x20\x20\x20\40\x20\40\40\x20\40\x20\40\x20\40\x20\x22\155\165\x6c\164\x69\137\x6d\141\x74\143\x68\x22\x3a\x20\173\xa\x20\40\40\x20\40\40\x20\x20\x20\x20\x20\x20\40\40\x20\40\x20\40\40\40\40\x20\40\x20\40\x20\x20\x20\x22\161\165\x65\x72\x79\42\x20\72\x20\x22" . $data . "\42\x2c\12\40\40\x20\40\40\40\x20\40\x20\x20\x20\x20\x20\x20\40\40\40\x20\40\x20\x20\40\x20\40\x20\x20\40\40\42\x66\x75\x7a\172\x69\156\145\163\163\42\72\x20\42\101\125\x54\117\42\54\12\40\40\x20\40\40\40\40\x20\x20\40\40\x20\x20\x20\40\x20\40\40\40\x20\x20\x20\x20\40\40\x20\x20\40\42\146\151\x65\154\144\163\42\x20\72\40\x5b\x20\x22\x63\116\141\155\x65\136\61\x30\42\x2c\x20\42\143\x53\165\x63\150\x62\145\x67\162\x69\146\x66\145\x5e\65\x22\54\x20\42\x63\x4d\x65\x74\x61\x4b\x65\171\167\157\162\144\163\42\40\135\12\40\x20\40\x20\40\40\40\x20\40\40\40\40\40\40\x20\x20\x20\40\x20\40\x20\x20\x20\x20\175\12\x20\40\x20\x20\x20\x20\40\40\x20\40\40\x20\x20\x20\x20\40\x20\40\40\40\x7d\x2c\12\x20\x20\40\x20\x20\x20\40\40\x20\x20\40\x20\40\40\x20\x20\40\x20\x20\40\x22\x66\151\154\x74\145\162\x22\x3a\x20\x7b\xa\x20\40\x20\x20\x20\40\40\40\40\40\40\x20\40\x20\x20\40\x20\40\40\40\x20\x20\40\40\42\x6d\141\164\143\x68\42\x3a\40\x7b\xa\x20\40\x20\40\40\40\40\40\40\40\40\40\x20\x20\x20\40\x20\x20\40\x20\x20\x20\x20\40\40\x20\x20\x20\x22\156\111\163\x74\x56\141\164\x65\x72\42\72\40\x22\x30\x22\12\40\x20\x20\40\x20\40\40\40\40\40\x20\x20\x20\x20\40\40\x20\40\40\40\x20\x20\x20\x20\175\xa\40\40\40\40\40\40\40\x20\x20\x20\x20\x20\40\x20\40\x20\40\x20\40\40\x7d\54\12\40\x20\40\x20\x20\40\40\40\x20\x20\40\x20\x20\40\x20\40\x20\40\40\40\42\155\165\x73\x74\137\x6e\x6f\164\x22\x3a\40\133\xa\x20\40\x20\x20\x20\40\x20\x20\x20\x20\40\x20\x20\x20\40\40\40\40\x20\x20\40\x20\40\40\173\x20\42\155\141\164\143\x68\42\72\40\173\x20\x22\x68\151\x64\145\113\x75\156\x64\x65\x6e\x67\x72\165\x70\x70\x65\42\x3a\x20\x22" . $kKundengruppe . "\x22\40\x7d\x7d\xa\x20\x20\x20\x20\x20\x20\x20\x20\40\x20\40\x20\40\x20\x20\x20\x20\x20\40\x20\x20\x20\135\12\x20\40\x20\x20\40\40\x20\40\40\x20\40\40\x20\40\40\x20\175\xa\x20\x20\x20\40\x20\40\x20\x20\40\x20\40\40\175\xa\40\x20\40\40\40\40\x20\x20\x7d"; dF5rr: goto VAeYk; s4U35: $result = "\x7b\12\x20\x20\40\40\40\x20\x22\x5f\x73\x6f\x75\x72\143\145\x22\x3a\40\133\x20\x22\143\116\141\x6d\x65\42\x2c\40\42\143\123\x65\x6f\x22\x20\135\54\12\40\40\x20\x20\40\40\x20\40\42\161\x75\145\x72\x79\42\72\x20\173\12\40\x20\x20\x20\40\40\x20\40\40\x20\x20\40\x22\142\x6f\x6f\154\42\72\40\x7b\xa\x20\40\x20\x20\40\40\40\40\40\x20\x20\x20\x20\x20\x20\x20\42\x6d\x75\163\x74\x22\x3a\x20\173\12\x20\x20\40\x20\x20\x20\x20\40\40\x20\40\x20\x20\x20\40\40\40\40\40\x20\42\x6d\x75\x6c\164\x69\x5f\x6d\141\164\143\150\x22\x3a\x20\173\xa\x20\x20\x20\x20\x20\40\40\40\x20\40\40\40\40\40\40\x20\40\x20\x20\40\x20\x20\x20\40\42\x71\x75\145\162\171\42\x20\x3a\x20\x22" . $data . "\42\54\12\x20\x20\40\40\40\x20\40\40\x20\40\x20\40\x20\x20\x20\x20\x20\x20\x20\x20\40\x20\40\x20\42\x66\x75\x7a\172\x69\156\145\x73\163\42\x3a\40\x22\x41\125\x54\x4f\x22\x2c\xa\40\40\40\x20\x20\40\x20\40\x20\40\x20\40\40\x20\40\40\x20\x20\x20\x20\x20\40\40\x20\42\146\151\145\x6c\x64\163\x22\x20\72\40\x5b\40\42\143\116\141\x6d\x65\x5e\x31\x30\x22\x2c\40\x22\143\123\165\143\150\x62\145\x67\x72\x69\x66\x66\145\x5e\x35\42\x2c\x20\42\143\x4d\x65\164\x61\113\145\x79\167\x6f\x72\144\x73\x22\x20\135\xa\40\x20\40\x20\40\x20\40\40\40\x20\x20\40\40\x20\x20\40\40\x20\x20\40\x7d\xa\x20\40\40\x20\x20\40\x20\40\40\40\x20\40\x20\x20\x20\40\175\54\xa\x20\x20\40\40\x20\40\x20\x20\40\x20\40\40\40\40\40\40\x22\146\x69\x6c\164\145\162\42\x3a\x20\173\xa\x20\x20\x20\x20\x20\40\x20\40\40\x20\x20\40\x20\40\x20\x20\40\40\40\x20\x22\x6d\x61\164\x63\150\x22\x3a\40\173\12\40\40\x20\40\x20\40\x20\40\x20\40\40\x20\40\x20\40\40\x20\40\40\x20\40\40\x20\x20\42\153\126\x61\x74\x65\162\101\x72\x74\151\x6b\x65\154\42\x3a\x20\x30\xa\x20\40\40\40\40\x20\x20\40\x20\x20\x20\40\x20\40\x20\x20\x20\40\40\x20\175\12\x20\40\x20\x20\40\40\40\40\x20\40\x20\40\40\40\40\40\175\54\12\x20\40\x20\40\40\40\40\x20\40\40\40\40\x20\40\x20\x20\x22\x6d\x75\x73\164\137\156\x6f\x74\x22\x3a\x20\x5b\xa\40\x20\x20\40\x20\40\x20\40\40\40\x20\40\40\x20\x20\40\x20\x20\40\40\x7b\x20\42\x6d\x61\164\143\x68\x22\x3a\x20\173\x20\42\150\x69\144\x65\x4b\165\156\144\145\x6e\x67\162\x75\x70\x70\x65\x22\72\x20\x22" . $kKundengruppe . "\42\x20\175\175\12\x20\x20\40\40\40\x20\x20\x20\40\x20\40\x20\x20\x20\x20\40\x20\x20\x5d\xa\40\40\40\40\x20\40\x20\40\x20\40\40\x20\175\12\40\40\40\40\x20\x20\40\40\175\12\40\40\40\40\x20\x20\175"; VAeYk: goto gZyFu; z03FH: $result = "\173\12\x20\40\x20\x20\x20\x20\x20\x20\42\x5f\x73\157\165\162\143\145\42\72\x20\x5b\40\x22\143\x4e\x61\155\x65\x22\54\x20\x22\143\123\145\157\42\x20\x5d\x2c\xa\x20\x20\40\40\40\x20\x20\40\42\x71\165\x65\162\x79\42\x3a\40\173\12\x20\x20\x20\x20\40\x20\x20\x20\x20\x20\40\x20\x22\x62\157\x6f\154\x22\72\x20\173\xa\x20\x20\x20\x20\x20\40\40\x20\x20\40\x20\40\x20\40\x20\x20\42\x6d\165\x73\x74\42\72\40\173\xa\x20\40\40\40\40\40\x20\40\x20\x20\x20\x20\40\x20\40\x20\x20\40\x20\x20\x22\155\165\x6c\164\151\x5f\x6d\141\x74\x63\150\42\x3a\40\x7b\xa\x20\40\x20\40\x20\40\40\x20\x20\x20\x20\40\x20\x20\x20\x20\40\x20\x20\x20\x20\x20\x20\40\42\161\165\145\x72\x79\x22\40\x3a\40\42" . $data . "\x22\x2c\12\40\40\40\x20\x20\x20\40\x20\x20\x20\40\x20\40\x20\x20\x20\40\40\x20\40\x20\x20\40\40\x22\x66\165\x7a\x7a\x69\x6e\145\163\163\x22\72\40\42\101\125\124\x4f\42\54\12\40\x20\40\40\x20\x20\40\x20\40\40\x20\x20\40\x20\x20\40\x20\x20\40\40\x20\x20\x20\40\42\146\151\145\154\144\x73\x22\x20\72\x20\x5b\40\42\143\x4e\x61\x6d\145\x5e\61\60\x22\x2c\40\42\x63\123\x75\143\x68\x62\145\x67\x72\151\x66\146\145\136\x35\x22\x2c\x20\42\x63\x4d\x65\x74\141\x4b\x65\x79\x77\157\162\144\x73\42\40\135\xa\40\x20\40\x20\40\40\40\x20\40\40\x20\x20\x20\x20\x20\x20\x20\40\x20\40\x7d\12\x20\40\x20\40\x20\40\x20\40\x20\40\40\40\x20\40\40\x20\175\54\xa\x20\40\x20\40\x20\x20\x20\x20\40\40\40\x20\40\x20\x20\x20\x22\x6d\x75\163\164\137\x6e\157\164\42\72\x20\133\12\x20\x20\40\x20\40\x20\40\x20\x20\40\x20\40\x20\x20\40\40\x20\x20\40\40\173\x20\x22\x6d\x61\164\x63\x68\x22\x3a\40\173\x20\x22\150\151\144\145\113\165\x6e\x64\x65\156\x67\162\165\160\x70\x65\42\x3a\40\x22" . $kKundengruppe . "\x22\x20\x7d\x7d\12\40\x20\x20\40\x20\40\x20\x20\x20\40\40\x20\40\x20\x20\x20\x20\40\x5d\xa\40\x20\40\40\x20\40\x20\40\40\40\40\40\175\12\40\40\40\x20\40\40\40\40\175\xa\40\x20\40\x20\40\x20\175"; gZyFu: return $result; } private function searchResetDB() { $allLanguages = Shop::Container()->getDB()->query("\x53\105\x4c\x45\103\124\x20\153\x53\160\162\141\143\x68\x65\x20\106\122\117\115\40\x74\163\160\x72\x61\x63\x68\145", 2); $status = true; foreach ($allLanguages as $language) { if (!$status) { goto C76n0; } $status = $this->delete($language->kSprache); C76n0: k5a_4: } rdPEA: return json_encode($status); } public function delete($langId) { goto szz0k; szz0k: $postUrl = $this->searchConfig->suchIndex . "\x5f" . $langId; $header = array("\143\157\156\164\145\x6e\164\x2d\164\171\160\145\72\40\x61\160\x70\x6c\151\143\x61\x74\151\x6f\156\x2f\152\163\157\156"); $curl = curl_init(); curl_setopt($curl, CURLOPT_URL, $this->searchConfig->urlBase . $postUrl); curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1); curl_setopt($curl, CURLOPT_CUSTOMREQUEST, "\104\105\x4c\x45\x54\105"); $response = curl_exec($curl); curl_close($curl); $responseArray = json_decode($response, true); if (isset($responseArray["\x61\x63\153\156\157\167\x6c\x65\144\x67\x65\144"])) { goto OPCyX; } goto DZ3TH; DZ3TH: if (isset($responseArray["\145\x72\162\x6f\x72"]["\162\157\157\x74\137\143\x61\x75\163\x65"][0]["\164\171\x70\145"])) { goto he2tr; } return false; goto SZhF4; he2tr: if (!($responseArray["\145\x72\162\157\x72"]["\162\x6f\157\164\137\x63\x61\x75\x73\x65"][0]["\x74\171\x70\x65"] == "\151\156\x64\145\x78\137\156\x6f\164\137\x66\x6f\165\x6e\x64\137\145\x78\143\145\160\x74\151\157\156")) { goto qku61; } return true; qku61: SZhF4: goto qfvqC; OPCyX: goto pZH4E; pZH4E: if (!($responseArray["\141\143\153\x6e\x6f\x77\154\145\144\147\145\x64"] == true)) { goto WZjq5; } return true; WZjq5: qfvqC: goto RhEoR; RhEoR: } }