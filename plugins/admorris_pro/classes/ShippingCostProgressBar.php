<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro; use JTL\Catalog\Product\Preise; use JTL\Cart\Cart; use JTL\Checkout\Versandart; use JTL\Language\LanguageModel; use JTL\Helpers\Text; use JTL\Helpers\ShippingMethod; use JTL\Shop; use JTL\Session\Frontend; use JTL\Country\Country; class ShippingCostProgressBar { use SettingsTrait; public float|int $warenkorbWert; public $versandLand; public $fVersandkostenfreiAbX; public bool $active; public bool $cart; public bool $mini_cart; public bool $descriptors; public string $color_under; public string $color_over; function __construct(private $plugin) { $this->mapSettings = ["\x63\141\162\x74", "\x6d\x69\156\151\x5f\x63\x61\162\164", "\x64\145\163\143\162\x69\x70\164\157\162\163", "\143\157\154\157\162\137\x75\x6e\144\x65\x72", "\143\157\x6c\x6f\x72\x5f\157\166\145\x72"]; $this->settingPrefix = "\x6d\141\162\x6b\x65\164\151\156\147\x5f\x73\150\x69\160\160\x69\156\x67\x5f\x63\x6f\163\x74\137\160\x72\157\147\162\145\x73\x73\x5f\142\x61\162"; $smarty = Shop::Smarty(); $this->initSettings(); $this->versandLand = locale_get_display_region("\x73\154\x2d\114\x61\x74\156\55" . $_SESSION["\143\114\x69\145\x66\145\162\x6c\141\x6e\144\111\x53\x4f"] . "\x2d\156\x65\144\151\x73", Text::convertISO2ISO639($_SESSION["\x63\111\123\117\123\x70\162\141\143\150\x65"])); $this->warenkorbWert = Frontend::getCart()->gibGesamtsummeWarenExt([C_WARENKORBPOS_TYP_ARTIKEL], true, true, $this->versandLand); } public function init() { $smarty = Shop::Smarty(); $dataArray = $smarty->getTemplateVars("\141\144\x6d\x6f\x72\162\151\163\x5f\x70\x72\x6f\x5f\x6d\x61\x72\153\x65\x74\151\156\x67\137\x73\150\x69\160\160\x69\x6e\x67\x5f\x63\x6f\163\x74\x5f\160\x72\157\147\x72\x65\x73\x73\137\142\x61\x72\x5f\x61\x72\x72\141\171"); if (!empty($dataArray)) { goto cuJ6n; } return; cuJ6n: if (!($this->warenkorbWert > 0)) { goto D0W0F; } if (!(Shop::getPageType() === PAGE_WARENKORB && $this->cart)) { goto yvbxj; } $this->displayInCart(); yvbxj: D0W0F: } private function displayInCart() { $smarty = Shop::Smarty(); $this->loadStyles(true); $template = $this->plugin->getPaths()->getFrontendPath() . "\164\145\x6d\x70\x6c\141\164\145\163\x2f\155\x61\x72\x6b\145\164\x69\x6e\x67\x5f\x73\150\151\160\x70\151\x6e\x67\x5f\x63\157\163\x74\x5f\x70\x72\x6f\x67\x72\x65\x73\163\x5f\142\x61\162\x2f\x6d\141\162\153\145\x74\x69\156\147\137\x73\150\x69\160\x70\151\x6e\x67\x5f\x63\x6f\x73\x74\x5f\x70\162\157\x67\x72\145\163\163\x5f\x62\141\x72\137\x63\141\x72\164\x2e\x74\x70\154"; $template = $smarty->fetch($template); cssSelector("\x73\150\151\160\160\151\156\x67\x5f\143\157\163\164\137\x70\x72\157\x67\x72\145\x73\x73\137\142\x61\162\137\x63\141\x72\x74", $template); } public function getOutputArray() { goto br13x; L1Igw: goto Xdyfp; xIjlv: if ($this->fVersandkostenfreiAbX == round($this->fVersandkostenfreiAbX)) { goto gg0UV; } $fVersandkostenfreiAbXLocalized = Preise::getLocalizedPriceString($this->fVersandkostenfreiAbX); goto ptPyO; gg0UV: $fVersandkostenfreiAbXLocalized = Preise::getLocalizedPriceString($this->fVersandkostenfreiAbX, null, true, 0); ptPyO: $leftDescriptorLocalized = Preise::getLocalizedPriceString(0, null, true, 0); $am_shippingCostBarArr["\x6c\x65\x66\164\104\145\x73\x63\162\151\x70\x74\x6f\162"] = $leftDescriptorLocalized; goto jJ3Xo; br13x: $smarty = Shop::Smarty(); $versandArt = null; $templateFavShipping = $smarty->getTemplateVars("\x46\x61\166\157\165\162\x61\x62\154\x65\x53\150\x69\160\x70\151\156\x67"); $diffVersandkostenfrei = 0; if (isset($_SESSION["\126\145\162\x73\141\156\144\x61\162\164"]) && isset($_SESSION["\126\145\162\x73\x61\156\144\141\x72\164"]->fPreis)) { goto WR1kE; } if (!empty($templateFavShipping)) { goto W1awi; } if (!($this->warenkorbWert != 0)) { goto MBM3T; } $customerGroupID = ($id = Frontend::getCustomer()->kKundengruppe) > 0 ? $id : Frontend::getCustomerGroup()->getID(); $shoppingCart = new Cart(); $shippingFreeMin = ShippingMethod::getFreeShippingMinimum($customerGroupID, $_SESSION["\143\114\151\x65\146\x65\x72\154\x61\x6e\144\111\x53\117"]); goto FKIsP; jJ3Xo: $am_shippingCostBarArr["\x72\151\147\150\x74\104\145\x73\143\162\151\x70\164\x6f\162"] = $fVersandkostenfreiAbXLocalized; goto Xdyfp; nL5wY: $this->descriptors = false; Xdyfp: $am_shippingCostBarArr["\x73\x68\157\x77\x44\145\x73\x63\162\x69\160\x74\x6f\162\163"] = $this->descriptors; $am_shippingCostBarArr["\143\157\x6c\157\x72\125\156\x64\145\x72"] = $this->color_under; $am_shippingCostBarArr["\x63\157\154\x6f\x72\117\166\145\162"] = $this->color_over; return $am_shippingCostBarArr; goto od2kF; xJhzC: WR1kE: $versandArt = $_SESSION["\x56\x65\x72\163\x61\156\144\x61\162\x74"]; $this->fVersandkostenfreiAbX = $versandArt->fVersandkostenfreiAbX; $diffVersandkostenfrei = ShippingMethod::getShippingFreeDifference($_SESSION["\x56\x65\162\163\x61\x6e\x64\141\x72\x74"], $this->warenkorbWert); goto kADGL; W1awi: $versandArt = $templateFavShipping; $this->fVersandkostenfreiAbX = $templateFavShipping->fVersandkostenfreiAbX; $diffVersandkostenfrei = Shop::Container()->getShippingService()->getShippingFreeDifference($templateFavShipping, Frontend::getCart()->PositionenArr); kADGL: goto zCjPV; jKe2m: $am_shippingCostBarArr["\x62\x69\163\126\x65\162\x73\141\156\144\153\x6f\163\164\x65\156\x66\162\x65\151"] = 0; goto YhYfQ; NxVyM: $prozentVonVersandkostenfrei = $this->warenkorbWert / $this->fVersandkostenfreiAbX * 100; $am_shippingCostBarArr["\x70\x72\157\147\162\145\x73\x73\x42\141\x72\126\x61\x6c\x75\x65"] = $prozentVonVersandkostenfrei; $am_shippingCostBarArr["\x62\x69\x73\126\145\x72\x73\141\156\144\x6b\x6f\163\164\145\x6e\x66\162\145\151"] = $diffVersandkostenfrei; $am_shippingCostBarArr["\142\151\x73\x56\x65\162\x73\141\x6e\x64\x6b\x6f\x73\164\145\156\146\162\x65\151\x4c\x6f\143\x61\x6c\x69\172\145\144"] = $diffVersandkostenfreiLocalized; YhYfQ: if ($this->descriptors && $this->fVersandkostenfreiAbX != 0.0) { goto xIjlv; } if ($this->fVersandkostenfreiAbX == 0.0) { goto nL5wY; } goto L1Igw; FKIsP: if (is_object($shippingFreeMin) || $shippingFreeMin != 0) { goto ZiqT4; } $this->fVersandkostenfreiAbX = 0; goto q0Z29; ZiqT4: $versandArt = $shippingFreeMin; $this->fVersandkostenfreiAbX = $versandArt->fVersandkostenfreiAbX; $diffVersandkostenfrei = ShippingMethod::getShippingFreeDifference($versandArt, $this->warenkorbWert); q0Z29: MBM3T: goto kADGL; goto xJhzC; zCjPV: if (!($this->warenkorbWert == 0 || empty($versandArt) || $this->fVersandkostenfreiAbX == 0 && $versandArt->fPreis != 0 || $this->fVersandkostenfreiAbX == 0 && $versandArt->fPreis == 0 && $versandArt->kVersandberechnung != "\61")) { goto cxxHq; } return null; cxxHq: $am_shippingCostBarArr = []; $diffVersandkostenfreiLocalized = Preise::getLocalizedPriceString($diffVersandkostenfrei); $am_shippingCostBarArr["\166\145\162\x73\x61\156\144\x4c\x61\x6e\144"] = self::getShippingFreeCountriesString($versandArt); $am_shippingCostBarArr["\x6d\x69\x6e\151\103\141\x72\164"] = $this->mini_cart; $am_shippingCostBarArr["\103\x61\162\x74"] = $this->cart; if ($diffVersandkostenfrei > 0 && $versandArt->fPreis != 0 || $diffVersandkostenfrei > 0 && $versandArt->kVersandberechnung != "\61") { goto NxVyM; } $am_shippingCostBarArr["\160\162\x6f\x67\162\x65\x73\163\102\x61\162\x56\x61\x6c\165\x65"] = 100; goto jKe2m; od2kF: } private function loadStyles($critical = false) { $smarty = Shop::Smarty(); if (!$critical) { goto E3Y2u; } \pq("\150\x65\x61\x64")->append("\x3c\154\x69\156\153\x20\x74\x79\x70\x65\75\x22\164\x65\170\x74\57\143\163\163\42\x20\150\x72\145\146\75\x22{$this->plugin->getPaths()->getFrontendURL()}\x63\x73\x73\x2f\x73\x68\151\x70\160\151\x6e\x67\55\x63\x6f\163\x74\x2d\x70\x72\157\147\162\145\163\x73\x2d\x62\x61\162\x2e\x63\x73\x73\x3f\x76\x3d{$this->plugin->getMeta()->getVersion()}\x22\x20\162\x65\154\x3d\42\163\x74\171\154\x65\163\x68\145\x65\164\42\76"); goto aG7pP; E3Y2u: $assetLoader = AssetLoader::getInstance(); $assetLoader->addToHead($this->plugin->getPaths()->getFrontendURL() . "\x63\163\x73\x2f\163\x68\x69\x70\x70\151\156\147\55\143\x6f\163\164\x2d\160\x72\157\x67\162\x65\x73\163\x2d\x62\141\162\x2e\x63\x73\163", "\163\x68\x69\x70\160\x69\156\x67\137\143\157\x73\x74\x5f\x70\162\x6f\147\x72\x65\x73\x73\137\x62\141\162"); aG7pP: } public static function getShippingFreeCountriesString($shippingMethod) : string { if (\is_object($shippingMethod)) { goto ohVN1; } return ''; ohVN1: $cacheID = "\x62\166\x6b\146\x6c\163\x5f" . $shippingMethod->fVersandkostenfreiAbX . \mb_strlen($shippingMethod->cLaender) . "\137" . Shop::getLanguageID(); if (!(($shippingFreeCountries = Shop::Container()->getCache()->get($cacheID)) === false)) { goto ThfnG; } $shippingFreeCountries = \implode("\x2c\x20", \array_map(static function (Country $e) { return $e->getName(); }, Shop::Container()->getCountryService()->getFilteredCountryList(\array_filter(\explode("\x20", $shippingMethod->cLaender)))->toArray())); Shop::Container()->getCache()->set($cacheID, $shippingFreeCountries, [\CACHING_GROUP_OPTION]); ThfnG: return $shippingFreeCountries; } }