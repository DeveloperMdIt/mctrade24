<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro\ioHandling\rewardPoints; use Exception; use JTL\Cache\JTLCacheInterface; use JTL\Customer\Customer; use JTL\DB\ReturnType; use JTL\Events\Dispatcher; use JTL\Helpers\Request; use JTL\IO\IOError; use JTL\Plugin\Helper; use JTL\Plugin\PluginInterface; use JTL\Services\JTL\CryptoServiceInterface; use JTL\Shop; use AdmPro\Nette\Schema\ValidationException; use Plugin\admorris_pro\ioHandling\AbstractIOClass; use Plugin\admorris_pro\ioHandling\IoRequestTrait; use AdmPro\Nette\Schema\Processor; use AdmPro\Nette\Schema\Expect; use AdmPro\Nette\Utils\Validators; use Plugin\admorris_pro\StatusRequest; class RewardPointsIO { use IoRequestTrait; protected static $tableName = "\x78\x70\x6c\165\x67\x69\x6e\137\x61\144\155\x6f\162\162\151\x73\x5f\160\162\x6f\x5f\162\145\167\141\162\x64\x5f\160\x6f\x69\x6e\x74\x73\x5f\164\x72\x61\156\x73\x61\x63\x74\151\157\x6e"; protected readonly RewardPointsTransaction $transaction; private PluginInterface $plugin; private CryptoServiceInterface $cryptoService; private JTLCacheInterface $cache; public function __construct() { $this->plugin = Helper::getPluginById("\x61\144\x6d\x6f\x72\162\151\x73\x5f\160\162\157"); $this->cryptoService = Shop::Container()->getCryptoService(); $this->cache = Shop::Container()->getCache(); $this->transaction = new RewardPointsTransaction($this->plugin, $this->cache); } public function getCustomerRewardPoints(array $data) : array|IOError { if (isset($data["\143\x75\x73\164\x6f\155\x65\x72\x44\141\x74\141"])) { goto C32at; } return new IOError("\113\145\151\x6e\x65\40\x65\x6d\141\x69\154\40\x61\x6e\x67\145\x67\x65\x62\x65\x6e", 400); C32at: if (Validators::isEmail($data["\x63\x75\x73\164\x6f\x6d\x65\162\x44\x61\x74\x61"])) { goto iWP0w; } $customerData = $data["\x63\165\x73\x74\x6f\x6d\x65\x72\x44\141\164\x61"]; $data = Shop::Container()->getDB()->getObjects("\123\x45\x4c\105\103\x54\40\153\113\165\x6e\x64\145\x20\106\x52\x4f\x4d\x20\164\153\165\156\x64\145\40\127\x48\105\x52\x45\40\x28\x20\x60\143\x4b\x75\x6e\x64\145\x6e\116\x72\140\x20\x4c\x49\x4b\x45\40\x3a\143\x75\163\x74\157\x6d\145\x72\104\x61\x74\141\x20\117\x52\40\x60\143\x4d\141\151\x6c\140\x20\114\111\x4b\105\x20\72\x63\x75\163\164\x6f\155\x65\x72\104\x61\164\x61\x20\51\x20\x41\116\x44\x20\140\x6e\122\x65\x67\151\163\x74\x72\151\x65\x72\x74\140\x20\x3d\x20\61\x3b", ["\143\x75\163\164\157\155\x65\162\104\x61\164\141" => "\45" . $customerData . "\x25"]); $customers = array_map(function ($item) { $id = (int) $item->kKunde; return new Customer($id); }, $data); goto aLs6m; iWP0w: $customerData = $data["\x63\165\x73\x74\157\x6d\145\162\x44\x61\164\141"]; $data = Shop::Container()->getDB()->getSingleObject("\123\x45\114\105\x43\124\x20\x6b\113\165\156\144\145\40\x46\x52\117\x4d\40\164\153\x75\x6e\x64\x65\40\x57\110\105\122\105\40\x60\143\x4d\x61\151\154\x60\x20\x3d\x20\72\x63\x75\163\164\157\155\x65\x72\x44\141\x74\141\40\x41\116\x44\40\x60\156\122\145\147\x69\163\x74\162\151\x65\x72\x74\x60\40\x3d\x20\61\73", ["\x63\165\163\x74\157\155\x65\162\104\141\164\141" => $customerData]); $customer = new Customer($data->kKunde); $customers = [$customer]; aLs6m: if (!empty($customers)) { goto Vl9FX; } return new IOError("\x45\x73\40\x6b\x6f\156\x6e\x74\x65\40\153\x65\151\x6e\x20\113\x75\x6e\x64\145\40\x67\x65\x66\x75\156\x64\x65\156\x20\167\145\162\144\145\156", 404); Vl9FX: return array_map(fn($customer) => $this->transaction->getPoints($customer, false), $customers); } public function createManual(array $data) { $schema = Expect::structure(["\x63\165\x73\x74\157\x6d\145\162\x5f\151\x64" => Expect::int()->required(), "\x74\x72\141\156\x73\141\143\x74\x69\157\156" => Expect::type("\156\x75\x6d\145\x72\151\143")->required()->castTo("\146\154\x6f\x61\x74")]); $processor = new Processor(); try { $normalized = $processor->process($schema, $data); } catch (ValidationException $e) { return new IOError($e->getMessage(), 500, [(string) $e]); } return $this->transaction->create($normalized->customer_id, $normalized->transaction, false, "\x6d\141\x6e\x75\141\154"); } public function createRewardPointsCSVFile() { $db = Shop::Container()->getDB(); $allCustomerRewardPoints = $db->queryPrepared("\123\105\x4c\105\103\124\xd\12\x20\x20\x20\x20\x20\40\40\40\x78\160\154\165\147\x69\156\x5f\141\144\155\157\162\162\x69\x73\x5f\160\162\x6f\x5f\x72\x65\167\141\162\144\x5f\160\x6f\151\156\164\x73\x5f\x74\x72\141\x6e\x73\x61\x63\x74\151\157\156\x2e\x63\x75\163\164\157\155\x65\x72\x5f\151\x64\54\15\12\x20\x20\x20\x20\40\40\x20\40\170\x70\x6c\x75\147\x69\x6e\137\x61\x64\155\157\x72\x72\151\x73\137\x70\162\x6f\x5f\162\145\167\x61\x72\144\x5f\x70\157\151\x6e\x74\163\x5f\x74\162\x61\156\163\141\143\x74\x69\x6f\x6e\56\144\141\x74\x65\54\15\12\x20\x20\40\x20\40\40\40\x20\170\160\154\x75\147\151\156\137\x61\144\x6d\x6f\162\162\x69\x73\137\160\x72\x6f\137\162\145\167\x61\x72\x64\x5f\x70\157\x69\156\x74\x73\137\164\162\x61\156\x73\x61\x63\164\x69\x6f\x6e\56\x74\x72\141\x6e\x73\141\143\164\x69\x6f\156\x2c\xd\12\40\x20\x20\x20\40\x20\x20\40\170\160\154\165\x67\x69\x6e\137\x61\144\x6d\157\162\162\151\x73\x5f\x70\x72\157\137\162\145\x77\141\x72\x64\x5f\x70\157\151\156\x74\163\x5f\164\162\x61\156\x73\141\x63\164\x69\157\156\56\x72\145\144\x65\x65\155\145\x64\x2c\15\xa\40\x20\40\40\x20\40\x20\x20\x78\x70\154\165\147\151\156\137\141\144\155\x6f\162\162\151\163\x5f\x70\162\x6f\x5f\162\145\x77\141\x72\x64\137\x70\157\151\156\x74\x73\137\x74\x72\x61\x6e\163\x61\143\x74\151\x6f\x6e\x2e\143\157\x6d\155\x65\x6e\164\x2c\15\12\x20\40\x20\x20\40\40\x20\x20\x74\x6b\165\x6e\144\x65\x2e\143\x56\x6f\x72\x6e\141\x6d\145\54\xd\xa\x20\x20\x20\40\x20\x20\x20\40\164\x6b\x75\x6e\x64\145\56\143\116\141\x63\x68\156\141\x6d\x65\54\xd\12\40\x20\x20\40\40\x20\40\x20\x74\153\165\156\144\x65\x2e\x63\115\141\x69\154\xd\xa\40\x20\x20\x20\40\40\x20\40\106\122\117\x4d\40\x78\160\154\x75\x67\151\156\x5f\x61\x64\155\157\162\162\x69\163\137\160\162\x6f\137\x72\x65\167\x61\162\144\x5f\160\x6f\x69\156\x74\163\137\164\162\141\156\x73\x61\143\164\151\x6f\156\15\xa\x20\40\x20\40\x20\40\40\x20\114\x45\106\124\40\112\117\x49\116\x20\x74\153\x75\x6e\x64\x65\15\12\40\x20\x20\40\x20\x20\x20\40\117\116\40\170\x70\154\165\147\x69\x6e\x5f\141\x64\155\x6f\162\162\151\163\137\x70\162\157\137\162\x65\x77\141\x72\144\137\x70\x6f\151\x6e\x74\x73\x5f\164\x72\x61\156\163\x61\143\x74\x69\157\156\x2e\x63\x75\163\164\x6f\x6d\x65\x72\x5f\x69\x64\x20\75\x20\164\153\x75\156\144\x65\56\153\113\165\156\144\145\xd\12\40\40\x20\40\x20\40", [], ReturnType::ARRAY_OF_OBJECTS); $allCustomerRewardPoints = array_map(function ($item) { $item->cNachname = $this->cryptoService->decryptXTEA($item->cNachname); return array_values((array) $item); }, $allCustomerRewardPoints); array_unshift($allCustomerRewardPoints, ["\143\x75\163\x74\157\155\x65\x72\111\x44", "\x64\141\164\145", "\164\x72\141\156\x73\x61\143\x74\151\x6f\156", "\x72\x65\144\x65\145\155\x65\x64", "\143\x6f\x6d\x6d\x65\x6e\164", "\146\x69\162\163\164\40\156\x61\x6d\x65", "\x6c\x61\x73\x74\x20\x6e\141\x6d\x65", "\145\x6d\x61\151\x6c"]); $path = $this->plugin->getPaths()->getBasePath() . "\162\x65\167\141\x72\144\x70\157\x69\x6e\164\163\x2e\x63\163\166"; $fp = fopen($path, "\x77"); foreach ($allCustomerRewardPoints as $fields) { fputcsv($fp, $fields); pjNnC: } fmbKp: } public function deleteRewardPointsCSVFile() { $plugin = $this->plugin; if (!$plugin) { goto gBbj7; } $pluginPath = $plugin->getPaths()->getBasePath(); unlink($pluginPath . "\x72\145\x77\x61\162\144\x70\157\151\156\164\x73\x2e\143\163\x76"); gBbj7: } }