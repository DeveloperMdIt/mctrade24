<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro\ioHandling\rewardPoints; use DateTime; use JTL\Cache\JTLCacheInterface; use JTL\Plugin\PluginInterface; use JTL\Shop; use Exception; use AdmPro\Carbon\Carbon; use JTL\Session\Frontend; use JTL\Customer\Customer; use Plugin\admorris_pro\LoggerTrait; use Plugin\admorris_pro\Models\RewardPointsTransactionModel; use Plugin\admorris_pro\Models\RewardPointsSettings; class RewardPointsTransaction { protected static $tableName = "\x78\x70\154\165\147\x69\x6e\x5f\141\x64\x6d\157\162\x72\x69\x73\137\x70\x72\157\x5f\162\x65\167\141\162\144\137\160\157\151\x6e\x74\x73\x5f\x74\x72\x61\156\163\x61\x63\164\x69\x6f\156"; protected RewardPointsSettings $settings; const CACHE_ID_PREFIX = "\x61\144\x6d\137\162\160\164\x5f"; const CACHE_TAG = "\x61\144\x6d\137\x72\160\x74"; use LoggerTrait; private ?CustomerRewardPoints $customerRewardPoints = null; public function __construct(private readonly PluginInterface $plugin, private readonly JTLCacheInterface $cache) { if (!(($settings = $cache->get(RewardPointsSettings::CACHE_ID)) === false)) { goto VcRax; } $settings = RewardPointsSettings::all()->first(); $cache->set(RewardPointsSettings::CACHE_ID, $settings, [\CACHING_GROUP_PLUGIN, $plugin->getCache()->getGroup()]); VcRax: if (!empty($settings)) { goto l37J_; } return; l37J_: $this->settings = $settings; } public static function __callStatic(string $method, array $parameters) { $cache = Shop::Container()->getCache(); $plugin = Shop::get("\x6f\160\x6c\x75\147\151\x6e\137\x61\144\x6d\x6f\162\162\x69\x73\x5f\x70\x72\157"); return self::createInstance()->{$method}(...$parameters); } public static function createInstance() { $cache = Shop::Container()->getCache(); $plugin = Shop::get("\157\x70\154\x75\147\x69\x6e\137\141\144\x6d\157\x72\x72\151\x73\x5f\x70\162\157"); return new self($plugin, $cache); } public function create(int $customerId, float $points, bool $redeemed, string $comment = "\143\x68\145\x63\153\157\165\164") : bool { $transaction = new RewardPointsTransactionModel(); $transaction->customer_id = $customerId; $transaction->date = new DateTime(); $transaction->transaction = $points; $transaction->redeemed = $redeemed; $transaction->comment = $comment; $saved = $transaction->save(); $this->flushCache($customerId); return $saved; } private function validate(object $data) { if (!($data->comment === "\155\x61\x6e\x75\141\x6c")) { goto kuPq3; } return; kuPq3: $maxLimit = $this->settings->maximum; $valid = $this->getPoints()->valid_points; if (!($maxLimit == 0)) { goto sgPXQ; } $maxLimit = $valid; sgPXQ: if (!(floatval($data->redeemed) > floatval($maxLimit))) { goto n_ElC; } $this->log->warning("\x53\x75\142\155\151\164\164\x65\x64\40\x72\145\167\141\162\144\40\160\157\151\156\164\x73\x20\145\170\143\x65\145\x64\163\40\155\x61\170\151\x6d\x75\155\x20\154\x69\x6d\x69\x74"); n_ElC: $minLimit = $this->settings->minimum; if (!(floatval($data->redeemed) < floatval($minLimit))) { goto kyiDB; } $this->log->warning("\x53\x75\x62\x6d\151\x74\164\x65\144\x20\x72\145\x77\x61\162\144\x20\160\157\151\156\x74\163\40\141\162\145\40\142\145\x6c\x6f\167\x20\x6d\x69\156\151\x6d\165\155\40\154\x69\155\151\x74"); kyiDB: } public static function getCustomerRewardPoints(array|int|Customer|null $data = null) : CustomerRewardPoints { $customer = self::getCustomer($data); return self::createInstance()->getPoints($customer); } private function getValidityDate($hard = false) : string { $dateValidityHard = new Carbon($this->settings->credit_validity_hard); if (!$hard) { goto cM1UZ; } return $dateValidityHard->format("\x59\55\155\x2d\x64\x20\x48\72\151\x3a\163"); cM1UZ: $creditValidityRolling = $this->settings->credit_validity_rolling; $dateValidityRolling = (new DateTime())->modify("\x2d{$creditValidityRolling}\40\144\141\x79"); if (!($creditValidityRolling === 0 || $dateValidityHard > $dateValidityRolling)) { goto yI5jd; } return $dateValidityHard->format("\x59\55\155\55\x64\40\x48\72\151\72\x73"); yI5jd: return $dateValidityRolling->format("\131\x2d\155\x2d\144\x20\x48\72\x69\x3a\x73"); } private static function getCustomer($data) : ?Customer { if (!is_null($data)) { goto QCNWb; } return Frontend::getCustomer(); QCNWb: if ($data instanceof Customer) { goto rFK1l; } if (is_int($data)) { goto C00og; } $email = is_object($data) ? $data->cMail : $data["\x63\x4d\141\151\154"]; $customer = (new Customer())->holRegKundeViaEmail($email); goto xP2pD; rFK1l: $customer = $data; goto xP2pD; C00og: $customer = new Customer($data); xP2pD: if (!empty($customer)) { goto j68TT; } return null; j68TT: $cryptoService = Shop::Container()->getCryptoService(); $customer->cNachname = \trim($cryptoService->decryptXTEA($customer->cNachname)); return $customer; } public function getPoints(?Customer $customer = null, bool $cached = true) : CustomerRewardPoints { goto PcoKj; NpKOq: $roundedDelayedPoints = $this->roundRewardPoints($points["\160\x65\156\144\151\x6e\x67"]); $this->customerRewardPoints = new CustomerRewardPoints($roundedValidPoints, $roundedDelayedPoints, $customer); $this->saveToCache($customer, $this->customerRewardPoints); return $this->customerRewardPoints; goto L4lNg; PcoKj: if (!is_null($customer)) { goto RSxQy; } $customer = Frontend::getCustomer(); RSxQy: if (!($customer->getID() === 0)) { goto LNhBx; } return new CustomerRewardPoints(); LNhBx: if (!($cached && (!is_null($this->customerRewardPoints) || !empty($this->loadFromCache($customer))))) { goto CHfqi; } return $this->customerRewardPoints; CHfqi: $validity = $this->getValidityDate(); goto J_e3M; CGrmc: $delaySetting = $this->settings->credit_delay; $delayDate = (new DateTime())->modify("\55{$delaySetting}\x20\x64\x61\x79")->format("\x59\x2d\x6d\x2d\144\40\x48\x3a\x69\72\163"); $pointsQuery = []; $pointsQuery["\x65\x61\162\x6e\x65\144"] = (clone $earnedPointsQuery)->where("\144\x61\164\x65", "\x3c\x3d", $delayDate); $pointsQuery["\160\x65\x6e\x64\x69\156\147"] = (clone $earnedPointsQuery)->where("\x64\141\164\x65", "\x3e", $delayDate); $pointsQuery["\x6d\x61\x6e\165\x61\154"] = (clone $validityFilteredQuery)->where("\x63\157\x6d\155\x65\x6e\164", "\x6d\141\x6e\165\141\154"); $pointsQuery["\162\145\x64\145\x65\x6d\145\x64"] = (clone $baseQuery)->where("\162\145\144\x65\x65\155\x65\144", true); $points = array_map(function ($query) { return $query->sum("\164\162\141\156\163\x61\143\164\x69\x6f\x6e"); }, $pointsQuery); $totalCustomerPoints = $points["\x65\141\162\x6e\145\x64"] + $points["\x6d\x61\156\165\x61\154"] + $points["\x72\x65\x64\x65\145\155\145\144"]; $roundedValidPoints = $this->roundRewardPoints($totalCustomerPoints); goto NpKOq; J_e3M: $baseQuery = RewardPointsTransactionModel::query()->where("\x63\165\163\164\157\155\145\x72\x5f\151\x64", $customer->kKunde); $pointsInvalidated = (clone $baseQuery)->where("\x64\x61\x74\x65", "\x3e", $validity)->where("\162\145\144\145\145\155\x65\144", false)->orderBy("\x64\x61\164\x65", "\x64\145\x73\x63")->get()->isEmpty(); if (!$pointsInvalidated) { goto ngizj; } $this->customerRewardPoints = new CustomerRewardPoints(0, 0, $customer); $this->saveToCache($customer, $this->customerRewardPoints); return $this->customerRewardPoints; ngizj: $validityHard = self::getValidityDate(true); $validityFilteredQuery = (clone $baseQuery)->where("\144\x61\164\x65", "\x3e", $validityHard); $earnedPointsQuery = (clone $validityFilteredQuery)->where("\162\x65\144\145\x65\x6d\x65\144", false)->where("\143\x6f\155\x6d\145\156\x74", "\x21\x3d", "\155\x61\x6e\x75\141\154"); goto CGrmc; L4lNg: } private function saveToCache(Customer $customer, CustomerRewardPoints $points) { $this->cache->set($this::CACHE_ID_PREFIX . $customer->getID(), $points, $this->getCacheTags(), 60 * 60); } private function loadFromCache(Customer $customer) { $points = $this->cache->get($this::CACHE_ID_PREFIX . $customer->getID()); if (!($points === false)) { goto nlmbR; } return false; nlmbR: return $this->customerRewardPoints = $points; } public function flushCache(?int $customerId = null) { if (!is_null($customerId)) { goto o8urP; } $this->cache->flushTags($this::CACHE_TAG); return; o8urP: $this->cache->flush($this::CACHE_ID_PREFIX . $customerId); } private function getCacheTags() : array { return [$this::CACHE_TAG, $this->plugin->getCache()->getGroup(), \CACHING_GROUP_PLUGIN]; } public function roundRewardPoints($earnedRewardPoints) { $roundingOperation = $this->settings->round; return match ($roundingOperation) { 1 => round($earnedRewardPoints), 2 => ceil($earnedRewardPoints), 3 => floor($earnedRewardPoints), default => $earnedRewardPoints, }; } }