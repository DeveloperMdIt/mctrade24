<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro\ioHandling; use JTL\Shop; use Exception; use JTL\IO\IOError; use JTL\Template\Model; use League\Flysystem\Filesystem; use League\Flysystem\Local\LocalFilesystemAdapter; use League\Flysystem\FilesystemException; use Plugin\admorris_pro\ConsentManagerIntegration; use Plugin\admorris_pro\ioHandling\cookieNoticePro\CookieNoticePro; use Plugin\admorris_pro\lib\AdmorrisLib; use Plugin\admorris_pro\Logger; use Plugin\admorris_pro\TemplateUpdater; class Backup { use IoRequestTrait; private $plugin; private $db; private $log; private $dbTableBackup; private $filesystem; const TEMPLATE_PATH = \PFAD_ROOT . "\164\145\x6d\x70\x6c\141\x74\x65\x73\x2f\x61\x64\x6d\157\x72\x72\151\x73\x5f\x70\x72\157\x2f"; const BACKUP_PATH = \PFAD_ROOT . "\x61\144\155\x6f\x72\162\x69\x73\x5f\x70\162\157\x5f\142\x61\x63\x6b\x75\x70\163\x2f\160\x6c\x75\147\151\156\137\x62\141\143\x6b\x75\x70\163\x2f"; public function __construct($plugin) { $this->plugin = $plugin; $this->db = Shop::Container()->getDB(); $this->log = $plugin->getLogger(); $this->dbTableBackup = new DbTableBackup($plugin); $this->initFilesystem(); } private function initFilesystem() { $adapter = new LocalFilesystemAdapter(\PFAD_ROOT); $this->filesystem = new Filesystem($adapter); } public function list() { $dircontents = scandir(self::BACKUP_PATH); $list = []; foreach ($dircontents as $key => $file) { $extension = pathinfo($file, PATHINFO_EXTENSION); if (!($extension == "\x7a\x69\160")) { goto HNm4W; } $filename = pathinfo($file, PATHINFO_FILENAME); $filenameParts = explode("\50", $filename); $version = substr_replace(array_pop($filenameParts), '', -1); $filenameParts = array(implode("\x5f", $filenameParts), $version); $creationDate = date("\x64\56\x6d\x2e\x59\40\110\x3a\x69", filectime(self::BACKUP_PATH . $file)); $shopUrl = Shop::getURL(); $list[] = array("\x66\x69\154\145\x4e\141\155\145" => $filenameParts[0], "\165\162\154" => "{$shopUrl}\57\x61\x64\155\157\162\162\x69\163\x5f\x70\162\x6f\137\142\x61\x63\153\165\x70\x73\57\160\x6c\x75\x67\151\156\137\x62\x61\x63\x6b\x75\x70\163\x2f{$filename}\56\x7a\x69\x70", "\166\145\x72\x73\x69\x6f\x6e" => $filenameParts[1], "\143\162\x65\x61\x74\x69\x6f\x6e\x44\x61\x74\x65" => $creationDate); HNm4W: xa1CN: } PAAmn: usort($list, array($this, "\163\x6f\162\164\114\x69\163\164")); return $list; } public function delete($data) { $status = true; $fileName = \PFAD_ROOT . "\x61\x64\x6d\157\162\162\151\163\x5f\x70\x72\157\137\142\x61\143\x6b\165\160\163\x2f\x70\x6c\165\x67\x69\156\137\142\141\143\153\165\160\163\x2f" . $data["\146\151\x6c\145\x4e\141\x6d\x65"] . "\x28" . $data["\x76\x65\x72\x73\x69\157\156"] . "\x29\x2e\x7a\x69\x70"; unlink($fileName) or die($status = false); return $status; } public function export($data, $type = "\163\164\141\x6e\144\x61\x72\144") { $data["\x66\x69\x6c\145\116\x61\155\x65"] = preg_replace("\x2f\133\136\x5c\x77\134\55\x5f\56\x5d\57", '', str_replace("\x20", "\55", $data["\x66\151\x6c\x65\x4e\x61\x6d\145"])); if ($type === "\x66\165\x6c\x6c") { goto uS_sQ; } $backupId = $data["\146\151\x6c\x65\x4e\x61\155\x65"] . "\x28\x76" . $this->plugin->getMeta()->getVersion() . "\51"; goto kGg6G; uS_sQ: $backupId = $data["\x66\151\154\145\116\x61\x6d\145"] . "\55\x53\x79\x73\x74\145\155\x42\x61\143\153\165\x70\x28\x76" . $this->plugin->getMeta()->getVersion() . "\x29"; kGg6G: try { $this->dbTableBackup->export($backupId, $type); $this->exportFiles($backupId); $this->zipExport($backupId); $this->deleteFolder($backupId); return true; } catch (\Exception $e) { return new IOError($e); return false; } } public function import($data) { $backupId = $data["\146\x69\x6c\145\116\141\x6d\145"] . "\50" . $data["\x76\x65\x72\163\151\x6f\x6e"] . "\51"; try { $this->zipImport($backupId); $this->importFiles($backupId); $this->dbTableBackup->import($backupId); $this->deleteFolder($backupId); $ordnerName = Model::loadByAttributes(["\164\x79\160\x65" => "\x73\x74\x61\156\x64\141\162\144"], $this->db); if (!($ordnerName->cTemplate === "\141\144\x6d\157\x72\162\x69\163\x5f\160\x72\157\x5f\x63\x68\x69\154\x64" || $ordnerName->cTemplate === "\141\x64\155\x6f\x72\x72\151\163\x5f\160\162\x6f")) { goto kjlz3; } $templateUpdater = new TemplateUpdater($ordnerName->cTemplate, Shop::Container()->getDB(), Shop::Container()->getCache()); $status = $templateUpdater->saveConfig(); if ($status) { goto dIR1T; } throw new Exception("\103\x6f\165\154\144\x20\x6e\x6f\164\x20\165\160\x64\x61\x74\x65\x20\164\x65\x6d\x70\154\141\164\x65"); dIR1T: kjlz3: return true; } catch (Exception $e) { $this->log->error("\x61\144\155\157\x72\x72\151\163\x20\120\162\x6f\x20\x2d\40\x49\155\160\157\162\x74\57\105\x78\x70\x6f\x72\164\72" . $e->getMessage()); return false; } } private function getFileList() { return ["\146\151\154\145\163" => ["\x74\150\x65\155\145\163\57\141\x64\155\x6f\162\x72\151\x73\x2f\164\150\x65\x6d\145\56\x63\x73\163" => "\164\x68\145\x6d\145\56\143\x73\163", "\160\x68\x70\57\150\x65\141\144\145\x72\114\x61\x79\157\165\x74\104\x61\x74\141\56\152\x73\x6f\156" => "\x68\x65\x61\x64\145\162\x4c\x61\171\x6f\x75\x74\104\x61\164\x61\56\x6a\163\157\156", "\x74\x68\x65\x6d\145\163\x2f\141\x64\155\x6f\162\x72\151\x73\x2f\154\145\x73\x73\x2f\x75\163\x65\162\x2d\163\x74\171\154\145\163\57\x75\163\x65\162\55\x73\x74\171\154\x65\x73\x2e\x6c\x65\163\163" => "\x75\x73\145\162\x2d\x73\x74\171\x6c\x65\x73\x2e\x6c\145\163\x73", "\x66\x61\166\151\143\x6f\156\x2e\x69\143\x6f" => "\146\x61\166\151\x63\x6f\x6e\x2e\151\x63\157", "\151\143\157\x6e\163\56\x73\x76\147" => "\151\x63\157\156\163\x2e\163\166\147", "\160\141\171\x6d\145\156\164\55\151\x63\157\156\163\56\163\166\147" => "\x70\141\x79\155\145\156\x74\x2d\x69\x63\x6f\156\x73\x2e\163\166\x67"], "\144\151\162\145\143\x74\x6f\x72\151\145\163" => ["\163\164\x79\x6c\x65\163\57\x73\141\163\163\x2f\165\x73\x65\162\55\163\x74\x79\x6c\145\163\57" => "\165\163\145\162\55\163\x74\171\154\145\163\55\163\141\163\163"]]; } private function copyDirectory($source, $dest) { try { $sourcePrefix = rtrim($source, "\x2f") . "\x2f"; $sourceLength = strlen($sourcePrefix); $contents = $this->filesystem->listContents($sourcePrefix, true); foreach ($contents as $item) { $path = $item->path(); $relativePath = substr($path, $sourceLength); $targetPath = $dest . "\x2f" . $relativePath; if ($item->isDir()) { goto WK24G; } $this->filesystem->copy($path, $targetPath); goto m81Hp; WK24G: $this->filesystem->createDirectory($targetPath); m81Hp: tzu3z: } efdZ1: return true; } catch (FilesystemException $e) { throw new Exception("\x44\x69\162\145\143\164\157\162\171\40\143\157\x70\171\x20\x66\141\151\x6c\145\x64\x3a\40" . $e->getMessage()); } } public function exportFiles($backupId) { $templatePath = str_replace(\PFAD_ROOT, '', self::TEMPLATE_PATH); $backupPath = str_replace(\PFAD_ROOT, '', self::BACKUP_PATH) . $backupId . "\x2f"; $this->log->debug("\141\144\155\x6f\x72\x72\x69\x73\40\x50\x72\x6f\x20\x2d\x20\105\x78\x70\x6f\x72\164\151\x6e\147\40\146\x69\154\145\x73\40\164\x6f\x20" . $backupPath); try { foreach ($this->getFileList()["\146\151\x6c\x65\163"] as $sourcePath => $targetFile) { $fullSourcePath = $templatePath . $sourcePath; if (!$this->filesystem->fileExists($fullSourcePath)) { goto tvSTS; } $this->filesystem->copy($fullSourcePath, $backupPath . $targetFile); tvSTS: suZgq: } svxgk: foreach ($this->getFileList()["\144\x69\162\145\143\x74\157\x72\151\145\163"] as $sourcePath => $targetDir) { $fullSourcePath = $templatePath . $sourcePath; if (!$this->filesystem->directoryExists($fullSourcePath)) { goto H9OCn; } $this->copyDirectory($fullSourcePath, $backupPath . $targetDir); H9OCn: O2t9f: } pKNMg: return true; } catch (Exception $e) { throw new Exception("\x43\157\x75\154\144\x20\x6e\157\164\x20\145\170\160\157\162\164\40\146\x69\x6c\145\x73\40\x62\145\143\x61\165\x73\x65\x20\x6f\146\x20\164\x68\145\x20\146\x6f\x6c\x6c\x6f\x77\x69\x6e\x67\40\105\162\x72\157\x72\x3a\x20" . $e->getMessage()); } } public function importFiles($backupId) { $templatePath = str_replace(\PFAD_ROOT, '', self::TEMPLATE_PATH); $backupPath = str_replace(\PFAD_ROOT, '', self::BACKUP_PATH) . $backupId . "\x2f"; try { foreach ($this->getFileList()["\x66\151\x6c\145\x73"] as $targetPath => $sourceFile) { $fullTargetPath = $templatePath . $targetPath; $backupFilePath = $backupPath . $sourceFile; if (!$this->filesystem->fileExists($backupFilePath)) { goto BWSPL; } $this->filesystem->copy($backupFilePath, $fullTargetPath); BWSPL: RNBnd: } pi21x: foreach ($this->getFileList()["\144\151\162\145\143\164\x6f\162\x69\145\163"] as $targetPath => $sourceDir) { $fullTargetPath = $templatePath . $targetPath; $backupDirPath = $backupPath . $sourceDir; if (!$this->filesystem->directoryExists($backupDirPath)) { goto q17FG; } if (!$this->filesystem->directoryExists($fullTargetPath)) { goto xlefm; } $this->filesystem->deleteDirectory($fullTargetPath); xlefm: $this->copyDirectory($backupDirPath, $fullTargetPath); q17FG: fo3lK: } I0lxr: return true; } catch (Exception $e) { throw new Exception("\103\157\165\154\144\40\x6e\x6f\164\40\x69\x6d\x70\157\162\164\40\x62\141\143\153\165\x70\40\x66\x69\x6c\145\163\x20\142\x65\143\x61\x75\x73\x65\x20\157\x66\40\x74\150\x65\x20\x66\x6f\x6c\x6c\157\x77\x69\x6e\x67\40\x45\x72\x72\x6f\x72\72\x20" . $e->getMessage()); } } private function removeDirectory($dir) { try { if (!$this->filesystem->directoryExists($dir)) { goto qUiil; } return $this->filesystem->deleteDirectory($dir); qUiil: return true; } catch (FilesystemException $e) { throw new Exception("\x46\141\x69\154\145\x64\40\x74\157\x20\162\145\x6d\x6f\x76\x65\40\x64\x69\162\145\143\164\157\x72\x79\72\40" . $e->getMessage()); } } public function sortList($a, $b) { $date1 = date_create($a["\x63\x72\x65\x61\164\151\x6f\156\x44\141\x74\x65"]); $date2 = date_create($b["\143\162\x65\141\x74\x69\157\156\104\141\164\x65"]); if (!($date1 == $date2)) { goto lqpGV; } return 0; lqpGV: return $date1 < $date2 ? -1 : 1; } public function arrayToObject($d) { if (is_array($d)) { goto PK0rh; } return $d; goto rNjhT; PK0rh: return (object) array_map(__METHOD__, $d); rNjhT: } public function copyFile($oldname, $newname) { try { $oldRelative = str_replace(\PFAD_ROOT, '', $oldname); $newRelative = str_replace(\PFAD_ROOT, '', $newname); $this->filesystem->copy($oldRelative, $newRelative); return true; } catch (FilesystemException $e) { throw new Exception("\x43\157\x75\x6c\x64\156\47\164\x20\x63\x6f\x70\x79\x20\146\x69\154\x65\x20{$oldname}\40\x74\x6f\x20{$newname}\72\x20" . $e->getMessage()); } } public function deleteFolder($dir) { try { $relativePath = str_replace(\PFAD_ROOT, '', self::BACKUP_PATH . $dir); if (!$this->filesystem->directoryExists($relativePath)) { goto DENp3; } return $this->filesystem->deleteDirectory($relativePath); DENp3: return true; } catch (FilesystemException $e) { throw new Exception("\x43\x6f\x75\154\x64\40\x6e\157\x74\x20\x64\x65\x6c\x65\x74\x65\40\142\141\143\153\165\x70\40\x66\x6f\154\144\x65\162\163\x3a\x20" . $e->getMessage()); } } public function zipExport($backupId) { try { $zipPath = self::BACKUP_PATH . $backupId . "\56\x7a\151\160"; $backupDir = self::BACKUP_PATH . $backupId; $zip = new \ZipArchive(); $result = $zip->open($zipPath, \ZipArchive::CREATE | \ZipArchive::OVERWRITE); if (!($result !== true)) { goto X0WFD; } throw new Exception("\x43\157\x75\154\144\x20\x6e\157\x74\40\x63\x72\x65\141\x74\145\x20\132\111\120\40\141\x72\x63\x68\x69\x76\x65\x2e\x20\105\x72\x72\x6f\x72\x20\143\157\x64\145\72\40{$result}"); X0WFD: $addFilesToZip = function ($dir, $zip) use(&$addFilesToZip, $backupDir) { $files = new \RecursiveIteratorIterator(new \RecursiveDirectoryIterator($dir, \RecursiveDirectoryIterator::SKIP_DOTS), \RecursiveIteratorIterator::LEAVES_ONLY); foreach ($files as $file) { goto YEA9N; Vnw6p: hnNM0: if (str_starts_with($normalizedFilePath, $normalizedPfadRoot)) { goto kXIZc; } throw new Exception("\106\151\154\145\x20\x70\141\x74\150\40\x64\x6f\x65\163\x20\156\157\164\x20\163\x74\x61\162\x74\x20\167\151\x74\x68\x20\x50\x46\101\x44\137\x52\117\117\124\x3a\x20{$filePath}\40\x28\x50\x46\x41\x44\137\122\117\117\x54\x20\162\145\141\x6c\72\40{$normalizedPfadRoot}\x29"); goto rKrNl; kXIZc: $relativePath = substr($normalizedFilePath, strlen($normalizedPfadRoot)); rKrNl: if ($zip->addFile($filePath, $relativePath)) { goto bJu15; } throw new Exception("\106\141\151\154\x65\x64\40\164\x6f\x20\141\x64\144\x20\146\x69\154\x65\x20\164\x6f\40\132\x49\x50\x20\141\x72\143\x68\x69\x76\145\72\x20{$filePath}"); bJu15: goto wIsbv; YEA9N: if ($file->isDir()) { goto TVm3Q; } $filePath = $file->getRealPath(); $pfadRootRealPath = realpath(\PFAD_ROOT); if (!($pfadRootRealPath === false)) { goto IxJLO; } throw new Exception("\103\x6f\165\x6c\144\x20\x6e\x6f\164\x20\x72\x65\163\157\154\166\145\40\120\106\101\x44\137\x52\x4f\117\x54\40\160\x61\x74\x68\x3a\x20" . \PFAD_ROOT); IxJLO: $normalizedFilePath = str_replace("\x5c", "\x2f", $filePath); $normalizedPfadRoot = str_replace("\x5c", "\x2f", $pfadRootRealPath); if (str_ends_with($normalizedPfadRoot, "\57")) { goto hnNM0; } $normalizedPfadRoot .= "\57"; goto Vnw6p; wIsbv: TVm3Q: PablT: goto bONao; bONao: } oFvVD: }; if (is_dir($backupDir)) { goto Hf1yb; } throw new Exception("\x42\x61\x63\x6b\165\160\x20\144\151\162\145\x63\164\157\162\171\x20\144\x6f\145\163\40\x6e\157\164\x20\x65\170\x69\163\164\72\40{$backupDir}"); Hf1yb: $addFilesToZip($backupDir, $zip); if ($zip->close()) { goto DcYpO; } throw new Exception("\x46\141\x69\x6c\x65\x64\x20\164\x6f\40\x66\151\x6e\141\154\x69\172\145\40\132\x49\120\40\x61\162\143\x68\151\x76\145"); DcYpO: return true; } catch (Exception $e) { $this->log->error("\x5a\x49\120\40\105\170\x70\157\x72\164\x20\x66\x61\x69\x6c\145\x64\72\x20" . $e->getMessage()); if (!(isset($zip) && $zip instanceof \ZipArchive)) { goto W4jYH; } $zip->close(); W4jYH: if (!(isset($zipPath) && file_exists($zipPath))) { goto tU2mr; } @unlink($zipPath); tU2mr: throw $e; } } public function zipImport($backupId) { $zip = new \ZipArchive(); if ($zip->open(self::BACKUP_PATH . $backupId . "\x2e\172\151\x70") === TRUE) { goto zOsrY; } throw new Exception("\x43\157\165\x6c\144\40\156\157\x74\x20\x65\170\164\162\141\143\x74\40\142\x61\x63\x6b\165\160\40\x66\151\x6c\145"); goto k2bV4; zOsrY: $zip->extractTo(\PFAD_ROOT); $zip->close(); return true; k2bV4: } }