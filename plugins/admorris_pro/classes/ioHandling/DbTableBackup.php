<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro\ioHandling; use JTL\Shop; use Exception; use Plugin\admorris_pro\ConsentManagerIntegration; use Plugin\admorris_pro\ioHandling\cookieNoticePro\CookieNoticePro; class DbTableBackup { private $plugin; private $db; public function __construct($plugin) { $this->plugin = $plugin; $this->db = Shop::Container()->getDB(); } public function export($backupId, $type) { goto NI6Oa; qNCQI: $dirname = dirname($filename); if (is_dir($dirname)) { goto rmN6f; } mkdir($dirname, 0755, true); rmN6f: file_put_contents($filename, $backupData); return true; goto shaGB; cgQ5w: $backupData->tpluginsprachvariablecustomsprache = $tpluginsprachvariablecustomsprache; $tableList = array("\170\x70\154\165\147\x69\156\x5f\141\144\155\157\x72\x72\151\x73\137\160\162\x6f\137\x61\x64\x76\x65\x6e\x74\x5f\143\141\x6c\145\x6e\144\141\162\x5f\x63\x6f\x6e\164\145\x6e\164", "\170\160\154\165\x67\x69\156\x5f\x61\144\155\x6f\x72\162\x69\x73\x5f\160\x72\x6f\x5f\141\144\166\145\156\x74\x5f\x63\x61\154\x65\x6e\x64\x61\x72\x5f\163\x65\164\164\151\x6e\147\x73", "\x78\160\x6c\165\147\151\156\137\x61\x64\x6d\157\x72\162\151\x73\137\160\162\157\137\141\163\x79\156\143\137\163\x63\x72\x69\x70\x74\x5f\143\x6f\x6e\146\151\147", "\x78\160\154\x75\x67\151\156\x5f\x61\x64\x6d\x6f\x72\x72\x69\x73\x5f\160\162\157\x5f\x63\x6f\157\x6b\151\x65\137\156\157\164\x69\143\145\137\x70\x72\157\x5f\x73\x65\x74\x74\151\156\147\163", "\170\160\x6c\165\147\151\x6e\137\x61\x64\x6d\x6f\162\162\151\163\x5f\x70\162\x6f\137\x64\151\x73\x63\157\x75\156\164\137\x74\x69\155\x65\x72\x5f\164\x65\x6d\x70", "\170\160\x6c\165\147\x69\156\137\141\x64\155\157\x72\x72\151\163\x5f\160\162\157\x5f\x65\x6c\145\155\145\x6e\x74\163", "\170\x70\154\165\x67\x69\156\x5f\x61\144\155\157\162\162\x69\163\137\160\x72\157\x5f\x65\154\145\x6d\x65\156\164\x73\x5f\x63\x61\x74\x65\147\157\x72\171", "\x78\160\x6c\x75\x67\x69\x6e\x5f\141\x64\x6d\x6f\162\162\x69\x73\x5f\x70\x72\x6f\137\x65\x6c\x65\155\145\x6e\164\163\137\x74\162\x69\x67\x67\145\x72\137\x66\151\154\164\x65\x72", "\x78\160\154\x75\147\x69\x6e\137\x61\x64\155\157\x72\162\x69\163\137\x70\x72\157\137\x68\145\x61\144\x65\162\154\141\x79\157\165\x74", "\x78\x70\x6c\x75\x67\x69\x6e\x5f\141\144\x6d\157\162\162\151\x73\137\x70\162\x6f\137\154\151\x76\x65\137\163\141\x6c\x65\x5f\156\x6f\x74\x69\x66\151\x63\x61\x74\151\157\x6e\137\x73\145\164\x74\151\x6e\x67\x73", "\x78\x70\x6c\165\x67\x69\x6e\137\141\x64\155\157\x72\162\x69\x73\137\160\x72\157\x5f\x6d\x61\x72\x6b\x65\x74\x69\156\x67\137\x73\150\x69\160\160\151\156\x67\x5f\143\157\x75\x6e\164\144\x6f\x77\156\x5f\156\x6f\137\x73\x68\x69\x70\x70\x69\x6e\x67", "\170\x70\154\x75\147\x69\156\137\141\x64\x6d\157\x72\162\x69\163\x5f\160\162\157\x5f\x70\x6f\x70\165\160", "\170\x70\154\x75\147\151\x6e\x5f\141\144\x6d\x6f\162\162\x69\163\x5f\160\x72\x6f\137\160\157\x70\x75\160\137\164\162\151\147\x67\x65\162\137\146\x69\154\164\x65\162", "\x78\160\x6c\165\147\x69\x6e\x5f\x61\x64\x6d\x6f\162\x72\x69\x73\x5f\160\162\x6f\137\162\x65\143\x65\156\x74\137\x73\x61\x6c\x65\x73", "\x78\x70\x6c\x75\x67\x69\x6e\x5f\141\x64\155\157\x72\x72\151\x73\137\160\x72\x6f\x5f\x72\145\x77\x61\x72\144\137\x70\x6f\151\156\164\x73\137\163\x65\x74\x74\x69\156\147\x73", "\170\160\154\x75\x67\x69\x6e\x5f\x61\x64\x6d\x6f\x72\162\x69\x73\137\x70\x72\x6f\x5f\x72\145\x77\x61\x72\x64\137\160\x6f\151\x6e\x74\x73\x5f\143\x75\163\x74\x6f\x6d\145\x72\137\147\162\157\165\x70\137\163\x65\x74\x74\x69\156\x67\163", "\x78\160\x6c\x75\x67\x69\156\x5f\x61\144\x6d\x6f\x72\162\x69\x73\137\x70\162\157\x5f\x73\141\x6c\145\137\x63\x6f\x75\x6e\x74\x64\157\167\156", "\170\x70\154\165\x67\151\x6e\137\141\x64\x6d\x6f\162\162\x69\x73\137\x70\x72\157\137\163\x61\x6c\x65\137\x63\x6f\x75\x6e\164\144\x6f\x77\156\137\x74\145\170\164", "\x78\160\154\165\x67\151\156\137\141\144\155\x6f\x72\162\x69\x73\x5f\x70\162\x6f\137\x74\x65\155\x70\x6c\x61\x74\145\137\163\145\x74\164\x69\x6e\147\x73", "\x78\x70\x6c\165\x67\151\156\x5f\141\144\155\x6f\x72\x72\151\163\137\x70\x72\x6f\137\164\x68\x65\x6d\x65", "\x63\x6f\157\153\x69\x65\116\157\x74\151\143\x65\x50\x72\157" => array("\x78\160\x6c\x75\147\151\x6e\137\141\144\155\x6f\162\x72\x69\x73\x5f\x70\162\157\137\143\157\x6f\x6b\x69\145\137\156\157\x74\151\143\x65\137\x70\x72\x6f", "\170\x70\x6c\x75\147\151\x6e\x5f\x61\x64\155\157\x72\x72\x69\163\137\x70\x72\157\x5f\x63\157\157\153\x69\145\x5f\x6e\x6f\x74\151\x63\145\137\160\x72\x6f\137\x64\x65\x73\x63\162\x69\x70\x74\151\x6f\156", "\170\x70\154\x75\147\151\x6e\x5f\x61\144\x6d\157\x72\162\151\163\x5f\x70\162\157\x5f\143\x6f\157\x6b\151\145\137\156\x6f\164\x69\143\145\137\160\x72\x6f\137\163\x63\x72\x69\160\x74\163", "\170\160\x6c\165\147\151\x6e\137\141\144\155\x6f\x72\x72\151\163\137\160\x72\x6f\137\x63\x6f\157\153\151\145\x5f\x6e\x6f\164\151\143\x65\137\x70\x72\157\x5f\x74\162\151\147\147\x65\162\137\x66\x69\x6c\164\x65\x72\163"), "\151\x63\x6f\x6e\x73" => array("\x78\x70\x6c\165\x67\x69\156\x5f\141\144\x6d\157\x72\162\151\x73\137\160\162\157\137\x69\143\x6f\156\163", "\x78\160\x6c\x75\x67\x69\x6e\x5f\141\x64\x6d\157\x72\162\x69\163\137\x70\162\157\137\151\143\157\x6e\x73\137\x75\x73\145\x64"), "\163\x6c\151\x64\x65\162" => array("\170\160\154\165\x67\x69\x6e\x5f\141\x64\155\x6f\162\x72\151\163\x5f\x70\x72\x6f\137\163\x6c\x69\x64\x65\x72", "\x78\x70\x6c\165\147\151\156\137\x61\x64\x6d\157\x72\162\x69\163\x5f\x70\x72\157\137\163\154\x69\x64\145"), "\x78\160\154\165\x67\151\156\137\x61\x64\155\x6f\162\162\151\163\x5f\160\162\157\137\x65\x6e\x68\x61\156\x63\x65\x64\x5f\145\x63\x6f\155\155\145\162\143\145\137\164\162\x61\143\153\151\156\147", "\170\x70\154\x75\147\151\156\x5f\141\144\x6d\x6f\x72\162\151\163\x5f\160\162\157\137\164\150\x72\145\x65\137\163\x69\170\164\171\x5f\x69\x6d\x61\x67\145\137\163\x65\x74\164\x69\x6e\147\163"); $fulltableList = array("\170\x70\154\165\147\151\156\137\141\x64\155\x6f\162\162\151\163\137\x70\162\x6f\137\x6d\141\151\x6c\x63\150\151\x6d\160\137\143\x72\x6f\156", "\170\x70\154\x75\x67\x69\156\x5f\x61\x64\x6d\157\162\x72\151\163\x5f\160\162\x6f\137\160\165\x73\x68\x5f\x6e\x6f\x74\151\146\x69\x63\x61\164\x69\x6f\x6e\x5f\x74\157\x6b\x65\156", "\170\x70\x6c\165\147\x69\156\137\141\x64\x6d\x6f\162\162\151\x73\137\x70\162\x6f\137\x73\145\141\162\x63\x68\x5f\x63\162\x6f\x6e", "\170\x70\x6c\x75\x67\x69\156\137\x61\x64\x6d\x6f\162\162\x69\163\137\160\x72\x6f\x5f\x72\x65\167\141\162\x64\x5f\x70\x6f\x69\156\164\x73\137\x74\162\x61\156\x73\x61\143\164\151\x6f\x6e"); if (!($type === "\x66\165\154\x6c")) { goto J2Hdo; } $tableList = array_merge($tableList, $fulltableList); J2Hdo: foreach ($tableList as $key => $table) { if (is_array($table)) { goto pye28; } $pluginData = $this->db->query("\x53\x45\x4c\x45\x43\x54\40\52\40\106\x52\x4f\115\x20{$table}", 2); $backupData->{$table} = $pluginData; goto T0ETU; pye28: $pluginData = null; foreach ($table as $subTable) { $pluginData[$subTable] = $this->db->query("\123\105\114\x45\103\x54\40\52\40\106\x52\117\115\x20{$subTable}", 2); QNoge: } ZVjLy: $backupData->{$key} = $pluginData; T0ETU: xAyg7: } MxmXv: $backupData = json_encode($backupData); $filename = Backup::BACKUP_PATH . $backupId . "\x2f\160\154\165\147\151\156\124\141\x62\x6c\145\x73\56\x61\144\x62\153"; goto qNCQI; NI6Oa: $backupData = new \stdClass(); $pluginId = $this->plugin->getId(); $backupData->nVersion = $this->plugin->getMeta()->getVersion(); $tplugineinstellungen = $this->db->query("\x53\105\114\105\x43\x54\x20\x63\x4e\x61\x6d\145\54\x20\x63\127\145\162\164\40\106\122\117\115\x20\x74\160\154\165\x67\x69\156\145\x69\x6e\x73\x74\x65\x6c\154\x75\156\x67\x65\x6e\x20\127\110\105\x52\105\40\x63\x4e\141\x6d\x65\40\114\x49\113\x45\x20\x27\45\141\144\x6d\x6f\x72\x72\x69\163\137\x70\x72\157\45\47", 2); $backupData->tplugineinstellungen = $tplugineinstellungen; $ttemplateeinstellungen = $this->db->query("\123\105\114\x45\x43\124\x20\x2a\40\x46\x52\117\115\x20\164\x74\x65\x6d\160\154\141\164\145\145\x69\156\163\x74\145\x6c\154\165\x6e\147\x65\156\40\127\x48\105\122\x45\40\143\x54\x65\x6d\x70\x6c\141\164\x65\40\x4c\111\113\105\40\47\x25\x61\144\155\x6f\x72\162\x69\x73\137\160\x72\x6f\45\x27", 2); $backupData->ttemplateeinstellungen = $ttemplateeinstellungen; $textensionpoint = $this->db->query("\123\105\114\x45\103\124\x20\153\123\x70\x72\141\x63\x68\x65\x2c\x20\153\x4b\x75\x6e\x64\x65\156\x67\x72\165\x70\x70\145\54\40\156\123\x65\x69\x74\x65\54\40\143\x4b\x65\171\x2c\40\143\x56\141\154\x75\145\x2c\x20\x63\x43\154\x61\x73\163\x2c\x20\x6b\x49\156\151\164\x69\x61\154\x20\106\x52\117\115\x20\164\x65\x78\164\145\x6e\163\151\157\x6e\160\x6f\x69\156\164\40\127\110\x45\122\x45\40\143\103\154\141\x73\163\40\x3d\x20\47\x41\x6d\x53\x6c\x69\x64\145\162\47", 2); $backupData->textensionpoint = $textensionpoint; $tpluginsprachvariablecustomsprache = $this->db->query("\123\x45\114\105\103\124\x20\x2a\40\106\122\x4f\115\x20\164\x70\154\165\147\151\156\x73\160\162\x61\x63\150\x76\x61\x72\x69\141\x62\x6c\x65\143\165\163\164\157\155\x73\160\162\x61\143\x68\x65\40\127\110\105\x52\x45\40\153\x50\x6c\x75\147\x69\x6e\x20\75\x20\x27{$pluginId}\47", 2); goto cgQ5w; shaGB: } public function import($backupId) { $pluginId = $this->plugin->getId(); $importFile = fopen(Backup::BACKUP_PATH . $backupId . "\x2f\160\x6c\165\147\151\156\124\141\x62\x6c\145\163\56\x61\144\142\x6b", "\x72\x2b") or die("\106\x69\x6c\x65\x20\144\157\x65\x73\40\156\157\x74\40\145\x78\151\163\x74\x21"); $importData = fgets($importFile); $importData = json_decode($importData, true); fclose($importFile); $importData = $this->arrayToObject($importData); if (!($importData->nVersion != $this->plugin->getMeta()->getVersion())) { goto vJ35a; } throw new Exception("\x43\157\x75\154\x64\40\x6e\157\164\x20\151\155\x70\157\162\x74\40\142\141\x63\x6b\165\x70\x20\x64\x61\164\x61\x62\141\x73\x65\40\164\x61\142\x6c\145\x73\x20\x62\x65\143\x61\x75\x73\x65\x20\x74\150\x65\40\x70\x6c\x75\x67\x69\156\x20\x76\145\x72\163\151\x6f\x6e\163\40\144\157\x6e\47\164\x20\x6d\x61\x74\x63\150"); vJ35a: Shop::Container()->getDB()->query("\123\105\x54\x20\106\x4f\x52\x45\x49\107\x4e\x5f\x4b\105\131\137\x43\110\105\103\x4b\x53\x20\75\x20\60"); foreach ($importData as $key => $importTable) { goto C_Awh; C_Awh: if ($key == "\164\160\x6c\165\147\151\156\x65\x69\x6e\163\164\x65\154\x6c\165\156\147\x65\156") { goto Ln7Os; } if ($key == "\164\164\145\x6d\x70\x6c\141\164\x65\145\151\156\163\164\145\x6c\154\165\x6e\147\145\156") { goto JXnrC; } if ($key == "\164\x65\x78\x74\145\156\x73\151\x6f\156\160\x6f\151\156\x74") { goto hjbTI; } if ($key == "\164\160\x6c\165\x67\151\x6e\163\x70\162\141\x63\150\x76\x61\162\151\x61\142\x6c\x65\x63\x75\x73\x74\x6f\x6d\163\160\x72\141\143\x68\x65") { goto W1t2R; } if ($key === "\x63\157\157\x6b\151\145\x4e\157\164\151\x63\145\x50\162\x6f") { goto KpFMs; } if (!($key != "\x6e\x56\x65\162\163\x69\x6f\156")) { goto sD15A; } if (!str_contains($key, "\170\160\x6c\165\147\x69\x6e")) { goto TgrCu; } $this->db->query("\104\x45\x4c\105\x54\105\40\106\x52\x4f\115\40{$key}", 3); foreach ($importTable as $rowKey => $importRow) { $this->db->insert($key, $importRow); OxIme: } tL8pu: goto zAXpA; zAXpA: goto OsfIf; TgrCu: $toArr = (array) $importData->{$key}; foreach ($toArr as $tableName => $valuesArray) { $this->db->query("\104\105\x4c\x45\x54\x45\40\106\x52\117\115\40{$tableName}", 3); $innerArr = (array) $toArr[$tableName]; foreach ($innerArr as $importRow) { $this->db->insert($tableName, $importRow); oTU3A: } Qu0BS: d6hTo: } nfvfR: OsfIf: sD15A: goto CoIcK; KpFMs: array_map(function ($item) { CookieNoticePro::delete($item, false); }, CookieNoticePro::getAll()); goto UuDio; MJER3: JXnrC: $this->db->query("\104\105\x4c\105\124\105\40\x46\x52\x4f\115\x20\164\x74\x65\x6d\x70\x6c\141\x74\145\x65\x69\156\163\164\145\154\x6c\165\156\147\x65\x6e\40\127\x48\105\x52\x45\x20\x63\x54\x65\x6d\160\154\141\x74\145\40\114\x49\113\x45\40\47\x25\x61\x64\x6d\157\x72\x72\x69\163\137\x70\162\x6f\x25\47", 3); foreach ($importTable as $key => $importRow) { $this->db->insert("\x74\164\145\x6d\160\154\141\x74\145\145\151\156\163\164\x65\154\x6c\165\156\x67\145\156", $importRow); ZAaun: } lPobu: ffnpS: goto BHx65; Ln7Os: foreach ($importTable as $key => $importRow) { $this->db->query("\x55\x50\x44\x41\x54\x45\40\164\160\154\x75\147\151\x6e\x65\151\156\163\164\x65\154\x6c\x75\x6e\x67\x65\156\40\123\x45\x54\40\143\127\x65\x72\164\40\x3d\x20\x27{$importRow->cWert}\47\40\127\x48\105\122\x45\x20\143\x4e\141\x6d\145\x20\x4c\x49\x4b\x45\x20\x27{$importRow->cName}\x27", 3); YM1Cb: } UDKkz: BHx65: goto tZS43; UuDio: array_map(function ($item) { if (!str_contains($item->itemID, "\x61\x64\155\x6f\x72\162\x69\163")) { goto GJxMI; } ConsentManagerIntegration::unregisterConsentItem($item->id); GJxMI: }, Shop::Container()->getDB()->selectAll("\164\x63\x6f\x6e\x73\x65\x6e\x74", [], [])); $cookiesData = get_object_vars($importTable->xplugin_admorris_pro_cookie_notice_pro); $localizationsData = get_object_vars($importTable->xplugin_admorris_pro_cookie_notice_pro_description); $scriptsData = get_object_vars($importTable->xplugin_admorris_pro_cookie_notice_pro_scripts); $triggerFiltersData = get_object_vars($importTable->xplugin_admorris_pro_cookie_notice_pro_trigger_filters); array_map(function ($cookie) use($localizationsData, $scriptsData, $triggerFiltersData) { $cookie->scripts = array_filter($scriptsData, function ($script) use($triggerFiltersData, $cookie) { $script->triggerFilters = array_filter($triggerFiltersData, function ($triggerFilter) use($script) { return $triggerFilter->scriptId === $script->id; }); return $script->cookieId === $cookie->id; }); $cookie->localization = array_filter($localizationsData, function ($localization) use($cookie) { return $localization->cookieId === $cookie->id; }); $cookie = json_decode(json_encode($cookie)); unset($cookie->tconsentId); CookieNoticePro::create($cookie, false); }, $cookiesData); CoIcK: goto jXTyN; W1t2R: $this->db->query("\x44\x45\114\x45\x54\x45\x20\106\122\x4f\115\x20\164\x70\154\165\x67\151\x6e\x73\x70\162\141\143\150\166\x61\162\x69\141\142\154\x65\x63\x75\x73\x74\157\155\163\x70\162\141\143\150\x65\x20\x57\110\105\122\105\40\x6b\x50\154\165\147\x69\156\x20\x3d\40\47{$pluginId}\x27", 3); goto XRaE9; tZS43: kgVCr: goto rwKN5; XRaE9: foreach ($importTable as $key => $importRow) { $kPluginSprachvariable = $this->db->query("\x53\105\x4c\105\x43\124\x20\x6b\120\x6c\x75\147\151\156\123\160\x72\141\x63\150\166\x61\x72\151\141\142\154\145\40\x46\x52\117\x4d\x20\x74\160\x6c\165\x67\x69\156\x73\160\x72\x61\143\x68\166\141\x72\151\141\142\154\x65\40\x57\x48\x45\x52\105\40\153\x50\x6c\165\x67\x69\156\40\x3d\40\x27{$pluginId}\47\40\x41\116\104\40\143\x4e\141\155\145\x20\75\x20\47{$importRow->cSprachvariable}\47\40\114\x49\x4d\111\x54\40\x31", 2); $kPluginSprachvariable = $kPluginSprachvariable[0]->kPluginSprachvariable; $importRow->kPlugin = $pluginId; $importRow->kPluginSprachvariable = $kPluginSprachvariable; $this->db->insert("\x74\x70\154\x75\x67\x69\x6e\x73\x70\x72\141\x63\x68\x76\141\x72\151\x61\142\154\145\143\x75\163\164\x6f\x6d\x73\160\162\141\143\150\x65", $importRow); ujvo2: } vFTr9: jXTyN: goto Hmbqg; hjbTI: $this->db->query("\104\105\x4c\105\124\x45\40\106\122\x4f\x4d\x20\164\145\170\x74\145\156\163\x69\157\156\x70\x6f\x69\x6e\x74\40\x57\x48\105\122\x45\x20\143\103\x6c\x61\x73\x73\40\75\x20\x27\x41\155\x53\154\x69\144\145\162\x27", 3); foreach ($importTable as $key => $importRow) { $this->db->insert("\x74\x65\x78\164\145\x6e\163\x69\x6f\156\160\157\151\x6e\x74", $importRow); cf_zx: } ZSM3A: Hmbqg: goto ffnpS; goto MJER3; rwKN5: } SbbE5: Shop::Container()->getDB()->query("\x53\105\x54\x20\106\117\x52\105\x49\107\x4e\137\113\x45\131\x5f\103\x48\x45\x43\113\123\x20\x3d\x20\61"); Shop::Container()->getCache()->flushAll(); return true; } public function arrayToObject($d) { if (is_array($d)) { goto mesCF; } return $d; goto AkxtF; mesCF: return (object) array_map(__METHOD__, $d); AkxtF: } }