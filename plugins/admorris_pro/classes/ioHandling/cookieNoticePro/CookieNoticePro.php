<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro\ioHandling\cookieNoticePro; use JTL\Consent\ConsentModel; use JTL\Shop; use Plugin\admorris_pro\ioHandling\AbstractIOClass; use Plugin\admorris_pro\ConsentManagerIntegration; use Plugin\admorris_pro\ioHandling\cookieNoticePro\CookieNoticePro as CookieNoticeProCookieNoticePro; use stdClass; class CookieNoticePro extends AbstractIOClass { public static function getAll() { $cookies = CookieNoticeProCookies::getAll(); $cookieNoticeDescriptions = CookieNoticeProDescriptions::getAll(); foreach ($cookies as $cookie) { $filteredLocalization = array_filter($cookieNoticeDescriptions, function ($obj) use($cookie) { return $obj->cookieId === $cookie->id; }); usort($filteredLocalization, function ($a, $b) { return strcmp($a->languageId, $b->languageId); }); $cookie->localization = $filteredLocalization; $cookie->cookieTitle = htmlspecialchars_decode($cookie->cookieTitle, ENT_QUOTES); foreach ($cookie->localization as $outerKey => $localization) { foreach ($localization as $innerKey => $langItem) { $langItem = htmlspecialchars_decode($langItem, ENT_QUOTES); Sh5zK: } KwpZ5: HBdO_: } GLQyc: $cookie->scripts = CookieNoticeProScripts::where("\143\157\x6f\x6b\x69\145\111\x64", $cookie->id); foreach ($cookie->scripts as $script) { $script->triggerFilters = CookieNoticeProTriggerFilters::where("\163\143\162\x69\x70\x74\111\144", $script->id); UlMiU: } aesfe: IQier: } dGqXj: return $cookies; } public static function create($data, $sanitize = true) { goto DwKFW; dTwGo: foreach ($localization as $item) { $item->cookieId = $cookie->id; CookieNoticeProDescriptions::create($item); L00wF: } ObFNu: foreach ($scripts as $script) { $script->cookieId = $cookie->id; $triggerFilters = $script->triggerFilters; unset($script->triggerFilters); if (isset($script->triggerFilterOperator)) { goto dp8T0; } $script->triggerFilterOperator = "\141\x6e\144"; dp8T0: $newScript = CookieNoticeProScripts::create($script); $script->triggerFilters = $triggerFilters; foreach ($triggerFilters as $triggerFilter) { $triggerFilter->scriptId = $newScript->id; CookieNoticeProTriggerFilters::create($triggerFilter); K0BQk: } AAEZD: PBS_A: } fT3A3: $payload = ConsentManagerIntegration::createConsentManagerPayload($newCookie, $localization); $jtlConsent = ConsentManagerIntegration::registerConsentItem($payload); $obj_merged = ConsentManagerIntegration::mergeAdmCookieAndJTLConsent($newCookie, $jtlConsent); CookieNoticeProCookies::update($obj_merged); $obj_merged->localization = $localization; $obj_merged->scripts = $scripts; goto lUQno; lUQno: return $obj_merged; goto VbUXn; DwKFW: if (!$sanitize) { goto jiH40; } $data = self::sanitizeInput($data); jiH40: $localization = $data->localization; $scripts = $data->scripts; $cookie = $data; unset($cookie->localization); unset($cookie->scripts); unset($cookie->newScript); $newCookie = CookieNoticeProCookies::create($cookie); goto dTwGo; VbUXn: } public static function update($data, $sanitizeInput = true) { goto S3tH7; S3tH7: if (!$sanitizeInput) { goto v6Gbc; } $data = self::sanitizeInput($data); v6Gbc: $localization = $data->localization; $scripts = $data->scripts; $cookie = $data; unset($cookie->localization); unset($cookie->scripts); unset($cookie->newScript); CookieNoticeProCookies::update($cookie); goto cHCnL; cHCnL: foreach ($localization as $lang) { if (empty($lang->id)) { goto QUq_v; } CookieNoticeProDescriptions::update($lang); goto qcPXJ; QUq_v: CookieNoticeProDescriptions::create($lang); qcPXJ: RwTSK: } dw6U4: foreach ($scripts as $script) { $script->cookieId = $cookie->id; $triggerFilters = $script->triggerFilters; if (!isset($script->id) || $script->id === null || str_contains($script->id, "\156\145\167")) { goto sbyFy; } $copy = clone $script; unset($copy->triggerFilters); CookieNoticeProScripts::update($copy); foreach ($triggerFilters as $triggerFilter) { if (!isset($triggerFilter->id) || $triggerFilter->id === null || str_contains($triggerFilter->id, "\156\145\167")) { goto w7QCe; } CookieNoticeProTriggerFilters::update($triggerFilter); goto N20xQ; w7QCe: CookieNoticeProTriggerFilters::create($triggerFilter); N20xQ: tD2a3: } n38Ug: goto w8ORk; sbyFy: $copy = clone $script; unset($copy->triggerFilters); $newScript = CookieNoticeProScripts::create($copy); $script->id = $newScript->id; foreach ($triggerFilters as $triggerFilter) { $triggerFilter->scriptId = $newScript->id; CookieNoticeProTriggerFilters::create($triggerFilter); SUD24: } OxIWc: w8ORk: GzKjj: } LCPXx: $savedScriptsIds = array_column(CookieNoticeProScripts::where("\143\157\x6f\x6b\151\x65\111\x64", $cookie->id), "\151\x64"); $newScriptIds = array_column($scripts, "\x69\x64"); $scriptsDiff = array_diff($savedScriptsIds, $newScriptIds); $savedTriggerFiltersIds = $newTriggerFilterIds = $triggerFiltersDiff = null; foreach ($scripts as $script) { $savedTriggerFiltersIds = array_column(CookieNoticeProTriggerFilters::where("\163\143\162\151\160\164\111\x64", $script->id), "\x69\144"); $newTriggerFilterIds = array_column($script->triggerFilters, "\151\x64"); $triggerFiltersDiff = array_diff($savedTriggerFiltersIds, $newTriggerFilterIds); Mmppw: } MLqu0: goto VEU7x; VEU7x: foreach ($triggerFiltersDiff as $toDelete) { $obj = new stdClass(); $obj->id = $toDelete; CookieNoticeProTriggerFilters::delete($obj); fu5A7: } xgTwM: foreach ($scriptsDiff as $toDelete) { $obj = new stdClass(); $obj->id = $toDelete; $filters = CookieNoticeProTriggerFilters::where("\x73\x63\x72\x69\x70\164\x49\144", $obj->id); array_map(function ($filter) { return CookieNoticeProTriggerFilters::delete($filter); }, $filters); CookieNoticeProScripts::delete($obj); gUyH8: } Tx5lW: $payload = ConsentManagerIntegration::createConsentManagerPayload($cookie, $localization); $jtlConsent = ConsentManagerIntegration::registerConsentItem($payload); $obj_merged = ConsentManagerIntegration::mergeAdmCookieAndJTLConsent($cookie, $jtlConsent); CookieNoticeProCookies::update($obj_merged); $obj_merged->localization = $localization; $obj_merged->scripts = $scripts; goto liblp; liblp: return $obj_merged; goto LypV9; LypV9: } public static function delete($data, $unregisterConsent = true) { if (!isset($data->newScript)) { goto dOvso; } unset($data->newScript); dOvso: $data = json_decode(json_encode($data, true)); foreach ($data->localization as $lang) { CookieNoticeProDescriptions::delete($lang); eQ5G8: } MOj1o: foreach ($data->scripts as $script) { foreach ($script->triggerFilters as $triggerFilter) { if (str_contains($triggerFilter->id, "\156\145\x77")) { goto uA27O; } CookieNoticeProTriggerFilters::delete($triggerFilter); uA27O: DGoct: } HA3Xc: CookieNoticeProScripts::delete($script); ezJuf: } QnPti: CookieNoticeProCookies::delete($data); if (!(isset($data->tconsentId) && $unregisterConsent)) { goto lDl4G; } ConsentManagerIntegration::unregisterConsentItem($data->tconsentId); lDl4G: return $data->id; } private static function sanitizeInput($data) { $data["\x63\157\x6f\153\x69\145\124\x69\x74\154\x65"] = htmlspecialchars($data["\143\x6f\157\x6b\x69\x65\124\x69\x74\x6c\145"], ENT_QUOTES); foreach ($data["\x6c\157\143\x61\x6c\x69\x7a\141\x74\151\x6f\x6e"] as $outer => $lang) { foreach ($lang as $inner => $value) { $data["\x6c\x6f\143\141\x6c\x69\x7a\x61\x74\151\x6f\x6e"][$outer][$inner] = htmlspecialchars($value, ENT_QUOTES, "\125\124\x46\55\70"); yk7tA: } zEKZt: Y1VB7: } rGH8b: $data = json_decode(json_encode($data, true)); return $data; } public static function handlePluginSetting($value) { $model = new ConsentModel(Shop::Container()->getDB()); $consentItems = $model->loadAll(Shop::Container()->getDB(), [], []); $consentItems = $consentItems->values(); $cookieNoticeProItems = self::getAll(); $filteredConsentItem = null; foreach ($cookieNoticeProItems as $cookieNoticeProItem) { if (!(isset($cookieNoticeProItem->tconsentId) && isset($cookieNoticeProItem->active) && $cookieNoticeProItem->active === "\x31")) { goto Ehd_8; } $filteredConsentItem = $consentItems->where("\x69\x64", $cookieNoticeProItem->tconsentId)->first(); if (!$filteredConsentItem) { goto h7n2b; } if ($value) { goto qomCc; } $filteredConsentItem->__set("\x61\x63\x74\x69\166\x65", 0); goto Iw4op; qomCc: $filteredConsentItem->__set("\x61\143\164\151\x76\145", 1); Iw4op: $filteredConsentItem->save(); h7n2b: Ehd_8: zSdDj: } uopqC: } }