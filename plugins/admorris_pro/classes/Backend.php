<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro; use JTL\Shop; use stdClass; use JTL\Customer\CustomerGroup; use JTL\Language\LanguageHelper; use JTL\Plugin\PluginInterface; use Plugin\admorris_pro\lib\AdmorrisLib; use Plugin\admorris_pro\Utils\TypeConverter; class Backend { use LoggerTrait; private $data; public function __construct(private PluginInterface $oPlugin, private StatusRequest $statusRequest, private $smarty) { $this->data = new stdClass(); $this->initLogger(); } public function render() { $this->smarty->assign("\x64\x61\x74\x61", json_encode($this->data))->assign("\x63\x61\x74\x65\x67\x6f\162\151\145\163", json_encode(getCategories()))->assign("\155\141\156\x75\146\141\x63\164\165\x72\x65\162\163", json_encode(getManufacturers()))->assign("\141\x70\160\112\163\106\x69\154\x65\x50\141\164\x68", $this->getAppJsFilePath()); return $this->smarty->fetch($this->oPlugin->getPaths()->getAdminPath() . "\x74\145\x6d\160\154\141\x74\x65\x73\x2f\142\141\x63\153\145\156\144\x2e\x74\x70\154"); } public function execute() { $this->handleAjaxRequests(); $this->setShopUrl(); $this->setLanguages(); $this->setCustomerGroups(); $this->setPluginSettings(); $this->setTemplateSettings(); $this->setAdventCalendarSettings(); $this->setStatusInfo(); $this->setPluginVersion(); $this->setFeaturePoints(); $this->setPluginId(); $this->setJtlToken(); $this->setPendingCronjobs(); $this->setTaxClasses(); $this->setBackendLanguage(); $this->setKcfinder(); $this->setUrls(); $this->setFlags(); return $this->render(); } public function handleAjaxRequests() { if (!(isset($_SERVER["\x48\x54\124\120\x5f\x58\137\x52\105\x51\x55\x45\x53\124\x45\x44\x5f\x57\x49\x54\110"]) && strtolower($_SERVER["\110\124\x54\120\137\130\137\122\x45\121\125\x45\x53\124\x45\104\x5f\x57\x49\x54\x48"]) == "\x78\155\154\150\164\164\160\x72\145\161\x75\x65\x73\164")) { goto OZnls; } $response = IoRequestRouting::direct($_REQUEST["\151\157"]); OZnls: } public function setShopUrl() { $shopUrl = Shop::getURL(); Shop::set("\141\144\x6d\x6f\x72\x72\151\163\x2d\164\x65\155\160\x6c\x61\x74\145\55\160\154\165\147\x69\156\55\151\144", $this->oPlugin->getID()); $this->data->shopUrl = $shopUrl; } public function setLanguages() { $oSprache = Shop::Lang()->getInstalled(); $this->data->languages = array_map(function ($item) { return $item->rawArray(); }, $oSprache); } private function getAppJsFilePath() { $path = $this->oPlugin->getPaths()->getAdminPath() . "\152\x73\x2f"; $manifestFilePath = $path . "\155\141\x6e\151\146\x65\163\164\56\x6a\163\x6f\x6e"; $file = @file_get_contents($manifestFilePath); if (!($file === false)) { goto tITWF; } throw new \Exception($manifestFilePath . "\40\156\x6f\164\40\146\x6f\165\x6e\x64"); tITWF: $manifest = json_decode($file, true); if (isset($manifest["\x61\x70\x70\x2e\152\x73"])) { goto xVtIR; } throw new \Exception("\106\x69\154\x65\40\156\157\x74\40\146\x6f\165\x6e\x64\x20\x69\x6e\x20\155\141\x6e\x69\x66\145\x73\164\x3a\40\141\x70\160\56\152\163"); xVtIR: $fileName = $manifest["\x61\160\x70\x2e\152\163"]; return $this->oPlugin->getPaths()->getAdminURL() . "\x6a\163\57" . $fileName; } public function setCustomerGroups() { $this->data->customerGroups = array_map(function ($item) { return ["\x69\x64" => $item->getID(), "\156\141\155\x65" => $item->getName()]; }, CustomerGroup::getGroups()); $this->data->customerGroups_alt = AdmorrisLib::getCustomerGroups(); } public function setPluginSettings() { try { $this->data->pluginSettings = Shop::get("\x61\x64\x6d\157\162\162\x69\x73\x50\162\157\x2d\x73\x65\x74\164\151\156\x67\163"); $this->data->storageOPC = "\x2f" . \STORAGE_OPC; $this->data->packages = StatusRequest::activePackages(); Shop::set("\141\144\155\x6f\162\x72\151\163\120\x72\157\55\x73\145\164\164\151\156\147\x73", $this->data->pluginSettings); } catch (\Throwable $th) { $this->log->error($th); } } public function setTemplateSettings() { $templateSettings = new TemplateSettings($this->oPlugin, Shop::Container()->getDB(), Shop::Container()->getCache()); $this->data->templateSettings = $templateSettings->load(); $this->data->headerLayout = $templateSettings->loadHeaderLayout(); } public function setAdventCalendarSettings() { $adventCalendarSettings = Shop::Container()->getDB()->select("\170\160\154\165\147\x69\x6e\137\x61\x64\x6d\157\162\162\151\163\137\x70\162\157\x5f\141\144\166\145\156\x74\x5f\x63\141\154\x65\x6e\144\x61\x72\137\163\x65\164\x74\151\x6e\147\x73", "\x69\144", 1); $adventCalendarSettings->active = TypeConverter::convertIntegerToBool($adventCalendarSettings->active); $adventCalendarSettings->dev_mode = TypeConverter::convertIntegerToBool($adventCalendarSettings->dev_mode); $adventCalendarSettings->preview_mode = TypeConverter::convertIntegerToBool($adventCalendarSettings->preview_mode); $adventCalendarSettings->open_current_date_only = TypeConverter::convertIntegerToBool($adventCalendarSettings->open_current_date_only); $this->data->adventCalendarSettings = $adventCalendarSettings; $lang = LanguageHelper::getAllLanguages(); $calendar = new Calendar($this->oPlugin, $lang); $adventCalendarContent = $calendar->getContent(); foreach ($adventCalendarContent as $day) { foreach ($day as $content) { $content->content = htmlspecialchars_decode($content->content); ByLxT: } GDoNv: xj_Cm: } Zr1f3: $this->data->adventCalendarContent = $adventCalendarContent; } public function setStatusInfo() { $status = $this->statusRequest; $status->requestLicense(); $lock = $status->lock(); $module = $status->module(); $template = $status->template(); $validity = $status->validity(); $moduleName = $status->moduleName(); $features = $status->features(); $this->data->nextMajorVersion = $status->getNextMajorVersion(); $this->data->nextVersion = $status->getNextNonMajorVersion(); $this->data->statusModule = $module; $this->data->statusModuleName = $moduleName; $this->data->statusFeatures = $features; $this->data->templateActive = $template === "\x31"; $this->data->statusLock = $lock != "\x32"; $this->data->statusBlockFeatures1 = $module == 0 || $validity == "\x30"; $this->data->statusBlockFeatures2 = !($module >= 2 && $validity == "\61"); $this->data->statusBlockFeatures3 = !($module >= 3 && $validity == "\x31"); $this->data->statusBlockFeatures4 = !($module >= 4 && $validity == "\61"); $this->data->validity = boolval($validity); } public function setPluginVersion() { $pluginVersion = $this->oPlugin->getMeta()->getVersion(); $this->data->pluginVersion = $pluginVersion; $status = $this->statusRequest; $pluginVersionLatest = $status->currentVersion(); $this->data->pluginVersionLatest = $pluginVersionLatest; $pluginKompatibleVersion = $status->compatibleVersion(); $this->data->pluginCompatibleVersion = $pluginKompatibleVersion; $this->data->newPluginVersionAvailable = $pluginVersionLatest ? version_compare($pluginVersionLatest, $pluginVersion, "\x3e") : false; $this->data->newCompatibleVersionAvailable = $pluginKompatibleVersion ? version_compare($pluginKompatibleVersion, $pluginVersion, "\x3e") : false; } public function setFeaturePoints() { $status = $this->statusRequest; $this->data->featurepunkte = (int) $status->featurepunkte(); $this->data->voting = (int) $status->voting(); } public function setPluginId() { $this->data->pluginId = (int) $this->oPlugin->getID(); } public function setJtlToken() { $this->data->jtlToken = $_SESSION["\152\x74\154\137\164\157\x6b\x65\156"]; } public function setPendingCronjobs() { $db = Shop::Container()->getDB(); $pendingSmartSearchCronjobs = $db->query("\x53\x45\114\105\x43\x54\40\x43\x4f\125\x4e\x54\50\52\51\40\141\163\40\x63\157\x75\156\x74\40\106\x52\x4f\115\40\x78\x70\x6c\165\x67\x69\x6e\x5f\141\x64\155\x6f\162\162\x69\x73\x5f\160\162\x6f\137\x73\145\141\x72\143\x68\137\143\162\157\156\x20\x57\x48\x45\122\x45\40\x63\x72\157\x6e\123\164\x61\164\165\x73\x20\x3d\x20\x30\40\101\x4e\x44\x20\x69\164\x65\x6d\104\145\x6c\145\164\x65\40\x3d\x20\60", 2); $this->data->pendingSmartSearchCronjobs = $pendingSmartSearchCronjobs[0]->count; $pendingMailChimpCronjobs = $db->query("\123\105\114\x45\103\x54\40\103\117\x55\x4e\124\x28\52\x29\x20\141\163\40\143\x6f\165\x6e\x74\x20\106\122\x4f\115\x20\x78\160\154\x75\147\x69\156\x5f\141\x64\155\157\162\x72\x69\x73\x5f\160\162\x6f\137\155\141\x69\154\143\x68\151\x6d\x70\x5f\x63\162\157\x6e\40\127\x48\x45\122\x45\40\143\x72\157\x6e\x53\164\x61\164\x75\x73\x20\75\x20\x30\40\x41\116\104\40\x69\x74\x65\x6d\x44\145\x6c\145\164\145\x20\75\x20\x30", 2); $this->data->pendingMailChimpCronjobs = $pendingMailChimpCronjobs[0]->count; } public function setTaxClasses() { $this->data->taxClasses = AdmorrisLib::getTaxClasses(); } public function setBackendLanguage() { $this->data->backendLanguage = explode("\x2d", Shop::getCurAdminLangTag())[0]; } public function setKcfinder() { if (!defined("\x50\x46\101\104\x5f\113\103\x46\111\116\x44\105\122")) { goto OA80A; } $this->data->kcfinder = $this->data->shopUrl . "\57" . \PFAD_KCFINDER; OA80A: } public function setUrls() { $this->data->adminMenuUrl = $this->oPlugin->getPaths()->getAdminURL(); $this->data->frontendUrl = $this->oPlugin->getPaths()->getFrontendURL(); $this->data->pluginUrl = $this->data->shopUrl . "\x2f\x70\154\x75\x67\x69\156\163\x2f\141\x64\x6d\157\162\162\x69\x73\137\x70\x72\157\57"; $this->data->themeFolder = $this->data->shopUrl . "\x2f\x74\145\x6d\x70\154\141\164\x65\x73\x2f\x61\144\x6d\157\162\162\151\x73\137\x70\162\x6f\x2f\x74\x68\x65\x6d\145\x73\x2f\141\144\155\157\x72\162\x69\x73\57"; } public function setFlags() { $this->data->flags = new stdClass(); $this->data->flags->newsfeed_preview = defined("\101\104\115\x4f\122\122\x49\x53\x5f\120\x52\117\x5f\x4e\x45\127\123\x46\105\x45\x44\x5f\x50\x52\105\x56\x49\105\x57") && constant("\x41\104\115\x4f\122\122\x49\x53\x5f\120\122\x4f\x5f\116\105\x57\x53\106\x45\105\104\137\120\x52\x45\x56\x49\105\127") === true; } }