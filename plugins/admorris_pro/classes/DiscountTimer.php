<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro; use JTL\Cart\CartItem; use JTL\DB\DbInterface; use JTL\DB\NiceDB; use JTL\DB\ReturnType; use JTL\Plugin\PluginInterface; use JTL\Session\Frontend; use JTL\Shop; use Plugin\admorris_pro\AssetLoader; use function Plugin\admorris_pro\getSetting; class DiscountTimer { private $db; private $settings; private $plugin; private $getSetting; public function __construct(PluginInterface $plugin, DbInterface $db) { $this->plugin = $plugin; $this->db = $db; $this->getSetting = getSettingsGroup("\155\141\162\153\145\164\151\156\147\x5f\144\151\x73\143\x6f\165\156\x74\x5f\164\x69\155\145\x72", $plugin); } public function createCoupon($kArtikel) { goto xQJAI; YhZz0: if (!($couponId <= 0)) { goto FS8D1; } return; FS8D1: $data = $this->db->query("\x53\x45\x4c\x45\x43\x54\40\x63\111\123\x4f\x20\x46\x52\117\115\40\164\163\160\162\x61\143\x68\145", 2); foreach ($data as $cISO) { $dataCouponLang = new \stdClass(); $dataCouponLang->kKupon = $couponId; $dataCouponLang->cISOSprache = $cISO->cISO; $dataCouponLang->cName = "{$couponName}"; $this->db->insert("\164\x6b\x75\160\x6f\156\163\160\162\141\x63\x68\x65", $dataCouponLang); VPt2S: } qQTBp: $dataDiscountTimer = (object) ["\163\145\163\x73\x69\x6f\156\x54\x6f\153\x65\156" => $jtl_token, "\x76\141\x6c\x69\x74\x79" => $timerTime, "\143\157\165\x70\x6f\x6e\x43\x6f\144\x65" => $couponCode, "\153\113\165\x70\157\156" => $couponId]; $this->db->insert("\x78\160\x6c\165\147\151\x6e\137\x61\x64\155\x6f\x72\162\151\163\x5f\x70\x72\157\x5f\144\x69\163\x63\157\165\x6e\164\137\164\x69\155\x65\162\x5f\164\145\155\x70", $dataDiscountTimer); SZfZQ: goto xQOUF; xQJAI: if ($this->didCartItemCountChange()) { goto besb6; } return; besb6: $jtl_token = $_SESSION["\152\x74\x6c\x5f\164\157\x6b\x65\156"]; $data = $this->db->query("\123\x45\114\x45\103\x54\x20\x69\144\x20\x46\122\117\115\x20\x78\x70\154\x75\x67\151\x6e\x5f\141\144\x6d\157\x72\162\x69\x73\x5f\x70\x72\x6f\137\144\x69\x73\x63\x6f\x75\x6e\164\x5f\164\151\x6d\x65\x72\137\164\145\155\160\40\x57\x48\105\x52\105\x20\x73\x65\163\x73\151\157\156\124\x6f\x6b\145\x6e\40\x3d\x20\x27{$jtl_token}\x27", ReturnType::ARRAY_OF_OBJECTS); $timerTime = new \DateTime(); $timeNow = $timerTime->format("\131\x2d\155\55\x64\x20\110\72\151\72\x73"); if (empty($data)) { goto BF9p7; } return; BF9p7: goto Xbk4b; mJqvE: $categoryCheck = false; foreach ($categoryData as $key => $value) { if (!in_array($categoryData[$key]->kKategorie, $categoryArray)) { goto Gh82M; } $categoryCheck = true; Gh82M: xDs1V: } pkJoQ: goto j_yic; d8_Dx: $categoryCheck = true; j_yic: if ($manufacturer === "\55\61") { goto odyrR; } $manufacturerArray = explode("\x3b", $manufacturer); $manufacturerCheck = in_array($productData->kHersteller, $manufacturerArray); goto GLiGd; ySc3I: $category = $getSetting("\143\141\x74\x65\x67\x6f\x72\171"); $fullCart = $getSetting("\146\165\x6c\x6c\137\143\x61\x72\164"); $kKundengruppe = !empty($_SESSION["\113\165\156\x64\x65\x6e\x67\x72\x75\x70\x70\145"]) ? $_SESSION["\113\x75\156\144\x65\156\x67\x72\x75\160\x70\x65"]->getID() : null; $productData = $this->db->query("\x53\105\x4c\x45\103\x54\40\143\x41\162\x74\x4e\x72\x2c\x20\153\x48\x65\162\x73\x74\x65\154\154\145\x72\x20\x46\122\x4f\115\40\164\x61\162\164\151\x6b\x65\x6c\40\127\110\105\x52\x45\x20\x6b\101\x72\x74\151\x6b\145\154\x20\75\x20\47{$kArtikel}\x27", ReturnType::SINGLE_OBJECT); if ($coustomerGroup === "\x2d\x31" || $coustomerGroup == $kKundengruppe) { goto nR_mX; } $coustomerGroupCheck = false; goto mxdJW; nR_mX: $coustomerGroupCheck = true; mxdJW: goto S8wlb; S8wlb: if ($products === '') { goto S7FXk; } $productsArray = explode("\73", $products); $productsCheck = in_array($productData->cArtNr, $productsArray); goto Kw0O8; S7FXk: $productsCheck = true; Kw0O8: if ($category === "\55\61") { goto d8_Dx; } $categoryData = $this->db->query("\x53\105\114\x45\103\124\x20\x6b\x4b\141\164\145\x67\157\x72\151\x65\40\106\x52\117\x4d\40\x74\x6b\x61\164\145\147\157\162\x69\145\x61\162\164\151\x6b\145\x6c\40\127\110\x45\122\x45\40\153\x41\162\164\x69\x6b\x65\154\x20\x3d\40\x27{$kArtikel}\47", 2); $categoryArray = explode("\x3b", $category); goto mJqvE; Xbk4b: $getSetting = $this->getSetting; $timerMinutes = $getSetting("\164\x69\x6d\145"); $timerDiscount = $getSetting("\144\151\x73\143\157\x75\156\x74"); $couponName = $getSetting("\156\141\x6d\x65"); $couponTyp = $getSetting("\144\x69\163\x63\157\165\156\x74\164\171\160"); $minimalOrderValue = $getSetting("\155\x69\156\151\x6d\x61\x6c\137\x6f\162\x64\145\x72\x5f\x76\x61\154\165\145"); $tax = $getSetting("\x74\x61\x78"); $coustomerGroup = $getSetting("\143\x75\163\x74\157\155\x65\x72\137\147\162\157\x75\160"); $products = $getSetting("\141\x72\x74\151\x63\x6c\x65"); $manufacturer = $getSetting("\x6d\141\x6e\x75\x66\141\x63\x74\165\x72\145\162"); goto ySc3I; GLiGd: goto Csne2; odyrR: $manufacturerCheck = true; Csne2: if (!($coustomerGroupCheck && $productsCheck && $manufacturerCheck && $categoryCheck)) { goto SZfZQ; } $timerTime->modify("\x2b\x20{$timerMinutes}\x20\x6d\x69\156\x75\x74\145\x73"); $timerTime = $timerTime->format("\x59\55\x6d\55\x64\40\110\x3a\x69\x3a\163"); $couponCode = $this->generateRandomString(); $dataCouponCode = (object) ["\x6b\113\x75\156\144\x65\x6e\147\162\165\x70\160\145" => $coustomerGroup, "\153\x53\x74\145\165\x65\162\x6b\x6c\x61\x73\163\145" => $tax, "\143\x4e\141\155\145" => "{$couponName}", "\x66\x57\x65\x72\164" => $timerDiscount, "\143\x57\145\x72\x74\124\171\160" => "{$couponTyp}", "\x64\x47\x75\145\x6c\x74\x69\x67\101\x62" => $timeNow, "\144\107\x75\x65\154\164\151\147\102\151\x73" => $timerTime, "\x66\115\x69\156\x64\145\x73\x74\142\145\163\164\x65\x6c\154\167\x65\x72\164" => $minimalOrderValue, "\x63\103\x6f\144\x65" => "{$couponCode}", "\156\x56\145\x72\x77\x65\156\144\165\x6e\147\145\156" => 1, "\143\101\x72\x74\151\x6b\145\x6c" => $products, "\x63\x48\145\162\163\164\x65\154\x6c\145\x72" => $manufacturer, "\143\113\141\164\145\147\x6f\162\x69\x65\x6e" => $category, "\x63\113\165\156\144\x65\156" => "\x2d\x31", "\143\x4b\165\160\157\156\x54\x79\160" => "\163\164\x61\156\144\x61\162\x64", "\x63\x5a\165\x73\141\164\172\147\x65\x62\165\145\150\x72\145\156" => "\x4e", "\143\101\153\164\x69\x76" => "\131", "\x64\x45\x72\163\x74\145\154\x6c\x74" => $timeNow, "\156\x47\x61\156\172\x65\156\x57\x4b\122\x61\142\x61\x74\x74\151\x65\x72\x65\x6e" => $fullCart]; $couponId = $this->db->upsert("\x74\153\165\x70\x6f\x6e", $dataCouponCode); goto YhZz0; xQOUF: } public function deleteExpiredCoupons() { $data = $this->db->query("\x53\x45\114\105\103\124\40\x6b\x4b\165\x70\157\156\40\106\x52\x4f\x4d\x20\170\160\x6c\165\147\x69\x6e\137\x61\x64\155\157\x72\x72\x69\163\137\160\x72\x6f\x5f\144\151\x73\143\157\x75\156\164\x5f\164\x69\x6d\x65\x72\x5f\x74\x65\155\160\x20\x57\110\105\122\x45\x20\x76\141\154\x69\164\x79\x20\x3c\40\116\117\127\50\x29", 2); foreach ($data as $kKupon) { $this->db->delete("\x78\160\x6c\x75\x67\x69\156\137\x61\144\x6d\157\x72\162\151\163\x5f\160\x72\157\x5f\x64\151\x73\143\x6f\x75\156\164\137\164\x69\x6d\x65\x72\137\164\145\155\160", "\x6b\x4b\165\160\157\x6e", $kKupon->kKupon); $this->db->delete("\x74\x6b\x75\x70\157\x6e", "\x6b\x4b\x75\160\157\156", $kKupon->kKupon); $this->db->delete("\164\153\165\160\x6f\x6e\163\160\x72\141\x63\x68\x65", "\153\x4b\165\160\x6f\x6e", $kKupon->kKupon); KAEgM: } AdL11: } private function generateRandomString(int $length = 6) : string { $characters = "\x30\x31\62\x33\64\65\x36\67\x38\x39\141\142\x63\x64\x65\x66\147\150\x69\152\153\x6c\155\156\x6f\x70\161\x72\x73\x74\165\x76\x77\170\171\x7a\101\102\x43\x44\x45\106\x47\x48\111\x4a\113\x4c\115\x4e\117\x50\x51\122\123\x54\125\126\127\130\131\132"; $charactersLength = strlen($characters); $randomString = ''; $i = 0; SVt1s: if (!($i < $length)) { goto WC4IY; } $randomString .= $characters[rand(0, $charactersLength - 1)]; KECaD: $i++; goto SVt1s; WC4IY: return $randomString; } public function showModal(AssetLoader $assetLoader) : void { goto ZON4t; kd9Wz: $assetLoader->loadShared("\143\x6f\165\156\164\144\x6f\167\x6e"); $assetLoader->loadShared("\146\x6c\x69\160\103\154\x6f\x63\153"); $frontendPath = $this->plugin->getPaths()->getFrontendPath(); $modalTemplatePath = $frontendPath . "\164\x65\155\x70\154\x61\164\145\163\57\155\x61\x72\153\145\164\x69\156\147\x5f\x64\151\163\x63\x6f\165\156\164\137\164\151\155\x65\162\x5f\155\x6f\x64\141\154\x2e\164\160\x6c"; $modalTemplate = $smarty->createTemplate($modalTemplatePath, $smartyData); pq("\x62\157\144\171")->append($modalTemplate->fetch()); $widgetTemplatePath = $frontendPath . "\164\x65\155\x70\x6c\141\x74\x65\163\57\x6d\141\x72\153\145\x74\x69\x6e\x67\x5f\x64\x69\x73\143\x6f\x75\x6e\x74\x5f\x74\151\x6d\x65\162\137\x77\x69\x64\x67\x65\x74\x2e\x74\x70\x6c"; $widgetTemplate = $smarty->createTemplate($widgetTemplatePath, $smartyData); pq("\x62\x6f\x64\x79")->append($widgetTemplate->fetch()); $url = $this->plugin->getPaths()->getFrontendURL(); goto OcDYl; kDHCs: $smartyData->assign("\155\x69\x6e\x69\x6d\141\154\x5f\x6f\162\x64\x65\162\137\x76\x61\x6c\x75\x65", $getSetting("\155\151\156\x69\155\141\x6c\x5f\157\x72\144\145\162\x5f\x76\141\x6c\x75\145")); $discount_type = $getSetting("\144\x69\163\x63\157\x75\x6e\164\x74\171\160"); if ($discount_type == "\160\162\157\172\x65\156\x74") { goto OamYx; } $discounttype = "\40" . $_SESSION["\x63\127\141\x65\150\x72\165\156\x67\x4e\141\x6d\145"]; goto zctoN; OamYx: $discounttype = "\46\43\x30\x33\x37\73"; zctoN: $smartyData->assign("\144\151\x73\143\157\x75\x6e\164\164\x79\160", $discounttype); $smartyData->assign("\x68\x65\141\x64\x6c\151\x6e\x65", $getTranslation("\150\x65\x61\x64\154\x69\156\145")); goto X37Vi; cK8lW: $validity = new \DateTime($data->vality); $validityIso = $validity->format("\143"); $getSetting = $this->getSetting; $getTranslation = getTranslationGroup("\155\141\x72\153\x65\x74\151\x6e\x67\137\x64\151\x73\x63\157\165\x6e\164\137\x74\151\155\x65\162", $this->plugin); $smartyData = $smarty->createData($smarty); $smartyData->assign("\x63\157\x75\160\x6f\x6e\x5f\143\157\144\x65", $data->couponCode); $smartyData->assign("\166\141\154\151\144\x69\164\171\111\x73\x6f", $validityIso); $smartyData->assign("\166\141\x6c\x69\144\x69\x74\x79", $data->vality); $smartyData->assign("\156\157\x77", $nowIso); $smartyData->assign("\x64\x69\x73\143\157\x75\156\x74", $getSetting("\x64\151\163\143\157\165\x6e\164")); goto kDHCs; OcDYl: $assetLoader->addToHead([$url . "\x63\x73\163\x2f\144\151\x73\143\157\x75\156\164\55\164\151\155\x65\x72\x2e\143\x73\x73", $url . "\x63\163\x73\x2f\160\x6f\160\165\160\x2e\143\x73\x73"], "\144\x69\x73\143\x6f\x75\x6e\164\x2d\164\x69\x6d\x65\162"); goto BSmyz; ZON4t: $this->saveCartItemCount(); $jtl_token = $_SESSION["\152\x74\154\x5f\x74\157\x6b\x65\x6e"]; $smarty = Shop::Smarty(); $now = new \DateTime(); $timeNow = $now->format("\x59\55\155\55\x64\40\x48\x3a\151\72\163"); $nowIso = $now->format("\x63"); $data = $this->db->query("\x53\105\x4c\x45\x43\124\x20\52\x20\x46\122\x4f\x4d\40\x78\160\154\x75\x67\x69\156\x5f\x61\x64\x6d\157\x72\x72\x69\163\x5f\160\162\157\137\x64\x69\x73\x63\157\165\156\164\x5f\164\151\155\x65\162\137\x74\x65\155\160\40\x57\x48\x45\x52\105\40\x73\x65\163\163\x69\157\x6e\x54\157\153\x65\156\x20\75\x20\47{$jtl_token}\47\x20\101\116\104\40\166\141\154\151\164\171\40\76\x3d\40\x27{$timeNow}\x27", ReturnType::SINGLE_OBJECT); if (!empty($data)) { goto Hox10; } return; Hox10: goto cK8lW; X37Vi: $smartyData->assign("\163\x75\142\154\151\156\145", $getTranslation("\x73\165\x62\x6c\151\x6e\145")); $smartyData->assign("\143\x61\x6c\x6c\137\x74\x6f\137\141\x63\164\151\x6f\156\x5f\x62\165\164\x74\157\x6e", $getTranslation("\x63\x61\154\154\137\164\157\137\x61\x63\x74\x69\x6f\156\x5f\142\165\x74\164\157\x6e")); $smartyData->assign("\x63\141\x6e\143\x65\x6c\x5f\142\165\x74\164\157\156", $getTranslation("\x63\x61\x6e\143\x65\154\137\x62\165\x74\164\157\156")); $name = $getSetting("\156\141\x6d\145"); $style = $getSetting("\x73\164\171\154\x65"); $smartyData->assign("\156\x61\x6d\145", $name); $smartyData->assign("\x73\164\171\154\145", $style); if (!($getSetting("\143\141\x74\145\x67\x6f\162\171") != -1 || $getSetting("\155\141\x6e\x75\146\141\x63\164\165\162\x65\x72") != -1 || $getSetting("\x61\162\164\x69\143\x6c\x65"))) { goto WkH3T; } $smartyData->assign("\141\144\x64\151\164\151\x6f\156\x61\154\x5f\x69\156\146\x6f", $getTranslation("\141\144\144\151\x74\x69\157\156\141\154\x5f\x69\156\x66\157")); WkH3T: goto kd9Wz; BSmyz: } private function getCartItemCount() { $cartItems = Frontend::getCart()->PositionenArr; $cartItemCount = array_reduce($cartItems, function ($carry, CartItem $item) { return $carry + $item->nAnzahl; }, 0); return $cartItemCount; } private function saveCartItemCount() : void { $cartItemCount = $this->getCartItemCount(); Frontend::set("\141\x64\155\157\x72\x72\151\163\120\162\157\56\x63\x61\162\164\x49\x74\x65\155\103\157\165\x6e\x74", $cartItemCount); } private function didCartItemCountChange() : bool { $cartItemCount = $this->getCartItemCount(); $lastCartItemCount = Frontend::get("\141\x64\155\x6f\162\x72\151\163\x50\x72\157\56\x63\x61\x72\164\111\164\145\x6d\103\157\x75\156\x74"); if (!($cartItemCount > $lastCartItemCount)) { goto Hl3As; } return true; Hl3As: return false; } }