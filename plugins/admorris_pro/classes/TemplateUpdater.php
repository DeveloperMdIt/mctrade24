<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro; use Exception; use InvalidArgumentException; use JTL\Alert\Alert; use JTL\Cache\JTLCacheInterface; use JTL\DB\DbInterface; use JTL\DB\ReturnType; use JTL\Helpers\Form; use JTL\Helpers\Overlay; use JTL\Helpers\Request; use JTL\Plugin\Admin\Installation\InstallationResponse; use JTL\Services\JTL\AlertServiceInterface; use JTL\Shop; use JTL\Smarty\JTLSmarty; use JTL\Template\Admin\Validation\TemplateValidator; use JTL\Template\BootChecker; use JTL\Template\Config; use JTL\Template\Model; use JTL\Template\XMLReader; use JTLShop\SemVer\Version; use stdClass; class TemplateUpdater { private $db; private $cache; private $currentTemplateDir; private $config; public function __construct(string $dir, DbInterface $db, JTLCacheInterface $cache) { $this->db = $db; $this->cache = $cache; $this->currentTemplateDir = $dir; if (\is_dir(\PFAD_ROOT . \PFAD_TEMPLATES . $this->currentTemplateDir)) { goto UyBh0; } $this->currentTemplateDir = null; $valid = false; throw new Exception("\124\x65\x6d\160\x6c\x61\164\145\x20\144\x69\162\x65\x63\x74\x6f\162\x79\x20{$this->currentTemplateDir}\x20\156\x6f\x74\x20\146\157\165\156\144", 1); UyBh0: $this->config = new Config($this->currentTemplateDir, $this->db); } private function setActiveTemplate(string $dir, string $type = "\163\164\x61\156\x64\x61\162\x64") : bool { try { goto UjK73; K0w1c: $model->setFramework((string) $tplConfig->Framework); Yfud9: $model->setBootstrap((int) \file_exists(\PFAD_ROOT . \PFAD_TEMPLATES . $dir . "\x2f\102\157\157\x74\x73\x74\x72\x61\x70\56\160\x68\x70")); $save = $model->save(); if (!($save === true)) { goto JDgj_; } if ($dh = \opendir(\PFAD_ROOT . \PFAD_COMPILEDIR)) { goto UY4Fc; } return false; UY4Fc: i7vwv: if (!(($obj = \readdir($dh)) !== false)) { goto cI0Si; } goto TEafU; wKf5r: return $save; goto b3LLg; fPBMi: Xlye5: $parent = (string) $tplConfig->Parent; $parentConfig = $reader->getXML($parent); iKxpS: $model = new Model($this->db); if (!isset($tplConfig->ExsID)) { goto OfNH1; } $model->setExsID((string) $tplConfig->ExsID); OfNH1: $model->setCTemplate($dir); $model->setType($type); goto iYcS0; UjK73: $this->db->delete("\164\x74\145\155\x70\x6c\x61\164\x65", "\145\124\171\x70", $type); $this->db->delete("\164\x74\x65\x6d\160\x6c\x61\164\145", "\143\x54\145\x6d\160\154\141\164\x65", $dir); $reader = new XMLReader(); $tplConfig = $reader->getXML($dir); if ($tplConfig !== null && !empty($tplConfig->Parent)) { goto g1bll; } $parentConfig = false; goto iKxpS; g1bll: if (\is_dir(\PFAD_ROOT . \PFAD_TEMPLATES . $tplConfig->Parent)) { goto Xlye5; } return false; goto fPBMi; TEafU: if (!(\mb_strpos($obj, "\x2e") === 0)) { goto U4TI2; } goto i7vwv; U4TI2: if (\is_dir(\PFAD_ROOT . \PFAD_COMPILEDIR . $obj)) { goto lKyQU; } \unlink(\PFAD_ROOT . \PFAD_COMPILEDIR . $obj); lKyQU: goto i7vwv; cI0Si: JDgj_: $this->cache->flushTags([\CACHING_GROUP_OPTION, \CACHING_GROUP_TEMPLATE]); goto wKf5r; iYcS0: if (empty($tplConfig->Parent)) { goto jWzvu; } $model->setParent((string) $tplConfig->Parent); jWzvu: $model->setName((string) $tplConfig->Name); $model->setAuthor((string) $tplConfig->Author); $model->setUrl((string) $tplConfig->URL); $model->setPreview((string) $tplConfig->Preview); $version = empty($tplConfig->Version) && $parentConfig ? (string) $parentConfig->Version : (string) $tplConfig->Version; $model->setVersion($version); if (empty($tplConfig->Framework)) { goto Yfud9; } goto K0w1c; b3LLg: } catch (\Throwable $th) { $currentFrontendTemplate = $this->db->select("\x74\164\x65\155\x70\x6c\x61\x74\145", "\x65\124\x79\160", "\x73\164\141\156\144\141\162\164"); $log = Shop::Container()->getLogService(); $log->error($th); if (!empty($currentFrontendTemplate)) { goto MXqlW; } $this->db->query("\x49\x4e\x53\x45\122\x54\x20\111\116\124\x4f\x20\x60\x74\x74\145\155\160\x6c\x61\x74\145\140\x20\x28\x60\143\124\x65\x6d\160\x6c\141\x74\x65\140\x2c\x20\x60\145\124\x79\x70\x60\x2c\40\140\x70\141\162\x65\156\164\x60\x2c\x20\140\x6e\x61\155\145\140\54\40\140\x61\x75\x74\150\x6f\x72\x60\54\x20\x60\165\162\x6c\140\54\x20\x60\x76\x65\162\163\151\157\x6e\140\54\40\140\160\162\x65\x76\x69\x65\167\x60\54\x20\x60\x65\170\x73\x49\104\x60\54\x20\x60\x62\157\x6f\x74\x73\164\x72\141\160\x60\x2c\x20\140\x66\x72\141\155\145\x77\x6f\162\x6b\140\51\40\x56\x41\x4c\125\105\x53\x20\40\xa\40\x20\40\40\40\x20\40\x20\x28\47\141\144\155\x6f\x72\162\151\163\x5f\160\x72\157\47\54\x20\x27\x73\x74\141\x6e\x64\141\x72\x64\47\54\x20\116\x55\x4c\114\54\40\x27\141\144\x6d\x6f\162\162\151\163\x20\120\x72\157\47\x2c\x20\x27\141\144\x6d\157\x72\162\x69\163\47\54\40\47\150\x74\164\x70\x73\x3a\x2f\x2f\141\x64\x6d\x6f\162\x72\151\163\56\x70\162\157\47\54\40\47\62\x2e\x34\x2e\x31\x39\47\54\x20\47\x70\162\145\x76\151\145\167\x2e\160\x6e\147\47\x2c\40\x4e\125\x4c\114\x2c\40\x31\x2c\x20\47\102\x6f\x6f\x74\163\164\162\x61\x70\x33\x27\51\x3b"); MXqlW: return false; } } public function saveConfig() { $parentFolder = null; $reader = new XMLReader(); $tplXML = $reader->getXML($this->currentTemplateDir); if (!($tplXML !== null && !empty($tplXML->Parent))) { goto nIhtD; } $parentFolder = (string) $tplXML->Parent; nIhtD: $tplConfXML = $this->config->getConfigXML($reader, $parentFolder); foreach ($tplConfXML as $config) { foreach ($config->settings as $setting) { $this->config->updateConfigInDB($setting->section, $setting->key, $setting->value); $this->cache->flushTags([\CACHING_GROUP_OPTION, \CACHING_GROUP_TEMPLATE]); VZSuv: } LUoUe: bAK1a: } edoKs: $check = $this->setActiveTemplate($this->currentTemplateDir); $this->db->query("\125\120\104\x41\124\x45\x20\x74\x67\154\157\x62\x61\154\x73\40\x53\105\x54\40\x64\114\x65\164\x7a\x74\x65\101\145\x6e\x64\x65\162\x75\156\x67\x20\75\x20\x4e\117\x57\x28\x29", ReturnType::DEFAULT); return $check; } }