<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro; use JTL\Shop; use JTL\Plugin\Plugin; use JTL\Session\Frontend; use JTL\Catalog\Product\Artikel; use JTL\Events\Dispatcher; use JTL\Cron\Job; use JTL\Plugin\PluginInterface; class ExtraProduct { public $product; private $customer_group; private static PluginInterface $plugin; function __construct() { $smarty = Shop::Smarty(); if (!(Shop::getPageType() !== PAGE_ARTIKEL)) { goto Wf6CM; } return; Wf6CM: $Artikel = $smarty->getTemplateVars("\x41\162\x74\x69\153\145\154"); $optionalExtraProductID = $Artikel->FunktionsAttribute["\x6f\160\164\x69\157\x6e\141\x6c\x5f\x65\x78\x74\x72\141\x5f\x70\x72\x6f\x64\165\143\164\137\151\144"] ?? null; if ($optionalExtraProductID) { goto BMs6O; } return; BMs6O: $this->loadStyles(); $this->customer_group = !empty($_SESSION["\113\165\x6e\144\145\x6e\147\x72\x75\160\x70\x65"]) ? $_SESSION["\x4b\165\x6e\x64\145\156\x67\x72\x75\x70\x70\x65"]->getID() : null; $optionalExtraProduct = Shop::Container()->getDB()->select("\164\141\x72\164\x69\153\x65\x6c", "\143\101\162\x74\x4e\x72", $optionalExtraProductID); $product = new Artikel(); $product->fuelleArtikel($optionalExtraProduct->kArtikel, null, $this->customer_group, $_SESSION["\x6b\x53\160\x72\141\x63\150\x65"], true); $this->product = $product; } public static function initHooks(PluginInterface $plugin, Dispatcher $dispatcher) { self::$plugin = $plugin; $active = $plugin->getConfig()->getValue("\141\144\155\x6f\x72\162\x69\x73\137\160\x72\157\137\155\x61\162\x6b\x65\x74\151\156\147\137\145\170\164\x72\141\137\160\x72\157\x64\x75\x63\164\x5f\x61\143\x74\151\166\145") === "\x59"; if ($active) { goto vMqUw; } return; vMqUw: $dispatcher->listen("\x73\150\x6f\160\x2e\150\x6f\x6f\x6b\56" . \HOOK_WARENKORB_CLASS_FUEGEEIN, function (array $args_arr) { self::addProduct($args_arr["\153\101\x72\164\151\153\145\154"]); self::addOptionalExtraProduct(); }); $dispatcher->listen("\x73\x68\157\x70\x2e\150\157\157\153\56" . \HOOK_LETZTERINCLUDE_INC, function () { self::addSmartyVariable(); if (!(Shop::getPageType() === \PAGE_PLUGIN)) { goto De7cw; } self::addProduct(); De7cw: }); $dispatcher->listen("\x73\x68\157\160\x2e\x68\157\x6f\x6b\x2e" . \HOOK_BESTELLABSCHLUSS_INC_BESTELLUNGINDB_ENDE, function (array $args_arr) use($plugin) { self::deleteFromXsellAndBestsellers($plugin, $args_arr["\157\102\x65\x73\164\x65\154\x6c\x75\x6e\147"]); }); $dispatcher->listen("\x73\150\x6f\x70\x2e\150\x6f\x6f\153\x2e" . \HOOK_BESTELLVORGANG_PAGE_STEPBESTAETIGUNG, function () { self::addProduct(); }); $dispatcher->listen("\x73\150\157\x70\56\150\157\157\153\56" . \HOOK_JTL_PAGE_MEINKKONTO, function () { self::addProduct(); }); $dispatcher->listen("\163\x68\x6f\x70\56\150\x6f\157\x6b\56" . \HOOK_WARENKORB_PAGE, function () { self::addProduct(); self::removeExessOptionalExtraProducts(); }); $dispatcher->listen("\163\x68\157\160\x2e\150\157\x6f\153\x2e" . \HOOK_WARENKORB_LOESCHE_POSITION, function (array $args) { $Artikel = $args["\160\157\163\x69\x74\151\x6f\156"]->Artikel; if (!isset($Artikel->FunktionsAttribute["\x6f\160\x74\151\157\x6e\x61\x6c\x5f\145\170\164\x72\141\137\x70\x72\157\144\165\143\x74\137\x69\x64"])) { goto qCsSY; } $pos = $args["\x6e\x50\157\163"]; self::removeOptionalExtraProduct($Artikel->FunktionsAttribute["\157\160\164\x69\157\156\141\154\137\x65\x78\x74\x72\x61\x5f\160\162\157\x64\x75\x63\164\137\151\x64"], $args["\160\157\163\151\164\151\x6f\x6e"]->nAnzahl, $pos); qCsSY: }); $dispatcher->listen("\x73\x68\157\160\56\x68\157\157\153\x2e" . \HOOK_JOBQUEUE_INC_BEHIND_SWITCH, function (array $args) { self::removeExtraProductFromTopSell($args["\x6a\157\x62"]); }); } private static function addSmartyVariable() { if (!(Shop::getPageType() === \PAGE_ARTIKEL && self::$plugin->getConfig()->getValue("\x61\144\155\157\x72\x72\151\x73\x5f\160\x72\x6f\137\155\x61\162\x6b\x65\x74\151\x6e\x67\137\145\x78\164\x72\x61\137\x70\x72\157\144\165\143\164\x5f\141\143\x74\151\166\x65") == "\131")) { goto mAf4D; } $extraProduct = new self(); Shop::Smarty()->assign("\x61\144\x6d\x6f\162\x72\x69\x73\137\160\162\157\137\x6d\141\162\153\x65\x74\151\156\147\x5f\145\170\164\162\141\x5f\160\x72\157\x64\165\143\164", $extraProduct); Shop::Smarty()->assign("\x61\x64\155\157\x72\x72\x69\163\x5f\x70\x72\x6f\x5f\x6d\x61\162\153\145\164\x69\x6e\147\137\x65\170\164\162\141\x5f\160\x72\157\x64\165\x63\x74\137\151\x6d\x61\147\x65", self::$plugin->getConfig()->getValue("\141\x64\155\x6f\162\162\151\163\x5f\x70\x72\157\137\155\x61\162\153\x65\164\x69\x6e\147\137\x65\x78\164\x72\141\137\160\162\x6f\144\165\143\164\137\151\x6d\x61\x67\145")); mAf4D: } private function loadStyles() { $smarty = Shop::Smarty(); $assetLoader = AssetLoader::getInstance(); $assetLoader->addToHead(self::$plugin->getPaths()->getFrontendURL() . "\x63\x73\x73\x2f\x6f\160\x74\151\157\x6e\x61\154\x2d\145\x78\164\x72\x61\55\x70\162\157\x64\x75\x63\x74\56\143\x73\163", "\x6f\x70\x74\151\157\156\141\x6c\x5f\145\170\x74\162\x61\x5f\160\x72\157\144\165\143\164"); } public static function addProduct(?int $productID = null) { if (!(!empty($productID) && Shop::has("\141\144\x6d\x6f\x72\162\151\x73\x50\x72\157\137\145\x78\164\162\x61\x70\x72\x6f\144\165\143\x74\163\x5f\x6c\141\x73\x74\x5f\x61\x64\144\145\x64"))) { goto kHN0d; } $last_extraproducts = Shop::get("\x61\x64\155\157\162\162\x69\163\120\x72\x6f\137\145\170\x74\x72\x61\x70\x72\157\x64\165\143\164\x73\137\154\x61\163\x74\x5f\141\144\x64\145\144"); if (!in_array($productID, $last_extraproducts)) { goto Ynu_i; } return; Ynu_i: kHN0d: $cart = Frontend::getCart(); foreach ($cart->PositionenArr as $i => $item) { if (!(isset($item->nPosTyp) && (int) $item->nPosTyp === \C_WARENKORBPOS_TYP_ARTIKEL && $item->cResponsibility == "\x61\x64\x6d\157\x72\162\x69\163\137\160\162\157\137\145\170\164\x72\x61\x5f\x70\162\x6f\x64\165\x63\x74" || !empty($item->Artikel->FunktionsAttribute["\145\170\164\162\141\x5f\160\162\x6f\144\x75\x63\x74\x5f\x6e\x6f\164\137\142\x75\x79\141\x62\x6c\x65"]) && $item->cResponsibility !== "\141\x64\155\157\x72\x72\x69\x73\x5f\x70\x72\x6f\x5f\x6f\160\164\x69\x6f\x6e\x61\154\137\x65\x78\x74\x72\141\137\160\x72\157\x64\x75\x63\164")) { goto aTaUr; } unset($cart->PositionenArr[$i]); aTaUr: MgHA4: } nCAw0: $cart->PositionenArr = \array_merge($cart->PositionenArr); $warenkorbpos = $cart->PositionenArr; $products = []; foreach ($warenkorbpos as $key => $pos) { $extra_product_id = $pos->Artikel->FunktionsAttribute["\x65\170\x74\162\x61\137\160\x72\x6f\144\165\x63\x74\137\x69\x64"] ?? null; if (!($extra_product_id !== null)) { goto C6f8t; } $extraKArtikel = Shop::Container()->getDB()->select("\x74\x61\162\164\x69\153\x65\x6c", "\x63\x41\162\164\x4e\162", $extra_product_id); if (empty($extraKArtikel)) { goto WPoz5; } $id = (int) $extraKArtikel->kArtikel; $products[$id] = (object) ["\x69\144" => $id, "\161\165\x61\156\164\151\164\x79" => isset($products[$id]) ? $products[$id]->quantity + $pos->nAnzahl : $pos->nAnzahl, "\x70\x72\x69\143\145" => (float) $extraKArtikel->fStandardpreisNetto, "\x6e\x61\x6d\x65" => $extraKArtikel->cName, "\164\141\170" => (int) $extraKArtikel->kSteuerklasse]; WPoz5: C6f8t: NUBhl: } z3uOY: $extraproducts_last_added = Shop::get("\x61\144\155\x6f\x72\162\151\163\120\x72\x6f\137\x65\170\x74\162\141\x70\x72\157\144\165\143\x74\163\x5f\x6c\x61\x73\x74\x5f\x61\x64\x64\x65\x64") ?? []; foreach ($products as $key => $product) { $extraproducts_last_added[] = $product->id; Shop::set("\x61\x64\155\x6f\x72\x72\x69\x73\x50\162\157\137\x65\x78\164\162\141\x70\x72\157\x64\165\x63\164\x73\x5f\x6c\x61\163\164\x5f\x61\144\x64\145\144", $extraproducts_last_added); $cart->fuegeEin($product->id, $product->quantity, [], \C_WARENKORBPOS_TYP_ARTIKEL, "\x61\x64\x6d\157\162\162\151\163\x5f\160\x72\157\137\x65\x78\164\162\x61\137\x70\162\x6f\x64\x75\143\164", 0, true, "\141\144\x6d\x6f\162\x72\151\163\137\x70\162\157\x5f\x65\170\164\x72\141\137\x70\x72\x6f\144\x75\143\164"); TO6xF: } jGSe9: self::updateCartSum(); self::rewindLastChangedItems($extraproducts_last_added); } public static function addOptionalExtraProduct() { goto n_GBL; SPvU1: $optionalExtraKArtikel = Shop::Container()->getDB()->select("\x74\x61\x72\164\151\x6b\x65\154", "\x63\x41\162\x74\116\162", $extraProductID) ?? null; if (empty($optionalExtraKArtikel)) { goto Yaoq_; } unset($_POST["\157\160\x74\x69\x6f\x6e\141\x6c\x2d\x65\170\164\x72\x61\55\160\162\x6f\x64\165\143\164"]); $cart = Frontend::getCart(); $unique = self::addVariationsToUnique("\141\x64\x6d\x5f\x6f\x70\x74\x65\170\x74" . $productID, $variations); $productExists = self::updateQuantityIfExistsInCart($productID, $optionalExtraKArtikel->kArtikel, $quantity, $unique); if (!$productExists) { goto TWnbE; } return; TWnbE: $cart->fuegeEin($optionalExtraKArtikel->kArtikel, $quantity, [], \C_WARENKORBPOS_TYP_ARTIKEL, $unique, 0, true, "\x61\144\155\x6f\162\162\151\x73\x5f\x70\x72\x6f\137\157\160\x74\x69\157\156\x61\x6c\x5f\x65\x78\164\x72\141\137\160\x72\157\x64\165\143\x74"); goto PbuAW; n_GBL: if (isset($_POST["\157\x70\164\x69\157\x6e\141\x6c\x2d\145\x78\x74\x72\x61\x2d\160\x72\x6f\x64\165\x63\x74"])) { goto sJiTR; } return; sJiTR: $productID = $_POST["\x61"] ?? null; $extraProductID = $_POST["\157\x70\x74\x69\x6f\156\141\154\x2d\x65\x78\164\x72\141\55\160\162\157\144\165\143\x74"] ?? null; $quantity = $_POST["\141\x6e\x7a\x61\150\x6c"] ?? null; $variations = $_POST["\x65\x69\x67\145\x6e\x73\x63\150\x61\x66\164\x77\x65\162\164"] ?? null; if (!(empty($productID) || empty($extraProductID) || empty($quantity))) { goto S7R3a; } return; S7R3a: goto SPvU1; PbuAW: $artArr = array(); array_push($artArr, $optionalExtraKArtikel->kArtikel); self::rewindLastChangedItems($artArr); Yaoq_: goto pIVTK; pIVTK: } public static function removeOptionalExtraProduct($extraProductID, $quantity, $pos) { $cart = Frontend::getCart(); $warenkorbpos = $cart->PositionenArr; foreach ($warenkorbpos as $i => $item) { if (!(isset($item->nPosTyp) && (int) $item->nPosTyp == 1 && $item->cResponsibility === "\x61\144\x6d\157\162\162\151\x73\137\160\162\x6f\x5f\x6f\x70\164\x69\157\156\141\x6c\x5f\x65\170\x74\162\x61\x5f\160\x72\157\144\165\143\164" && $item->cArtNr == $extraProductID && $i == $pos + 1)) { goto oJBSd; } unset($cart->PositionenArr[$i]); return; oJBSd: vXp3e: } YnoRs: } public static function removeExessOptionalExtraProducts() { $cart = Frontend::getCart(); $warenkorbpos = $cart->PositionenArr; $productsChanged = 0; foreach ($warenkorbpos as $i => $item) { if (!(isset($item->nPosTyp) && (int) $item->nPosTyp == 1 && isset($item->Artikel->FunktionsAttribute["\x6f\160\164\151\x6f\156\141\154\137\145\170\164\162\x61\137\x70\x72\x6f\144\165\143\164\x5f\151\x64"]))) { goto w3KDX; } $extraProductPos = $i + 1; if (!(isset($warenkorbpos[$extraProductPos]) && $warenkorbpos[$extraProductPos]->nAnzahl > $item->nAnzahl && $warenkorbpos[$extraProductPos]->cResponsibility === "\141\x64\155\x6f\x72\162\x69\x73\137\x70\x72\157\x5f\157\x70\x74\x69\x6f\x6e\x61\154\x5f\145\170\x74\x72\x61\x5f\x70\162\x6f\144\165\143\x74")) { goto F5r12; } $warenkorbpos[$extraProductPos]->nAnzahl = $item->nAnzahl; $productsChanged++; F5r12: w3KDX: UDFrC: } uJO_b: if (!($productsChanged === 0)) { goto S1r2n; } return; S1r2n: $cart->setzePositionsPreise(); self::updateCartSum(); } private static function updateCartSum() { $cart = Frontend::getCart(); Shop::Smarty()->assign("\127\x61\162\145\156\x73\x75\x6d\x6d\145\x4c\x6f\143\141\x6c\x69\172\x65\144", $cart->gibGesamtsummeWarenLocalized())->assign("\123\164\x65\x75\x65\162\x70\x6f\163\x69\x74\x69\157\156\145\x6e", $cart->gibSteuerpositionen()); } private static function updateQuantityIfExistsInCart($productID, $extraProductID, $quantity, $unique) { $cart = Frontend::getCart(); $warenkorbpos = $cart->PositionenArr; $productExists = false; foreach ($warenkorbpos as $i => $item) { if (!(isset($item->nPosTyp) && (int) $item->nPosTyp == 1 && $item->cResponsibility === "\141\144\x6d\x6f\162\162\151\163\137\x70\162\x6f\x5f\157\x70\164\x69\157\156\x61\154\137\145\170\164\x72\141\x5f\160\162\x6f\144\x75\x63\164" && $item->cUnique === $unique)) { goto Qx5Rl; } $quantityBefore = $item->nAnzahl; $quantity = $quantityBefore + $quantity; $item->nAnzahl = $quantity; $productExists = true; Qx5Rl: EEv3F: } p4t08: return $productExists; } private static function addVariationsToUnique($unique, $variations) { if (!empty($variations)) { goto o4tmE; } return $unique; o4tmE: foreach ($variations as $key => $value) { $unique .= $key . $value; cCpD8: } vGiWj: return $unique; } private static function rewindLastChangedItems(array $extraproducts_last_added) { $cart = Frontend::getCart(); foreach ($cart->PositionenArr as $i => $item) { if (!(isset($item->nZeitLetzteAenderung) && in_array($item->kArtikel, $extraproducts_last_added))) { goto Lo5sb; } $item->nZeitLetzteAenderung -= 1000; Lo5sb: VfmDH: } r27i0: } public static function deleteFromXsellAndBestsellers(\JTL\Plugin\PluginInterface $oPlugin, \JTL\Checkout\Bestellung $oBestellung) { if (!($oPlugin->getConfig()->getValue("\141\144\155\x6f\x72\162\151\x73\x5f\x70\162\x6f\137\x6d\141\162\x6b\145\x74\151\x6e\x67\137\145\170\164\162\x61\137\x70\162\x6f\x64\165\143\x74\x5f\141\143\164\151\166\x65") !== "\131")) { goto ep998; } return; ep998: $positionen = $oBestellung->Positionen; foreach ($positionen as $key => $position) { if (!($position->cUnique === 1000 || $position->cResponsibility === "\141\144\155\157\162\162\x69\163\137\160\x72\x6f\x5f\145\170\164\162\x61\x5f\160\162\x6f\x64\165\143\164" || $position->cResponsibility === "\x61\x64\x6d\157\x72\162\x69\x73\x5f\x70\162\157\137\157\160\x74\x69\157\156\x61\x6c\137\x65\170\x74\162\141\137\160\x72\157\x64\x75\x63\164")) { goto ZAZ3P; } Shop::Container()->getDB()->delete("\164\170\x73\145\x6c\x6c\153\141\165\146", "\153\x58\x53\x65\154\x6c\101\162\x74\x69\x6b\145\154", $position->kArtikel); Shop::Container()->getDB()->delete("\164\x62\145\163\164\163\145\x6c\x6c\x65\162", "\x6b\101\162\x74\x69\153\x65\154", $position->kArtikel); ZAZ3P: cwh7S: } rZM4U: } public static function removeExtraProductFromTopSell($job) { if (!(get_class($job) === "\x4a\124\114\x5c\x43\x72\x6f\156\x5c\x4a\157\x62\x5c\x54\x6f\x70\x53\x65\154\154\145\162")) { goto wIr8Y; } $query = "\x53\105\114\105\103\124\x20\x74\141\162\x74\151\153\145\x6c\56\x6b\x41\162\164\x69\153\x65\154\40\106\x52\117\115\x20\164\141\x72\164\151\x6b\x65\154\x20\112\117\x49\116\40\164\141\162\164\151\153\x65\154\x61\x74\x74\162\x69\x62\165\164\40\x4f\116\x20\164\141\162\164\x69\153\x65\154\x61\164\164\x72\x69\142\165\x74\x2e\x63\x57\145\x72\x74\40\75\40\x74\x61\x72\x74\x69\x6b\145\154\x2e\143\x41\162\164\x4e\x72\40\x57\x48\x45\122\x45\40\164\141\162\x74\151\153\x65\154\141\x74\164\162\x69\142\x75\x74\56\x63\x4e\141\x6d\145\40\x3d\40\47\145\170\164\162\141\137\160\162\157\x64\165\x63\164\x5f\151\144\x27\x20\147\x72\x6f\165\160\x20\142\x79\x20\x6b\x41\x72\x74\x69\x6b\145\154"; $extraProducts = Shop::Container()->getDB()->query($query, 2); if (empty($extraProducts)) { goto KLS4T; } foreach ($extraProducts as $key => $product) { Shop::Container()->getDB()->delete("\164\x62\145\x73\x74\x73\x65\154\x6c\x65\x72", "\x6b\101\162\164\x69\x6b\x65\154", $product->kArtikel); O9FJa: } sRHi3: KLS4T: wIr8Y: } }