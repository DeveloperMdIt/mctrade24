<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro; use JTL\Shop; class AssetLoader extends Singleton { private $head = []; private $body = []; private $embeddedStyles = ''; private $addLoadjs = false; private $shared = []; private $callbacks = []; protected function __construct() { if (isTemplateActive()) { goto i4HsX; } $this->addLoadjs = true; i4HsX: } private function add($location, $assets, $name, $loadingOption) { $this->{$location}[$name] = $assets; } public function addToHead($assets, $name, $loadingOption = false) { $this->add("\x68\145\x61\144", $assets, $name, $loadingOption); } public function addToBody($assets, $name, $loadingOption = false) { $this->add("\142\157\144\x79", $assets, $name, $loadingOption); } public function addEmbeddedStyles($styles) { $this->embeddedStyles .= $styles; } public function defineShared($location, $assets, $name) { $this->shared[$name] = (object) ["\154\x6f\x61\x64" => false, "\x6e\x61\155\145" => $name, "\x61\163\163\145\x74\x73" => $assets, "\x6c\x6f\143\x61\x74\151\x6f\156" => $location]; } public function defineCallback($name, $callback) { $this->callbacks[] = (object) ["\156\x61\x6d\145" => $name, "\143\141\x6c\154\142\x61\x63\x6b" => $callback]; } public function loadShared($name) { if (is_array($name)) { goto NxBl2; } $this->loadSharedItem($name); goto OXvqc; NxBl2: foreach ($name as $item) { $this->loadSharedItem($item); zNPWc: } AKLwt: OXvqc: } private function loadSharedItem($name) { if (!isset($this->shared[$name])) { goto IK3PL; } $this->shared[$name]->load = true; IK3PL: } private function getShared() { foreach ($this->shared as $key => $item) { if (!$item->load) { goto b51hH; } $this->{$item->location}[$item->name] = $item->assets; b51hH: BY4Vu: } xksOE: } public function run() { goto Mz7qo; QIwa_: $head .= $this->embeddedStyles; nqsAb: if (empty($this->head)) { goto H8tvh; } $head .= $this->generateDeferred("\150\145\x61\x64"); H8tvh: if (empty($this->body)) { goto BF6Bk; } $body .= $this->generateDeferred("\x62\x6f\x64\171"); BF6Bk: if (empty($this->callbacks)) { goto iva5h; } foreach ($this->callbacks as $cb) { $body .= "\x3c\x73\x63\162\x69\x70\x74\40\144\x65\x66\x65\162\x20\x73\162\143\75\x22\x64\141\164\x61\x3a\x74\x65\170\164\x2f\152\141\x76\x61\163\143\x72\151\x70\164\x3b\142\x61\163\145\66\64\x2c" . \base64_encode($cb->callback) . "\x22\x3e\x3c\57\163\143\x72\151\x70\x74\x3e"; oQaeI: } goto Rzj_2; Rzj_2: ym7uh: iva5h: if (empty($head)) { goto eanSe; } \pq("\x68\145\x61\x64")->append($head); eanSe: if (empty($body)) { goto JDBPC; } \pq("\142\x6f\144\x79")->append($body); JDBPC: goto SVSiE; Mz7qo: $body = ''; $head = ''; if (!$this->addLoadjs) { goto zbLCs; } $plugin = Shop::get("\x6f\160\x6c\x75\147\151\x6e\x5f\x61\x64\155\157\162\x72\x69\x73\137\x70\x72\157"); $pluginPath = $plugin->getPaths()->getBasePath(); $loadjs = file_get_contents($pluginPath . "\146\162\157\156\164\145\x6e\x64\57\166\145\x6e\144\157\162\57\154\157\141\x64\x6a\x73\56\x6d\x69\156\x2e\x6a\x73"); $head .= "\74\x73\x63\162\151\160\164\76{$loadjs}\x3c\57\163\143\x72\151\x70\x74\76\xa\x20\x20\40\40\x20\40\x3c\x73\x63\162\151\x70\x74\76\146\x75\x6e\143\x74\x69\x6f\156\x20\x61\144\x6d\x6f\x72\x72\x69\163\x70\162\157\137\162\x65\x61\144\171\50\144\51\173\x27\x6c\157\x61\x64\x69\x6e\x67\x27\41\x3d\x64\x6f\x63\x75\x6d\x65\x6e\x74\56\162\145\141\x64\171\123\x74\x61\164\145\x3f\144\50\51\x3a\144\157\143\165\x6d\145\x6e\164\56\x61\x64\x64\x45\x76\x65\156\x74\x4c\x69\163\164\145\156\145\162\50\x27\104\117\115\103\157\x6e\x74\x65\x6e\164\x4c\x6f\x61\x64\x65\144\47\54\144\51\175\74\57\163\x63\162\151\x70\164\76"; zbLCs: $this->getShared(); if (empty($this->embeddedStyles)) { goto nqsAb; } goto QIwa_; SVSiE: } private function generateLoadJs($location) { $loadjs = ''; $callbacks = ''; foreach ($this->{$location} as $key => $value) { if (is_array($value)) { goto w9iYn; } $value = prefixFileType($value); $valueStr = "\42" . addPluginVersion($value) . "\42"; goto NFWra; w9iYn: $value = array_map("\x50\x6c\x75\147\x69\156\x5c\141\144\x6d\157\x72\162\151\x73\x5f\160\x72\157\x5c\160\162\x65\146\x69\170\x46\151\154\145\x54\171\160\x65", $value); $value = array_map("\120\x6c\165\147\x69\x6e\x5c\141\x64\x6d\x6f\162\162\151\x73\137\x70\162\x6f\134\141\x64\x64\x50\x6c\x75\147\x69\x6e\x56\145\162\163\151\x6f\156", $value); $valueStr = "\x22" . implode("\42\54\x20\x22", $value) . "\42"; NFWra: $loadjs .= "\154\x6f\141\144\152\x73\x28\x5b{$valueStr}\135\54\x20\x27{$key}\x27\51\x3b"; ncGa0: } KYP8h: if (empty($this->callbacks)) { goto sPsX5; } foreach ($this->callbacks as $cb) { $callbacks .= "\x6c\157\x61\144\152\x73\56\x72\x65\141\144\171\50\47{$cb->name}\47\x2c\x20\146\165\x6e\x63\x74\151\x6f\x6e\x28\x29\x7b{$cb->callback}\x7d\x29\x3b"; uKAVO: } GIq1B: sPsX5: $customTemplateSettings = Shop::get("\x61\x64\x6d\x6f\x72\x72\x69\x73\x2d\x63\165\163\164\x6f\x6d\55\x74\x65\155\x70\154\x61\164\145\55\163\145\164\164\x69\x6e\147\x73"); $isCheckout = Shop::Smarty()->getTemplateVars("\156\x53\x65\151\164\145\x6e\124\x79\160") === PAGE_BESTELLVORGANG; $jqueryAsyncSetting = $customTemplateSettings->jquery_async_loading && !$isCheckout; if (isTemplateActive() && $jqueryAsyncSetting && Shop::getPageType() !== PAGE_BESTELLVORGANG) { goto T0InB; } return "\74\163\x63\x72\151\160\x74\76{$loadjs}{$callbacks}\x3c\x2f\x73\143\x72\151\x70\x74\76"; goto jCay7; T0InB: return "\x3c\163\x63\x72\x69\160\x74\x3e\154\157\x61\144\x6a\163\56\162\x65\x61\x64\171\x28\47\x6a\x51\x75\x65\162\171\47\54\x20\146\x75\156\x63\x74\151\157\156\50\51\x20\x7b{$loadjs}{$callbacks}\x7d\x29\73\74\57\163\143\x72\151\x70\164\76"; jCay7: } private function generateDeferred($location) { $tags = ''; $location = $location; foreach ($this->{$location} as $item) { if (is_array($item)) { goto q5e2l; } $tags .= $this->buildTag(addPluginVersion($item)); goto i0llY; q5e2l: foreach ($item as $subItem) { $tags .= $this->buildTag(addPluginVersion($subItem)); GyaT8: } pKzpk: i0llY: bdHbf: } TQkO6: return $tags; } private function buildTag($src) { if (strpos($src, "\x2e\143\x73\x73") !== false) { goto Xb46j; } $tag = "\74\163\x63\x72\151\160\164\x20\163\x72\143\75\x22{$src}\42\x20\144\x65\x66\145\162\x3e\74\57\163\x63\x72\151\x70\164\x3e"; goto YaynY; Xb46j: $tag = "\x3c\154\x69\x6e\x6b\40\162\145\x6c\x3d\x22\x73\x74\171\154\145\x73\150\x65\145\x74\x22\40\x68\x72\145\x66\x3d\x22{$src}\x22\40\x6d\145\x64\x69\x61\75\42\160\x72\151\x6e\x74\x22\x20\157\156\x6c\157\141\x64\x3d\42\164\150\151\163\x2e\155\145\144\x69\x61\x3d\47\x61\154\154\47\x22\x3e"; YaynY: return $tag; } } function prefixFileType($file) { if (!(strpos($file, "\x2e\143\x73\x73") !== false)) { goto dtqDf; } $file = "\143\163\x73\x21" . $file; dtqDf: return $file; } function addPluginVersion($file) { $plugin = Shop::get("\157\160\154\x75\x67\151\156\x5f\141\144\x6d\x6f\x72\162\x69\x73\137\x70\162\x6f"); if (!empty($plugin)) { goto bpb4K; } return $file; bpb4K: $version = $plugin->getMeta()->getVersion(); return $file . "\77\166\x3d" . $version; }