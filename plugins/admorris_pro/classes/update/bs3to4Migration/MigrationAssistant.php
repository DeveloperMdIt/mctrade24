<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro\update\bs3to4Migration; use JTL\DB\DbInterface; use JTL\DB\ReturnType; use JTL\IO\IOError; use JTL\Shop; use League\Flysystem\Filesystem; use League\Flysystem\Local\LocalFilesystemAdapter; use Plugin\admorris_pro\LoggerTrait; class MigrationAssistant { use LoggerTrait; protected LessToSassConverter $lessToSassConverter; protected BootstrapVariableMigrator $bootstrapVariableMigrator; protected BootstrapClassMigrator $bootstrapClassMigrator; protected Filesystem $filesystem; const CONVERT_USER_STYLES = "\x63\157\156\166\145\162\x74\x55\163\145\162\123\x74\x79\x6c\145\x73"; const ADJUST_ELEMENTS_CSS_CLASSES = "\x61\x64\x6a\165\163\164\x45\154\x65\155\x65\x6e\x74\x73\103\163\x73\x43\x6c\x61\163\x73\145\x73"; const ADJUST_EXPERT_SETTINGS = "\141\x64\152\165\163\164\x45\x78\x70\x65\x72\x74\123\145\x74\164\151\156\x67\x73"; const TEMPLATE_PATH = "\x74\x65\x6d\160\154\x61\x74\145\163\x2f\x61\144\155\x6f\162\x72\151\163\x5f\x70\162\157\x2f"; const BACKUP_PATH = "\141\144\155\x6f\162\162\151\163\x5f\x70\162\x6f\x5f\x62\x61\143\153\x75\160\163\x2f"; private $migrationState = [self::CONVERT_USER_STYLES => false, self::ADJUST_ELEMENTS_CSS_CLASSES => false, self::ADJUST_EXPERT_SETTINGS => false]; public function __construct(protected ?DbInterface $db = null) { $this->initLogger(); if (!($this->db === null)) { goto eUqQr; } $this->db = Shop::Container()->getDB(); eUqQr: $this->lessToSassConverter = new LessToSassConverter(); $this->bootstrapVariableMigrator = new BootstrapVariableMigrator(); $this->bootstrapClassMigrator = new BootstrapClassMigrator(); $adapter = new LocalFilesystemAdapter(PFAD_ROOT); $this->filesystem = new Filesystem($adapter); } public function run($req) { if (isset($req["\155\151\x67\x72\x61\164\151\x6f\x6e\x4f\160\164\151\157\x6e\x73"])) { goto uVCjT; } return new IOError("\x45\162\162\x6f\162\x3a\x20\x4d\x69\x67\162\141\x74\x69\x6f\156\x20\x4f\x70\164\151\x6f\x6e\163\40\x6e\157\x74\40\163\x65\x74"); uVCjT: $migrationOptions = $req["\x6d\x69\147\162\x61\x74\x69\x6f\x6e\117\x70\x74\151\x6f\156\163"]; if (!in_array(self::CONVERT_USER_STYLES, $migrationOptions)) { goto SVuNy; } $this->convertUserStyles(); SVuNy: if (!in_array(self::ADJUST_ELEMENTS_CSS_CLASSES, $migrationOptions)) { goto OcLhv; } $this->adjustElementsCssClasses(); OcLhv: if (!in_array(self::ADJUST_EXPERT_SETTINGS, $migrationOptions)) { goto UEBcZ; } $this->adjustExpertSettings(); UEBcZ: return $this->migrationState; } private function convertUserStyles() { $lessFilePath = self::TEMPLATE_PATH . "\164\x68\145\155\x65\x73\57\x61\x64\x6d\157\162\162\x69\163\57\x6c\145\x73\x73\57\x75\x73\x65\162\x2d\x73\164\171\154\145\163\57\x75\163\145\162\55\163\x74\x79\x6c\145\163\x2e\x6c\x65\163\x73"; $sassFilePath = self::TEMPLATE_PATH . "\x73\x74\171\154\x65\x73\x2f\163\x61\163\163\x2f\165\163\145\x72\x2d\163\x74\x79\154\x65\163\57\137\165\x73\145\162\x2d\163\164\171\154\x65\163\56\163\x63\163\x73"; try { $lessContent = $this->filesystem->read($lessFilePath); if (!($lessContent === false)) { goto z1eaR; } throw new MigrationException("\114\x65\x73\163\40\146\x69\x6c\x65\x20\156\157\164\40\x66\157\165\156\x64"); z1eaR: if (!empty($lessContent)) { goto YUstg; } throw new MigrationException("\125\163\145\x72\x2d\123\x74\171\x6c\145\163\40\x4c\145\163\x73\x20\106\x69\154\145\x20\151\163\164\x20\x6c\x65\x65\x72"); YUstg: $sassContent = $this->lessToSassConverter->convert($lessContent); $backupBeforeSelectorReplacement = self::BACKUP_PATH . "\165\x73\145\162\55\x73\164\171\x6c\145\163\x5f\142\145\146\157\x72\x65\x2d\163\x65\x6c\145\143\x74\x6f\162\55\x72\x65\160\154\x61\x63\x65\155\145\156\164\55" . date("\131\x2d\x6d\55\x64\55\x48\55\151\55\x73") . "\x2e\x73\x63\163\x73"; $this->filesystem->write($backupBeforeSelectorReplacement, $sassContent); $sassContent = $this->bootstrapClassMigrator->replace($sassContent, true); $backupPath = self::BACKUP_PATH . "\x75\163\x65\x72\x2d\163\164\171\x6c\x65\163\55" . date("\x59\55\155\x2d\x64\55\x48\55\x69\55\x73") . "\56\x73\143\x73\163"; $this->filesystem->copy($sassFilePath, $backupPath); $this->filesystem->write($sassFilePath, $sassContent); $this->migrationState[self::CONVERT_USER_STYLES] = ["\x73\x74\141\x74\x75\163" => "\163\x75\143\x63\145\163\163"]; } catch (\Exception $e) { $this->migrationState[self::CONVERT_USER_STYLES] = $this->createErrorResponse($e); } } private function adjustElementsCssClasses() { try { $elements = $this->db->executeQuery("\x53\105\114\105\103\x54\x20\52\40\x46\122\117\115\x20\170\160\x6c\x75\x67\151\156\x5f\141\x64\x6d\x6f\x72\162\x69\x73\x5f\160\x72\x6f\x5f\x65\x6c\x65\x6d\x65\156\x74\163", ReturnType::ARRAY_OF_OBJECTS); if (!empty($elements)) { goto NUmU_; } throw new MigrationException("\113\145\x69\x6e\x65\x20\x45\x6c\145\x6d\x65\x6e\164\163\x20\x67\x65\146\x75\x6e\x64\145\156"); NUmU_: $backupPath = self::BACKUP_PATH . "\x65\x6c\x65\155\x65\x6e\x74\163\137\142\x6f\157\x74\x73\164\x72\x61\x70\x33\137\164\x6f\137\x34\137\155\151\147\x72\141\x74\x69\157\156\137\x62\141\143\x6b\x75\x70\56\x6a\x73\157\156"; $this->filesystem->write($backupPath, json_encode($elements)); $elements = array_map(function ($element) { $element->selector = $this->bootstrapClassMigrator->replace($element->selector, true); $element->content = $this->bootstrapClassMigrator->replace($element->content); return $element; }, $elements); foreach ($elements as $element) { $this->db->update("\170\160\x6c\x75\x67\x69\x6e\x5f\x61\144\x6d\x6f\x72\x72\x69\x73\137\160\x72\x6f\x5f\145\154\x65\155\145\x6e\x74\163", "\x69\x64", (int) $element->id, $element); Qkluy: } CzRsF: $this->migrationState[self::ADJUST_ELEMENTS_CSS_CLASSES] = ["\163\x74\141\x74\x75\163" => "\x73\x75\x63\143\145\163\163"]; } catch (\Exception $e) { $this->migrationState[self::ADJUST_ELEMENTS_CSS_CLASSES] = $this->createErrorResponse($e); } } private function adjustExpertSettings() { } private function createErrorResponse($error, $message = null) { $this->log->error($error); return ["\x73\164\141\x74\x75\x73" => "\x66\x61\x69\154\145\x64", "\x65\162\162\157\162" => ["\x6d\x65\163\x73\141\147\x65" => $error instanceof MigrationException ? $error->getMessage() : $message]]; } }