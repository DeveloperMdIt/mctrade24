<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro\update; use JTL\Shop; use JTL\DB\DbInterface; use JTL\Plugin\PluginInterface; use Plugin\admorris_pro\Logger; use Exception; use League\Flysystem\Filesystem; use League\Flysystem\Local\LocalFilesystemAdapter; use JTL\Cache\JTLCacheInterface; use JTL\Plugin\Admin\Installation\Installer; use JTL\Plugin\Admin\Installation\Uninstaller; use JTL\Plugin\Admin\Validation\LegacyPluginValidator; use JTL\Plugin\Admin\Validation\PluginValidator; use JTL\Plugin\Helper; use JTL\XMLParser; use Plugin\admorris_pro\TemplateUpdater; use JTL\Plugin\InstallCode; use Plugin\admorris_pro\ConsentManagerIntegration; use Plugin\admorris_pro\ioHandling\cookieNoticePro\CookieNoticePro; use function Plugin\admorris_pro\container; class Updater { private $downloadlink; private $template; private $crypt_1; private $data; private $filesystem; private $backupTimestamp; private $log; private bool $simulateUpdate = false; private bool $movedDirectories = false; const TEMPLATE_PATH = "\x74\145\155\160\154\x61\164\145\163\x2f\141\x64\155\157\x72\162\x69\163\137\160\162\x6f\x2f"; const BACKUP_PATH = "\x61\x64\x6d\x6f\x72\x72\x69\163\137\x70\162\157\x5f\x62\141\143\153\x75\160\163\57"; private $backupFiles = [["\x6e\141\x6d\145" => "\160\x68\x70\x2f\x68\145\x61\144\x65\162\114\x61\171\x6f\165\164\x44\x61\x74\141\56\x6a\x73\x6f\x6e"], ["\x6e\x61\x6d\145" => "\164\x68\x65\155\x65\x73\x2f\x61\x64\x6d\x6f\162\x72\151\x73\57\x6c\145\163\x73\57\165\163\145\x72\55\x73\164\x79\x6c\x65\163\57\x75\163\145\x72\x2d\x73\164\x79\154\x65\x73\x2e\x6c\x65\x73\163"], ["\x6e\x61\x6d\x65" => "\164\x68\145\155\145\x73\57\x62\x61\163\x65\57\x69\x6d\x61\x67\x65\163\57\x66\141\x76\x69\x63\x6f\156\56\151\143\157"], ["\x6e\x61\x6d\x65" => "\x69\x63\x6f\x6e\163\56\x73\166\147"], ["\156\141\x6d\145" => "\160\x61\x79\155\145\x6e\164\55\x69\x63\x6f\156\x73\56\x73\166\x67"], ["\x6e\x61\x6d\145" => "\x73\164\x79\154\145\x73\x2f\x73\x61\x73\163\x2f\165\163\x65\x72\55\x73\x74\x79\x6c\145\163"], ["\156\141\155\145" => "\163\x74\171\154\x65\163\x2f\141\144\x6d\157\x72\162\151\163", "\x62\x61\143\153\x75\160" => false]]; private $backupDirs = [["\163\x6f\x75\162\x63\x65" => "\164\x65\155\x70\x6c\x61\164\145\x73\x2f\141\x64\x6d\157\x72\162\151\163\137\160\162\157", "\x74\x61\162\x67\145\x74" => self::BACKUP_PATH . "\164\145\155\x70\154\x61\x74\145\x5f\x62\x61\143\x6b\x75\160", "\x72\145\x71\165\x69\x72\145\144" => false], ["\163\157\165\162\143\x65" => "\x70\x6c\165\x67\151\x6e\x73\x2f\x61\144\x6d\157\x72\162\151\x73\137\160\162\157", "\x74\141\162\x67\x65\164" => self::BACKUP_PATH . "\160\154\x75\x67\151\156\x5f\142\141\x63\x6b\165\x70", "\162\145\x71\165\x69\x72\145\144" => true]]; public function __construct(private PluginInterface $plugin, private DbInterface $db, private JTLCacheInterface $cache, private string $rootDirectory = \PFAD_ROOT) { $this->data = $this->db->select("\x78\x70\x6c\x75\147\x69\156\137\141\144\155\157\x72\x72\151\163\x5f\160\x72\157\x5f\163\164\141\x74\165\163", "\151\144", 1); $this->downloadlink = $this->data->dl; $this->template = $this->data->t; $this->crypt_1 = $this->data->e; $adapter = new LocalFilesystemAdapter($this->rootDirectory); $this->filesystem = new Filesystem($adapter); $this->backupTimestamp = date("\131\x2d\x6d\x2d\x64\55\x48\55\151\x2d\x73"); if (!(defined("\101\104\x4d\x4f\x52\x52\x49\x53\x5f\120\x52\117\x5f\x53\x49\115\125\114\101\124\105\x5f\x55\x50\104\x41\x54\105") && constant("\101\104\x4d\x4f\x52\122\x49\123\x5f\120\x52\x4f\137\123\111\x4d\125\x4c\x41\x54\105\137\x55\120\104\101\x54\105"))) { goto OQjwt; } $this->simulateUpdate = true; OQjwt: $this->log = container()->makeWith(Logger::class, ["\x70\x72\145\160\x65\156\x64\x54\145\x78\x74" => "\125\160\x64\x61\164\145\x72"]); } public function request($req, $requestType = null) { try { if (!is_null($requestType)) { goto DesZw; } $requestType = $req["\x72\x65\161\x75\145\163\x74\x54\x79\160\x65"]; DesZw: $version = $req["\166\145\x72\x73\x69\157\x6e"] ?? null; if (!$version) { goto uhTqD; } $currentVersion = Shop::get("\157\x70\154\x75\x67\x69\x6e\137\x61\x64\x6d\x6f\x72\x72\151\163\137\x70\x72\x6f")->getMeta()->getVersion(); $majorVersion = explode("\x2e", $currentVersion)[0]; $nextMajorVersion = $majorVersion + 1; $nextMajorVersion = $nextMajorVersion . "\x2e\x30\56\x30\55\141\x6c\x70\x68\141"; if (!version_compare($version, $nextMajorVersion, "\x3e\x3d")) { goto rxu2X; } setcookie("\x61\144\x6d\x6f\162\x72\151\163\137\x70\x72\157\x5f\x6d\141\152\x6f\x72\137\165\x70\x64\141\164\x65", $currentVersion, 0); rxu2X: uhTqD: switch ($requestType) { case "\160\x72\x65\160\x61\162\145": $response = $this->prepare($version); goto lDqRF; case "\165\160\144\x61\164\x65": $response = $this->update(); goto lDqRF; default: $response = $this->{$requestType}(); goto lDqRF; } CTKyU: lDqRF: return json_encode($response); } catch (\Throwable $th) { $this->log->error($th->getMessage()); return json_encode(["\x65\162\162\157\162" => $th->getMessage(), "\x73\x74\141\x63\153\x54\x72\x61\x63\145" => $th->getTraceAsString()]); } } private function prepare($version = null) { goto qQ4GU; qQ4GU: $downloadlink = $this->downloadlink; $data = $this->data; if ($downloadlink == "\x4b\x56") { goto ZAlmn; } if (empty($downloadlink)) { goto dZKqs; } goto D5q01; ZAlmn: return UpdateResponse::VERSION_INCOMPATIBLE; goto D5q01; dZKqs: return UpdateResponse::INVALID_LICENSE; goto X2RUr; XA98S: vHTjD: $downloadlink = "\141\x64\x6d\157\x72\x72\151\x73\137\x70\162\157\137" . $data->nextVersion; A10T8: $this->log->notice("\x50\162\145\x70\141\x72\x69\156\x67\x20\x75\160\x64\x61\164\145\40\167\x69\x74\150\40\x64\157\167\156\x6c\x6f\x61\x64\40\x6c\151\x6e\153\72\40" . $downloadlink); try { $this->download($downloadlink); $this->backupFiles(); $this->backupDirectories(); $this->extractZip($downloadlink); \sleep(3); if (!function_exists("\x6f\160\143\x61\143\150\x65\137\162\x65\163\x65\164")) { goto LfCWC; } opcache_reset(); \sleep(3); LfCWC: return UpdateResponse::SUCCESS; } catch (\Throwable $th) { $this->log->error($th); if (!$this->movedDirectories) { goto NwOmu; } $this->restoreDirectoriesFromBackup(); NwOmu: return UpdateResponse::ERROR; } goto utztu; X2RUr: D5q01: if (!$this->simulateUpdate) { goto FyNW6; } return UpdateResponse::SUCCESS; FyNW6: if ($version) { goto tZvNW; } if ($data->nextVersion) { goto vHTjD; } goto A10T8; tZvNW: $downloadlink = "\x61\144\x6d\157\162\x72\151\163\x5f\160\x72\157\x5f" . $version; goto A10T8; goto XA98S; utztu: } private function update() { $this->log->notice("\123\164\141\x72\x74\151\x6e\x67\x20\x75\160\144\141\164\x65\40\160\x72\157\143\x65\x73\x73"); $db = $this->db; $db->query("\123\x45\x54\x20\106\x4f\x52\x45\x49\107\116\x5f\x4b\x45\x59\137\x43\x48\x45\x43\113\x53\75\x30"); try { $salesboosterConsents = ConsentManagerIntegration::backupSalesboosterConsents(); $cache = $this->cache; $parser = new XMLParser(); $installer = new Installer($db, new Uninstaller($db, $cache), new LegacyPluginValidator($db, $parser), new PluginValidator($db, $parser)); $updater = new \JTL\Plugin\Admin\Updater($db, $installer); } catch (\Throwable $th) { $this->log->error($th); $db->query("\x53\105\x54\40\106\117\x52\x45\111\107\116\137\113\x45\x59\x5f\103\x48\x45\103\113\x53\75\x31"); return UpdateResponse::ERROR; } $downloadlink = $this->downloadlink; if (!(empty($downloadlink) || $downloadlink == "\x4b\126")) { goto n6DUl; } return UpdateResponse::ERROR; n6DUl: try { goto RXLMl; t6rB3: $activeTemplate = Shop::Container()->getTemplateService()->getActiveTemplate(); $templateID = $activeTemplate->getTemplate(); if (!($templateID === "\x61\x64\155\x6f\x72\x72\x69\x73\137\160\162\157\x5f\143\150\151\154\x64" || $templateID === "\x61\x64\x6d\157\162\162\x69\163\x5f\x70\x72\157")) { goto zgPN1; } $templateUpdater = new TemplateUpdater($templateID, $db, $cache); $status = $templateUpdater->saveConfig(); if ($status) { goto e_h41; } $db->query("\123\x45\124\40\x46\x4f\x52\x45\x49\x47\x4e\x5f\x4b\x45\x59\x5f\x43\x48\105\103\x4b\x53\x3d\x31"); throw new \Exception("\x43\x6f\x75\154\144\156\x27\x74\x20\x75\160\x64\x61\164\x65\x20\164\145\155\x70\154\x61\x74\145"); e_h41: zgPN1: goto ammTg; RXLMl: $kPlugin = $this->plugin->getID(); $status = $updater->update($kPlugin); ConsentManagerIntegration::loadSalesboosterConsentsBackup($salesboosterConsents); if (!($status !== InstallCode::OK)) { goto zIPKk; } $error = (new InstallCode($status))->getKey(); $this->log->error("\103\157\x75\x6c\144\40\156\157\x74\40\x69\x6e\x73\x74\141\154\154\x20\x70\154\165\x67\x69\x6e\x20" . $error); $db->query("\x53\x45\124\x20\x46\117\x52\x45\111\x47\x4e\137\113\x45\x59\x5f\x43\x48\x45\103\113\x53\75\61"); throw new \Exception("\x43\157\165\154\x64\x6e\x27\164\x20\165\160\x64\x61\x74\x65\40\160\154\x75\147\151\x6e\x20\55\40" . $error); zIPKk: $this->log->notice("\x50\x6c\x75\x67\151\156\x20\165\160\144\141\x74\x65\x20\163\x75\x63\x63\145\x73\163\x66\x75\x6c"); goto t6rB3; ammTg: $this->log->notice("\x54\x65\155\160\x6c\x61\164\145\x20\165\x70\x64\141\164\145\40\x73\165\143\x63\x65\163\x73\x66\x75\154"); if ($this->simulateUpdate) { goto XvH4b; } $this->restoreTemplateFilesFromBackup(); XvH4b: $db->query("\x53\105\x54\40\x46\x4f\x52\105\111\x47\x4e\x5f\113\x45\x59\x5f\x43\x48\x45\103\x4b\123\75\61"); if ($this->simulateUpdate) { goto DlANA; } $this->cleanupBackups($downloadlink); DlANA: try { $this->restoreAdmorrisConsents(); $this->log->notice("\x43\x6f\x6e\x73\x65\x6e\x74\163\x20\162\145\163\x74\157\x72\x65\x64\40\x73\x75\x63\143\145\x73\163\x66\x75\x6c\154\171"); } catch (\Throwable $th) { $this->log->error("\x43\x6f\x75\154\x64\40\156\x6f\164\40\x72\x65\x73\164\157\x72\145\40\143\x6f\x6e\x73\145\x6e\x74\163\x3a\40" . $th->getMessage()); return UpdateResponse::ERROR; } $db->query("\123\x45\x54\x20\106\117\x52\x45\x49\x47\116\x5f\x4b\105\131\x5f\103\110\x45\103\x4b\x53\x3d\61"); goto VS2wP; VS2wP: $this->log->notice("\x55\x70\144\141\x74\x65\x20\x63\x6f\x6d\160\154\x65\164\145\x64\x20\x73\x75\143\143\145\163\163\146\165\154\154\171"); return UpdateResponse::SUCCESS; goto xA0NA; xA0NA: } catch (\Throwable $th) { $this->log->error("\x45\162\162\x6f\x72\40\144\x75\162\x69\156\x67\x20\165\160\144\141\x74\x65\x3a\x20" . $th->getMessage()); $db->query("\x53\x45\124\40\x46\117\x52\x45\111\x47\x4e\x5f\113\105\x59\137\103\110\x45\103\113\123\x3d\61"); try { $this->restoreAdmorrisConsents(); } catch (\Throwable $e) { $this->log->error("\103\157\165\x6c\x64\x20\156\157\164\40\x72\145\163\x74\x6f\x72\x65\40\x63\x6f\156\x73\x65\x6e\164\163\x20\x61\146\x74\145\x72\x20\x65\x72\162\157\162\72\40" . $e->getMessage()); } if ($this->simulateUpdate) { goto zyavv; } try { $this->restoreDirectoriesFromBackup(); } catch (\Throwable $e) { $this->log->error("\103\157\165\154\x64\x20\x6e\157\164\40\162\x65\163\x74\157\162\x65\x20\x66\162\157\155\40\x62\141\143\153\x75\160\72\x20" . $e->getMessage()); } zyavv: } return UpdateResponse::ERROR; } private function backupFiles() { $backupDir = self::BACKUP_PATH . "\164\145\155\160\154\141\x74\145\x5f\x62\x61\x63\x6b\x75\160\x5f" . $this->backupTimestamp; if ($this->filesystem->directoryExists($backupDir)) { goto JHu0F; } $this->filesystem->createDirectory($backupDir, ["\166\x69\163\151\142\x69\154\151\x74\171" => "\160\x75\x62\154\151\143"]); JHu0F: foreach ($this->backupFiles as $fileInfo) { if (!(isset($fileInfo["\x62\141\x63\x6b\x75\160"]) && !$fileInfo["\x62\x61\143\153\x75\160"])) { goto zEk9O; } goto ihkM6; zEk9O: $sourcePath = self::TEMPLATE_PATH . $fileInfo["\156\141\155\145"]; $targetPath = $backupDir . "\x2f" . $fileInfo["\x6e\141\155\145"]; $targetDir = dirname($targetPath); if ($this->filesystem->directoryExists($targetDir)) { goto FXzLR; } $this->filesystem->createDirectory($targetDir, ["\x76\x69\163\151\x62\x69\154\x69\164\x79" => "\160\x75\x62\x6c\151\x63"]); FXzLR: try { if ($this->filesystem->fileExists($sourcePath)) { goto nxNQy; } if ($this->filesystem->directoryExists($sourcePath)) { goto AdPQP; } $this->log->warning("\123\x6f\165\x72\x63\x65\40\156\157\164\40\146\157\165\156\144\54\x20\x73\x6b\x69\160\x70\x69\156\x67\40\142\141\143\x6b\165\160\x3a\40{$sourcePath}"); goto vvs0Z; nxNQy: $this->filesystem->copy($sourcePath, $targetPath); $this->log->debug("\x42\141\x63\x6b\x65\x64\x20\x75\160\x20\146\151\x6c\x65\x3a\x20{$sourcePath}\x20\164\157\40{$targetPath}"); goto vvs0Z; AdPQP: $this->copyDirectoryRecursively($sourcePath, $targetPath); $this->log->debug("\x42\141\143\153\x65\x64\40\165\160\x20\144\x69\162\x65\x63\164\x6f\x72\171\72\40{$sourcePath}\x20\164\x6f\40{$targetPath}"); vvs0Z: } catch (\Throwable $th) { $this->log->error("\106\x61\x69\x6c\x65\x64\40\164\x6f\x20\142\x61\x63\x6b\x20\x75\x70\72\40{$sourcePath}\56\x20\105\162\162\157\x72\x20\x64\x65\x74\141\x69\154\163\x3a\40" . $th->getMessage()); } ihkM6: } ZwWue: $backupInfo = $this->rootDirectory . $backupDir . "\x2f\142\141\x63\153\x75\x70\111\x6e\x66\x6f\56\x74\x78\x74"; $pluginVersion = $this->plugin->getMeta()->getVersion(); $shopVersion = \APPLICATION_VERSION; $phpversion = phpversion(); file_put_contents($backupInfo, "\124\151\x6d\145\163\x74\x61\x6d\x70\x3a\40{$this->backupTimestamp}\xa\120\x6c\165\x67\x69\x6e\40\126\x65\x72\x73\x69\x6f\156\72\x20{$pluginVersion}\xa\123\x68\157\160\40\x56\x65\x72\163\x69\157\156\x3a\x20{$shopVersion}\xa\120\110\x50\40\126\145\162\x73\151\x6f\x6e\x3a\40{$phpversion}\xa"); $this->log->notice("\x42\141\143\153\165\x70\40\x63\157\x6d\160\x6c\145\x74\x65\144\x20\x74\x6f\x3a\40{$backupDir}"); } private function backupDirectories() { $this->moveDirectories(); $this->movedDirectories = true; } private function restoreDirectoriesFromBackup() { $this->moveDirectories(true); } private function moveDirectories($restore = false) { $this->log->notice("\102\x61\143\x6b\x69\x6e\x67\40\165\x70\40\x64\x69\x72\x65\x63\x74\x6f\x72\x69\x65\163"); foreach ($this->backupDirs as $dirInfo) { goto LWaMU; aFY4W: $this->log->notice("\x42\x61\x63\x6b\x65\x64\x20\x75\160\40\x64\x69\162\145\143\x74\157\162\171\x3a\40{$sourcePath}\40\x74\x6f\40{$targetPath}"); goto KD5MG; qFD_s: $this->log->notice("\x52\145\x73\x74\x6f\x72\145\x64\x20\x64\x69\162\x65\x63\x74\157\162\x79\72\40{$targetPath}\40\146\162\x6f\x6d\x20\142\141\x63\153\x75\x70"); KD5MG: i9Qya: goto HxLla; LWaMU: if ($restore) { goto LXE8B; } $sourcePath = $dirInfo["\x73\157\x75\x72\143\x65"]; $targetPath = $dirInfo["\164\141\162\x67\145\x74"]; goto vdiIY; LXE8B: $sourcePath = $dirInfo["\x74\141\x72\x67\x65\x74"]; $targetPath = $dirInfo["\x73\x6f\x75\162\x63\145"]; vdiIY: if ($this->filesystem->directoryExists($sourcePath)) { goto vqDhi; } if (!$dirInfo["\162\x65\x71\x75\x69\x72\x65\x64"]) { goto DkAAi; } goto ZeO7Z; ZeO7Z: throw new \Exception("\x52\x65\x71\x75\x69\x72\145\x64\40\x64\x69\x72\x65\x63\x74\157\x72\x79\40\x6e\157\164\x20\x66\x6f\165\156\x64\72\x20{$sourcePath}"); DkAAi: $this->log->notice("\123\x6f\x75\162\x63\145\40\x64\x69\162\145\x63\x74\157\x72\x79\40\x64\157\145\163\40\x6e\x6f\x74\40\145\x78\x69\x73\x74\54\40\163\x6b\x69\160\160\x69\x6e\x67\x3a\40{$sourcePath}"); goto i9Qya; vqDhi: if (!$this->filesystem->directoryExists($targetPath)) { goto t8s28; } $this->filesystem->deleteDirectory($targetPath); t8s28: $this->filesystem->move($sourcePath, $targetPath); if ($restore) { goto qFD_s; } goto aFY4W; HxLla: } PdcLY: } private function restoreTemplateFilesFromBackup() { foreach ($this->backupFiles as $fileInfo) { $sourcePath = self::BACKUP_PATH . "\x74\x65\155\x70\154\141\x74\x65\137\x62\141\x63\x6b\x75\x70\x2f" . $fileInfo["\156\141\x6d\x65"]; $targetPath = self::TEMPLATE_PATH . $fileInfo["\156\x61\x6d\x65"]; try { if ($this->filesystem->fileExists($sourcePath)) { goto eLcf9; } if ($this->filesystem->directoryExists($sourcePath)) { goto zhLeB; } $this->log->warning("\x42\141\x63\x6b\x75\160\40\156\157\164\40\x66\157\x75\x6e\144\x2c\x20\163\153\x69\160\x70\x69\156\x67\x20\162\145\163\x74\157\162\x61\164\x69\x6f\x6e\72\x20{$sourcePath}"); goto ao3Xg; eLcf9: $this->filesystem->copy($sourcePath, $targetPath); $this->log->notice("\122\145\x73\x74\x6f\162\x65\x64\x20\146\x69\154\145\x3a\40{$sourcePath}\40\164\157\x20{$targetPath}"); goto ao3Xg; zhLeB: $this->copyDirectoryRecursively($sourcePath, $targetPath); $this->log->notice("\122\x65\163\x74\x6f\x72\145\x64\40\x64\151\x72\x65\143\x74\x6f\x72\171\72\x20{$sourcePath}\40\x74\157\40{$targetPath}"); ao3Xg: } catch (\Throwable $th) { $this->log->warning("\x46\141\x69\154\145\144\40\164\157\x20\x72\x65\163\x74\157\162\145\72\x20{$sourcePath}\x2e\x20\x45\x72\x72\157\x72\x3a\x20" . $th->getMessage()); $this->log->error($th); } f89LN: } BTA7h: } private function copyDirectoryRecursively(string $sourceDir, string $targetDir) : void { if ($this->filesystem->directoryExists($sourceDir)) { goto As9Pm; } $this->log->warning("\x53\157\165\162\143\145\x20\144\151\x72\145\x63\x74\157\x72\x79\40\x64\x6f\145\x73\x6e\x27\164\x20\145\x78\151\163\164\72\40{$sourceDir}"); return; As9Pm: if ($this->filesystem->directoryExists($targetDir)) { goto ACEc0; } $this->filesystem->createDirectory($targetDir); ACEc0: $contents = $this->filesystem->listContents($sourceDir, false); foreach ($contents as $item) { $sourcePath = $item->path(); $relativePath = basename($sourcePath); $targetPath = rtrim($targetDir, "\57") . "\x2f" . $relativePath; if ($item->isDir()) { goto OOK_J; } $this->filesystem->copy($sourcePath, $targetPath); goto TC2rS; OOK_J: $this->copyDirectoryRecursively($sourcePath, $targetPath); TC2rS: Mhaoh: } an416: $this->log->debug("\122\145\143\165\162\x73\x69\166\x65\154\x79\40\x63\x6f\x70\x69\145\x64\x20\144\x69\162\145\x63\x74\157\x72\x79\x3a\x20{$sourceDir}\x20\x74\157\x20{$targetDir}"); } private function cleanupBackups($downloadlink) { try { $zipPath = "\141\x64\155\x6f\x72\x72\151\x73\137\160\x72\157\x5f\x62\141\143\x6b\x75\x70\163\x2f" . $downloadlink . "\56\172\151\x70"; if (!$this->filesystem->fileExists($zipPath)) { goto W5F18; } $this->filesystem->delete($zipPath); $this->log->notice("\x44\145\154\x65\x74\x65\144\x20\144\x6f\167\156\x6c\157\x61\144\40\x66\151\154\145\x3a\40{$zipPath}"); W5F18: } catch (\Throwable $th) { $this->log->error("\106\141\x69\154\145\x64\x20\x74\157\x20\143\154\x65\x61\156\x20\x75\160\x20\x62\141\143\x6b\x75\160\x73\x3a\x20" . $th->getMessage()); } } private function download($downloadlink) { try { goto WY2w8; SNyi0: if (!($response === false)) { goto k8hG6; } throw new Exception("\103\x6f\165\x6c\144\40\156\157\x74\40\163\x65\x74\x20\143\x75\162\154\x20\x66\x69\154\145\x20\150\141\156\x64\154\x65\162\x20\x69\156\x20\144\157\167\156\x6c\x6f\141\144\50\x29"); k8hG6: $response = curl_exec($ch); if (!($response === false)) { goto h3UJf; } $error = curl_error($ch); curl_close($ch); fclose($file); throw new Exception("\103\x6f\x75\x6c\x64\x20\156\157\x74\x20\x65\170\x65\x63\165\x74\145\40\x63\165\162\x6c\x20\x69\x6e\40\x64\157\x77\x6e\x6c\157\x61\x64\x28\51\72\40" . $error); h3UJf: goto SF4qH; SF4qH: curl_close($ch); fclose($file); $this->log->notice("\104\x6f\167\156\x6c\x6f\x61\144\145\144\40\165\160\144\141\x74\x65\x20\146\x69\x6c\145\72\x20{$downloadlink}\x2e\x7a\151\x70"); return true; goto e3E_b; WY2w8: if ($this->filesystem->directoryExists("\x61\144\155\x6f\162\162\x69\x73\x5f\x70\x72\157\137\142\141\x63\x6b\165\160\x73")) { goto AlFv5; } $this->filesystem->createDirectory("\141\x64\155\157\x72\x72\151\x73\x5f\160\162\157\137\142\x61\x63\153\165\160\x73", ["\166\151\163\151\x62\x69\x6c\151\x74\x79" => "\160\x75\x62\x6c\x69\x63"]); AlFv5: $file = fopen(PFAD_ROOT . "\141\144\155\157\x72\162\151\x73\137\160\x72\157\137\x62\141\x63\x6b\165\x70\x73\x2f" . $downloadlink . "\x2e\172\151\160", "\167"); $ch = curl_init(); curl_setopt($ch, CURLOPT_URL, "\x68\x74\164\x70\x73\x3a\57\57\141\144\155\157\x72\x72\x69\163\x2e\143\x6f\155\57\x70\x72\x6f\x2f\x66\151\x6c\145\163\x2f" . $downloadlink . "\56\172\151\160"); curl_setopt($ch, CURLOPT_FAILONERROR, true); curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true); curl_setopt($ch, CURLOPT_RETURNTRANSFER, true); $response = curl_setopt($ch, CURLOPT_FILE, $file); goto SNyi0; e3E_b: } catch (\Throwable $th) { throw new \Exception("\101\156\40\x45\170\x63\145\x70\x74\x69\157\156\x20\x6f\x63\x63\x75\x72\x72\x65\x64\x20\x77\x68\151\154\145\40\144\157\167\156\x6c\x6f\x61\144\151\156\x67\x20\164\x68\x65\x20\165\160\144\x61\164\x65\x20\172\x69\x70\40\x66\x69\154\x65\x3a\x20" . $th->getMessage(), 0, $th); } } private function extractZip($filename) { $zip = new \ZipArchive(); $zipPath = PFAD_ROOT . "\x61\x64\155\x6f\162\162\x69\163\137\160\x72\x6f\137\142\x61\x63\153\165\160\163\x2f" . $filename . "\56\172\x69\160"; if ($zip->open($zipPath) === true) { goto xe_C6; } throw new Exception("\x43\157\165\154\144\x20\156\157\x74\40\157\160\145\156\40\x7a\x69\x70\40\146\x69\154\x65\x3a\x20{$zipPath}"); goto BHIpJ; xe_C6: $zip->extractTo(PFAD_ROOT); $response = $zip->close(); if (!($response === false)) { goto tNu77; } throw new Exception("\103\157\x75\x6c\144\x20\156\x6f\164\x20\x65\170\x74\x72\141\143\164\x20\x75\x70\x64\x61\x74\x65\40\x7a\x69\160\x20\x66\x69\154\x65\x20\x66\162\157\155\x3a\x20{$zipPath}"); tNu77: $this->log->notice("\x45\170\164\x72\x61\143\164\145\144\x20\165\x70\x64\x61\x74\145\40\x66\151\154\x65\x3a\40{$zipPath}"); return $response; BHIpJ: } private function restoreAdmorrisConsents() { $cookies = CookieNoticePro::getAll(); foreach ($cookies as $cookie) { $payload = ConsentManagerIntegration::createConsentManagerPayload($cookie, $cookie->localization); $jtlConsent = ConsentManagerIntegration::registerConsentItem($payload); $obj_merged = ConsentManagerIntegration::mergeAdmCookieAndJTLConsent($cookie, $jtlConsent); CookieNoticePro::update($obj_merged, false); GBJxx: } LfC54: } public function testMovingFilesAndDirectories() { $doneFilePath = $this->rootDirectory . "\x64\x6f\156\145\56\x74\x78\x74"; if (!file_exists($doneFilePath)) { goto xkGpM; } $this->log->notice("\x55\160\x64\141\x74\145\x20\x70\162\x6f\143\x65\163\x73\40\x61\154\x72\145\141\144\x79\40\143\x6f\155\x70\x6c\145\x74\x65\144\56\x20\123\153\151\160\x70\x69\x6e\147\40\164\145\163\x74\x2e"); return; xkGpM: $this->backupFiles(); $this->backupDirectories(); $this->restoreTemplateFilesFromBackup(); file_put_contents($doneFilePath, "\x55\160\x64\x61\x74\x65\x20\160\162\x6f\143\145\x73\163\40\x63\x6f\155\160\x6c\x65\164\145\x64\40\163\x75\143\x63\145\x73\163\x66\165\154\x6c\x79\56"); } }