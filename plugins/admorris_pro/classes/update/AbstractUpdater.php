<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro\update; use AdmPro\Illuminate\Database\Eloquent\Model; use JTL\DB\DbInterface; use JTL\Shop; use JTL\DB\ReturnType; use Plugin\admorris_pro\LoggerTrait; use Plugin\admorris_pro\pluginSettings\PluginSettingsNew; use AdmPro\Carbon\Carbon; abstract class AbstractUpdater { use LoggerTrait; use SettingsLoaderTrait; protected string $model; protected array $excludeValues = []; protected array $renameValues = []; protected ?string $wasActive = null; protected ?string $needsToBeActive = null; public function __construct(protected DbInterface $db) { $this->initLogger(); try { $this->loadSettings(); $this->renameSettings(); } catch (\Throwable $th) { $this->log->error($th); } } public function moveSettings() : void { $this->log->debug("\x4d\157\166\151\x6e\147\x20\x73\x65\164\x74\151\x6e\x67\x73\40\x74\x6f\x20" . $this->model); $model = $this->model; $excludeValues = $this->excludeValues; $wasActive = $this->wasActive; $needsToBeActive = $this->needsToBeActive; $pluginSettings = $this->pluginSettings; try { $wasActiveBefore = false; $wasActiveFull = $this->getSearchValue() . $wasActive; $model = $model::all()->first(); $excludeValuesPrefixed = array_map(fn($value) => $this->getSearchValue() . $value, $excludeValues); foreach ($pluginSettings as $item) { if (!in_array($item->cName, $excludeValuesPrefixed)) { goto ChVRj; } goto GVknQ; ChVRj: if ($item->cName === $wasActiveFull) { goto SY0b3; } $name = str_replace($this->getSearchValue(), '', $item->cName); $model->{$name} = $this->valueConversion($item->cWert); goto Kd2lm; SY0b3: if (!($item->cWert === "\x59")) { goto PmpUS; } $wasActiveBefore = true; PmpUS: Kd2lm: GVknQ: } zEqsJ: if (!($wasActiveBefore && !empty($needsToBeActive))) { goto ci2yH; } $model->{$needsToBeActive} = true; ci2yH: $model->save(); } catch (\Throwable $th) { $this->log->error("\105\162\162\x6f\x72\x20\x75\x70\x64\x61\164\x69\156\x67\40" . $this->model . "\40\x69\156\40\101\142\x73\164\162\141\x63\164\40\125\x70\x64\x61\164\x65\x72\x2e"); $this->log->error($th); } } private function valueConversion($value) { $iso8601Regex = "\57\x5e\134\x64\173\64\x7d\x2d\x5c\144\x7b\x32\x7d\x2d\134\144\x7b\x32\x7d\x54\134\144\173\x32\175\x3a\x5c\144\173\62\x7d\x3a\134\144\173\62\175\x28\x5c\56\134\x64\53\x29\x3f\x5a\x24\57"; if (preg_match($iso8601Regex, $value)) { goto f__ya; } if (in_array($value, ["\x59", "\116"])) { goto NyzxZ; } goto gFuxT; f__ya: $carbon = Carbon::parse($value); return $carbon->format("\131\55\155\55\144\40\x48\x3a\151\72\x73"); goto gFuxT; NyzxZ: return $value === "\x59" ? 1 : 0; gFuxT: return $value; } public function renameSettings() : void { $renameValues = $this->renameValues; $searchValue = $this->getSearchValue(); if (!empty($renameValues)) { goto eYFqn; } return; eYFqn: $pluginSettings = array_map(function ($item) use($renameValues, $searchValue) { $name = str_replace($searchValue, '', $item->cName); if (!isset($renameValues[$name])) { goto Sn0s2; } $item->cName = $searchValue . $renameValues[$name]; Sn0s2: return $item; }, $this->pluginSettings); $this->pluginSettings = $pluginSettings; } }