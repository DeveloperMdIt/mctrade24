<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro; use Exception; use JTL\Consent\ConsentModel; use JTL\Consent\ConsentLocalizationModel; use JTL\Language\LanguageHelper; use Illuminate\Support\Collection; use JTL\DB\DbInterface; use JTL\Shop; use Plugin\admorris_pro\lib\AdmorrisLib; class ConsentManagerIntegration { public static function registerConsentItem(array $consentItem) { try { goto dx4TR; dzEif: throw new Exception("\143\x6f\x75\154\144\x20\x6e\x6f\164\x20\163\141\x76\x65\40\103\157\x6e\x73\145\x6e\x74\111\x74\x65\155\40\164\157\x20\144\x62"); goto ukGJE; cFzFw: return ["\x73\165\x63\x63\x65\x73\x73" => true, "\x69\x64" => $consentModel->id, "\150\x69\144\144\x65\x6e\x4e\x61\155\145" => $consentModel->itemID]; ukGJE: goto qSyJ8; dx4TR: self::validateConsentItem($consentItem); $db = Shop::Container()->getDB(); $jtlConsentItems = self::getAllConsentItems($db); $consentItemJTL = $consentItem; $consentItem["\x68\151\144\x64\x65\x6e\x4e\141\x6d\x65"] = "\141\144\x6d\157\x72\x72\x69\x73\x2d" . $consentItem["\150\151\x64\x64\x65\x6e\116\141\x6d\x65"]; $consentItemJTL["\151\x74\x65\155\111\104"] = $consentItem["\x68\151\x64\144\145\156\x4e\141\x6d\x65"]; $consentItemJTL["\160\154\165\147\151\156\111\x44"] = AdmorrisLib::getPluginId(); $languages = []; if (!(count($consentItem["\154\x6f\143\141\x6c\151\172\x61\x74\151\157\156"]) > 0)) { goto KQu21; } $languages = self::getLanguageIDs($consentItem); goto hWpbx; y1Qaa: $localizationsArr = self::getLocalizationArray($consentModel, $languages, $consentItem); $localizations = new Collection(); foreach ($localizationsArr as $localization) { $filteredConsentLocModels = $consentModel->localization->where("\151\144", $localization["\151\x64"]); if (count($filteredConsentLocModels) !== 0) { goto t31i_; } $localizationModel = new ConsentLocalizationModel($db); $localizationModel->fill($localization); goto CF1Fp; t31i_: $localizationModel = $filteredConsentLocModels->first(); $localizationModel->fill($localization); $locResult = $localizationModel->save(); if (!($locResult === false)) { goto BSJpU; } throw new Exception("\103\x6f\x75\154\144\x20\156\x6f\164\40\x73\141\x76\x65\x20\x43\x6f\x6e\163\x65\156\164\x49\164\145\155\x4c\157\143\141\x6c\x69\x7a\141\164\x69\x6f\156\40\x74\x6f\x20\144\x62"); BSJpU: CF1Fp: $localizations->push($localizationModel); FnxZX: } I1NOD: $consentItemJTL["\x6c\157\x63\141\154\x69\172\141\164\151\x6f\156"] = $localizations; $consentModel->fill($consentItemJTL); $res = $consentModel->save(); self::bumpConsentVersion(); Shop::Container()->getCache()->flushTags([\CACHING_GROUP_CORE]); if ($res === true) { goto cFzFw; } goto dzEif; hWpbx: KQu21: $localizationsArr = []; $consentModelArr = self::initConsentModel($jtlConsentItems, $consentItem, $db); $consentModel = $consentModelArr["\x63\x6f\156\163\x65\x6e\x74\x4d\x6f\144\145\x6c"]; if (!isset($consentModelArr["\151\144"])) { goto rMF_W; } $consentItemJTL["\151\144"] = $consentModelArr["\151\144"]; rMF_W: if (!isset($consentModelArr["\x69\x74\145\155\111\104"])) { goto qc5wF; } $consentItemJTL["\151\164\x65\155\x49\104"] = $consentModelArr["\151\164\x65\x6d\111\x44"]; qc5wF: goto y1Qaa; qSyJ8: } catch (Exception $e) { container()->make(Logger::class)->error($e); } } public static function bumpConsentVersion() : void { Shop::Container()->getDB()->query("\125\x50\104\101\124\x45\40\164\147\154\x6f\142\141\154\163\x20\123\105\124\40\x63\x6f\156\x73\145\156\164\x56\x65\x72\x73\151\x6f\x6e\40\x3d\x20\143\x6f\156\x73\145\x6e\164\126\145\162\x73\151\x6f\156\x20\53\x20\x31\54\40\144\x4c\x65\164\x7a\164\x65\101\x65\156\x64\x65\x72\x75\x6e\x67\x20\75\40\x4e\117\127\50\51"); } public static function unregisterConsentItem(int $consentItemID) : void { $db = Shop::Container()->getDB(); $jtlConsentItems = self::getAllConsentItems($db); $filteredItemsID = $jtlConsentItems->where("\x69\144", $consentItemID); $toDelete = $filteredItemsID->first(); if (!$toDelete) { goto WTs4i; } $result = $toDelete->delete(); Shop::Container()->getCache()->flushTags([\CACHING_GROUP_CORE]); if ($result) { goto EbpGk; } throw new Exception("\111\x74\x65\155\40\143\x6f\165\x6c\144\x20\156\x6f\x74\x20\x62\145\x20\144\145\154\x65\x74\145\x64\x20\146\162\x6f\155\x20\x44\102"); goto Ggygn; EbpGk: return; Ggygn: return; WTs4i: } private static function validateConsentItem(array $consentItem) : void { $validArray = ["\141\x63\164\x69\x76\x65", "\x6c\157\143\141\x6c\x69\x7a\x61\164\x69\x6f\x6e"]; foreach ($validArray as $item) { if (isset($consentItem[$item])) { goto ftrIp; } throw new Exception($item . "\x20\x6e\x6f\164\40\x73\x65\164\56\x20\x43\x61\156\x6e\157\164\x20\163\141\166\145\x20\164\157\40\144\x62"); ftrIp: F1_oT: } qJ3Wt: } private static function getAllConsentItems($db) : Collection { $model = new ConsentModel($db); $consentItemsInDB = $model->loadAll($db, [], []); $return = $consentItemsInDB->values(); return $return; } private static function getLanguageIDs(array $consentItem) : array { $returnArr = []; $lang = new LanguageHelper(); $availableLanguages = $lang->getAvailable(); foreach ($availableLanguages as $language) { foreach ($consentItem["\x6c\x6f\x63\141\x6c\x69\x7a\x61\164\151\157\x6e"] as $key => $localization) { if (!($language->iso === $localization["\x6c\141\156\147\x75\141\147\x65\111\144"])) { goto foEPC; } $returnArr[$key] = $language->id; foEPC: s8Z1J: } IA7IH: PRXUD: } DzyuA: if (!empty($returnArr)) { goto Z5XUo; } $defaultLang = $lang->getDefaultLanguage(); $returnArr[$defaultLang->getIso()] = $defaultLang->getId(); Z5XUo: return $returnArr; } private static function getLocalizationArray(ConsentModel $model, array $languages, array $item) : array { $returnArr = []; foreach ($languages as $key => $language) { $localizationArr = []; $localizationArr["\x6c\141\156\x67\165\x61\147\x65\111\104"] = $language; $localizationArr["\x63\157\x6e\x73\145\x6e\x74\111\104"] = $model->id; $localizationArr["\151\144"] = self::getLocalizationID($model, $model->id, $language); $localizationArr["\x64\x65\x73\x63\162\151\x70\164\151\157\x6e"] = $item["\x6c\x6f\x63\x61\154\x69\x7a\141\x74\151\x6f\x6e"][$key]["\143\x6f\x6f\153\151\145\x44\145\163\143\x72\x69\x70\x74\x69\157\x6e"] ?? $item["\154\x6f\x63\141\x6c\151\172\141\164\x69\157\x6e"]["\145\x6e\147"]["\x63\x6f\x6f\153\x69\145\x44\145\x73\143\162\x69\160\164\x69\x6f\156"]; $localizationArr["\160\x72\x69\x76\141\x63\171\120\x6f\x6c\151\x63\x79"] = $item["\x6c\157\x63\x61\154\x69\172\141\x74\151\x6f\156"][$key]["\160\162\x69\x76\x61\143\x79\x50\x6f\154\151\143\x79"] ?? $item["\x6c\x6f\x63\141\x6c\151\x7a\x61\x74\151\157\156"]["\x65\x6e\147"]["\x70\162\x69\166\x61\143\x79\120\x6f\x6c\x69\x63\171"]; $localizationArr["\160\165\x72\x70\x6f\x73\145"] = $item["\x6c\x6f\x63\x61\x6c\x69\172\x61\x74\x69\157\156"][$key]["\143\157\x6f\153\x69\145\120\165\x72\160\157\x73\x65"] ?? $item["\154\157\x63\x61\x6c\151\x7a\141\164\x69\157\156"]["\145\x6e\x67"]["\x63\x6f\157\153\x69\145\120\x75\x72\160\x6f\x73\145"]; $localizationArr["\x6e\x61\x6d\145"] = $item["\x6c\x6f\x63\x61\x6c\x69\x7a\x61\x74\x69\157\x6e"][$key]["\143\x6f\x6f\153\151\x65\x54\151\x74\154\145"] ?? $item["\x6c\157\143\141\x6c\151\x7a\x61\164\151\x6f\156"]["\145\x6e\x67"]["\x63\x6f\157\x6b\151\x65\124\x69\x74\x6c\x65"]; array_push($returnArr, $localizationArr); p9bmW: } dVg3p: return $returnArr; } private static function getLocalizationID(ConsentModel $consentModel, int $consentID, int $languageID) : ?int { $localization = $consentModel->getLocalization()->where("\143\x6f\156\163\145\x6e\x74\111\104", $consentID)->where("\154\141\x6e\x67\x75\x61\x67\145\111\104", $languageID); $localization = $localization->first(); if (!($localization === null)) { goto rzByC; } return null; rzByC: return $localization->id; } private static function initConsentModel(Collection $jtlConsentItems, array $consentItem, DbInterface $db) : array { goto ZUkLh; ZUkLh: $returnArr = []; if (isset($consentItem["\164\x63\x6f\156\163\x65\x6e\164\x49\144"]) && $consentItem["\164\x63\x6f\156\x73\x65\156\x74\111\144"] != null) { goto snJoU; } $returnArr["\151\164\145\155\x49\104"] = self::updateItemIDOnDuplicate($jtlConsentItems, $consentItem); $returnArr["\143\157\x6e\x73\x65\x6e\x74\115\157\144\x65\x6c"] = new ConsentModel($db); goto vZUFm; snJoU: $filteredItemsID = $jtlConsentItems->where("\151\144", $consentItem["\164\143\157\x6e\163\x65\x6e\164\111\144"]); if (count($filteredItemsID) !== 0) { goto W_7TX; } $filteredItemsItemID = $jtlConsentItems->where("\x69\x74\x65\155\x49\x44", $consentItem["\x68\x69\x64\144\145\x6e\x4e\x61\x6d\145"]); if (count($filteredItemsItemID) !== 0) { goto eP1FP; } goto mfO64; mfO64: $returnArr["\151\164\x65\x6d\x49\104"] = self::updateItemIDOnDuplicate($jtlConsentItems, $consentItem); $returnArr["\143\x6f\x6e\163\145\x6e\x74\x4d\157\144\x65\x6c"] = new ConsentModel($db); goto bP07m; eP1FP: $consentModel = $filteredItemsItemID->first(); $returnArr["\143\x6f\x6e\x73\145\156\164\115\x6f\144\145\154"] = $consentModel; $returnArr["\x69\144"] = $consentModel->id; bP07m: goto NCK7R; W_7TX: goto MO_0_; MO_0_: $returnArr["\143\x6f\156\x73\x65\x6e\x74\x4d\x6f\144\x65\x6c"] = $filteredItemsID->first(); $returnArr["\151\144"] = $consentItem["\x74\143\x6f\156\x73\145\x6e\x74\x49\x64"]; NCK7R: vZUFm: return $returnArr; goto O4gvb; O4gvb: } private static function updateItemIDOnDuplicate(Collection $jtlConsentItems, array $consentItem) { $itemsWithSameItemID = $jtlConsentItems->where("\x69\x74\145\x6d\x49\x44", $consentItem["\150\151\144\x64\x65\x6e\x4e\141\155\x65"]); if (count($itemsWithSameItemID) === 0) { goto JecpP; } $newName = $consentItem["\x68\151\x64\144\145\156\x4e\141\x6d\x65"]; $randVal = null; d6fAr: if (!(count($jtlConsentItems->where("\x69\164\145\x6d\x49\104", $newName)) > 0)) { goto Wj7vB; } $randVal = rand(0, 10000); $newName = $consentItem["\x68\x69\144\144\145\x6e\116\141\155\145"] . $randVal; goto d6fAr; Wj7vB: return $newName; goto UdvoP; JecpP: return $consentItem["\150\x69\144\x64\145\x6e\x4e\x61\155\x65"]; UdvoP: } public static function createConsentManagerPayload($cookie, $descriptions) { $log = Shop::Container()->getLogService(); try { $localizationArr = []; $descCopy = null; foreach ($descriptions as $desc) { $descCopy = clone $desc; if (!isset($descCopy->id)) { goto iiGwG; } unset($descCopy->id); iiGwG: if (!isset($descCopy->cookieId)) { goto Uv6zc; } unset($descCopy->cookieId); Uv6zc: $descCopy->cookieTitle = $cookie->cookieTitle; $localizationArr[$desc->languageId] = (array) $descCopy; N4twW: } WXghU: $payload = ["\164\143\x6f\x6e\x73\x65\x6e\164\x49\144" => isset($cookie->tconsentId) ? (int) $cookie->tconsentId : null, "\x68\151\x64\x64\x65\156\x4e\141\x6d\x65" => $cookie->cookieName, "\143\157\x6d\160\141\156\x79" => $cookie->company ? $cookie->company : '', "\141\x63\164\151\x76\145" => (int) $cookie->active, "\154\x6f\x63\x61\x6c\x69\172\x61\x74\151\x6f\x6e" => $localizationArr]; return $payload; } catch (Exception $e) { $log->error("\105\x72\x72\x6f\x72\40\x63\162\145\141\164\x65\103\x6f\x6e\x73\145\x6e\x74\x4d\141\156\x61\147\x65\162\x50\141\x79\154\x6f\x61\x64\72\x20" . $e); } } public static function mergeAdmCookieAndJTLConsent($cookie, $jtlConsent) { $log = container()->make(Logger::class); try { $jtlConsentId = $jtlConsent["\151\144"]; unset($jtlConsent["\151\144"]); $obj_merged = (object) array_merge((array) $cookie, (array) $jtlConsent); $obj_merged->tconsentId = $jtlConsentId; unset($obj_merged->success); return $obj_merged; } catch (Exception $e) { $log->error("\x45\x72\x72\x6f\162\40\x63\x6d\x65\162\147\x65\x41\144\155\x43\x6f\x6f\x6b\x69\145\101\156\x64\112\124\114\103\157\x6e\x73\x65\x6e\164\72\40" . $e); } } public static function backupSalesboosterConsents() : Collection { $salesboosterConsents = ConsentModel::loadAll(Shop::Container()->getDB(), ["\x70\x6c\x75\x67\x69\x6e\111\104"], [AdmorrisLib::getPluginId()]); $salesboosterConsentsConverted = $salesboosterConsents->map(function ($consent) { $consent = $consent->rawArray(); unset($consent["\x69\x64"]); $consent["\154\x6f\x63\141\154\x69\x7a\x61\x74\151\x6f\156"] = $consent["\154\x6f\x63\141\154\x69\172\141\x74\151\157\x6e"]->map(function ($item) { $item = $item->rawArray(); unset($item["\151\x64"]); return $item; })->all(); return $consent; }); return $salesboosterConsentsConverted; } public static function loadSalesboosterConsentsBackup(Collection $salesboosterConsents) { if (!$salesboosterConsents->isEmpty()) { goto SeDlf; } return; SeDlf: $salesboosterConsents->each(function ($consentItem) { ConsentModel::create($consentItem, Shop::Container()->getDB()); }); } }