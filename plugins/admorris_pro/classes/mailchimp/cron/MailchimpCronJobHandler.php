<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro\mailchimp\cron; use JTL\Events\Dispatcher; use JTL\Plugin\PluginInterface; use JTL\Shop; use Plugin\admorris_pro\controller\AbstractHookController; use Plugin\admorris_pro\StatusRequest; use Plugin\admorris_pro\mailchimp\cron\MailchimpCronItemDTO; class MailchimpCronJobHandler extends AbstractHookController { private const MAILCHIMP_CRON_TABLE = "\x78\160\154\x75\x67\151\156\137\141\144\x6d\x6f\162\x72\x69\163\x5f\x70\162\157\x5f\x6d\x61\x69\x6c\143\150\151\155\x70\x5f\143\162\157\156"; protected string $configKey = "\141\144\155\x6f\x72\162\151\x73\137\160\x72\x6f\137\155\x61\162\153\145\164\151\156\147\x5f\155\x61\151\154\x63\x68\151\x6d\160\x5f\x61\143\x74\151\166\x65"; protected int $minModuleLevel = 1; public function __construct(PluginInterface $plugin, Dispatcher $dispatcher, StatusRequest $statusRequest) { parent::__construct($plugin, $dispatcher, $statusRequest); } protected function init() : void { try { $this->dispatcher->hookInto(\HOOK_ARTIKEL_XML_BEARBEITEINSERT, $this->productExport(...)); $this->dispatcher->hookInto(\HOOK_ARTIKEL_XML_BEARBEITEDELETES, $this->productDelete(...)); $this->dispatcher->hookInto(7, $this->customerExport(...)); $this->dispatcher->hookInto(27, $this->customerExport(...)); $this->dispatcher->hookInto(207, $this->orderExport(...)); } catch (\Throwable $th) { $this->log->error("\105\x72\162\x6f\162\40\x77\150\x69\x6c\145\40\x72\145\147\x69\163\x74\145\x72\151\x6e\x67\x20\x6d\x61\151\154\x63\150\x69\155\x70\40\x63\162\x6f\x6e\x20\152\157\x62\x20\150\157\157\x6b\x73\72\x20" . $th->getMessage(), ["\x65\x78\143\145\160\x74\151\x6f\x6e" => $th]); } } private function productExport($args_arr) : void { if (!(isset($args_arr["\157\x41\162\164\x69\153\x65\x6c"]->kArtikel) && $args_arr["\157\x41\162\x74\x69\153\x65\154"]->kArtikel > 0)) { goto T0C9r; } $cronItem = MailchimpCronItemDTO::forExport(itemId: intval($args_arr["\x6f\x41\x72\164\x69\x6b\145\154"]->kArtikel), itemType: "\160\x72\157\x64\165\x63\x74"); Shop::Container()->getDB()->upsert(self::MAILCHIMP_CRON_TABLE, $cronItem->toStdClass()); T0C9r: } private function productDelete($args_arr) : void { if (!(isset($args_arr["\x6b\101\162\164\x69\x6b\x65\x6c"]) && $args_arr["\x6b\101\x72\164\151\153\x65\154"] > 0)) { goto PSxGe; } $cronItem = MailchimpCronItemDTO::forDelete(itemId: $args_arr["\153\x41\x72\x74\151\x6b\x65\154"], itemType: "\160\162\x6f\x64\165\x63\164"); Shop::Container()->getDB()->upsert(self::MAILCHIMP_CRON_TABLE, $cronItem->toStdClass()); PSxGe: } private function orderExport($args_arr) : void { if (!(isset($args_arr["\157\102\145\163\164\145\x6c\154\165\x6e\x67"]->kBestellung) && $args_arr["\x6f\102\x65\x73\164\x65\154\154\x75\x6e\x67"]->kBestellung > 0)) { goto hekki; } $this->deleteMailchimpCart(); $cronItem = MailchimpCronItemDTO::forExport(itemId: intval($args_arr["\157\x42\145\163\164\145\x6c\x6c\165\156\147"]->kBestellung), itemType: "\x6f\x72\144\145\162"); Shop::Container()->getDB()->upsert(self::MAILCHIMP_CRON_TABLE, $cronItem->toStdClass()); if (!(isset($args_arr["\x6f\102\x65\163\x74\x65\x6c\x6c\x75\156\147"]->kKunde) && $args_arr["\x6f\x42\145\163\164\x65\154\x6c\x75\x6e\x67"]->kKunde > 0)) { goto xvnRD; } $customerCronItem = MailchimpCronItemDTO::forExport(itemId: intval($args_arr["\x6f\x42\145\163\164\x65\x6c\154\165\x6e\x67"]->kKunde), itemType: "\x63\165\163\x74\x6f\155\x65\x72"); Shop::Container()->getDB()->upsert(self::MAILCHIMP_CRON_TABLE, $customerCronItem->toStdClass()); xvnRD: hekki: } private function deleteMailchimpCart() : void { try { $kundendaten = $_SESSION["\113\x75\x6e\144\x65"] ?? null; if (empty($kundendaten)) { goto W3981; } $frontendPath = $this->plugin->getPaths()->getFrontendPath(); include_once $frontendPath . "\x6d\141\x69\x6c\143\x68\x69\155\x70\57\x64\x65\x6c\145\x74\x65\x5f\x63\141\x72\x74\x2e\160\x68\x70"; W3981: } catch (\Throwable $th) { $this->log->error("\105\162\x72\157\162\x20\144\x65\x6c\145\164\151\156\147\x20\155\x61\x69\154\x63\x68\151\x6d\x70\40\143\x61\162\164\72\x20" . $th->getMessage(), ["\x65\170\143\x65\x70\x74\151\x6f\x6e" => $th]); } } private function customerExport($args_arr) : void { $kundendaten = $_SESSION["\x4b\165\156\x64\x65"] ?? null; if (empty($kundendaten)) { goto gZeuP; } $cronItem = MailchimpCronItemDTO::forExport(itemId: intval($kundendaten->getID()), itemType: "\x63\165\163\x74\x6f\x6d\x65\162"); Shop::Container()->getDB()->upsert(self::MAILCHIMP_CRON_TABLE, $cronItem->toStdClass()); gZeuP: } }