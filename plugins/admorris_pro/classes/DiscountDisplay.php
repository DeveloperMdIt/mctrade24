<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro; use JTL\Shop; use JTL\Catalog\Product\Artikel; use JTL\Catalog\Product\Preise; class DiscountDisplay { use SettingsTrait; public $unit; public $textPos; public $discountFromUvp; public $customer_group; private $view; public $discount; public bool $active; public string $calc_from_uvp; public string $background_color; public string $text_color; public string $label_position; public string $label_vertical_position; public string $productlist_format; public string $productdetail_format; public string $show_old_price; public string $list_insert_type; public string $old_price_style; public string $list_fontsize; public string $details_fontsize; function __construct(private $plugin, private ?PriceDiscrimination $priceDiscrimination = null) { $this->mapSettings = ["\143\141\x6c\143\x5f\146\162\157\x6d\x5f\165\166\160", "\142\x61\143\153\x67\162\x6f\165\156\x64\x5f\x63\157\x6c\157\162", "\164\x65\x78\164\137\143\157\154\x6f\162", "\x6c\x61\x62\145\154\x5f\x70\157\163\x69\164\151\x6f\156", "\x6c\x61\x62\x65\x6c\x5f\x76\x65\x72\164\x69\143\x61\x6c\137\x70\x6f\163\151\x74\x69\157\x6e", "\x70\162\x6f\144\x75\143\x74\154\151\x73\x74\137\146\157\162\155\x61\x74", "\x70\x72\157\x64\x75\x63\164\144\x65\x74\x61\151\154\137\146\x6f\162\x6d\141\164", "\163\150\157\x77\x5f\x6f\x6c\144\x5f\160\162\151\143\x65", "\x6c\x69\163\164\x5f\151\156\163\x65\x72\x74\137\164\x79\x70\x65", "\x6f\x6c\144\137\160\x72\x69\x63\x65\137\163\164\x79\x6c\145", "\154\x69\163\164\137\x66\157\x6e\x74\163\x69\x7a\145", "\144\x65\164\x61\x69\x6c\x73\137\146\x6f\x6e\x74\163\x69\x7a\145"]; $this->langVars = ["\x70\162\x65\146\x69\170\x65\144\137\164\145\170\x74", "\x70\157\163\x74\146\x69\x78\x65\x64\137\x74\x65\x78\x74", "\157\x6c\x64\x5f\160\162\x69\x63\145", "\x75\166\x70"]; $this->settingPrefix = "\x6d\141\x72\x6b\145\164\151\x6e\147\x5f\x64\x69\163\143\x6f\165\x6e\x74\x5f\x64\x69\x73\x70\154\x61\x79"; $this->initSettings(); $this->customer_group = !empty($_SESSION["\x4b\165\156\144\x65\156\147\x72\x75\x70\160\x65"]) ? $_SESSION["\x4b\x75\x6e\144\145\156\x67\162\x75\160\x70\x65"]->getID() : null; if (!(isTemplateActive() && Shop::getPageType() === PAGE_STARTSEITE)) { goto x1f9v; } $this->view = "\x6c\x69\163\164"; x1f9v: } public function init() { $this->loadStyles(); if (Shop::getPageType() === PAGE_ARTIKELLISTE && $this->productlist_format !== "\x66\x61\154\x73\x65") { goto S2fbq; } if (Shop::getPageType() === PAGE_ARTIKEL) { goto kOuEH; } goto r0dUC; S2fbq: $this->displayInListView(); goto r0dUC; kOuEH: $this->displayInDetailView(); r0dUC: } private function displayInListView() { $smarty = Shop::Smarty(); $this->initFormatSettings("\154\x69\163\x74"); $Suchergebnisse = $smarty->getTemplateVars("\123\x75\143\150\x65\162\x67\145\142\x6e\x69\163\x73\x65"); $productList = $Suchergebnisse->getProducts() ?? null; if (empty($productList)) { goto bJ4W3; } foreach ($productList as $Artikel) { goto glMaA; YtK3y: $fullSelector = str_ireplace("\43\x6b\101\162\164\151\x6b\145\154\43", $Artikel->kArtikel, $selector); $template = $this->plugin->getPaths()->getFrontendPath() . "\164\x65\x6d\x70\x6c\141\x74\x65\x73\x2f\x64\151\x73\x63\x6f\165\156\164\x5f\x64\x69\163\160\x6c\141\171\x5f\x6c\x69\163\164\x2e\x74\x70\x6c"; $content = $smarty->fetch($template); \pq($fullSelector)->{$method}($content); Kk_qC: jgu7_: PCRft: h7Xnl: goto QfiE0; yzk0b: ox0Xp: $this->calcPriceDiscrimination($Artikel); goto gLo0h; mVkbR: $this->calcDiscountFromArticle($Artikel); gLo0h: if (!($this->discount !== false)) { goto Kk_qC; } $smarty->assign("\x61\x6d\137\x64\x69\x73\x63\x6f\165\156\164", $this)->assign("\141\x6d\137\141\162\x74\x69\143\154\x65", $Artikel); $selector = $this->plugin->getConfig()->getValue("\141\x64\155\157\162\x72\151\x73\x5f\x70\162\157\x5f\145\x78\160\145\x72\x74\137\163\x65\164\164\x69\x6e\x67\x73\137\144\x69\x73\x63\x6f\x75\156\164\137\144\151\x73\x70\154\x61\x79\x5f\154\x69\x73\164\137" . $this->list_insert_type . "\137\x63\163\x73\x5f\163\145\x6c\x65\143\x74\157\x72"); $method = $this->plugin->getConfig()->getValue("\x61\x64\x6d\x6f\x72\162\x69\163\137\x70\162\157\137\145\170\160\x65\162\x74\x5f\x73\x65\164\164\x69\x6e\x67\x73\137\144\151\x73\143\157\x75\x6e\164\137\x64\151\163\x70\x6c\x61\x79\137\154\x69\163\x74\x5f" . $this->list_insert_type . "\137\143\x73\163\x5f\163\x65\154\x65\x63\164\157\162\x5f\x74\x79\160\x65"); goto YtK3y; glMaA: $kArtikel = $Artikel->kArtikel; if (!($kArtikel !== null)) { goto PCRft; } $Artikel = new Artikel(); $Artikel->fuelleArtikel($kArtikel, null, $this->customer_group, $_SESSION["\x6b\x53\160\x72\141\143\x68\145"], true); $isSpecialOffer = $this->isSpecialOffer($Artikel); $isPriceDiscrimination = $this->isPriceDiscrimination($Artikel); if (!($isSpecialOffer || $isPriceDiscrimination)) { goto jgu7_; } if ($isPriceDiscrimination) { goto ox0Xp; } if ($isSpecialOffer) { goto mVkbR; } goto gLo0h; goto yzk0b; QfiE0: } zfcAX: bJ4W3: } private function displayInDetailView() { goto bWxPn; ao_Dh: $content = $smarty->fetch($template); if (!isset($method)) { goto P4e7m; } pq($selector)->{$method}($content); P4e7m: NKK_J: EXKht: goto TExAv; JIHLs: $this->calcPriceDiscrimination($Artikel); goto JEM0f; ZRvPm: $this->calcDiscountFromArticle($Artikel); JEM0f: if (!($this->discount !== false)) { goto NKK_J; } $smarty->assign("\141\x6d\x5f\144\x69\x73\143\x6f\165\x6e\164", $this)->assign("\141\x6d\137\141\x72\164\151\x63\154\145", $Artikel); $selector = $this->plugin->getConfig()->getValue("\141\144\155\x6f\x72\x72\151\x73\137\x70\162\157\x5f\x65\x78\x70\145\162\164\x5f\163\x65\x74\x74\x69\156\147\x73\137\144\151\x73\143\157\x75\x6e\x74\x5f\144\x69\163\x70\154\x61\171\137\x64\x65\164\141\x69\x6c\163\x5f\x63\x73\163\x5f\x73\145\x6c\145\143\164\x6f\x72"); $method = $this->plugin->getConfig()->getValue("\141\x64\x6d\157\162\162\x69\163\x5f\x70\x72\x6f\x5f\145\170\x70\x65\x72\x74\137\x73\145\x74\164\x69\x6e\147\x73\137\x64\151\163\x63\x6f\x75\156\x74\137\x64\x69\163\160\154\x61\x79\137\144\145\x74\141\x69\154\x73\x5f\143\x73\x73\x5f\163\145\x6c\x65\x63\164\x6f\x72\x5f\164\x79\x70\145"); $template = $this->plugin->getPaths()->getFrontendPath() . "\x74\x65\x6d\x70\x6c\141\x74\145\x73\x2f\x64\x69\163\x63\x6f\x75\156\x74\137\x64\151\x73\160\x6c\x61\171\x5f\144\x65\164\141\x69\154\163\56\x74\160\154"; goto ao_Dh; bWxPn: $this->initFormatSettings("\144\145\x74\x61\151\154"); $smarty = Shop::Smarty(); $Artikel = $smarty->getTemplateVars("\157\162\147\x5f\x61\162\x74\x69\143\154\x65"); $isSpecialOffer = $this->isSpecialOffer($Artikel); $isPriceDiscrimination = $this->isPriceDiscrimination($Artikel); if (!($isSpecialOffer || $isPriceDiscrimination)) { goto EXKht; } if ($isPriceDiscrimination) { goto gx7L_; } if ($isSpecialOffer) { goto ZRvPm; } goto JEM0f; gx7L_: goto JIHLs; TExAv: } private function isSpecialOffer($Artikel) { if ($Artikel->Preise->fVKBrutto > 0 && ($Artikel->Preise->Sonderpreis_aktiv || $Artikel->Preise->rabatt || $this->calculateFromUvp($Artikel))) { goto ldTFU; } return false; goto ewsFi; ldTFU: return true; ewsFi: } private function calcDiscountFromArticle($Artikel) { $NettoPreise = Shop::Smarty()->getTemplateVars("\116\x65\x74\164\157\120\x72\x65\151\x73\145"); $preis = $Artikel->Preise->fVK[$NettoPreise] / $_SESSION["\127\x61\145\150\162\x75\156\147"]->getConversionFactor(); $alterPreis = $Artikel->Preise->alterVK[$NettoPreise] / $_SESSION["\x57\141\145\150\x72\165\156\147"]->getConversionFactor(); if ($this->calc_from_uvp && $this->calculateFromUvp($Artikel)) { goto XOzCs; } $this->discountFromUvp = false; $this->discount = $this->getDiscount($preis, $alterPreis); goto z9B00; XOzCs: $uvp = $NettoPreise == 1 ? $Artikel->fUVP : $Artikel->fUVPBrutto; $this->discountFromUvp = true; $this->discount = $this->getDiscount($preis, $uvp); z9B00: } private function isPriceDiscrimination($Artikel) { if (!empty($Artikel)) { goto qRyaY; } return; qRyaY: return !empty($this->priceDiscrimination) ? $this->priceDiscrimination->isPriceDiscrimination($Artikel) : false; } private function calcPriceDiscrimination($Artikel) { goto t3yKw; clcGI: if ($alterPreis < $preis) { goto nOLoe; } $bisherigerPreis = $alterPreis; goto FDG_E; nOLoe: $bisherigerPreis = $preis; FDG_E: $uvp = $NettoPreise === 1 ? $Artikel->fUVP : $Artikel->fUVPBrutto; if ($this->calc_from_uvp && $this->calculateFromUvp($Artikel) && $bisherigerPreis < $uvp) { goto rQlCO; } $this->discountFromUvp = false; $this->discount = $this->getDiscount($spezialpreis, $bisherigerPreis); goto mjO6A; mjO6A: goto BAM9p; rQlCO: $this->discountFromUvp = true; $this->discount = $this->getDiscount($spezialpreis, $uvp); BAM9p: goto Jxu8s; t3yKw: $currentArticleId = $Artikel->kArtikel; $Artikel = $this->priceDiscrimination->getArticle($currentArticleId); $NettoPreise = Shop::Smarty()->getTemplateVars("\x4e\x65\x74\x74\x6f\120\162\145\151\x73\145"); $kundengruppe = (int) $_SESSION["\x61\x64\155\x6f\x72\x72\x69\x73\x5f\x70\162\157\137\160\x72\145\x69\163\144\x69\146\x66\x65\162\x65\156\x7a\x69\x65\x72\x75\x6e\x67"]->kKundengruppe; $spezialpreis = $this->priceDiscrimination->getSpecialPrice($kundengruppe, $Artikel->kArtikel, 1, $NettoPreise); $spezialpreis = $spezialpreis / $_SESSION["\x57\141\x65\150\x72\165\156\147"]->getConversionFactor(); $preis = $Artikel->Preise->fVK[$NettoPreise]; $preis = $preis / $_SESSION["\x57\141\x65\150\162\165\x6e\x67"]->getConversionFactor(); $alterPreis = $Artikel->Preise->alterVK[$NettoPreise]; $alterPreis = $alterPreis / $_SESSION["\x57\x61\x65\150\x72\165\156\147"]->getConversionFactor(); goto clcGI; Jxu8s: } private function calculateFromUvp($Artikel) { if (!($this->calc_from_uvp === "\x74\x72\x75\x65" || $this->calc_from_uvp === "\156\x6f\164\x5f\x64\151\x73\143\157\x75\x6e\x74\x73" && !($Artikel->Preise->Sonderpreis_aktiv || $Artikel->Preise->rabatt))) { goto SnH2U; } return (float) $Artikel->fUVP > 0 && (float) $Artikel->fUVPBrutto > (float) $Artikel->Preise->alterVK[0] && (float) $Artikel->fUVPBrutto > (float) $Artikel->Preise->fVKBrutto; SnH2U: } private function getDiscount($price, $oldPrice) { $priceDifference = $oldPrice - $price; if (!($priceDifference === 0)) { goto MZYLh; } return false; MZYLh: if (!($this->unit === "\143\x75\x72\x72\145\x6e\143\x79")) { goto ybDgL; } return Preise::getLocalizedPriceString($priceDifference); ybDgL: $percentValue = $priceDifference / $oldPrice * 100; if (!($percentValue < 1)) { goto jPL2g; } return false; jPL2g: return $this->formatPercentSaved($percentValue); } private function formatPercentSaved($num) { return number_format($num, 0, "\54", "\x2e") . "\45"; } private function initFormatSettings($view) { $this->view = $view; $formatSetting = "\x70\x72\x6f\x64\x75\143\164{$view}\137\x66\157\x72\155\141\x74"; if (strpos($this->{$formatSetting}, "\x70\145\162\x63\145\156\x74") !== false) { goto oOi55; } $this->unit = "\143\x75\162\162\145\156\x63\x79"; goto AJm35; oOi55: $this->unit = "\160\145\162\x63\x65\x6e\x74"; AJm35: if (strpos($this->{$formatSetting}, "\x70\162\x65\146\151\x78\x5f\164\145\170\x74") !== false) { goto HmiLL; } if (strpos($this->{$formatSetting}, "\160\x6f\x73\164\x66\x69\170\x5f\164\145\x78\164") !== false) { goto IA0Id; } $this->textPos = "\x6e\157\x5f\x74\145\x78\164"; goto ECu_x; HmiLL: $this->textPos = "\160\162\145\146\x69\170\137\164\145\x78\164"; goto ECu_x; IA0Id: $this->textPos = "\160\157\x73\x74\x66\x69\x78\x5f\x74\x65\x78\x74"; ECu_x: } private function addText() { if ($this->textPos === "\160\x72\145\x66\x69\x78\137\x74\145\x78\x74") { goto FLko8; } if ($this->textPos === "\160\157\x73\164\146\151\x78\137\164\x65\170\164") { goto HIAOP; } goto RBseh; FLko8: if (!isset($this->discount)) { goto m3ywe; } $this->discount = $this->lang->prefixed_text . $this->discount; m3ywe: goto RBseh; HIAOP: $this->discount = $this->discount . $this->lang->postfixed_text; RBseh: } private function loadStyles() { $smarty = Shop::Smarty(); $smarty->assign("\x61\155\x5f\144\x69\x73\143\x6f\165\156\164", $this); $template = $this->plugin->getPaths()->getFrontendPath() . "\164\145\155\x70\154\141\x74\x65\163\x2f\x64\x69\163\x63\157\165\156\164\x5f\144\151\163\x70\x6c\x61\x79\137\163\164\x79\154\x65\163\56\164\x70\x6c"; $styles = $smarty->fetch($template); $assetLoader = AssetLoader::getInstance(); $assetLoader->addEmbeddedStyles($styles); $assetLoader->addToHead($this->plugin->getPaths()->getFrontendURL() . "\143\x73\163\x2f\144\151\163\143\x6f\x75\x6e\164\55\x64\151\163\160\154\141\171\x2e\143\x73\163", "\x64\151\x73\143\157\x75\x6e\x74\x5f\x64\x69\163\160\154\141\171"); } public function productSlider($Artikel) { if (!$this->isSpecialOffer($Artikel)) { goto psqot; } $this->initFormatSettings("\x6c\151\163\x74"); $this->calcDiscountFromArticle($Artikel); if ($this->discount) { goto wZuLg; } return; wZuLg: $smarty = Shop::Smarty(); $smarty->assign("\x61\x6d\x5f\144\x69\x73\x63\157\x75\156\164", $this)->assign("\141\155\137\x61\x72\164\151\143\x6c\x65", $Artikel); $template = $this->plugin->getPaths()->getFrontendPath() . "\x74\x65\155\x70\x6c\x61\x74\145\163\x2f\x64\151\163\143\x6f\x75\x6e\x74\x5f\144\x69\x73\x70\x6c\141\171\x5f\154\x69\163\x74\x2e\164\160\x6c"; return $smarty->fetch($template); psqot: } }