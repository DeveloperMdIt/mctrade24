<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro; use JTL\DB\ReturnType; use JTL\Shop; class Elements { public const CACHE_ID = "\x61\x64\155\x6f\x72\x72\x69\x73\x5f\x70\x72\x6f\137\x65\x6c\x65\x6d\x65\x6e\164\x73"; private $smarty; private $settings; private $debugMode; private $triggerFilter; private $cache; public function __construct() { $this->smarty = Shop::Smarty(); $this->settings = Shop::get("\x61\x64\x6d\157\162\x72\151\x73\x2d\x63\x75\x73\x74\x6f\x6d\55\164\x65\x6d\x70\154\x61\x74\x65\55\163\145\164\164\151\156\147\163"); $this->debugMode = filter_var($this->settings->elementsDebugMode, FILTER_VALIDATE_BOOLEAN); $this->triggerFilter = new TriggerFilter(); $this->cache = Shop::Container()->getCache(); } public function loadElements() : void { if (!$this->debugMode) { goto Jh779; } return; Jh779: $elementsWithTriggers = $this->loadElementsWithTriggers(); foreach ($elementsWithTriggers as $element) { if (!(!Shop::isAdmin() && $element->onlyForAdmins)) { goto B_kVw; } goto Mc7Jd; B_kVw: $triggerResult = true; if (empty($element->triggerFilters)) { goto Xc3fb; } $triggerResult = $this->triggerFilter->checkTrigger($element->triggerFilters, $element->triggerFilterOperator); Xc3fb: if (!$triggerResult) { goto hqHkP; } $this->showElement($element); hqHkP: Mc7Jd: } oUC89: } private function loadElementsWithTriggers() : array { if (!(($cachedElements = $this->cache->get(self::CACHE_ID)) !== false)) { goto NNCwV; } return $this->filterElementsByTime($cachedElements); NNCwV: $db = Shop::Container()->getDB(); $query = "\x53\x45\114\x45\x43\x54\x20\12\40\40\x20\x20\x20\40\40\x20\x20\x20\40\40\40\x20\40\40\145\56\x2a\54\xa\x20\40\x20\40\40\40\x20\x20\x20\40\40\x20\40\40\40\x20\164\146\x2e\151\144\x20\x61\163\x20\164\146\137\x69\144\x2c\40\164\146\56\x74\162\x69\147\x67\x65\162\x46\151\154\x74\x65\162\x54\x79\x70\145\x20\141\x73\40\x74\x66\137\146\x69\154\164\145\162\x54\x79\160\145\x2c\40\xa\x20\x20\x20\40\x20\40\40\x20\40\x20\40\40\x20\x20\40\40\164\x66\56\164\162\151\147\x67\x65\x72\x46\151\x6c\x74\145\162\x56\141\154\165\145\40\x61\x73\40\x74\146\x5f\146\151\154\164\145\162\126\x61\x6c\x75\145\x2c\40\x74\146\x2e\x65\154\x65\155\x65\156\x74\111\x64\x20\x61\x73\40\164\x66\x5f\145\154\145\155\x65\156\x74\111\x64\12\40\40\40\x20\x20\x20\40\x20\x20\x20\x20\40\106\x52\117\115\x20\170\160\154\165\x67\151\156\x5f\141\x64\x6d\157\162\162\x69\x73\137\x70\162\157\x5f\145\x6c\145\155\x65\156\x74\x73\x20\x65\12\40\40\40\40\x20\40\x20\x20\x20\40\40\40\114\105\106\x54\x20\112\x4f\x49\x4e\x20\170\x70\x6c\x75\147\151\156\137\x61\144\155\157\x72\162\x69\x73\137\x70\x72\x6f\x5f\145\x6c\x65\155\x65\156\164\163\137\x63\x61\x74\145\147\x6f\x72\171\x20\143\x20\x4f\x4e\x20\x65\x2e\143\x61\164\x65\147\157\162\171\x49\x44\x20\75\x20\x63\x2e\151\x64\xa\x20\x20\40\x20\40\40\40\x20\x20\x20\x20\x20\x4c\105\x46\x54\x20\112\117\x49\116\40\170\160\154\x75\x67\151\156\x5f\141\144\155\157\162\x72\x69\x73\137\x70\x72\157\137\145\154\145\155\x65\x6e\x74\163\137\164\162\151\x67\x67\145\x72\137\146\151\154\164\145\x72\x20\164\146\40\117\116\40\x65\56\x69\144\40\x3d\40\x74\146\56\145\x6c\145\x6d\145\x6e\x74\x49\144\12\x20\x20\x20\40\40\40\40\x20\x20\x20\40\40\127\110\x45\x52\105\x20\145\x2e\x61\x63\164\151\166\145\40\x3d\x20\x27\61\x27\xa\40\x20\x20\x20\x20\40\x20\x20\40\40\40\x20\x41\116\x44\x20\x63\x2e\x61\143\x74\x69\x76\145\40\x3d\x20\x27\61\47\12\40\x20\x20\x20\x20\40\x20\40\x20\40\x20\x20\x4f\122\x44\x45\122\40\102\131\x20\145\56\x70\162\x69\x6f\162\x69\164\x79\40\104\105\x53\103\xa\x20\x20\40\x20\x20\x20\40\40"; $results = $db->query($query, ReturnType::ARRAY_OF_OBJECTS); if (!empty($results)) { goto oNjMv; } $this->cache->set(self::CACHE_ID, [], [\CACHING_GROUP_PLUGIN, Shop::get("\x6f\160\154\165\x67\x69\x6e\x5f\x61\144\x6d\157\x72\162\151\x73\x5f\x70\162\x6f")?->getCache()->getGroup()]); return []; oNjMv: $elementsMap = []; foreach ($results as $row) { $elementId = $row->id; if (isset($elementsMap[$elementId])) { goto oQVhu; } $element = (object) ["\x69\144" => $row->id, "\x6e\141\x6d\145" => $row->name, "\x63\x6f\156\x74\x65\x6e\x74" => $row->content, "\x73\x65\x6c\145\x63\164\x6f\162" => $row->selector, "\x73\x65\x6c\x65\x63\x74\x6f\x72\124\x79\x70\145" => $row->selectorType, "\x74\x72\151\147\147\145\162\106\x69\154\x74\x65\x72\117\160\145\162\x61\164\157\162" => $row->triggerFilterOperator, "\141\143\164\151\x76\x65" => $row->active, "\x73\164\141\x72\x74\x54\x69\155\x65" => $row->startTime, "\x65\156\144\x54\151\x6d\145" => $row->endTime, "\x70\162\151\x6f\162\151\164\x79" => $row->priority, "\x6f\156\154\171\x46\x6f\x72\x41\x64\155\151\156\163" => (bool) $row->onlyForAdmins, "\164\x72\x69\147\x67\145\x72\x46\x69\154\164\145\162\163" => []]; $elementsMap[$elementId] = $element; oQVhu: if (!($row->tf_id !== null)) { goto QSZ07; } $triggerFilter = (object) ["\x69\x64" => $row->tf_id, "\164\162\151\147\147\145\162\106\151\154\x74\145\x72\x54\x79\160\x65" => $row->tf_filterType, "\164\162\x69\147\x67\x65\162\106\151\x6c\x74\145\162\126\x61\x6c\x75\x65" => $row->tf_filterValue, "\145\x6c\145\155\145\x6e\x74\x49\144" => $row->tf_elementId]; $elementsMap[$elementId]->triggerFilters[] = $triggerFilter; QSZ07: wFiKQ: } JyV_3: $allElements = array_values($elementsMap); $this->cache->set(self::CACHE_ID, $allElements, [\CACHING_GROUP_PLUGIN, Shop::get("\157\x70\x6c\165\x67\x69\156\x5f\141\144\x6d\157\x72\162\151\x73\137\x70\x72\x6f")?->getCache()->getGroup()]); return $this->filterElementsByTime($allElements); } private function filterElementsByTime(array $elements) : array { $now = date("\x59\55\155\55\x64\x20\110\72\151\72\x73"); return array_filter($elements, function ($element) use($now) { return $element->startTime <= $now && $element->endTime >= $now; }); } private function showElement(object $el) : void { $content = $el->content; $selector = $el->selector; $selectorType = $el->selectorType; $elementTemplate = ''; $element = pq($selector); if (empty($element->get())) { goto uNBi2; } try { $elementTemplate = $this->smarty->fetch("\x65\166\141\x6c\x3a" . $content); } catch (\Throwable $th) { if (!Shop::isAdmin()) { goto Nv6E8; } $errorMessage = "\74\x64\151\166\x20\x63\154\141\163\x73\75\42\141\154\x65\162\164\40\x61\154\x65\x72\x74\x2d\144\141\x6e\x67\x65\x72\42\40\163\164\x79\x6c\145\x3d\42\155\141\x72\147\x69\x6e\72\x20\64\162\x65\x6d\40\x31\x72\x65\x6d\x20\x31\162\x65\x6d\73\x22\x3e\12\x20\40\40\40\101\x64\155\x6f\x72\x72\x69\163\x20\x50\x72\x6f\72\xa\40\40\x20\40\74\x68\x34\76\x45\162\162\x6f\x72\40\151\x6e\40\105\x6c\x65\x6d\x65\x6e\164\x20\46\x71\165\x6f\x74\73{$el->name}\x26\161\x75\x6f\164\73\x3a\x3c\57\x68\64\x3e\xa\x20\40\x20\40\74\x70\76\12\x20\40\40\x20\x20\40\40\40\x3c\x63\157\144\x65\x3e{$th->getMessage()}\74\57\x63\x6f\x64\x65\76\12\40\x20\40\40\74\57\x70\x3e\xa\40\x20\x20\x20\x3c\x70\76\xa\40\40\x20\x20\40\40\40\40\74\x73\x6d\141\154\x6c\76\104\151\x65\x73\145\40\x4e\x61\143\150\162\151\x63\150\164\x20\x69\163\x74\40\156\165\162\40\x66\46\165\x75\x6d\x6c\x3b\162\x20\101\144\x6d\x69\x6e\40\x55\163\145\x72\x20\x73\x69\x63\150\164\142\141\162\74\x2f\x73\x6d\x61\154\x6c\x3e\12\x20\x20\x20\40\74\x2f\x70\76\xa\x3c\x2f\144\151\166\76"; pq("\x62\157\x64\171")->prepend($errorMessage); Nv6E8: Shop::Container()->getLogService()->error("\101\x64\x6d\x6f\x72\x72\151\163\x20\120\162\x6f\x3a\40\106\x65\x68\154\145\x72\x20\x69\156\x20\x45\x6c\145\x6d\x65\x6e\164\40\x22" . $el->name . "\x22\72\x20" . $th->getMessage()); } if (!(empty($elementTemplate) && !in_array($selectorType, ["\162\145\160\x6c\x61\143\x65\127\x69\x74\150", "\x72\x65\x70\154\x61\143\x65\x41\154\x6c", "\x74\x65\x78\x74", "\145\155\x70\x74\x79", "\150\164\155\x6c", "\x72\145\155\157\x76\145"]))) { goto fX2Xq; } return; fX2Xq: match ($selectorType) { "\141\160\160\145\x6e\x64" => $element->append($elementTemplate), "\x70\162\x65\160\145\x6e\144" => $element->prepend($elementTemplate), "\x62\145\x66\x6f\x72\x65" => $element->before($elementTemplate), "\141\146\164\145\x72" => $element->after($elementTemplate), "\x72\x65\x70\154\x61\x63\x65\x57\x69\x74\x68" => $element->replaceWith($elementTemplate), "\x72\145\x70\154\141\143\x65\x41\154\x6c" => $element->replaceAll($elementTemplate), "\162\x65\x70\x6c\141\x63\145\103\154\141\163\163" => (function () use($element, $selector, $elementTemplate) { $classes = explode("\40", $selector); $classesToRemove = explode("\56", end($classes)); foreach ($classesToRemove as $class) { $element->removeClass($class); pcC3Z: } Wc8pA: $element->addClass($elementTemplate); })(), "\x61\144\144\103\154\141\163\x73" => $element->addClass($elementTemplate), "\x72\x65\x6d\x6f\166\145\103\154\x61\163\163" => (function () use($element, $elementTemplate) { $classes = explode("\40", $elementTemplate); foreach ($classes as $class) { $element->removeClass($class); ro_WN: } H838I: })(), "\162\145\155\157\166\x65\x41\x74\x74\x72" => (function () use($element, $elementTemplate) { $attributes = explode("\x20", $elementTemplate); foreach ($attributes as $attr) { $element->removeAttr($attr); QNvcu: } yo7GT: })(), "\141\x64\x64\x41\164\164\162" => (function () use($element, $elementTemplate) { $attributes = explode("\40", $elementTemplate); foreach ($attributes as $attr) { $keyValue = explode("\x3d", $attr); $element->attr($keyValue[0], $keyValue[1]); LVjoZ: } E0wKn: })(), "\x74\145\x78\x74" => $element->text($elementTemplate), "\x77\x72\x61\x70" => $element->wrap($elementTemplate), "\167\x72\x61\x70\111\x6e\156\x65\162" => $element->wrapInner($elementTemplate), "\x77\162\141\160\101\154\x6c" => $element->wrapAll($elementTemplate), "\141\160\160\145\156\144\124\157" => $element->appendTo($elementTemplate), "\160\x72\145\160\145\156\144\x54\x6f" => $element->prependTo($elementTemplate), "\x69\156\163\145\162\164\101\x66\164\x65\x72" => $element->insertAfter($elementTemplate), "\151\156\163\x65\162\x74\x42\145\146\x6f\x72\145" => $element->insertBefore($elementTemplate), "\x65\155\160\x74\x79" => $element->empty(), "\x72\x65\x6d\157\x76\145" => $element->remove(), "\x68\164\155\154" => $element->html($elementTemplate), default => throw new \InvalidArgumentException("\111\x6e\166\141\154\151\x64\x20\163\x65\154\145\143\164\157\x72\x20\x74\171\x70\x65\x3a\x20{$selectorType}"), }; uNBi2: } }