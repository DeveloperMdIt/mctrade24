<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro; use JTL\Shop; use JTL\Catalog\Product\Artikel; use JTL\Catalog\Product\Preise; use JTL\Shopsetting; use JTL\Helpers\Request; class PriceDiscrimination { private $articles = []; private $discountedArticles = []; public $customerGroup; private $smarty; public $currentCustomerGroup; public function __construct(private $plugin) { $this->plugin = $plugin; $this->smarty = Shop::Smarty(); $this->currentCustomerGroup = $_SESSION["\x4b\165\156\144\145\x6e\147\x72\165\x70\x70\x65"]->getID() ?? 0; $this->getDiscountCustomerGroup(); } private function getDiscountCustomerGroup() { if (empty($this->customerGroup)) { goto fZcyB; } return $this->customerGroup; fZcyB: return $this->customerGroup = !empty($_SESSION["\141\144\155\x6f\x72\162\151\x73\x5f\160\x72\157\137\x70\x72\x65\151\x73\x64\151\146\x66\x65\x72\x65\156\172\151\145\162\x75\156\147"]->kKundengruppe) ? (int) $_SESSION["\x61\x64\x6d\157\x72\x72\x69\x73\x5f\160\162\157\137\x70\162\x65\x69\163\x64\151\146\146\x65\162\x65\x6e\x7a\x69\145\x72\165\x6e\147"]->kKundengruppe : 0; } public function getArticle($articleId, $withDiscount = false) { $this->getDiscountCustomerGroup(); $articleProperty = $withDiscount ? "\x64\x69\x73\143\x6f\x75\156\x74\145\x64\x41\162\x74\x69\143\154\x65\x73" : "\141\x72\164\151\x63\x6c\x65\x73"; $customerGroup = $withDiscount ? $this->customerGroup : $this->currentCustomerGroup; if (!empty($this->{$articleProperty}[$articleId])) { goto e3My6; } $newArticle = new Artikel(); $newArticle->fuelleArtikel($articleId, null, $customerGroup, $_SESSION["\x6b\123\160\x72\x61\x63\x68\145"], true); $this->{$articleProperty}[$articleId] = $newArticle; e3My6: return $this->{$articleProperty}[$articleId]; } public function isPriceDiscrimination($Artikel) { if (!(!$this->isEnabled() || empty($this->getDiscountCustomerGroup()))) { goto RDW4E; } return false; RDW4E: $currentId = $Artikel->kArtikel; $newArticle = $this->getArticle($currentId); if (!($this->articles[$currentId]->bHasKonfig == true)) { goto fgw8_; } return false; fgw8_: $spezialpreis = $this->getSpecialPrice($this->customerGroup, $Artikel->kArtikel, 1, 1); $spezialpreis = $spezialpreis * $_SESSION["\x57\x61\145\x68\x72\165\156\x67"]->getConversionFactor(); if (!($spezialpreis < $Artikel->Preise->fVK[1] && ($this->getDiscountAllSetting() || $_SESSION["\x61\144\155\x6f\x72\x72\151\x73\137\160\162\x6f\x5f\160\162\x65\151\163\x64\151\146\146\x65\162\x65\156\172\151\145\162\x75\x6e\147"]->kArtikel == $Artikel->kArtikel))) { goto FHpLe; } return true; FHpLe: } private function isEnabled() { $enabled = $this->plugin->getConfig()->getValue("\x61\144\155\x6f\162\x72\151\x73\137\160\x72\157\x5f\x6d\141\162\153\x65\164\x69\156\147\x5f\x70\x72\151\143\x65\x5f\x64\151\163\143\162\151\155\x69\156\141\x74\151\x6f\156\137\141\x63\164\151\x76\x65"); return $enabled === "\131"; } private function getDiscountAllSetting() { return $this->plugin->getConfig()->getValue("\x61\144\x6d\x6f\x72\x72\x69\163\x5f\x70\162\x6f\x5f\x6d\141\x72\153\145\164\151\x6e\x67\x5f\160\x72\x69\x63\x65\x5f\144\x69\x73\x63\162\151\155\x69\x6e\x61\164\151\x6f\156\137\x64\x69\163\143\157\x75\156\x74\137\141\154\154") === "\x59"; } public function applyDiscount() { goto UD6cb; UD6cb: $rabatttitel = $this->plugin->getLocalization()->getTranslation("\141\144\x6d\157\x72\162\x69\x73\137\160\162\x6f\x5f\x6d\x61\162\153\x65\164\151\x6e\x67\137\x70\162\151\x63\x65\x5f\x64\151\x73\x63\162\151\x6d\x69\x6e\x61\x74\151\157\156\137\144\151\163\143\157\x75\156\164\137\164\x65\x78\x74"); $found = false; $cartBefore = $_SESSION["\x57\141\x72\x65\x6e\153\x6f\x72\x62"]->PositionenArr; $specialKArtikel = $_SESSION["\x61\x64\155\157\162\162\151\x73\137\x70\x72\x6f\137\160\162\x65\x69\163\x64\151\x66\146\145\162\x65\156\172\151\145\x72\165\x6e\147"]->kArtikel ?? null; $allProducts = $this->getDiscountAllSetting(); $diffenzInklTaxSumme = []; if (!$this->customerGroup) { goto XVfco; } $kundengruppe = $this->customerGroup; if ($allProducts) { goto CLY7I; } $cart = $_SESSION["\x57\x61\162\145\x6e\153\x6f\162\x62"]; goto qVYju; qVYju: foreach ($cart->PositionenArr as $i => $item) { if (!(isset($item->nPosTyp) && (int) $item->nPosTyp === 4 && isset($item->cUnique) && $item->cUnique == 100)) { goto Mgstk; } unset($cart->PositionenArr[$i]); Mgstk: vBW3W: } d4zTu: $cart->PositionenArr = \array_merge($cart->PositionenArr); $_SESSION["\127\141\x72\x65\x6e\x6b\157\162\142"] = $cart; goto kj5hD; CLY7I: $steuerklassen = Shop::Container()->getDB()->query("\x53\105\x4c\x45\103\124\40\153\x53\x74\145\165\x65\x72\x6b\x6c\141\163\x73\x65\x20\106\x52\x4f\115\40\x74\x73\164\x65\x75\145\162\153\x6c\x61\163\x73\145", 2); foreach ($steuerklassen as $steuerklasse) { $spezialposition = 100 + $steuerklasse->kSteuerklasse; $cart = $_SESSION["\127\x61\162\145\156\153\x6f\162\x62"]; foreach ($cart->PositionenArr as $i => $item) { if (!(isset($item->nPosTyp) && (int) $item->nPosTyp === 4 && isset($item->cUnique) && $item->cUnique == $spezialposition)) { goto P3YZX; } unset($cart->PositionenArr[$i]); P3YZX: OsNHB: } NBgy7: $cart->PositionenArr = \array_merge($cart->PositionenArr); $_SESSION["\x57\x61\162\x65\156\153\157\162\142"] = $cart; $diffenzInklTaxSumme[$steuerklasse->kSteuerklasse] = new \stdClass(); jnjY3: } Qi2cw: kj5hD: goto Jyci5; Jyci5: $warenkorbpos = $_SESSION["\x57\141\162\145\156\x6b\x6f\162\142"]->PositionenArr; $diffenzInklTaxSummeTotal = 0; foreach ($warenkorbpos as $key => $pos) { goto ouG2q; eeExi: gJ9Vm: jfH2E: goto ThBzS; xwXSb: $steuerklasse = $warenkorbpos[$key]->kSteuerklasse; $spezialpreis = round($spezialpreis * (1 + $steuersatz / 100), 2); $standardpreis = round($standardpreis * (1 + $steuersatz / 100), 2); $diferenzInklTax = round(($standardpreis - $spezialpreis) * $anzahl, 2) / $_SESSION["\127\x61\x65\x68\162\x75\x6e\147"]->getConversionFactor(); $diferenzInklTax = round($diferenzInklTax, 2); $diffenzInklTaxSummeTotal = $diffenzInklTaxSummeTotal + $diferenzInklTax; if ($allProducts) { goto TD4t_; } $_SESSION["\x57\x61\162\145\156\x6b\x6f\162\142"]->erstelleSpezialPos($rabatttitel . "\x20" . html_entity_decode($warenkorbpos[$key]->Artikel->cName), 1, $diferenzInklTax * -1, $steuerklasse, 4, false, true, '', 100); goto qmpF2; TD4t_: goto k8lXc; ouG2q: if (!($pos->nPosTyp !== \C_WARENKORBPOS_TYP_ARTIKEL || $this->notDiscriminated($pos->Artikel))) { goto O5Vrm; } goto jfH2E; O5Vrm: $kArtikel = $warenkorbpos[$key]->kArtikel; $anzahl = $warenkorbpos[$key]->nAnzahl; $spezialpreis = $this->getSpecialPrice($this->customerGroup, $kArtikel, $anzahl, 1); $standardpreis = $this->getSpecialPrice($this->currentCustomerGroup, $kArtikel, $anzahl, 1); if (!($standardpreis > $spezialpreis)) { goto gJ9Vm; } $steuersatz = $_SESSION["\x53\x74\x65\165\x65\x72\x73\x61\164\172"]; $steuersatz = $steuersatz[$warenkorbpos[$key]->kSteuerklasse]; goto xwXSb; k8lXc: if (!empty($diffenzInklTaxSumme[$steuerklasse]->summe)) { goto GilfC; } $diffenzInklTaxSumme[$steuerklasse]->summe = $diferenzInklTax; goto WsVYw; GilfC: $diffenzInklTaxSumme[$steuerklasse]->summe = $diffenzInklTaxSumme[$steuerklasse]->summe + $diferenzInklTax; WsVYw: $diffenzInklTaxSumme[$steuerklasse]->steuerklasse = $steuerklasse; $diffenzInklTaxSumme[$steuerklasse]->steuersatz = $steuersatz; qmpF2: $found = true; goto eeExi; ThBzS: } z1qCP: $_SESSION["\x61\144\155\x6f\162\162\x69\x73\137\x70\x72\x6f\137\160\x72\145\151\163\144\x69\x66\146\x65\x72\x65\x6e\172\151\145\162\165\156\147"]->diffenzInklTaxSummeTotal = $diffenzInklTaxSummeTotal; XVfco: if (!($found == true && $allProducts)) { goto aDNCt; } foreach ($diffenzInklTaxSumme as $steuerklasse) { if (!(isset($steuerklasse->summe) && $steuerklasse->summe > 0.01)) { goto MX2QR; } $_SESSION["\127\141\162\145\x6e\153\x6f\x72\142"]->erstelleSpezialPos($rabatttitel . "\40\x28" . $steuerklasse->steuersatz . "\x25\40\125\x53\x74\x29", 1, $steuerklasse->summe * -1, $steuerklasse->steuerklasse, 4, false, true, '', 100 + $steuerklasse->steuerklasse); MX2QR: o65R0: } BOR3k: aDNCt: goto HWCc4; HWCc4: $cartAfter = $_SESSION["\x57\141\162\145\x6e\x6b\x6f\x72\x62"]->PositionenArr; if (!($this->getBasketTotal($cartBefore) !== $this->getBasketTotal($cartAfter) && Shop::getPageType() === PAGE_WARENKORB)) { goto y80eA; } echo "\74\x6d\145\x74\x61\x20\x68\x74\164\160\55\x65\161\x75\151\166\75\47\162\145\146\162\145\x73\150\47\40\x63\157\156\x74\x65\156\x74\75\x27\60\x27\x3e"; y80eA: return $found; goto mJzAJ; mJzAJ: } public function getSpecialPrice($kundengruppe, $kArtikel, $Anzahl, $netto = 0) { $kundengruppenpreise = new Preise($kundengruppe, $kArtikel, 0, 1); if (!$kundengruppenpreise->Sonderpreis_aktiv) { goto OW2iV; } $kundengruppenrabatt = 0; goto gkam_; OW2iV: $artikel = new Artikel(); $kundengruppenrabatt = $artikel->getDiscount($kundengruppe, $kArtikel); gkam_: $price = $this->getStaffelpreis($kundengruppenpreise, $Anzahl, $netto); return $this->calculateSpecialPrice($price, $kundengruppenrabatt); } private function getStaffelpreis($kundengruppenpreise, $Anzahl, $netto = 0) { goto Knt94; Knt94: $index = $netto; if ($kundengruppenpreise->nAnzahl1 != null && $Anzahl >= $kundengruppenpreise->nAnzahl1 && ($kundengruppenpreise->nAnzahl2 == null || $Anzahl < $kundengruppenpreise->nAnzahl2)) { goto flwNH; } if ($kundengruppenpreise->nAnzahl2 != null && $Anzahl >= $kundengruppenpreise->nAnzahl2 && ($kundengruppenpreise->nAnzahl3 == null || $Anzahl < $kundengruppenpreise->nAnzahl3)) { goto qHDRC; } if ($kundengruppenpreise->nAnzahl3 != null && $Anzahl >= $kundengruppenpreise->nAnzahl3 && ($kundengruppenpreise->nAnzahl4 == null || $Anzahl < $kundengruppenpreise->nAnzahl4)) { goto s8izI; } if ($kundengruppenpreise->nAnzahl4 != null && $Anzahl >= $kundengruppenpreise->nAnzahl4 && ($kundengruppenpreise->nAnzahl5 == null || $Anzahl < $kundengruppenpreise->nAnzahl5)) { goto iGeqo; } if ($kundengruppenpreise->nAnzahl5 != null && $Anzahl >= $kundengruppenpreise->nAnzahl5) { goto LiM2y; } $price = $kundengruppenpreise->fVK[$index]; goto gL14J; flwNH: $price = $kundengruppenpreise->fStaffelpreis_arr[0][$index]; goto ZvLPt; ZvLPt: goto gL14J; qHDRC: $price = $kundengruppenpreise->fStaffelpreis_arr[1][$index]; goto gL14J; s8izI: $price = $kundengruppenpreise->fStaffelpreis_arr[2][$index]; goto gL14J; iGeqo: $price = $kundengruppenpreise->fStaffelpreis_arr[3][$index]; goto gL14J; goto Iic1H; Iic1H: LiM2y: $price = $kundengruppenpreise->fStaffelpreis_arr[4][$index]; gL14J: return $price; goto zeVk8; zeVk8: } private function calculateSpecialPrice($price, $customergroupDiscount) { if ($customergroupDiscount != 0) { goto hDVTh; } $spezialpreis = $price; goto JUuL7; hDVTh: $spezialpreis = $price * (1 - $customergroupDiscount / 100); JUuL7: return round($spezialpreis, 4); } public function getBasketTotal($PositionenArr) { $total = 0; foreach ($PositionenArr as $key => $pos) { $total = $total + $pos->fPreis; xDI3_: } RKTnD: return $total; } public function setSmartyAndSessionVariables() { goto FPfCc; kTXKP: if (empty($kundengruppenId->kKundengruppe)) { goto QjuD5; } $_SESSION["\x61\144\155\x6f\162\x72\x69\x73\x5f\160\x72\157\137\160\162\x65\x69\x73\144\x69\x66\146\145\162\x65\156\x7a\x69\145\x72\165\156\x67"]->kArtikel = $kArtikel; $_SESSION["\141\144\155\x6f\x72\x72\151\x73\137\160\162\157\137\x70\x72\145\x69\x73\144\151\146\x66\145\162\x65\156\172\x69\145\162\165\156\147"]->kKundengruppe = $kundengruppenId->kKundengruppe; $_SESSION["\x61\144\155\x6f\x72\162\151\x73\137\160\162\x6f\137\160\x72\x65\x69\x73\144\151\146\x66\145\162\x65\156\x7a\x69\145\162\165\x6e\x67"]->initialkKundengruppe = $this->currentCustomerGroup; QjuD5: Lqj62: if (!empty($_SESSION["\x61\144\x6d\157\x72\x72\x69\x73\137\x70\162\157\x5f\x70\162\x65\151\x73\144\151\146\x66\145\x72\145\156\172\x69\x65\x72\165\x6e\147"]->kKundengruppe)) { goto iqjeQ; } return; iqjeQ: switch (Shop::getPageType()) { case \PAGE_ARTIKEL: $this->setProductdetailsVariable(); goto C8Zgv; case \PAGE_ARTIKELLISTE: $this->setProductlistVariables(); goto C8Zgv; } goto klZ8a; klZ8a: YYI2Z: C8Zgv: goto wY5ri; zWUQz: $_SESSION["\141\144\x6d\157\x72\162\x69\163\137\x70\162\157\x5f\x70\162\145\151\x73\144\151\x66\x66\145\162\145\x6e\x7a\151\x65\x72\x75\x6e\x67"] = new \stdClass(); hZJKd: if (!($allProducts && $parameterValue !== null)) { goto zk5ur; } $_SESSION["\x61\x64\x6d\157\162\x72\x69\163\x5f\x70\x72\x6f\x5f\160\x72\x65\151\x73\x64\151\146\x66\145\x72\x65\156\x7a\151\x65\x72\x75\x6e\x67"]->parameterValue = $parameterValue; zk5ur: if (!$allProducts) { goto Mi5_T; } $parameterValue = $_SESSION["\x61\x64\155\x6f\162\x72\151\163\x5f\x70\162\157\137\160\162\x65\151\163\144\x69\x66\146\145\x72\x65\156\172\151\145\x72\x75\156\x67"]->parameterValue ?? null; Mi5_T: if (!($parameterValue !== null)) { goto Lqj62; } $kundengruppenId = Shop::Container()->getDB()->queryPrepared("\123\105\114\x45\x43\x54\40\153\x4b\165\x6e\144\145\156\147\x72\x75\x70\x70\145\x20\106\122\117\115\x20\164\x6b\x75\156\144\x65\x6e\147\162\165\160\x70\x65\156\x61\164\164\162\x69\142\x75\x74\x20\127\110\x45\x52\x45\x20\x63\116\x61\x6d\x65\40\x3d\x20\47\x70\x72\145\151\x73\144\151\146\146\x65\162\x65\156\172\151\x65\162\165\156\147\47\40\x41\116\x44\40\143\x57\x65\162\164\x20\75\x20\72\160\x61\x72\x61\x6d\x65\x74\x65\x72\126\x61\154\x75\145", ["\160\141\x72\141\155\x65\164\x65\x72\126\141\154\165\x65" => $parameterValue], 1); goto kTXKP; FPfCc: $nSeitenTyp = Shop::getPageType(); $kArtikel = null; if (!($nSeitenTyp === 1)) { goto zdf00; } $Artikel = $this->smarty->getTemplateVars("\x41\162\x74\151\153\145\154"); $kArtikel = $Artikel->Preise->kArtikel; zdf00: $parameter = $this->plugin->getConfig()->getValue("\x61\x64\x6d\x6f\x72\x72\151\x73\137\160\162\157\x5f\155\141\x72\x6b\x65\164\x69\156\147\137\x70\x72\x69\143\x65\137\144\x69\163\x63\162\x69\x6d\x69\156\141\164\x69\x6f\156\x5f\x70\x61\162\x61\155\x65\164\x65\x72"); $allProducts = $this->getDiscountAllSetting(); $parameterValue = $_GET[$parameter] ?? null; if (!empty($_SESSION["\141\x64\155\157\x72\x72\151\163\137\x70\162\x6f\x5f\160\162\x65\x69\x73\144\x69\x66\146\x65\x72\x65\156\172\x69\x65\x72\165\156\147"])) { goto hZJKd; } goto zWUQz; wY5ri: } private function setProductdetailsVariable() { goto qKGWr; TMXc3: $Artikel->fStaffelpreisVPE5 = $newArtikel->fStaffelpreisVPE5; $Artikel->fStaffelpreisVPE_arr = $newArtikel->fStaffelpreisVPE_arr; $Artikel->cStaffelpreisLocalizedVPE_arr = $newArtikel->cStaffelpreisLocalizedVPE_arr; $Artikel->staffelPreis_arr = $newArtikel->staffelPreis_arr; $Artikel = $this->getArticleRatings($Artikel); $this->smarty->assign("\101\162\x74\151\x6b\x65\x6c", $Artikel); goto mUlSW; Lwr59: $newArtikel = $this->getArticleRatings($newArtikel); $this->smarty->assign("\101\x72\x74\x69\153\x65\154", $newArtikel); goto I09Ff; I09Ff: mUlSW: goto YYlKg; qKGWr: $Artikel = $this->smarty->getTemplateVars("\x41\x72\x74\151\153\x65\154"); $kArtikel = $Artikel->Preise->kArtikel; if (!$this->notDiscriminated($Artikel)) { goto aDMGq; } return; aDMGq: $newArtikel = $this->getArticle($kArtikel, true); if ($newArtikel->Preise->fVKNetto < $this->smarty->getTemplateVars("\x41\162\x74\x69\153\x65\x6c")->Preise->fVKNetto && $Artikel->nIstVater == 1) { goto pPLOx; } if ($newArtikel->Preise->fVKNetto < $this->smarty->getTemplateVars("\101\x72\164\151\153\x65\x6c")->Preise->fVKNetto) { goto Lwr59; } goto mUlSW; pPLOx: goto p4zXV; p4zXV: $Artikel->Preise = $newArtikel->Preise; $Artikel->cStaffelpreisLocalizedVPE1 = $newArtikel->cStaffelpreisLocalizedVPE1; $Artikel->cStaffelpreisLocalizedVPE2 = $newArtikel->cStaffelpreisLocalizedVPE2; $Artikel->cStaffelpreisLocalizedVPE3 = $newArtikel->cStaffelpreisLocalizedVPE3; $Artikel->cStaffelpreisLocalizedVPE4 = $newArtikel->cStaffelpreisLocalizedVPE4; $Artikel->cStaffelpreisLocalizedVPE5 = $newArtikel->cStaffelpreisLocalizedVPE5; $Artikel->fStaffelpreisVPE1 = $newArtikel->fStaffelpreisVPE1; $Artikel->fStaffelpreisVPE2 = $newArtikel->fStaffelpreisVPE2; $Artikel->fStaffelpreisVPE3 = $newArtikel->fStaffelpreisVPE3; $Artikel->fStaffelpreisVPE4 = $newArtikel->fStaffelpreisVPE4; goto TMXc3; YYlKg: } private function setProductlistVariables() { $allProducts = $this->getDiscountAllSetting(); $Suchergebnisse = $this->smarty->getTemplateVars("\x53\x75\x63\150\x65\162\x67\145\x62\156\151\163\163\145"); if (!(!isset($Suchergebnisse) || empty($Suchergebnisse->getProducts()))) { goto dYANX; } return; dYANX: $productList = $Suchergebnisse->getProducts(); foreach ($productList as $key => $Artikel) { $kArtikel = $Artikel->kArtikel; if (!$this->notDiscriminated($Artikel)) { goto dHnY0; } goto cSpAM; dHnY0: $newArtikel = new Artikel(); $newArtikel->fuelleArtikel($kArtikel, null, $_SESSION["\x61\144\155\x6f\x72\162\x69\163\x5f\x70\162\x6f\x5f\160\162\x65\151\163\144\x69\146\x66\145\162\145\x6e\x7a\151\145\x72\x75\156\147"]->kKundengruppe, $_SESSION["\153\x53\x70\162\x61\143\x68\x65"], true); if (!($newArtikel->Preise->fVKNetto < $Artikel->Preise->fVKNetto)) { goto IxkXL; } $productList[$key] = $newArtikel; IxkXL: cSpAM: } F2u05: $Suchergebnisse->setProducts($productList); $this->smarty->assign("\x53\x75\x63\150\145\162\x67\145\142\x6e\151\x73\x73\145", $Suchergebnisse); } private function getArticleRatings($AktuellerArtikel) { $ratingStars = Request::verifyGPCDataInt("\142\x74\147\x73\164\x65\x72\x6e\145"); if (!($AktuellerArtikel->Bewertungen === null || $ratingStars > 0)) { goto ENGtQ; } $conf = Shopsetting::getInstance()->getAll(); $ratingPage = Request::verifyGPCDataInt("\142\164\x67\163\145\151\x74\x65"); $sorting = Request::verifyGPCDataInt("\x73\157\x72\x74\x69\145\x72\162\x65\x69\x68\145\156\x66\157\x6c\x67\145"); $showRatings = Request::verifyGPCDataInt("\x62\x65\x77\x65\x72\x74\165\156\147\137\141\x6e\x7a\145\151\x67\x65\156"); $allLanguages = Request::verifyGPCDataInt("\155\157\162\145\x52\141\164\151\x6e\147"); $AktuellerArtikel->holeBewertung($conf["\x62\x65\x77\145\x72\164\165\156\147"]["\x62\145\167\145\162\x74\165\x6e\x67\x5f\x61\156\x7a\141\x68\154\x73\x65\x69\x74\x65"], $ratingPage, $ratingStars, $conf["\x62\x65\167\145\x72\x74\x75\156\x67"]["\142\145\167\145\162\164\165\x6e\147\137\x66\x72\145\151\163\143\150\141\154\164\145\x6e"], $sorting); $AktuellerArtikel->holehilfreichsteBewertung(); ENGtQ: return $AktuellerArtikel; } public function notDiscriminated(\JTL\Catalog\Product\Artikel $Artikel) : bool { $allProducts = $this->plugin->getConfig()->getValue("\x61\144\155\157\162\x72\151\x73\137\160\x72\x6f\137\x6d\x61\162\x6b\145\x74\x69\156\x67\x5f\x70\162\151\143\x65\137\144\x69\163\143\162\151\155\x69\156\x61\164\151\x6f\x6e\137\144\151\x73\143\157\x75\156\x74\x5f\141\154\x6c"); return !($allProducts == "\131" || $_SESSION["\141\x64\x6d\157\x72\x72\x69\x73\137\160\162\157\x5f\x70\162\x65\151\x73\x64\x69\x66\146\x65\162\x65\156\x7a\151\145\162\165\x6e\x67"]->kArtikel == $Artikel->getID()) && $Artikel->bHasKonfig == false; } public function showInfo() { $showInfo = $this->plugin->getConfig()->getValue("\x61\x64\x6d\157\x72\162\x69\x73\x5f\160\x72\157\x5f\x6d\141\162\x6b\145\x74\x69\x6e\147\137\160\x72\151\x63\x65\137\144\151\x73\143\162\151\155\151\x6e\x61\x74\151\x6f\156\137\163\150\157\167\137\x69\x6e\x66\x6f"); $kundengruppe = $this->getDiscountCustomerGroup(); if (!($showInfo !== "\131" || empty($kundengruppe))) { goto E1LTN; } return; E1LTN: switch (Shop::getPageType()) { case \PAGE_ARTIKEL: $this->detailsInfo(); goto l53fE; case \PAGE_ARTIKELLISTE: $this->listInfo(); goto l53fE; } rU953: l53fE: } private function detailsInfo() : void { $Artikel = $this->smarty->getTemplateVars("\101\x72\164\x69\153\145\x6c"); $kArtikel = $Artikel->getID(); if (!$this->notDiscriminated($Artikel)) { goto gYX7L; } return; gYX7L: $kundengruppe = $this->getDiscountCustomerGroup(); $aktuelleKundengruppe = $_SESSION["\113\x75\156\144\x65\x6e\147\x72\x75\x70\160\145"]->getID() ?? null; $NettoPreise = Shop::Smarty()->getTemplateVars("\116\145\164\164\x6f\120\162\145\x69\163\145"); $spezialpreis = $this->getSpecialPrice($kundengruppe, $kArtikel, 1, $NettoPreise); $standardPreis = $this->getSpecialPrice($aktuelleKundengruppe, $kArtikel, 1, $NettoPreise); if (!($standardPreis > $spezialpreis)) { goto yD9JW; } Shop::Smarty()->assign("\x61\x64\155\157\162\162\x69\163\x5f\x70\162\x6f\137\x6d\x61\162\153\145\x74\x69\156\147\137\160\162\151\143\x65\137\144\x69\x73\143\x72\x69\155\151\x6e\x61\164\151\157\x6e\137\x73\x68\x6f\167\137\x69\156\146\x6f", $this->plugin->getConfig()->getValue("\x61\x64\155\157\162\162\x69\163\x5f\160\x72\x6f\x5f\x6d\141\162\x6b\145\x74\x69\x6e\147\137\160\x72\x69\143\145\137\x64\151\163\x63\162\151\x6d\x69\156\x61\164\x69\x6f\x6e\137\163\x68\x6f\167\x5f\151\156\x66\x6f")); $template = $this->plugin->getPaths()->getFrontendPath() . "\164\x65\155\160\154\141\x74\145\x73\x2f\x6d\x61\x72\153\145\164\151\x6e\x67\x5f\x70\162\151\143\x65\137\144\x69\163\143\162\151\155\151\156\x61\164\x69\157\156\56\x74\160\x6c"; $template = $this->smarty->fetch($template); cssSelector("\x70\162\151\143\145\x5f\144\x69\163\x63\162\151\155\x69\156\141\164\x69\x6f\156", $template); yD9JW: } private function listInfo() : void { $aktuelleKundengruppe = $_SESSION["\113\165\x6e\x64\145\x6e\x67\x72\x75\x70\x70\145"]->getID() ?? null; $Suchergebnisse = $this->smarty->getTemplateVars("\123\x75\143\x68\x65\x72\x67\145\142\156\151\163\163\145"); if (!(isset($Suchergebnisse) && !empty($Suchergebnisse->getProducts()))) { goto UX55Z; } $productList = $Suchergebnisse->getProducts(); Shop::Smarty()->assign("\141\144\x6d\x6f\x72\162\x69\163\x5f\160\162\x6f\x5f\155\x61\x72\153\x65\164\x69\x6e\147\137\x70\x72\151\x63\145\x5f\x64\151\x73\x63\x72\x69\155\151\156\x61\164\151\x6f\156\137\x73\x68\x6f\167\137\x69\156\146\x6f", $this->plugin->getConfig()->getValue("\x61\144\155\157\162\x72\151\x73\x5f\x70\162\x6f\x5f\x6d\141\x72\153\x65\164\151\156\147\x5f\160\x72\151\143\x65\137\x64\x69\163\x63\162\151\155\x69\156\x61\x74\151\x6f\156\x5f\x73\x68\157\x77\137\151\x6e\x66\157")); foreach ($productList as $Artikel) { $kArtikel = $Artikel->kArtikel; if (!$this->notDiscriminated($Artikel)) { goto I7oIR; } goto ghRnb; I7oIR: $kundengruppe = $_SESSION["\141\144\x6d\x6f\x72\162\151\163\x5f\x70\162\157\137\160\162\x65\151\x73\x64\151\x66\x66\145\162\145\x6e\x7a\151\145\162\165\156\x67"]->kKundengruppe; $NettoPreise = Shop::Smarty()->getTemplateVars("\116\x65\164\x74\157\x50\x72\145\151\x73\x65"); $spezialpreis = $this->getSpecialPrice($kundengruppe, $kArtikel, 1, $NettoPreise); $standardPreis = $this->getSpecialPrice($aktuelleKundengruppe, $kArtikel, 1); if (!($standardPreis > $spezialpreis)) { goto rcWcq; } $selector = $this->plugin->getConfig()->getValue("\x61\x64\x6d\x6f\162\162\151\x73\137\160\x72\x6f\x5f\145\170\160\x65\162\x74\137\163\x65\x74\x74\151\x6e\147\x73\x5f\x70\162\151\143\x65\137\144\x69\163\x63\162\x69\x6d\151\156\x61\164\x69\x6f\x6e\x5f\154\x69\163\164\x5f\143\x73\x73\137\x73\x65\154\145\x63\164\157\x72"); $method = $this->plugin->getConfig()->getValue("\141\144\x6d\157\x72\162\x69\163\x5f\x70\x72\157\137\145\170\160\145\162\x74\137\x73\145\x74\x74\x69\x6e\x67\163\137\x70\162\x69\x63\x65\x5f\x64\151\163\x63\162\x69\155\151\x6e\141\x74\151\x6f\x6e\137\154\x69\163\164\137\x63\163\163\x5f\163\x65\x6c\145\x63\164\157\x72\x5f\x74\x79\160\x65"); $fullSelector = str_ireplace("\x23\x6b\101\162\x74\151\x6b\145\x6c\43", $Artikel->kArtikel, $selector); $template = $this->plugin->getPaths()->getFrontendPath() . "\x74\145\x6d\160\154\x61\164\x65\x73\57\155\141\x72\x6b\x65\x74\x69\x6e\x67\x5f\160\x72\x69\x63\x65\137\x64\151\163\x63\162\x69\155\x69\x6e\141\x74\x69\157\x6e\137\x6c\151\163\164\x2e\164\160\x6c"; $content = $this->smarty->fetch($template); \pq($fullSelector)->{$method}($content); rcWcq: ghRnb: } xA0SM: UX55Z: } }