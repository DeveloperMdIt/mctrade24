<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro; use Exception; use JTL\Cache\JTLCacheInterface; use JTL\DB\ReturnType; use JTL\Language\LanguageHelper; use JTL\Plugin\PluginInterface; use JTL\Shop; use stdClass; class Calendar { private $content = []; private $lang = []; public const CONTENT_CACHE_ID = "\141\x64\155\157\x72\x72\151\163\137\x70\162\157\137\x61\x64\x76\x65\156\164\x5f\143\141\x6c\145\156\144\141\162\x5f\x63\x6f\156\x74\145\156\x74"; public const SETTINGS_CACHE_ID = "\x61\x64\x6d\x6f\162\162\151\163\137\x70\162\157\x5f\x61\x64\x76\x65\x6e\x74\x5f\x63\141\x6c\x65\156\144\141\162\x5f\163\x65\164\x74\151\156\x67\163"; private object $plugin_opts; private $imgUrl; private JTLCacheInterface $cache; function __construct(private PluginInterface $plugin, $lang) { $this->lang = $lang; $this->cache = Shop::Container()->getCache(); $this->getEntriesFromDb(); $this->loadSettings(); $this->imgUrl = Shop::getURL() . "\57\160\154\165\x67\x69\x6e\163\57\x61\x64\155\157\x72\162\151\x73\137\160\162\x6f\57" . "\x69\x6d\x67\x2f\x61\144\166\x65\156\164\x5f\x63\x61\154\145\x6e\144\x61\162\x2f\164\x68\145\x6d\x65\x5f\60\x31"; } private function loadSettings() { $settings = $this->cache->get(self::SETTINGS_CACHE_ID); if (!($settings === false)) { goto ssdAU; } $settings = Shop::Container()->getDB()->select("\x78\160\154\x75\147\151\156\x5f\x61\x64\x6d\x6f\162\162\151\x73\137\x70\x72\x6f\137\141\x64\x76\145\156\x74\x5f\x63\x61\x6c\145\156\144\x61\x72\137\x73\x65\x74\164\x69\x6e\x67\163", "\x69\x64", ReturnType::SINGLE_OBJECT); $this->cache->set(self::SETTINGS_CACHE_ID, $settings, [\CACHING_GROUP_PLUGIN, $this->plugin->getCache()->getGroup()]); ssdAU: $settings->open_current_date_only = boolval($settings->open_current_date_only); $settings->dev_mode = boolval($settings->dev_mode); $settings->preview_mode = boolval($settings->preview_mode); $settings->active = boolval($settings->active); $this->plugin_opts = $settings; } public static function initFrontend(PluginInterface $oPlugin) { goto h7oR9; HoZ0h: $currentLang = $_SESSION["\x63\x49\x53\117\123\x70\162\141\143\x68\145"]; $content = $calendar->getContent($currentLang, true); $showCalendar = $calendar->checkDate(); if ($showCalendar) { goto gfYt2; } return; gfYt2: $settings = $calendar->getCalendarSettings(); Shop::Smarty()->assign("\x63\141\x6c\145\156\144\141\x72\x43\x6f\x6e\x74\x65\x6e\164", $content)->assign("\151\155\147\x55\x72\x6c", $imgUrl)->assign("\x73\x68\x6f\167\103\x61\154\x65\x6e\144\141\x72", $showCalendar)->assign("\142\162\141\x6e\x64\x5f\143\157\154\x6f\162", $settings->brand_color ?? null)->assign("\x74\x6f\147\x67\x6c\x65\137\157\x66\x66\x73\145\x74", $settings->toggle_offset ?? null)->assign("\x7a\x5f\151\x6e\x64\x65\x78", $settings->z_index ?? null); $template = $oPlugin->getPaths()->getFrontendPath() . "\x74\x65\x6d\160\x6c\141\x74\x65\x73\57\x63\141\x6c\x65\x6e\x64\141\162\137\x77\x69\x64\147\x65\x74\x2e\x74\160\x6c"; $styles = $oPlugin->getPaths()->getFrontendURL() . "\x63\x73\163\57\x61\144\x76\145\156\x74\55\143\x61\x6c\145\156\144\141\x72\56\x63\x73\163"; goto dDk9J; h7oR9: if (!in_array(Shop::getPageType(), [3, 4, 9, 10, 11])) { goto XXc1d; } return; XXc1d: $smarty = Shop::Smarty(); $imgUrl = Shop::getURL() . "\x2f\160\154\x75\147\x69\x6e\x73\57\141\144\x6d\x6f\x72\x72\x69\x73\137\x70\162\x6f\x2f" . "\x69\x6d\x67\57\141\144\166\145\156\x74\x5f\x63\x61\x6c\x65\156\x64\x61\x72\57\x74\150\x65\155\145\x5f\x30\61"; $lang = Shop::Lang(); $calendar = new self($oPlugin, $lang->getInstalled()); $date = getdate(); $month = $date["\x6d\157\x6e"]; $dayOfMonth = $date["\155\144\x61\171"]; goto HoZ0h; dDk9J: $javascript = $oPlugin->getPaths()->getFrontendURL() . "\152\x73\x2f\141\x64\166\145\156\x74\x43\x61\154\145\156\144\141\x72\56\152\163"; pq("\x62\x6f\144\x79")->append($smarty->fetch($template)); pq("\x2e\x61\x6d\x2d\141\x64\x76\x65\156\164\x2d\143\x61\x6c\x65\156\144\141\162\55\155\157\144\x61\154\137\137\x62\x6f\x64\x79\x20\x69\155\147")->attr("\x6c\157\141\144\151\156\147", "\x6c\x61\x7a\x79"); $assetLoader = AssetLoader::getInstance(); $assetLoader->addToHead([$styles, $javascript], "\x61\144\x76\145\x6e\x74\x43\x61\x6c\145\156\144\x61\x72"); goto hYZTb; hYZTb: } public static function ioSave($req, $requestType) { goto A82ir; A82ir: $response = []; $response["\x65\162\x72\x6f\162"] = false; $cache = Shop::Container()->getCache(); $data = $req["\x64\x61\x74\141"]; if ($requestType === "\x73\x65\164\x74\151\156\147\163") { goto ncbx7; } $lang = LanguageHelper::getAllLanguages(); $plugin = Shop::get("\x6f\x70\x6c\x75\147\151\156\137\141\x64\x6d\x6f\162\x72\151\x73\137\160\162\157"); $calendar = new self($plugin, $lang); foreach ($data as $contentLang) { $contentLang = (object) $contentLang; $contentLang->id = (int) $contentLang->id; $contentLang->day = (int) $contentLang->day; try { $calendar->saveContent($contentLang); } catch (Exception $e) { $response["\145\162\162\157\x72"] = true; $response["\155\145\x73\x73\141\147\x65"] = $e; } w8TxA: } A5QDQ: goto yRett; nCpQC: return json_encode($response); goto xu3jn; yRett: $cache->flush(self::CONTENT_CACHE_ID); goto YTCPg; ncbx7: $settings = (object) $data; unset($settings->id); Shop::Container()->getDB()->update("\170\x70\154\x75\147\151\156\137\141\x64\x6d\157\162\x72\151\x73\137\160\x72\157\137\x61\144\166\145\156\x74\x5f\143\141\154\x65\x6e\144\x61\x72\x5f\163\145\164\x74\151\x6e\147\163", "\151\x64", 1, $settings); $cache->flush(self::SETTINGS_CACHE_ID); $cache->flush(PluginSettings::CACHE_ID); YTCPg: header("\103\x6f\156\164\145\x6e\x74\x2d\x74\x79\160\145\x3a\40\141\160\160\x6c\x69\143\x61\164\151\157\156\57\x6a\x73\x6f\156"); goto nCpQC; xu3jn: } private function initDb(?array $langArray = null) { $lang = $langArray ?? $this->lang; $i = 0; ROwbM: if (!($i < 24)) { goto u2dgc; } foreach ($lang as $l) { $entry = new stdClass(); $entry->day = $i + 1; $entry->language = $l->cISO; $entry->content = ''; Shop::Container()->getDB()->insert("\x78\x70\154\x75\147\151\156\137\141\x64\x6d\157\162\162\151\163\137\x70\162\157\137\141\x64\166\145\x6e\164\137\x63\x61\154\145\156\144\x61\162\137\x63\x6f\156\164\x65\156\x74", $entry); EudcV: } MiFfS: msZ8J: $i++; goto ROwbM; u2dgc: $this->cache->flush(self::CONTENT_CACHE_ID); $this->getEntriesFromDb(true); } private function getEntriesFromDb($noInit = false) { $cache = Shop::Container()->getCache(); $content = $cache->get(self::CONTENT_CACHE_ID); if (!empty($content)) { goto XfoP2; } $content = Shop::Container()->getDB()->query("\x53\105\114\105\x43\124\40\52\40\106\122\x4f\x4d\x20\170\x70\154\x75\x67\x69\156\x5f\x61\144\155\157\162\162\x69\x73\x5f\160\x72\x6f\137\x61\144\x76\145\x6e\x74\137\x63\x61\x6c\145\x6e\x64\x61\x72\x5f\x63\x6f\156\164\145\156\164", 2); $cache->set(self::CONTENT_CACHE_ID, $content, [\CACHING_GROUP_PLUGIN, $this->plugin->getCache()->getGroup()]); XfoP2: if (is_array($content) && count($content) > 0) { goto WGfE1; } if (!$noInit) { goto bhrpS; } return; bhrpS: $this->initDb(); goto cuELO; WGfE1: foreach ($content as $entry) { $this->setContentEntry($entry); ZY4T2: } SYvyp: $this->addNewLanguageContent($noInit); cuELO: } private function setContentEntry($entry) { $this->content[$entry->day - 1][$entry->language] = $entry; } private function addNewLanguageContent($noInit = false) { $contentLanguages = array_keys($this->content[0]); $lang = $this->lang; $lang = array_filter($lang, function ($l) use($contentLanguages) { return !in_array($l->cISO, $contentLanguages); }); if (!(!empty($lang) && !$noInit)) { goto wpDp4; } $this->initDb($lang); wpDp4: } public function getContent($lang = NULL, $restrictDate = false) { if ($lang === NULL) { goto GKPzd; } $content_lang = []; foreach ($this->content as $content) { $content_lang[] = $content[$lang]; K3awM: } U8l5E: $content_lang = $this->addModalHeadings($content_lang); if (!$restrictDate) { goto E2_gi; } $content_lang = $this->allowedDaysOnly($content_lang); E2_gi: return $content_lang; goto fqBeg; GKPzd: return $this->content; fqBeg: } public function saveContent($data) { $this->setContentEntry($data); $saved = Shop::Container()->getDB()->update("\170\x70\x6c\x75\147\151\156\x5f\141\144\155\x6f\x72\x72\151\x73\137\x70\x72\157\x5f\x61\144\x76\x65\156\x74\137\143\x61\154\145\x6e\144\141\162\137\143\x6f\x6e\x74\x65\156\x74", "\151\144", (int) $data->id, $data); if (!($saved < 0)) { goto grT0r; } throw new \Exception("\x45\162\162\x6f\162\40\x73\141\166\x69\x6e\147\x20\x63\x61\x6c\x65\x6e\144\x61\x72\40\143\157\x6e\164\x65\156\164"); grT0r: } private function addModalHeadings($content) { $modal_headings = []; $modal_heading_styles = ["\x62\x6f\164\x74\157\155", "\164\x6f\x70", "\142\x6f\x74\x74\157\x6d", "\142\157\x74\x74\x6f\155", "\x74\157\160", "\164\x6f\x70"]; $i = 1; IQAy9: if (!($i <= 6)) { goto q3clh; } $modal_headings[] = ["\165\162\x6c" => $this->imgUrl . "\x2f\x42\x61\156\156\145\162\57\102\x61\156\156\145\x72\137" . str_pad($i, 2, "\x30", STR_PAD_LEFT) . "\137\154\x61\162\147\x65\x5f", "\x73\x74\171\x6c\145" => $modal_heading_styles[$i - 1]]; b5ilp: $i++; goto IQAy9; q3clh: $i = 0; foreach ($content as $d) { $d->headingImage = $modal_headings[$i]; if ($i < count($modal_headings) - 1) { goto cT2xG; } $i = 0; goto LVdtb; cT2xG: $i += 1; LVdtb: vDbtg: } kl6ye: return $content; } private function allowedDaysOnly($content) { if (!(Shop::isAdmin() && $this->plugin_opts->preview_mode || $this->plugin_opts->dev_mode)) { goto N877K; } return $content; N877K: $date = getdate(); $month = $date["\x6d\x6f\x6e"]; $dayOfMonth = $date["\x6d\144\x61\x79"]; if (!$this->checkDate()) { goto k7G0w; } if ($this->plugin_opts->open_current_date_only) { goto wvgO0; } return array_slice($content, 0, $dayOfMonth); goto G0o7W; wvgO0: return [$content[$dayOfMonth - 1]]; G0o7W: k7G0w: return false; } public function checkDate() { goto yRwdM; yRwdM: if ($this->plugin_opts->active) { goto fQf7a; } return false; goto gMcMf; fQf7a: if (!($this->plugin_opts->dev_mode || Shop::isAdmin() && $this->plugin_opts->preview_mode)) { goto LUyne; } return true; LUyne: $date = getdate(); $year = $date["\x79\x65\x61\162"]; $now = date_create(); goto mFYn6; WdwaG: goto qeJ99; Z0ltW: try { $show_until = date_create($show_until); } catch (\Exception $e) { $show_until = date_create("\x32\x35\56\x31\62\x2e" . $year); } qeJ99: if ($now >= $show_from && $now <= $show_until) { goto WNFmH; } return false; goto Yf_cx; WNFmH: return true; Yf_cx: goto dh71S; dh71S: gMcMf: goto kbVmR; mFYn6: $show_from = $this->plugin_opts->show_from_date; $show_until = $this->plugin_opts->show_until_date; if (!empty($show_from)) { goto kDEw7; } $show_from = date_create("\x30\x31\x2e\x31\62\56" . $year); goto gYYAj; kDEw7: try { $show_from = date_create($show_from); } catch (\Exception $e) { $show_from = date_create("\60\61\x2e\61\62\56" . $year); } gYYAj: if (!empty($show_until)) { goto Z0ltW; } $show_until = date_create("\62\x35\56\61\x32\x2e" . $year); goto WdwaG; kbVmR: } function getCalendarSettings() { return $this->plugin_opts; } }