<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro\controller; use JTL\Shop; use Plugin\admorris_pro\Models\ThreeSixtyImageSettings; use Exception; use function Plugin\admorris_pro\container; use Plugin\admorris_pro\Logger; class ThreeSixtyImageController { public const CACHE_ID = "\x61\x64\x6d\x6f\162\x72\x69\x73\x5f\x70\x72\x6f\137\164\150\162\x65\x65\x53\x69\x78\x74\171\x49\155\141\147\x65\x46\x6f\x6c\144\145\x72\x73"; public static function generateFoldersAndFilelists() { $cache = Shop::Container()->getCache(); $plugin = $plugin = Shop::get("\157\160\154\165\147\151\x6e\137\x61\x64\x6d\x6f\x72\162\x69\x73\137\x70\162\157"); if (!(($settings = $cache->get(ThreeSixtyImageSettings::CACHE_ID)) === false)) { goto k3Qdn; } $settings = ThreeSixtyImageSettings::all()->first(); $cache->set(ThreeSixtyImageSettings::CACHE_ID, $settings, [\CACHING_GROUP_PLUGIN, $plugin->getCache()->getGroup()]); k3Qdn: $result = self::generateFilelists($settings, $cache); return $result; } public static function generateFilelists($settings, $cache) { $baseFolderPath = \PFAD_ROOT . $settings->basepath; $customSubPath = ''; if (!$settings->subpath) { goto w1lPK; } $customSubPath = "\x2f" . $settings->subpath; w1lPK: if (is_dir($baseFolderPath)) { goto OiC_X; } throw new Exception($baseFolderPath . "\x20\144\157\x65\x73\40\156\x6f\x74\x20\x65\170\151\x73\x74\x20\157\x72\40\151\163\40\x6e\157\164\40\141\x20\146\157\154\x64\x65\x72\40"); OiC_X: $subDirectories = self::generateSubdirectoryArray($baseFolderPath); $missingFolders = []; foreach ($subDirectories as $subDir) { $largeDir = $baseFolderPath . "\57" . $subDir . $customSubPath . "\57\154\x61\162\x67\x65"; $smallDir = $baseFolderPath . "\x2f" . $subDir . $customSubPath . "\57\163\155\141\x6c\x6c"; if (is_dir($baseFolderPath . "\57" . $subDir . $customSubPath)) { goto CLMsK; } array_push($missingFolders, $baseFolderPath . "\57" . $subDir . $customSubPath); goto UTULn; CLMsK: $largeImages = self::generateFilelist($largeDir, $settings->basepath . "\57" . $subDir . $customSubPath . "\57\x6c\141\162\147\145"); $smallImages = self::generateFilelist($smallDir, $settings->basepath . "\x2f" . $subDir . $customSubPath . "\x2f\x73\x6d\x61\x6c\154"); if (!(empty($largeImages) || empty($smallImages))) { goto MbMfz; } goto UTULn; MbMfz: $largeFileListString = implode("\54\40", $largeImages); $smallFileListString = implode("\x2c\x20", $smallImages); self::writeFilelist($largeFileListString, $largeDir); self::writeFilelist($smallFileListString, $smallDir); UTULn: } vkVLL: if (empty($missingFolders)) { goto JmLiI; } container()->make(Logger::class)->error("\x46\x6f\154\147\145\156\144\x65\x20\117\162\x64\156\145\x72\x20\x65\170\x69\x73\x74\151\145\x72\145\x6e\40\156\x69\143\x68\164\x3a\xa" . implode("\xa", $missingFolders)); JmLiI: $plugin = $plugin = Shop::get("\157\x70\x6c\x75\147\x69\x6e\137\x61\x64\x6d\x6f\x72\162\151\x73\x5f\160\162\x6f"); $cache->set(self::CACHE_ID, $subDirectories, [\CACHING_GROUP_PLUGIN, $plugin->getCache()->getGroup()]); return ["\146\x69\154\x65\154\x69\163\x74\163" => true, "\146\x6f\x6c\144\145\x72\101\162\162\141\x79" => $subDirectories]; } public static function getImageFolderArray($directory) { $subDirectories = self::generateSubdirectoryArray($directory); return $subDirectories; } public static function getThumbnailName($imageDir) { $imageDirComplete = \PFAD_ROOT . $imageDir; $filelist = self::generateFilelist($imageDirComplete, $imageDir); $thumbName = reset($filelist); return $thumbName; } private static function generateSubdirectoryArray($directory) { if (file_exists($directory)) { goto P4KAj; } return; P4KAj: $subDirectories = array_diff(scandir($directory), ["\56\56", "\56"]); foreach ($subDirectories as $key => $subDir) { if (is_dir($directory . "\x2f" . $subDir)) { goto G__Ga; } unset($subDirectories[$key]); G__Ga: Tn02E: } oChAp: if ($subDirectories) { goto aVohQ; } throw new Exception("\x54\150\x65\x20\146\x6f\x6c\144\145\x72\40\x64\x6f\145\x73\x20\x6e\x6f\164\40\x63\x6f\x6e\164\x61\151\156\x20\x61\156\171\x20\151\x6d\x61\x67\x65\x20\x66\157\x6c\x64\x65\x72\163"); aVohQ: return $subDirectories; } private static function generateFilelist($imageDir, $imageDirWithoutBase) { if (file_exists($imageDir)) { goto iT_BZ; } return; iT_BZ: $filelist = array_diff(scandir($imageDir), ["\56\56", "\x2e"]); $filelist = array_reduce($filelist, function ($result, $link) use($imageDir, $imageDirWithoutBase) { $allowedExtensions = ["\152\160\147", "\x6a\160\x65\147", "\160\156\147", "\167\x65\x62\x70", "\x67\x69\x66"]; $fileExtension = strtolower(pathinfo($link, PATHINFO_EXTENSION)); if (is_dir($imageDir . "\57" . $link) || in_array($fileExtension, $allowedExtensions) === false) { goto PfK2d; } $result[] = $imageDirWithoutBase . "\x2f" . $link; return $result; goto Sx24l; PfK2d: return $result; Sx24l: }, []); return $filelist; } private static function writeFilelist($fileListText, $imageDir) { $fp = fopen($imageDir . "\57\x46\151\154\145\x6c\151\163\164\56\x74\170\164", "\x77"); fwrite($fp, $fileListText); fclose($fp); } }