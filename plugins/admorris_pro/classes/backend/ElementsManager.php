<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro\backend; use JTL\DB\ReturnType; use JTL\Shop; use JTL\IO\IOError; use Plugin\admorris_pro\Utils\TypeConverter; use Plugin\admorris_pro\ioHandling\IoRequestTrait; use Plugin\admorris_pro\Elements; class ElementsManager { use IoRequestTrait; protected static $tableName = "\x78\160\154\165\147\151\x6e\137\141\144\x6d\x6f\162\x72\x69\x73\137\160\x72\x6f\x5f\145\x6c\145\155\145\156\x74\x73"; public function getElements($categoryID) { $data = Shop::Container()->getDB()->query("\123\x45\x4c\105\103\x54\40\x2a\x20\x46\x52\117\x4d\x20\x78\160\154\165\x67\x69\x6e\137\x61\144\x6d\x6f\162\x72\151\163\137\x70\162\157\x5f\145\154\x65\155\145\x6e\164\163\x20\x57\x48\105\122\105\x20\x63\141\164\145\147\x6f\162\171\x49\x44\40\x3d\40{$categoryID}\40\117\x52\x44\x45\x52\40\x42\131\40\40\x60\170\160\x6c\165\x67\x69\156\137\x61\x64\155\x6f\162\162\151\163\137\160\162\x6f\137\x65\154\x65\x6d\x65\156\x74\x73\140\56\140\160\162\151\x6f\162\151\x74\x79\140\40\104\105\123\103\x20", 2); foreach ($data as $key => $element) { $element->active = TypeConverter::convertIntegerToBool($element->active); $element->startTime = TypeConverter::dateTimeStringToIso($element->startTime); $element->endTime = TypeConverter::dateTimeStringToIso($element->endTime); $element->onlyForAdmins = TypeConverter::convertIntegerToBool($element->onlyForAdmins); RHdfQ: } eEbn9: return $data; } public function saveElements($data) { $startDate = strtotime($data["\x73\x74\x61\162\164\x54\x69\155\x65"]); $startDate = date("\131\55\x6d\55\x64\40\x48\72\151\x3a\163", $startDate); $endDate = strtotime($data["\x65\156\144\x54\151\155\145"]); $endDate = date("\x59\x2d\x6d\x2d\144\x20\110\72\151\x3a\x73", $endDate); $content = TypeConverter::encode_entities($data["\143\x6f\x6e\x74\145\x6e\x74"]); $active = TypeConverter::convertBoolToInteger($data["\x61\143\x74\x69\x76\x65"]); $query = "\12\40\40\x20\x20\x20\40\40\x20\122\x45\120\x4c\x41\103\x45\40\x49\116\x54\x4f\40\170\x70\154\165\x67\151\x6e\137\141\x64\x6d\157\162\x72\151\x73\137\160\x72\157\137\145\x6c\145\155\x65\x6e\164\163\40\xa\40\40\x20\40\x20\x20\x20\40\x20\x20\x56\x41\x4c\125\105\123\40\x28\12\40\40\40\x20\40\x20\x20\x20\x20\40\40\x20\72\x69\x64\54\xa\x20\40\x20\40\x20\x20\x20\x20\40\40\40\40\x3a\x70\162\x69\157\x72\x69\164\x79\54\40\12\40\x20\40\x20\x20\40\40\40\x20\x20\x20\40\x3a\143\141\x74\x65\147\157\162\171\111\x44\54\x20\12\x20\x20\40\x20\40\x20\40\40\x20\x20\x20\x20\x3a\x6e\x61\155\145\x2c\40\12\x20\40\40\x20\x20\40\x20\x20\x20\x20\40\x20\72\141\x63\x74\151\x76\145\54\40\12\x20\x20\40\40\40\40\x20\x20\x20\40\x20\40\x3a\x74\145\x6d\160\x6c\x61\164\x65\x2c\xa\40\40\x20\40\40\x20\40\40\40\x20\40\40\72\163\x74\141\x72\x74\104\x61\164\x65\54\x20\12\40\x20\x20\x20\40\40\40\x20\40\40\40\x20\72\145\156\x64\104\x61\164\x65\54\xa\40\x20\x20\40\x20\40\x20\40\x20\40\x20\x20\72\x6f\x6e\154\171\106\157\162\x41\x64\155\x69\156\x73\54\xa\x20\x20\x20\40\x20\40\x20\x20\x20\40\40\40\x3a\x73\145\x6c\x65\143\164\x6f\162\x2c\x20\12\40\40\x20\40\x20\40\x20\x20\40\40\x20\x20\72\163\145\154\145\x63\x74\157\162\x54\171\160\145\x2c\40\12\x20\x20\40\x20\40\x20\40\x20\x20\40\x20\x20\72\164\162\151\x67\147\145\162\106\x69\x6c\x74\145\x72\x4f\160\145\162\x61\x74\x6f\162\54\x20\12\x20\40\x20\x20\40\x20\x20\40\x20\x20\40\x20\72\x63\x6f\x6e\x74\x65\156\x74\xa\40\40\40\x20\x20\x20\40\x20\40\40\51"; $preparationArr = ["\151\x64" => $data["\x69\x64"], "\x70\162\x69\x6f\162\151\164\x79" => $data["\160\x72\x69\x6f\x72\151\x74\171"], "\143\141\x74\145\x67\x6f\x72\171\111\104" => $data["\143\x61\164\x65\147\x6f\162\171\111\104"], "\x6e\141\x6d\145" => $data["\156\141\x6d\x65"], "\141\143\164\x69\166\145" => $active, "\164\145\x6d\x70\x6c\141\x74\145" => $data["\x74\145\x6d\x70\154\141\x74\145"], "\163\x74\141\162\164\104\141\164\x65" => $startDate, "\x65\156\x64\104\141\x74\145" => $endDate, "\157\156\154\x79\x46\157\162\101\144\155\x69\x6e\163" => $data["\157\156\154\171\106\x6f\x72\x41\x64\155\x69\156\163"], "\x73\145\154\145\x63\164\x6f\162" => $data["\163\145\x6c\145\x63\x74\x6f\x72"], "\163\145\154\x65\143\164\157\x72\x54\x79\x70\145" => $data["\163\145\x6c\145\143\x74\157\162\x54\171\160\x65"], "\x74\x72\151\x67\147\145\162\x46\x69\x6c\164\145\162\117\x70\x65\162\x61\164\157\x72" => $data["\x74\162\x69\147\x67\x65\162\x46\151\x6c\x74\145\162\x4f\160\x65\x72\x61\164\x6f\x72"], "\143\157\x6e\164\x65\x6e\x74" => $content]; $response = Shop::Container()->getDB()->getAffectedRows($query, $preparationArr); if (!($response > 0)) { goto XauZl; } $this->flushElementsCache(); return true; XauZl: return false; } public function add($id) { $elementId = Shop::Container()->getDB()->query("\x49\x4e\x53\x45\122\x54\x20\x49\x4e\x54\x4f\x20\140\x78\160\154\165\147\151\x6e\137\141\x64\155\157\162\162\x69\x73\x5f\x70\162\x6f\x5f\x65\x6c\145\155\x65\x6e\164\x73\140\x20\x28\12\x20\40\x20\x20\x20\x20\x20\40\x20\x20\40\x20\140\x69\144\140\40\x2c\12\40\x20\x20\40\x20\x20\40\x20\40\x20\x20\x20\x60\x70\162\x69\x6f\x72\x69\164\x79\140\x20\54\xa\x20\x20\x20\40\40\x20\40\x20\x20\40\x20\40\x60\143\141\x74\145\x67\157\x72\x79\x49\x44\140\40\54\12\x20\x20\40\40\x20\x20\40\40\40\40\40\40\x60\156\x61\155\145\x60\x20\x2c\12\x20\40\40\x20\x20\x20\40\40\40\x20\40\40\140\x61\x63\x74\151\x76\x65\x60\x20\54\12\x20\x20\40\x20\x20\x20\40\40\40\40\40\x20\140\x74\x65\155\160\154\141\x74\x65\140\x20\54\12\x20\x20\x20\40\40\40\40\x20\40\40\40\40\x60\x73\x74\x61\162\164\x54\x69\155\x65\140\x20\54\xa\x20\x20\40\x20\x20\40\40\40\40\40\x20\40\140\145\156\x64\124\x69\155\145\x60\x20\54\xa\40\40\x20\x20\x20\40\40\x20\x20\x20\40\x20\x60\x6f\x6e\x6c\x79\106\x6f\162\x41\x64\x6d\x69\156\x73\140\x20\x2c\12\40\x20\x20\x20\40\x20\x20\x20\40\x20\x20\40\140\163\x65\x6c\145\143\x74\x6f\162\x60\x20\54\12\x20\40\x20\40\40\x20\x20\x20\40\40\40\x20\140\x73\145\x6c\145\143\164\x6f\162\124\171\x70\145\x60\x20\x2c\xa\40\x20\x20\40\40\x20\x20\x20\x20\x20\40\x20\140\x74\162\x69\x67\147\145\x72\106\x69\x6c\x74\x65\162\x4f\160\x65\162\x61\164\157\x72\x60\x20\x2c\xa\40\40\40\40\x20\40\40\40\x20\x20\40\x20\x60\x63\x6f\156\164\145\x6e\164\140\xa\40\x20\x20\x20\x20\40\x20\x20\40\x20\x20\x20\x29\xa\40\x20\40\40\x20\40\x20\40\40\x20\40\x20\126\101\x4c\125\x45\x53\x20\x28\12\x20\x20\x20\40\x20\x20\40\x20\x20\x20\x20\x20\116\x55\x4c\x4c\x20\x2c\40\40\x27\60\x27\x2c\40\40\47{$id}\x27\x2c\x20\40\47\116\x65\x75\x65\163\x20\105\x6c\145\x6d\x65\x6e\x74\x27\54\x20\x20\47\60\47\x2c\40\40\47\143\x6f\144\145\x27\x2c\40\40\47\62\60\61\71\x2d\x30\61\55\60\x31\40\x30\61\72\60\x31\x3a\x30\61\x27\x2c\40\40\x27\62\x30\x33\x30\55\60\x31\55\60\61\40\x30\61\72\x30\x31\x3a\60\x31\47\x2c\40\47\60\x27\54\x20\40\47\142\157\x64\171\47\x2c\x20\40\47\141\160\x70\145\x6e\144\47\x2c\x20\x20\47\x61\x6e\x64\47\x2c\x20\x4e\x55\114\114\12\x20\40\40\40\40\x20\40\40\40\x20\x20\40\51\73", ReturnType::LAST_INSERTED_ID); if (!($elementId > 0)) { goto F8uG0; } $this->flushElementsCache(); F8uG0: return $elementId; } public function delete($id) { Shop::Container()->getDB()->delete("\170\x70\x6c\165\147\151\x6e\x5f\141\144\155\x6f\x72\162\x69\163\x5f\160\162\157\x5f\x65\154\x65\x6d\x65\x6e\x74\163", "\151\x64", (int) $id); Shop::Container()->getDB()->delete("\x78\x70\x6c\x75\147\151\156\137\x61\x64\155\x6f\x72\162\x69\x73\x5f\160\162\157\137\x65\154\145\x6d\145\x6e\164\x73\x5f\164\x72\151\147\147\x65\162\137\146\151\154\x74\145\162", "\145\154\145\155\x65\x6e\x74\111\x64", (int) $id); $this->flushElementsCache(); return true; } public function copy($id) { $element = Shop::Container()->getDB()->select("\x78\x70\154\x75\x67\151\x6e\x5f\x61\x64\155\x6f\162\162\151\163\137\x70\x72\157\x5f\x65\x6c\145\x6d\x65\156\x74\x73", "\151\144", $id); $element->id = ''; $newID = Shop::Container()->getDB()->insert("\170\160\x6c\x75\x67\x69\156\137\x61\144\155\x6f\x72\162\x69\163\x5f\160\x72\x6f\x5f\x65\x6c\145\x6d\x65\156\164\163", $element); $elementFilterData = Shop::Container()->getDB()->selectAll("\x78\x70\x6c\165\147\151\156\137\141\144\155\157\162\162\151\163\137\x70\x72\157\x5f\x65\154\x65\155\145\156\x74\x73\x5f\164\x72\151\147\x67\145\162\137\x66\x69\x6c\x74\145\x72", "\145\x6c\145\155\x65\x6e\164\x49\144", $id); foreach ($elementFilterData as $key => $elementFilter) { $elementFilterData[$key]->id = ''; $elementFilterData[$key]->elementId = $newID; $result = Shop::Container()->getDB()->insert("\x78\160\x6c\x75\147\151\x6e\x5f\141\x64\155\157\x72\x72\x69\x73\x5f\x70\162\157\137\145\154\145\155\x65\156\x74\x73\x5f\x74\x72\151\x67\x67\145\x72\137\x66\x69\x6c\x74\145\x72", $elementFilterData[$key]); UkQWo: } LEzsi: if (!($newID > 0)) { goto TodtM; } $this->flushElementsCache(); TodtM: return $newID != ''; } public function import() { if (!($_FILES == null || count($_FILES) == 0)) { goto W6Nhn; } return new IOError("\116\x6f\40\146\x69\154\x65\x73\x20\165\x70\154\x6f\141\x64\145\x64\56", 200); W6Nhn: $selectedCategory = null; if (!($_POST["\144\141\164\x61"] && $_POST["\x64\141\x74\x61"] != '')) { goto SOLc1; } $data = json_decode($_POST["\144\141\x74\x61"]); if (!($data->selectedCategory != null)) { goto nl8Q5; } $selectedCategory = $data->selectedCategory; nl8Q5: SOLc1: foreach ($_FILES as $element) { goto DhpoM; DhpoM: if (!($element["\x65\162\x72\x6f\x72"] != UPLOAD_ERR_OK)) { goto d2qoC; } return false; d2qoC: $tmpFilePath = $element["\x74\155\160\137\156\x61\155\x65"]; if (file_exists($tmpFilePath)) { goto uvUKo; } return false; uvUKo: $content = file_get_contents($element["\x74\x6d\160\137\156\x61\x6d\x65"]); $element = json_decode($content); if (!($element->triggerFilterOperator == null)) { goto O5XDA; } goto WO32S; v0qMH: ykp6M: ziQb3: goto tFuT2; WO32S: return new IOError("\123\157\x6d\x65\40\146\x69\154\145\163\40\141\162\x65\x20\x6e\157\x74\x20\x76\141\154\151\144\40\x65\154\x65\x6d\x65\156\164\x73\x20\x66\151\x6c\x65\163\x2e", 200); O5XDA: $elementFilterData = $element->elementFilterData; unset($element->elementFilterData); if (!($selectedCategory != null)) { goto tS0dS; } $element->categoryID = $selectedCategory; tS0dS: $element->id = ''; $newID = Shop::Container()->getDB()->insert("\x78\x70\x6c\x75\147\151\x6e\x5f\x61\x64\155\x6f\162\162\x69\x73\x5f\160\x72\157\137\145\154\145\155\x65\x6e\x74\163", $element); foreach ($elementFilterData as $elementFilter) { $elementFilter->id = ''; $elementFilter->elementId = $newID; $result = Shop::Container()->getDB()->insert("\x78\160\x6c\165\147\x69\x6e\137\x61\x64\155\x6f\162\162\x69\163\137\x70\162\x6f\x5f\145\x6c\145\x6d\145\156\164\163\137\x74\x72\x69\x67\147\x65\162\x5f\x66\x69\154\x74\x65\x72", $elementFilter); dhvVt: } goto v0qMH; tFuT2: } abOgh: if (!($newID > 0)) { goto gu1du; } $this->flushElementsCache(); gu1du: return $newID != ''; } public function export($id) { $element = Shop::Container()->getDB()->select("\x78\x70\154\x75\147\151\x6e\x5f\x61\144\155\x6f\x72\162\151\x73\x5f\160\x72\157\137\145\x6c\x65\155\145\x6e\164\x73", "\151\144", $id); $elementFilterData = Shop::Container()->getDB()->selectAll("\170\160\154\165\147\x69\156\x5f\x61\144\155\x6f\x72\x72\151\x73\x5f\x70\162\157\x5f\x65\154\x65\155\x65\x6e\x74\x73\137\164\x72\151\147\147\145\162\x5f\146\x69\x6c\x74\x65\x72", "\145\x6c\145\155\x65\156\x74\111\x64", $id); $element->elementFilterData = $elementFilterData; return $element ?? false; } public function exportAll() { $elements = Shop::Container()->getDB()->query("\123\x45\x4c\105\103\124\40\52\x20\x46\122\117\x4d\x20\x78\160\154\165\147\x69\x6e\137\141\x64\x6d\157\x72\162\151\x73\137\160\x72\157\137\145\x6c\x65\155\145\x6e\x74\x73\x20\117\x52\x44\105\x52\40\102\131\40\x60\151\144\x60", 2); foreach ($elements as $key => $element) { $elementFilterData = Shop::Container()->getDB()->selectAll("\170\160\154\x75\x67\151\156\137\x61\144\x6d\157\162\x72\x69\x73\137\160\x72\157\137\x65\154\145\x6d\145\156\164\x73\137\164\162\x69\x67\147\145\x72\x5f\x66\x69\x6c\164\x65\x72", "\x65\x6c\145\155\145\x6e\x74\111\x64", $element->id); $elements[$key]->elementFilterData = $elementFilterData; shRTF: } VMVW8: return $elements ?? false; } public function updateActive($data) { $active = TypeConverter::convertBoolToInteger($data["\141\143\164\151\166\x65"]); $query = "\12\x20\40\x20\x20\x20\x20\40\40\40\x20\x20\x20\x55\120\x44\101\x54\x45\x20\x78\160\154\x75\147\151\x6e\137\141\x64\155\157\162\x72\x69\163\137\x70\162\157\x5f\x65\x6c\x65\x6d\145\156\164\163\40\12\x20\x20\40\x20\40\40\x20\40\x20\40\x20\x20\123\105\124\40\x61\x63\164\x69\x76\x65\40\75\40\72\141\143\x74\x69\166\145\12\40\x20\40\x20\40\x20\40\40\40\40\40\x20\x57\x48\x45\122\105\40\x69\144\40\75\40\x3a\x69\144"; $preparationArr = ["\151\144" => $data["\151\x64"], "\x61\143\x74\x69\x76\x65" => $active]; $response = Shop::Container()->getDB()->getAffectedRows($query, $preparationArr); if (!($response > 0)) { goto fqW3f; } $this->flushElementsCache(); fqW3f: return $response > 0; } public function createCategory($data) { $data["\x69\x64"] = ''; $newID = Shop::Container()->getDB()->insert("\x78\160\154\x75\147\151\156\x5f\x61\x64\155\x6f\x72\x72\151\163\x5f\x70\162\157\137\x65\154\145\x6d\x65\156\x74\163\x5f\x63\x61\x74\145\x67\x6f\x72\x79", (object) $data); return $newID != ''; } public function getCategories() { $data = Shop::Container()->getDB()->query("\x53\105\114\105\103\x54\40\52\40\x46\x52\117\x4d\x20\x78\160\154\165\147\151\x6e\x5f\x61\144\155\x6f\x72\x72\x69\163\x5f\160\x72\157\x5f\145\x6c\x65\x6d\145\156\164\163\x5f\143\x61\x74\145\147\x6f\x72\x79", 2); foreach ($data as $key => $category) { $data[$key]->categoryData = $this->getElements($category->id); F4N4F: } WIxFr: return $data; } public function deleteCategory($id) { $result = Shop::Container()->getDB()->delete("\x78\x70\x6c\165\x67\x69\156\137\141\144\155\157\x72\x72\151\x73\137\160\162\x6f\137\145\x6c\145\x6d\145\156\x74\x73\137\x63\x61\164\x65\147\x6f\162\x79", "\151\x64", (int) $id); Shop::Container()->getDB()->queryPrepared("\125\120\104\x41\124\105\x20\x78\160\154\165\147\x69\156\137\x61\144\x6d\x6f\162\x72\151\163\x5f\160\162\x6f\137\x65\154\x65\x6d\x65\x6e\x74\x73\40\123\x45\x54\x20\x63\x61\x74\x65\x67\x6f\162\171\x49\x44\40\75\40\x31\x20\127\110\105\122\105\40\143\141\x74\145\x67\157\162\x79\111\x44\40\x3d\x20\x3a\151\x64", ["\151\144" => (int) $id], ReturnType::AFFECTED_ROWS); $this->flushElementsCache(); return $result > 0; } public function updateCategoryName($data) { $obj = new \stdClass(); $obj->id = $data["\151\144"]; $obj->name = $data["\156\x61\155\145"]; $db = Shop::Container()->getDB(); $result = $db->update("\170\x70\154\x75\147\151\x6e\x5f\141\x64\x6d\157\x72\162\151\x73\x5f\x70\x72\x6f\x5f\145\x6c\x65\155\x65\156\x74\x73\x5f\x63\141\x74\145\147\x6f\162\171", "\151\144", $data["\x69\144"], $obj); if ($result) { goto jB6Y6; } return false; goto Z9P8s; jB6Y6: return true; Z9P8s: } public function toggleCategoryActive($data) { $obj = new \stdClass(); $obj->id = $data["\151\144"]; $obj->active = $data["\141\143\x74\x69\x76\145"]; $db = Shop::Container()->getDB(); header("\103\x6f\156\x74\145\x6e\164\x2d\164\x79\x70\x65\72\x20\x61\160\160\154\151\x63\x61\164\151\157\156\57\152\x73\157\156"); $result = $db->update("\x78\160\154\x75\147\151\156\137\x61\144\x6d\x6f\x72\162\x69\163\137\x70\x72\157\x5f\x65\154\x65\x6d\x65\x6e\x74\x73\137\x63\141\x74\145\147\157\162\171", "\x69\x64", $data["\151\x64"], $obj); if ($result) { goto La9GJ; } return false; goto cbNYc; La9GJ: $this->flushElementsCache(); return true; cbNYc: } public function getFilter($elementId) { $data = Shop::Container()->getDB()->query("\x53\x45\x4c\105\103\124\x20\x2a\x20\x46\x52\x4f\115\40\170\160\154\x75\147\x69\x6e\137\141\144\x6d\157\x72\162\x69\163\x5f\x70\162\157\137\x65\154\145\155\145\x6e\x74\163\137\164\162\x69\147\x67\x65\162\x5f\146\151\154\x74\145\x72\x20\x57\110\x45\122\105\40\145\154\145\x6d\x65\x6e\x74\111\144\40\75\x20{$elementId}", 2); return $data; } public function saveFilter($data) { $filterData = (object) ["\145\154\145\x6d\x65\x6e\x74\x49\x64" => $data["\151\x64"], "\x74\162\x69\x67\x67\x65\x72\106\x69\154\x74\145\x72\124\171\160\145" => $data["\164\x72\151\147\147\145\162\x46\151\154\x74\x65\x72\x54\171\x70\x65"], "\x74\162\151\x67\147\145\x72\x46\151\154\x74\145\162\x56\141\x6c\x75\145" => $data["\x74\162\x69\x67\147\x65\x72\x46\x69\154\164\145\x72\126\141\154\165\x65"]]; Shop::Container()->getDB()->insert("\170\x70\154\165\147\x69\156\137\141\x64\155\x6f\162\x72\151\163\x5f\x70\x72\157\137\x65\154\x65\x6d\x65\x6e\x74\x73\x5f\164\x72\x69\147\147\x65\162\137\146\x69\154\164\x65\162", $filterData); $this->flushElementsCache(); return true; } public function deleteFilter($id) { Shop::Container()->getDB()->delete("\x78\160\x6c\165\147\x69\156\x5f\141\x64\x6d\x6f\162\x72\151\x73\137\160\162\157\137\145\154\x65\x6d\145\x6e\164\x73\x5f\x74\x72\151\x67\147\x65\x72\137\146\x69\x6c\164\x65\x72", "\x69\x64", (int) $id); $this->flushElementsCache(); return true; } private function flushElementsCache() { Shop::Container()->getCache()->flush(Elements::CACHE_ID); } }