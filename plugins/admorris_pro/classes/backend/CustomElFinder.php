<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro\backend; use JTL\Shop; use JTL\Media\Image as JtlImage; use Intervention\Image\ImageManager; use Intervention\Image\Encoders\WebpEncoder; use Intervention\Image\Interfaces\ImageInterface; class CustomElFinder { public $srcSetsDest = PFAD_ROOT . STORAGE_OPC . "\56\163\162\143\163\x65\x74\x73\57"; public $opcDest = PFAD_ROOT . STORAGE_OPC; private $imageManager; public function __construct() { $driver = JtlImage::getImageDriver(); $this->imageManager = new ImageManager($driver); } private function getOPCStorageName() { $storagePathArray = explode("\x2f", STORAGE_OPC); $opcStorageName = $storagePathArray[count($storagePathArray) - 2]; return $opcStorageName; } private function srcSetFolderExists($path) { $pathArray = explode("\x2f", $path); $opcIdx = array_search($this->getOPCStorageName(), $pathArray); if (!($opxIdx = count($pathArray) - 1)) { goto STSJ9; } return true; STSJ9: $subDir = array_slice($pathArray, $opcIdx + 1); return is_dir(PFAD_ROOT . STORAGE_OPC . "\56\x73\162\x63\163\145\164\x73\x2f" . implode("\x2f", $subDir)); } private function getSrcSetFilesList($path) { $fileName = pathinfo($path, PATHINFO_FILENAME); $dir = pathinfo($path, PATHINFO_DIRNAME); if ($dir . "\57" !== $this->opcDest) { goto DPZeI; } $dir = ''; goto aNkhf; DPZeI: $dir = str_replace($this->opcDest, '', $dir); aNkhf: $glob = glob($this->srcSetsDest . $dir . "\x2f" . preg_quote($fileName, "\x2f") . "\x2a"); $fileList = []; foreach ($glob as $file) { if (!(preg_match("\x2f" . preg_quote($fileName, "\57") . "\55\133\60\55\71\135\173\62\x2c\x34\175\170\133\x30\55\71\x5d\173\x32\54\x34\x7d\x2e\x5c\167\x2b\x2f", $file) === 1)) { goto w_mnL; } array_push($fileList, $file); w_mnL: wxrlf: } iDTi8: return $fileList; } private function createFileName($img, $extension, $width = null, $height = null, $originalBasename = null) { goto PYWiP; rIH1G: gqiji: goto fAV2n; mbcqq: if ($finalExtension === null && $originalBasename !== null) { goto PCgcX; } if ($finalExtension === null) { goto XJKIU; } goto O8A1G; PCgcX: $originalExtension = pathinfo($originalBasename, PATHINFO_EXTENSION); if (!empty($originalExtension)) { goto JVjx1; } $finalExtension = "\152\x70\147"; goto omKnM; JVjx1: $finalExtension = $originalExtension; goto PFPZP; PFPZP: omKnM: goto O8A1G; XJKIU: $finalExtension = "\152\160\147"; O8A1G: if ($imgWidth !== null && $imgHeight !== null) { goto uciKC; } return pathinfo($filename, PATHINFO_FILENAME) . "\x2d" . time() . "\56" . $finalExtension; goto gqiji; uciKC: return pathinfo($filename, PATHINFO_FILENAME) . "\55" . strval($imgWidth) . "\x78" . strval($imgHeight) . "\x2e" . $finalExtension; goto rIH1G; PYWiP: $imgWidth = $width; $imgHeight = $height; if (!($imgWidth === null && method_exists($img, "\x77\x69\x64\x74\150"))) { goto T2u1K; } $imgWidth = $img->width(); T2u1K: if (!($imgHeight === null && method_exists($img, "\150\x65\151\147\x68\164"))) { goto eFzd2; } $imgHeight = $img->height(); eFzd2: $filename = $originalBasename ?? "\151\x6d\141\x67\x65\137" . uniqid(); $finalExtension = $extension; goto mbcqq; fAV2n: } public function createSrcSetsFolder() { try { if (!(is_dir(PFAD_ROOT . STORAGE_OPC . "\x2e\163\162\143\x73\x65\x74\163") === false)) { goto rghN5; } mkdir(PFAD_ROOT . STORAGE_OPC . "\56\163\x72\143\x73\145\164\163", 0755); rghN5: } catch (\Exception $e) { echo "\105\x78\143\x65\160\164\x69\x6f\156\72\40", $e->getMessage(); } } private function createSrcSetDir($url, $isDirectory) { goto hAg6Z; BzFsm: $i++; goto Fejrh; kNGPM: return $newSubDir; goto MWb_L; DfiyH: $i = $opcIdx + 1; Fejrh: if (!($i < $loopCondition)) { goto kNGPM; } $childDir = $pathArray[$i]; $newSubDir = $parentDir . "\57" . $childDir; if (!(is_dir($newSubDir) === false)) { goto JFxjx; } mkdir($newSubDir, 0755); JFxjx: $parentDir = $newSubDir; CORN2: goto BzFsm; hAg6Z: $pathArray = explode("\57", $url); $opcIdx = array_search($this->getOPCStorageName(), $pathArray); $parentDir = PFAD_ROOT . STORAGE_OPC . "\56\x73\x72\143\163\145\164\163"; $newSubDir = $parentDir; if ($isDirectory) { goto r1qEW; } $loopCondition = count($pathArray) - 1; goto MAvHg; r1qEW: $loopCondition = count($pathArray); MAvHg: goto DfiyH; MWb_L: } public function createSrcSets($cmd, $result, $args, $elfinder) { foreach ($result["\x61\x64\144\145\x64"] as $file) { goto B4Rgn; MhViD: $encodedWebP->save($srcSetUrl . "\57" . $webPFileName); xglRG: $sizeHelper = $newImg; if ($sizeFactor > 0.16 && $sizeHelper->width() > 100 && $sizeHelper->height() > 100) { goto F5aVT; } sQbvZ: SA5cX: ul5EH: u7LuG: goto eEoOZ; B4Rgn: if (!($file["\x6d\x69\155\145"] === "\x69\155\x61\147\x65\x2f\x77\x65\142\x70" || $file["\x6d\151\155\x65"] === "\x69\155\141\147\145\57\152\x70\145\x67" || $file["\x6d\x69\155\x65"] === "\151\x6d\141\x67\x65\57\x70\156\x67")) { goto ul5EH; } if (!(!empty($file["\x75\162\x6c"]) && $file["\x75\x72\154"] != 1 || !empty($file["\x68\141\x73\150"]))) { goto SA5cX; } $url = $elfinder->realpath($file["\x68\141\x73\x68"]); $srcSetUrl = $this->createSrcSetDir($url, false); $img = $this->imageManager->read($url); if (!($file["\155\x69\155\145"] !== "\151\155\141\x67\145\57\167\145\142\160")) { goto KpI4X; } $WebPImage = $this->imageManager->read($url)->encode(new WebpEncoder(quality: 90)); $originalBasename = pathinfo($url, PATHINFO_FILENAME); $webPFileName = $this->createFileName($WebPImage, "\x77\x65\x62\x70", $img->width(), $img->height(), $originalBasename); $WebPImage->save($srcSetUrl . "\x2f" . $webPFileName); goto RExLm; iywPj: $fileName = $this->createFileName($newImg, null, null, null, $originalBasename); $newImg->save($srcSetUrl . "\x2f" . $fileName); if (!($file["\x6d\151\155\x65"] !== "\151\x6d\141\147\x65\57\167\x65\x62\x70")) { goto xglRG; } $newWebPImage = $this->imageManager->read($url); $newWidth = (int) round($img->width() * $sizeFactor); $newHeight = (int) round($img->height() * $sizeFactor); $newWebPImage->scale(width: $newWidth, height: $newHeight); $encodedWebP = $newWebPImage->encode(new WebpEncoder(quality: 90)); $originalBasename = pathinfo($url, PATHINFO_FILENAME); $webPFileName = $this->createFileName($encodedWebP, "\167\x65\x62\160", $newWidth, $newHeight, $originalBasename); goto MhViD; RExLm: KpI4X: $sizeFactor = 1; $sizeHelper = $img; F5aVT: $sizeFactor = $sizeFactor - 0.083; $newImg = $this->imageManager->read($url); $newWidth = (int) round($img->width() * $sizeFactor); $newHeight = (int) round($img->height() * $sizeFactor); $newImg->scale(width: $newWidth, height: $newHeight); $originalBasename = pathinfo($url, PATHINFO_FILENAME); goto iywPj; eEoOZ: } mLBdp: return true; } public function removeSrcSet($cmd, $result, $args, $elfinder) { foreach ($result["\x72\x65\155\x6f\x76\145\144"] as $file) { if (!($file["\155\151\155\x65"] === "\x64\x69\x72\145\143\164\157\162\171")) { goto HBJ9m; } $this->removeSrcSetDirectory($file["\162\x65\141\154\160\x61\164\150"]); HBJ9m: if (!($file["\155\151\155\x65"] === "\151\x6d\141\x67\x65\57\x6a\160\145\147" || $file["\x6d\x69\155\145"] === "\x69\155\141\x67\145\57\160\156\147" || $file["\x6d\x69\155\145"] === "\x69\x6d\x61\147\145\57\167\x65\x62\160")) { goto WRQzN; } $files = $this->getSrcSetFilesList($file["\x72\x65\141\x6c\x70\x61\164\x68"]); if (!(count($files) > 0)) { goto lM_cR; } $this->removeImages($files); lM_cR: WRQzN: UjqAs: } FfAb9: return true; } private function removeSrcSetDirectory($url) { $dir = $this->createSrcSetDir($url, true); $this->rrmdir($dir); } private function rrmdir($dir) { if (!is_dir($dir)) { goto oNL0I; } $objects = scandir($dir); foreach ($objects as $object) { if (!($object != "\x2e" && $object != "\56\x2e")) { goto rUU59; } if (is_dir($dir . DIRECTORY_SEPARATOR . $object) && !is_link($dir . "\x2f" . $object)) { goto YHHYD; } unlink($dir . DIRECTORY_SEPARATOR . $object); goto d4N_M; YHHYD: $this->rrmdir($dir . DIRECTORY_SEPARATOR . $object); d4N_M: rUU59: r50MO: } EBtWI: rmdir($dir); oNL0I: } private function removeImages($files) { foreach ($files as $file) { @unlink($file); EIuji: } QR0Zr: return; } public function renameSrcSet($cmd, $result, $args, $elfinder) { foreach ($result["\141\144\x64\x65\144"] as $new) { foreach ($result["\162\x65\155\157\x76\x65\144"] as $old) { if (!($new["\x6d\151\155\x65"] === "\x64\x69\162\145\143\x74\x6f\162\x79")) { goto s0x8B; } if (!$this->srcSetFolderExists($old["\162\x65\x61\x6c\x70\x61\164\150"])) { goto ecoHU; } $this->renameSrcSetDir($new, $old); ecoHU: s0x8B: if (!($new["\155\151\x6d\145"] === "\151\x6d\x61\147\145\57\152\160\145\147" || $new["\155\x69\155\x65"] === "\x69\x6d\141\147\145\x2f\160\156\147" || $new["\x6d\151\155\x65"] === "\x69\155\x61\x67\x65\x2f\167\x65\x62\x70")) { goto h6iK4; } $filesToUpdate = $this->getSrcSetFilesList($old["\x72\145\141\x6c\160\141\x74\x68"]); if (!(count($filesToUpdate) > 0)) { goto OHH1A; } $this->renameSrcSetFiles($new, $filesToUpdate); OHH1A: h6iK4: J7mCM: } R47Sp: FmfG1: } ldShA: return true; } private function renameSrcSetDir($newDir, $oldDir) { $currentSrcSetDir = $this->createSrcSetDir($oldDir["\x72\x65\141\154\160\x61\164\x68"], true); $pathCopy = $oldDir["\x72\x65\141\x6c\x70\x61\164\150"]; $pathCopyArray = explode("\x2f", $pathCopy); $pathCopyArray[count($pathCopyArray) - 1] = $newDir["\156\141\155\x65"]; $newSrcSetDir = $this->createSrcSetDir(implode("\57", $pathCopyArray), true); $files = scandir($currentSrcSetDir); foreach ($files as $file) { if (!($file != "\x2e" && $file != "\x2e\56")) { goto dHwV_; } rename($currentSrcSetDir . "\x2f" . $file, $newSrcSetDir . "\57" . $file); dHwV_: DiU7F: } LZdyi: $this->removeSrcSetDirectory($oldDir["\162\x65\x61\x6c\160\141\164\x68"]); } private function renameSrcSetFiles($newFile, $filesToUpdate) { foreach ($filesToUpdate as $file) { $filePathArray = explode("\57", $file); $fileName = $filePathArray[count($filePathArray) - 1]; $fileNameDimensionAndExtension = explode("\x2d", $fileName); $newFileName = pathinfo($newFile["\156\141\x6d\145"], PATHINFO_FILENAME); $filePathArray[count($filePathArray) - 1] = $newFileName . "\55" . end($fileNameDimensionAndExtension); rename($file, implode("\x2f", $filePathArray)); cF38b: } pvWdp: } public function moveSrcSet($cmd, $result, $args, $elfinder) { if (!empty($result["\162\145\155\x6f\x76\x65\144"])) { goto hHH89; } $this->createSrcSets($cmd, $result, $args, $elfinder); goto ZK3AQ; hHH89: foreach ($result["\x61\144\x64\145\x64"] as $new) { $newLocation = $elfinder->realpath($new["\x68\141\163\150"]); foreach ($result["\162\145\155\157\166\x65\x64"] as $old) { if (!($new["\155\x69\155\x65"] === "\144\x69\x72\145\143\164\157\162\x79")) { goto bynlU; } if (!$this->srcSetFolderExists($old["\x72\x65\141\154\x70\141\164\150"])) { goto B0MFV; } $this->moveSrcSetDir($newLocation, $old); B0MFV: bynlU: if (!($new["\155\151\x6d\145"] === "\151\x6d\141\147\x65\57\152\x70\145\147" || $new["\x6d\151\x6d\x65"] === "\x69\155\141\147\x65\57\x70\156\x67" || $new["\x6d\151\x6d\x65"] === "\151\x6d\x61\147\145\57\167\x65\x62\160")) { goto QxWd7; } $filesToUpdate = $this->getSrcSetFilesList($old["\x72\x65\x61\x6c\x70\141\x74\x68"]); if (!(count($filesToUpdate) > 0)) { goto obJhG; } $this->moveSrcSetFiles($newLocation, $filesToUpdate); obJhG: QxWd7: P2V4u: } OWqcM: KyhlR: } Olc_5: ZK3AQ: return true; } private function moveSrcSetFiles($newLocation, $filesToUpdate) { $newDir = $this->createSrcSetDir($newLocation, false); foreach ($filesToUpdate as $file) { $filePathArray = explode("\57", $file); $srcSetFileName = end($filePathArray); rename($file, $newDir . "\57" . $srcSetFileName); cP1mA: } DhFvO: } private function moveSrcSetDir($newLocation, $oldDir) { $newDir = $this->createSrcSetDir($newLocation, true); $currentSrcSetDir = $this->createSrcSetDir($oldDir["\162\x65\x61\154\x70\x61\164\x68"], true); $files = scandir($currentSrcSetDir); foreach ($files as $file) { if (!($file != "\x2e" && $file != "\56\x2e")) { goto YgC44; } rename($currentSrcSetDir . "\57" . $file, $newDir . "\x2f" . $file); YgC44: ZZpq0: } Wp6x4: $this->removeSrcSetDirectory($oldDir["\162\x65\141\154\x70\141\164\150"]); } public function duplicateSrcSet($cmd, $result, $args, $elfinder) { foreach ($result["\x61\144\144\x65\x64"] as $new) { if (!($new["\x6d\151\x6d\x65"] === "\151\x6d\x61\147\145\57\152\x70\x65\147" || $new["\155\x69\x6d\145"] === "\151\155\141\x67\145\x2f\x70\156\x67" || $new["\155\x69\x6d\x65"] === "\151\155\141\x67\x65\57\167\x65\142\160")) { goto xlmDr; } $this->createSrcSets($cmd, $result, $args, $elfinder); xlmDr: ZUvwi: } abtkd: return true; } }