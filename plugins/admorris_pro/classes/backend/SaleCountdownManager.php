<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro\backend; use Plugin\admorris_pro\ioHandling\IoRequestTrait; use Plugin\admorris_pro\Models\SaleCountdownModel; use Plugin\admorris_pro\Models\SaleCountdownTextModel; use Plugin\admorris_pro\Facades\Cache; use Plugin\admorris_pro\SaleCountdown; use JTL\IO\IOError; use AdmPro\Carbon\Carbon; class SaleCountdownManager { use IoRequestTrait; public function admGetSaleCountdownList() : array { return $this->getAll(); } public function admSaveSaleCountdown(array $data) : array { if (isset($data["\x69\x64"]) && !empty($data["\151\144"])) { goto VNe0O; } return $this->create($data); goto vJZbU; VNe0O: return $this->update($data); vJZbU: } public function admDeleteSaleCountdown(array $data) : array { return $this->delete($data); } public function getAll() : array { try { $saleCountdowns = SaleCountdownModel::with("\x74\145\170\x74\163")->get(); $response = ["\145\162\x72\x6f\162" => false, "\x64\141\x74\x61" => []]; if (!$saleCountdowns->isNotEmpty()) { goto JPl_T; } foreach ($saleCountdowns as $sale) { $saleData = $sale->toArray(); $saleData["\163\x68\x6f\x77\106\162\157\155\x44\x61\164\x65"] = $sale->showFromDate->format("\x63"); $saleData["\x73\164\x61\162\164\x44\141\164\145"] = $sale->startDate->format("\x63"); $saleData["\145\x6e\144\x44\x61\x74\x65"] = $sale->endDate->format("\x63"); if (!$sale->texts->isNotEmpty()) { goto cMlSe; } $bannerText = new \stdClass(); foreach ($sale->texts as $text) { $bannerText->{$text->languageId} = $text->bannerText; P08no: } cbibw: $saleData["\142\x61\x6e\156\145\x72\124\145\170\164"] = $bannerText; cMlSe: $response["\144\x61\164\141"][] = $saleData; f834c: } ZMXUR: JPl_T: return $response; } catch (\Throwable $th) { return ["\145\x72\162\157\162" => true, "\155\145\x73\163\x61\147\145" => "\106\x61\151\x6c\145\x64\x20\x74\157\40\x72\x65\x74\162\151\145\166\145\x20\x73\x61\x6c\145\40\x63\157\x75\156\x74\144\x6f\x77\156\x73"]; } } public function create(array $data) : array { try { $response = ["\145\x72\162\x6f\x72" => false]; $bannerTexts = $data["\x62\141\x6e\x6e\145\x72\124\145\170\x74"] ?? []; unset($data["\142\141\156\x6e\x65\162\124\145\170\164"]); $data["\163\x68\157\x77\x46\162\x6f\x6d\x44\x61\x74\145"] = Carbon::parse($data["\163\150\x6f\167\x46\x72\x6f\155\x44\141\164\x65"]); $data["\x73\164\141\162\164\104\141\x74\x65"] = Carbon::parse($data["\x73\x74\x61\162\x74\104\141\x74\145"]); $data["\x65\156\x64\104\141\164\x65"] = Carbon::parse($data["\x65\156\144\x44\x61\x74\145"]); $saleCountdown = SaleCountdownModel::create($data); if ($saleCountdown) { goto AOIX9; } $response["\x65\162\x72\x6f\162"] = true; $response["\155\145\x73\163\141\147\145"] = "\x46\x61\x69\154\x65\x64\40\164\157\x20\143\162\145\x61\x74\145\x20\x73\141\x6c\x65\x20\143\157\x75\156\164\x64\x6f\167\x6e"; goto yHjCC; AOIX9: $this->saveBannerTexts($bannerTexts, $saleCountdown->id); $this->clearAllCaches(); $response["\x69\144"] = $saleCountdown->id; yHjCC: return $response; } catch (\Throwable $th) { return ["\145\x72\162\x6f\x72" => true, "\155\145\x73\x73\141\147\x65" => "\x46\x61\x69\x6c\x65\144\x20\164\157\x20\143\x72\145\x61\x74\145\40\163\x61\x6c\145\40\x63\x6f\x75\x6e\164\x64\157\167\156\x3a\x20" . $th->getMessage()]; } } public function update(array $data) : array { try { goto A4Q2Z; B4YRb: if (!isset($data["\x73\x68\x6f\167\x46\162\x6f\155\104\x61\x74\145"])) { goto Ys911; } $data["\163\150\157\x77\106\x72\157\155\x44\141\x74\x65"] = Carbon::parse($data["\x73\150\157\x77\x46\x72\x6f\x6d\104\141\x74\x65"]); Ys911: if (!isset($data["\x73\164\x61\x72\x74\x44\141\164\145"])) { goto BEdfa; } $data["\x73\164\141\x72\x74\104\141\164\x65"] = Carbon::parse($data["\163\164\141\x72\164\x44\x61\164\145"]); BEdfa: if (!isset($data["\x65\156\144\x44\141\x74\145"])) { goto UZNIL; } $data["\x65\156\x64\x44\x61\x74\x65"] = Carbon::parse($data["\x65\x6e\144\104\x61\x74\x65"]); UZNIL: $updated = $saleCountdown->update($data); goto ZmDAH; A4Q2Z: $response = ["\x65\x72\162\x6f\x72" => false]; if (isset($data["\151\x64"])) { goto J6uef; } return ["\x65\x72\162\157\162" => true, "\155\x65\163\x73\141\147\x65" => "\x49\104\40\151\x73\40\x72\145\161\165\x69\162\145\x64\x20\x66\157\x72\40\165\160\144\x61\164\145"]; J6uef: $saleCountdown = SaleCountdownModel::find($data["\x69\x64"]); if ($saleCountdown) { goto FePzs; } return ["\145\x72\162\x6f\x72" => true, "\155\145\x73\163\x61\147\x65" => "\x53\x61\x6c\145\x20\x63\157\165\156\164\144\x6f\x77\x6e\x20\x6e\x6f\164\40\x66\157\x75\156\144"]; FePzs: $bannerTexts = $data["\142\141\156\156\145\x72\124\145\x78\164"] ?? []; unset($data["\x62\141\156\156\x65\x72\124\x65\170\164"]); goto B4YRb; ZmDAH: if ($updated) { goto aHyMh; } $response["\145\162\162\x6f\162"] = true; $response["\155\145\163\x73\141\x67\x65"] = "\106\x61\151\x6c\x65\144\40\x74\157\40\165\x70\x64\141\164\x65\40\x73\x61\x6c\145\x20\143\157\x75\156\164\x64\x6f\x77\x6e"; goto XGymM; aHyMh: $this->saveBannerTexts($bannerTexts, $saleCountdown->id); $this->clearAllCaches(); XGymM: return $response; goto CbJAX; CbJAX: } catch (\Throwable $th) { return ["\x65\162\x72\157\x72" => true, "\155\145\163\163\x61\147\145" => "\106\x61\x69\x6c\145\x64\40\x74\157\x20\x75\x70\x64\141\164\145\x20\x73\141\154\145\40\143\157\165\156\164\x64\x6f\x77\156\72\x20" . $th->getMessage()]; } } public function delete(array $data) : array { try { $response = ["\145\162\x72\x6f\x72" => false]; if (isset($data["\151\144"])) { goto Ubp8r; } return ["\145\x72\x72\x6f\162" => true, "\155\x65\x73\x73\141\147\145" => "\111\x44\40\x69\163\x20\x72\x65\161\x75\x69\x72\x65\144\40\146\157\162\x20\144\145\x6c\145\164\x69\x6f\156"]; Ubp8r: $saleCountdown = SaleCountdownModel::find($data["\x69\x64"]); if ($saleCountdown) { goto gPuXA; } return ["\x65\x72\x72\x6f\x72" => true, "\155\145\163\x73\141\x67\145" => "\123\141\154\145\40\x63\x6f\165\156\x74\x64\x6f\x77\x6e\x20\x6e\157\x74\x20\x66\x6f\x75\156\x64"]; gPuXA: $saleCountdown->texts()->delete(); $deleted = $saleCountdown->delete(); if ($deleted) { goto mWWqc; } $response["\145\x72\162\157\x72"] = true; $response["\155\x65\163\163\141\x67\145"] = "\x46\x61\151\x6c\145\144\40\x74\x6f\x20\144\x65\x6c\145\x74\145\x20\x73\x61\x6c\145\40\143\157\x75\x6e\164\144\157\167\x6e"; goto XZFUx; mWWqc: $this->clearAllCaches(); XZFUx: return $response; } catch (\Throwable $th) { return ["\145\162\x72\x6f\162" => true, "\155\x65\x73\x73\141\147\x65" => "\x46\x61\x69\x6c\145\x64\x20\x74\x6f\40\x64\145\x6c\145\x74\145\x20\163\x61\154\x65\x20\143\157\x75\156\164\x64\157\167\156\x3a\x20" . $th->getMessage()]; } } private function saveBannerTexts(array $bannerTexts, int $saleCountdownId) : void { SaleCountdownTextModel::where("\163\141\x6c\145\103\x6f\165\x6e\164\144\x6f\x77\x6e\111\144", $saleCountdownId)->delete(); foreach ($bannerTexts as $languageId => $bannerText) { if (empty($bannerText)) { goto tg9e2; } SaleCountdownTextModel::create(["\x73\141\154\145\103\x6f\165\156\x74\x64\157\167\x6e\111\144" => $saleCountdownId, "\x6c\141\x6e\x67\165\141\x67\145\x49\144" => $languageId, "\142\x61\156\x6e\x65\162\x54\145\x78\x74" => $bannerText]); tg9e2: QvfvB: } rWA5Z: Cache::flushTags(SaleCountdownTextModel::CACHE_TAGS); } private function clearAllCaches() : void { Cache::flushTags(SaleCountdownModel::CACHE_TAGS); Cache::flushTags(SaleCountdownTextModel::CACHE_TAGS); Cache::flush(SaleCountdown::CACHE_ID); } }