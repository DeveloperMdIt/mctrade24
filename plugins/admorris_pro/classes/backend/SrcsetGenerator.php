<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro\backend; use Intervention\Image\ImageManager; use JTL\Media\Image as JtlImage; use RecursiveFilterIterator; use RecursiveIteratorIterator; use RecursiveDirectoryIterator; use stdClass; use Exception; use Intervention\Image\Encoders\WebpEncoder; use Intervention\Image\Interfaces\ImageInterface; use Intervention\Image\Interfaces\EncodedImageInterface; use Plugin\admorris_pro\ioHandling\IoRequestTrait; class RecursiveDotFilterIterator extends RecursiveFilterIterator { public function accept() : bool { return "\x2e" !== substr($this->current()->getFilename(), 0, 1); } } class SrcsetGenerator { use IoRequestTrait; private ImageManager $imageManager; public function __construct() { $driver = JtlImage::getImageDriver(); $this->imageManager = new ImageManager($driver); } public function getOpcFreeDiskSpace() : float|false { return disk_free_space(PFAD_ROOT . STORAGE_OPC); } public function getOpcTotalDiskSpace() : float|false { return disk_total_space(PFAD_ROOT . STORAGE_OPC); } public function generateImageSrcset(array $req) { return $this->createSrcSets($req); } public function downloadExternalImage(array $req) { goto cVdOb; P5ly1: if (!(empty($path) && strpos($returnValue, "\57") === 0)) { goto IPmWg; } $returnValue = ltrim($returnValue, "\x2f"); IPmWg: uWbDs: return $returnValue; goto f_2gP; MVAjb: WUTLH: $savePath .= $fileName; $img = file_get_contents($url); file_put_contents($savePath, $img); $returnValue = $savePath; if (!(strpos($savePath, PFAD_ROOT) === 0)) { goto uWbDs; } $returnValue = substr($savePath, strlen(PFAD_ROOT)); if (!(strpos($returnValue, "\57") !== 0 && strpos($path, "\57") === 0)) { goto P2nH4; } $returnValue = "\x2f" . $returnValue; P2nH4: goto P5ly1; cVdOb: $url = $req["\x75\162\x6c"]; $name = $req["\x6e\x61\x6d\145"] ?? pathinfo($url)["\x66\151\154\x65\156\x61\155\x65"]; $path = $req["\x70\x61\164\x68"] ?? ''; $extension = pathinfo($url)["\x65\x78\x74\145\156\x73\151\157\156"]; $randomNumber = mt_rand(100000, 999999); $fileName = $name . "\55" . $randomNumber . "\56" . $extension; $fullDir = PFAD_ROOT . STORAGE_OPC; $savePath = ''; if (!empty($path)) { goto oLoyH; } $savePath = $fullDir; goto hpixl; hpixl: goto SSrkS; oLoyH: $fullDir .= $path; if (is_dir($fullDir)) { goto pKjG4; } mkdir($fullDir, 0755, true); pKjG4: $savePath = $fullDir . "\x2f"; SSrkS: if (!(substr($savePath, -1) !== "\x2f")) { goto WUTLH; } $savePath .= "\x2f"; goto MVAjb; f_2gP: } public function getImagesWithoutExistingSrcset() : array { $dir = PFAD_ROOT . STORAGE_OPC; $this->createSrcSetsFolder(); $iterator = new RecursiveIteratorIterator(new RecursiveDotFilterIterator(new RecursiveDirectoryIterator($dir))); $files = []; foreach ($iterator as $info) { if (!$info->isFile()) { goto dZ3bi; } $file_path = str_replace(PFAD_ROOT . STORAGE_OPC, '', $info->getPathname()); if (!(substr($file_path, 0, 1) !== "\x2f" && strpos($file_path, DIRECTORY_SEPARATOR) !== false)) { goto J03NQ; } $file_path = "\57" . $file_path; J03NQ: $file_path = ltrim($file_path, "\x2f"); $path_parts = pathinfo($file_path); $allowed_extensions = ["\160\x6e\x67", "\152\160\145\147", "\152\160\x67", "\x77\x65\142\x70"]; if (!(isset($path_parts["\145\x78\x74\x65\x6e\x73\151\157\156"]) && in_array(strtolower($path_parts["\x65\170\x74\x65\x6e\x73\x69\x6f\x6e"]), $allowed_extensions, true))) { goto iXvK0; } if (!($this->srcSetExists($file_path) === false)) { goto atzYs; } $fileObj = new stdClass(); $fileObj->path = $file_path; $fileObj->size = filesize($info->getPathname()); $files[] = $fileObj; atzYs: iXvK0: dZ3bi: vlr2D: } okMhN: return $files; } private function srcSetExists(string $path) : bool { $fileName = pathinfo($path, PATHINFO_FILENAME); $dirName = pathinfo($path, PATHINFO_DIRNAME); $globDir = $dirName === "\56" || $dirName === '' ? '' : $dirName . "\x2f"; $globPattern = PFAD_ROOT . STORAGE_OPC . "\56\163\x72\x63\163\x65\164\163\57" . $globDir . preg_quote($fileName, "\57") . "\55\52"; $fileList = []; $foundFiles = glob($globPattern); if (!($foundFiles === false)) { goto jEm5s; } $foundFiles = []; jEm5s: foreach ($foundFiles as $file) { if (!(preg_match("\57" . preg_quote($fileName, "\x2f") . "\55\x5b\60\55\71\135\x7b\x32\x2c\x34\175\x78\133\x30\x2d\x39\x5d\173\x32\x2c\64\175\x5c\56\134\x77\53\x24\x2f", basename($file)) === 1)) { goto a99fi; } $fileList[] = $file; a99fi: qqYtt: } Qk3lk: return count($fileList) > 0; } private function createSrcSetsFolder() : void { try { $srcsetsDir = PFAD_ROOT . STORAGE_OPC . "\x2e\x73\x72\x63\x73\x65\x74\163"; if (!(is_dir($srcsetsDir) === false)) { goto rgGmD; } mkdir($srcsetsDir, 0755, true); rgGmD: } catch (Exception $e) { error_log("\x45\x78\x63\x65\x70\164\151\157\156\40\x69\x6e\x20\143\x72\x65\141\x74\x65\x53\162\143\x53\x65\x74\x73\x46\157\154\x64\x65\162\72\x20" . $e->getMessage()); } } private function createSrcSets(array $file) : stdClass|string { $path = $file["\160\x61\x74\150"]; try { goto QlGsZ; LOUVY: QYiAm: $originalBasename = pathinfo($path, PATHINFO_FILENAME); $sizeFactor = 1; m_9mD: $sizeFactor -= 0.1; if (!($sizeFactor < 0.2 && ($img->width() * $sizeFactor < 100 || $img->height() * $sizeFactor < 100))) { goto kCDeN; } if (!($img->width() * $sizeFactor < 100 || $img->height() * $sizeFactor < 100)) { goto g1AtB; } goto xaFvt; g1AtB: kCDeN: goto gLsE8; JmnVk: if (!isset($file["\144\x6f\164\x50\x72\157\x70"])) { goto Kkx8K; } $data->dotProp = $file["\144\157\164\x50\162\157\160"]; Kkx8K: return $data; goto y4cJ9; gLsE8: $newImg = $this->imageManager->read($origin); $newWidth = (int) round($img->width() * $sizeFactor); $newHeight = (int) round($img->height() * $sizeFactor); if (!($newWidth < 50 || $newHeight < 50)) { goto w1vW5; } goto xaFvt; w1vW5: $newImg->scale(width: $newWidth, height: $newHeight); $fileName = $this->createFileName($newImg, null, $originalBasename); $newImg->save($srcsetDestDir . "\x2f" . $fileName); if (!($ext !== "\167\145\x62\160")) { goto yBjdJ; } goto vi10f; vi10f: $newWebPImage = $this->imageManager->read($origin); $newWebPImage->scale(width: $newWidth, height: $newHeight); $newWebPImageEncoded = $newWebPImage->encode(new WebpEncoder(quality: 90)); $webPFileName = $this->createFileNameFromEncoded($newWebPImageEncoded, "\x77\145\142\x70", $originalBasename, $newWidth, $newHeight); $newWebPImageEncoded->save($srcsetDestDir . "\x2f" . $webPFileName); yBjdJ: if ($sizeFactor > 0.2 && ($newImg->width() > 100 && $newImg->height() > 100)) { goto m_9mD; } xaFvt: $data = new stdClass(); $data->status = 1; goto JmnVk; ufvDS: mkdir($srcsetDestDir, 0755, true); EijEA: $img = $this->imageManager->read($origin); if (!($img->width() > 3840 || $img->height() > 3840)) { goto Mb5ff; } $img = $this->resizeImage($img, $origin); Mb5ff: if (!($ext !== "\167\x65\142\160")) { goto QYiAm; } $webPImageEncoded = $this->imageManager->read($origin)->encode(new WebpEncoder(quality: 90)); $webPImageFileName = $this->createFileNameFromEncoded($webPImageEncoded, "\167\145\x62\160", pathinfo($path, PATHINFO_FILENAME), $img->width(), $img->height()); $webPImageEncoded->save($srcsetDestDir . "\57" . $webPImageFileName); goto LOUVY; QlGsZ: $pathToArray = explode("\x2f", ltrim($path, "\57")); $ext = strtolower(pathinfo($path, PATHINFO_EXTENSION)); $origin = PFAD_ROOT . STORAGE_OPC . ltrim($path, "\57"); $srcsetPathBase = PFAD_ROOT . STORAGE_OPC . "\56\x73\162\x63\163\x65\164\163\x2f"; $newPathRelative = ''; if (!(count($pathToArray) > 1)) { goto dG5aD; } $newPathRelative = implode("\x2f", array_slice($pathToArray, 0, -1)); dG5aD: $srcsetDestDir = $srcsetPathBase . $newPathRelative; if (is_dir($srcsetDestDir)) { goto EijEA; } goto ufvDS; y4cJ9: } catch (Exception $e) { error_log("\x45\x78\143\145\x70\x74\x69\x6f\156\40\x69\x6e\x20\143\x72\145\x61\164\x65\x53\x72\143\123\145\164\x73\72\40" . $e->getMessage() . "\x20\146\157\162\x20\x66\x69\154\145\40" . $path); return $e->getMessage(); } } private function createFileName(ImageInterface $img, ?string $customExtension, string $originalBasename) : string { $finalExtension = $customExtension; if (!($finalExtension === null)) { goto YtzC9; } $originalExtension = pathinfo($originalBasename, PATHINFO_EXTENSION); if (!empty($originalExtension)) { goto q8RGV; } $finalExtension = "\152\x70\147"; goto DQHB4; q8RGV: $finalExtension = $originalExtension; DQHB4: YtzC9: return $originalBasename . "\55" . $img->width() . "\170" . $img->height() . "\x2e" . $finalExtension; } private function createFileNameFromEncoded(EncodedImageInterface $encodedImage, ?string $customExtension, string $originalBasename, int $width, int $height) : string { $finalExtension = $customExtension ?? "\167\145\142\x70"; return $originalBasename . "\x2d" . $width . "\170" . $height . "\x2e" . $finalExtension; } private function resizeImage(ImageInterface $img, string $originalPathForSave) : ImageInterface { $maxWidth = 3840; $maxHeight = 3840; $resized = false; if (!($img->width() > $maxWidth || $img->height() > $maxHeight)) { goto s5e4X; } if ($img->width() > $img->height()) { goto q8_LQ; } if ($img->height() > $img->width()) { goto kOsJr; } $img->scale(width: $maxWidth); goto ckODK; q8_LQ: $img->scale(width: $maxWidth); goto ckODK; kOsJr: $img->scale(height: $maxHeight); ckODK: $resized = true; s5e4X: if (!$resized) { goto Mg5XQ; } $img->save($originalPathForSave); Mg5XQ: return $img; } }