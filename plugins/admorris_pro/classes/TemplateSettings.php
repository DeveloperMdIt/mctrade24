<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro; use JTL\Cache\JTLCacheInterface; use JTL\DB\DbInterface; use JTL\DB\ReturnType; use JTL\Filesystem\LocalFilesystem; use JTL\IO\IOError; use JTL\Shop; use Plugin\admorris_pro\Utils\TypeConverter; use JTL\Minify\MinifyService; use JTL\Plugin\PluginInterface; use JTL\Template\Config; use League\Flysystem\Filesystem; use League\Flysystem\Local\LocalFilesystemAdapter; use Plugin\admorris_pro\Facades\Cache; use Plugin\admorris_pro\ioHandling\IoRequestTrait; use Plugin\admorris_pro\Utils\Icon; class TemplateSettings { use IoRequestTrait; const CSS_PATH = PFAD_ROOT . "\x74\145\x6d\x70\x6c\141\164\145\x73\x2f\x61\x64\155\x6f\162\162\151\163\137\160\x72\x6f\x2f\x73\x74\171\154\x65\163\x2f\141\144\155\x6f\162\162\151\x73"; public const CACHE_ID = "\141\144\x6d\157\x72\x72\151\x73\x5f\160\x72\157\137\164\x65\x6d\160\154\141\x74\145\x5f\x73\145\164\164\x69\156\147\163"; public const TEMPLATE_CONFIG_CACHE_ID = "\x61\x64\x6d\157\162\x72\x69\x73\137\160\162\157\x5f\x74\x65\155\160\x6c\141\164\x65\x5f\x63\157\x6e\x66\x69\147"; public function __construct(private PluginInterface $plugin, private DbInterface $db, private JTLCacheInterface $cache) { } public function load() : TemplateSettingsDTO { return Cache::remember(self::CACHE_ID, function () { goto K17nu; Un0nd: NfiYW: $themeVars = !empty($themeVars) ? $themeVars : []; $templateSettingsDTO = new TemplateSettingsDTO(templateCustom: $templateCustom, template: $template, themeVars: $themeVars); return $templateSettingsDTO; goto Bi41Y; K17nu: if ($this->checkIfTableExists()) { goto f5S3_; } throw new \Exception("\x41\144\x6d\x6f\x72\x72\x69\163\x20\x50\x72\x6f\40\x74\145\x6d\x70\x6c\x61\164\x65\40\x73\x65\x74\164\x69\156\147\163\x20\x74\141\142\x6c\145\40\144\x6f\145\163\x20\x6e\x6f\x74\40\x65\170\x69\x73\x74\x2e"); f5S3_: $templateCustom = $this->db->select("\170\160\154\x75\x67\151\x6e\137\141\x64\x6d\x6f\x72\x72\x69\x73\137\160\x72\157\x5f\x74\145\x6d\x70\x6c\x61\x74\x65\x5f\163\x65\x74\x74\151\x6e\x67\x73", "\151\144", 1); $templateCustom = self::setCustomTemplateSettingsTypes($templateCustom); $templateCustom->paymentIcons = json_decode($templateCustom->paymentIcons ?? ''); $templateConfig = $this->getTemplateConfig(); $template = !empty($templateConfig) ? self::setTemplateSettingsTypes($templateConfig) : null; $themeId = (int) $templateCustom->themeId; $themeVars = $this->db->select("\170\x70\x6c\x75\147\151\x6e\137\x61\144\x6d\157\162\162\151\x73\137\x70\x72\157\x5f\x74\x68\145\x6d\x65", "\x69\144", $themeId); goto ezjZp; ezjZp: if (!empty($themeVars)) { goto K0O9l; } $themeVars = Shop::Container()->getDB()->selectAll("\x78\160\154\x75\147\x69\156\137\x61\x64\x6d\x6f\162\x72\151\x73\137\x70\x72\x6f\137\164\150\x65\x6d\145", [], []); if (empty($themeVars)) { goto eedAR; } $themeVars = $themeVars[0]; eedAR: K0O9l: if (!$themeVars) { goto NfiYW; } $themeData = json_decode($themeVars->data); unset($themeVars->data); $themeVars = array_merge((array) $themeVars, (array) $themeData); goto Un0nd; Bi41Y: }, [\CACHING_GROUP_TEMPLATE]); } public function save($req) { goto xNFNH; b0OTa: if (empty($themeSaved)) { goto uN1TP; } $customSettings->themeId = (int) $themeSaved; uN1TP: $response["\145\162\x72\157\x72"] = $themeSaved < 0 ? true : false; if (!is_array($css)) { goto g2o1m; } $this->saveCssFiles($css); g2o1m: l_nB3: $template = Shop::Container()->getTemplateService()->getActiveTemplate(false); $templateName = Shop::Container()->getTemplateService()->getActiveTemplate(false)->getCTemplate(); goto EmQ3V; EmQ3V: $templateName = in_array($templateName, ["\141\144\155\x6f\x72\x72\x69\163\x5f\x70\x72\x6f", "\x61\x64\155\157\x72\162\151\163\137\160\x72\157\x5f\143\150\x69\x6c\x64"]) ? $templateName : "\x61\x64\155\x6f\162\x72\151\x73\x5f\160\162\157"; $config = new Config($templateName, $this->db); foreach ($templateSettings as $groupName => $settingGroup) { foreach ($settingGroup as $key => $value) { $config->updateConfigInDB($groupName, $key, $value); Q2ZGA: } F7SFb: iVXoq: } c5ZMX: Shop::Container()->getCache()->flushTags([\CACHING_GROUP_TEMPLATE]); $customSettings->id = (int) $customSettings->id; $templateSaved = $this->db->update("\170\160\154\165\x67\151\156\x5f\141\x64\155\x6f\x72\162\151\x73\137\160\162\157\137\x74\x65\155\x70\x6c\141\x74\x65\137\163\x65\164\164\151\x6e\x67\163", "\151\144", 1, $customSettings); $this->cache->flush(self::CACHE_ID); $this->cache->flush(self::TEMPLATE_CONFIG_CACHE_ID); $iconsSaved = $this->saveIcons($icons); goto FELFi; FELFi: Shop::Container()->getCache()->flushTags([Icon::CACHE_ID]); $response["\164\x65\x6d\x70\154\141\x74\x65\123\x61\166\145\x64"] = $iconsSaved; $response["\151\143\x6f\156\x73\x53\x61\x76\145\144"] = $iconsSaved; $response["\x65\162\162\x6f\162"] = ($templateSaved < 0 ? true : false) || $response["\x65\x72\x72\x6f\162"]; header("\103\x6f\x6e\x74\145\156\164\x2d\164\171\160\x65\72\x20\141\x70\x70\x6c\x69\143\x61\164\151\x6f\156\57\x6a\x73\x6f\x6e"); return json_encode($response); goto i5vIk; FZllI: $templateSettings = self::setTemplateSettingsTypes($req["\163\x65\x74\164\x69\x6e\x67\163"]["\164\145\155\x70\x6c\x61\x74\x65"], true); $icons = json_decode($req["\163\x65\x74\164\x69\156\x67\x73"]["\151\x63\x6f\156\163\x55\163\145\x64"] ?? ''); if (!($req["\157\x70\x74\x69\157\x6e\163"]["\164\x68\145\x6d\145\125\160\144\x61\164\x65\x64"] === true)) { goto l_nB3; } $css = $req["\163\x65\x74\x74\x69\156\x67\x73"]["\143\163\x73"] ?? null; $customSettings->cacheId = 0; unset($themeVars->id); unset($themeVars->name); $themeData = new \stdClass(); $themeData->name = "\x63\165\163\x74\x6f\155"; $themeData->data = json_encode($themeVars); goto y9Ubd; xNFNH: if (isset($req["\x73\x65\164\x74\151\156\x67\x73"]["\164\x65\x6d\160\154\x61\x74\x65\x43\165\x73\164\x6f\x6d"])) { goto tzLTT; } return new IOError("\105\x72\162\157\162\72\x20\x53\145\164\164\151\156\147\x73\40\x6e\157\164\x20\x73\x65\164"); tzLTT: $response = []; $response["\x65\162\162\157\x72"] = false; $themeVars = (object) $req["\163\x65\164\x74\151\156\147\163"]["\164\x68\x65\155\145\x56\141\162\x73"]; $customSettings = self::setCustomTemplateSettingsTypes($req["\163\145\x74\164\x69\x6e\x67\163"]["\x74\x65\155\160\154\x61\164\x65\x43\165\x73\x74\157\x6d"], true); if (!(isset($customSettings->paymentIcons) && is_array($customSettings->paymentIcons))) { goto foVuq; } $customSettings->paymentIcons = json_encode($customSettings->paymentIcons); foVuq: goto FZllI; y9Ubd: $themeSaved = null; $updateSavedTheme = $this->db->select("\170\160\154\165\x67\151\156\137\141\144\155\x6f\x72\x72\151\163\137\160\x72\157\137\x74\150\145\x6d\145", "\151\x64", (int) $customSettings->themeId); if (!empty($updateSavedTheme)) { goto u79TG; } $themeSaved = $this->db->insert("\170\160\154\165\x67\151\x6e\x5f\141\144\155\157\x72\162\151\163\137\160\x72\x6f\x5f\x74\x68\145\x6d\x65", $themeData); $response["\164\x68\145\x6d\145\x53\x61\166\145\x64"] = $themeSaved; goto lNUpI; u79TG: $themeUpdated = $this->db->update("\170\160\154\x75\x67\x69\x6e\137\x61\144\x6d\x6f\x72\x72\151\x73\137\x70\x72\157\137\164\150\145\155\145", "\x69\144", (int) $customSettings->themeId, $themeData); $response["\164\150\145\155\x65\125\x70\x64\141\164\145\x64"] = $themeUpdated; lNUpI: goto b0OTa; i5vIk: } private function saveCssFiles($cssFiles) { $adapter = new LocalFilesystemAdapter(self::CSS_PATH); $filesystem = new Filesystem($adapter); foreach ($cssFiles as $file) { $filesystem->write($file["\146\151\154\145\x4e\141\155\145"], $file["\x63\x73\x73"]); GFSWZ: } clT2x: $manifest = []; foreach ($cssFiles as $file) { $manifest[$file["\x66\x69\154\145\116\141\155\x65"]] = md5($file["\x63\x73\x73"]); lMI6S: } MzaYg: $filesystem->write("\x6d\x61\x6e\151\x66\x65\x73\x74\56\x6a\x73\x6f\x6e", json_encode($manifest)); } private function saveIcons($icons) { $iconsSaved = 1; if (!is_null($icons)) { goto nOX_5; } return 0; nOX_5: foreach ($icons as $icon) { $iconObj = new \stdClass(); $iconObj->id = $icon->id; $iconObj->iconType = $icon->iconType; $iconObj->iconId = $icon->iconId; $iconObj->iconFamily = $icon->iconFamily; $iconObj->sizeMultiplier = null; if (!($icon->sizeMultiplier !== null || $icon->sizeMultiplier !== '' || $icon->sizeMultiplier !== 0)) { goto Xf3Jt; } $iconObj->sizeMultiplier = $icon->sizeMultiplier; Xf3Jt: $iconQuery = $this->db->upsert("\170\160\154\x75\x67\x69\x6e\x5f\141\144\155\x6f\162\x72\151\x73\x5f\x70\x72\157\x5f\x69\143\157\x6e\x73\x5f\x75\163\145\x64", $iconObj); if (!($iconQuery == 0)) { goto s6Kn1; } $iconsSaved = 0; s6Kn1: V9Lbd: } cXZeQ: return $iconsSaved; } private function getTemplateConfig() { if (!(($settings = $this->cache->get(self::TEMPLATE_CONFIG_CACHE_ID)) !== false)) { goto y1BWG; } return $settings; y1BWG: $template = $this->db->query("\x53\x45\x4c\x45\x43\124\40\x63\x54\145\x6d\x70\x6c\141\164\145\40\x46\x52\x4f\115\40\x74\164\x65\155\160\154\141\x74\x65\40\x57\x48\105\122\x45\x20\x65\124\171\x70\40\x3d\40\47\x73\164\x61\156\144\x61\x72\x64\x27", 1); $template = $template->cTemplate; $template = in_array($template, ["\x61\144\155\x6f\162\x72\151\x73\x5f\160\x72\157", "\x61\x64\x6d\157\162\162\151\163\137\160\162\157\x5f\143\x68\x69\x6c\x64"]) ? $template : "\141\144\155\157\162\x72\x69\x73\137\x70\x72\157"; $data = $this->db->query("\x53\x45\114\105\103\124\40\143\123\145\153\x74\x69\157\x6e\x20\x41\123\40\x73\x65\x63\x2c\x20\143\x57\145\162\x74\x20\x41\x53\40\x76\141\154\54\x20\x63\x4e\x61\x6d\x65\x20\x41\x53\40\156\x61\x6d\145\40\xa\40\40\40\40\40\40\40\x20\106\x52\x4f\115\40\x74\164\145\x6d\160\154\141\x74\x65\x65\151\156\x73\x74\x65\154\x6c\x75\156\147\x65\156\x20\12\40\x20\x20\40\40\40\x20\40\x57\110\105\122\x45\40\x63\x54\145\155\x70\x6c\x61\x74\x65\x20\x3d\x20\x27{$template}\x27", 2); $settings = []; foreach ($data as $setting) { if (isset($settings[$setting->sec])) { goto X9NWg; } $settings[$setting->sec] = []; X9NWg: $settings[$setting->sec][$setting->name] = $setting->val; ABztd: } euBYm: $this->cache->set(self::TEMPLATE_CONFIG_CACHE_ID, $settings, [\CACHING_GROUP_PLUGIN, \CACHING_GROUP_TEMPLATE, $this->plugin->getCache()->getGroup()]); return $settings; } public function saveHeader($req) { $response = []; $response["\x65\162\x72\157\162"] = false; $headerLayout = $req["\x73\145\164\164\151\x6e\147\163"]; $headerData = json_encode($headerLayout); $file = fopen(PFAD_ROOT . "\x74\145\155\x70\154\141\164\145\x73\x2f\141\x64\155\x6f\x72\x72\151\163\137\160\162\x6f\57\160\150\160\x2f\x68\145\x61\144\145\x72\114\x61\x79\157\x75\x74\x44\x61\164\x61\x2e\152\x73\157\x6e", "\167"); fwrite($file, $headerData); $saved = fclose($file); $this->cache->flush(self::CACHE_ID); $this->cache->flush(self::TEMPLATE_CONFIG_CACHE_ID); header("\103\x6f\156\164\145\x6e\x74\55\164\171\160\145\x3a\40\x61\x70\x70\154\151\143\141\164\151\x6f\156\x2f\x6a\x73\157\x6e"); return json_encode($response); } public function loadHeaderLayout() { $headerLayoutPath = PFAD_ROOT . "\x74\x65\155\160\x6c\x61\164\x65\x73\57\x61\144\155\x6f\162\162\x69\163\x5f\160\x72\157\x2f\x70\x68\x70\57\150\145\141\144\x65\x72\x4c\141\171\157\x75\164\104\141\164\141\56\x6a\163\x6f\156"; if (!file_exists($headerLayoutPath)) { goto dwLnP; } return file_get_contents($headerLayoutPath); dwLnP: } private static function setTemplateSettingsTypes($settings, $decode = null) { $templateBoolString = ["\x66\x6f\157\164\145\162" => ["\x6e\x65\x77\x73\154\x65\164\164\145\162\137\146\x6f\157\x74\145\x72", "\x73\157\143\x69\141\154\x6d\145\x64\x69\141\x5f\x66\157\x6f\x74\145\162"], "\x67\x65\156\145\x72\141\x6c" => ["\165\x73\x65\x5f\143\162\x6f\156", "\160\x72\x6f\x67\162\x65\x73\x73\151\166\145\x5f\154\157\141\144\151\x6e\147", "\x75\x73\x65\x5f\146\x6f\x6e\164\137\141\167\145\x73\x6f\155\x65\137\x34", "\x75\163\x65\137\146\x6f\156\x74\x5f\141\167\145\163\157\x6d\145\x5f\x35"], "\x74\150\x65\155\145" => ["\142\x61\156\x6e\145\162\x5f\146\x75\154\154\x5f\167\x69\x64\164\150", "\161\x74\171\137\x6d\157\144\x69\x66\171\x5f\144\x72\157\160\144\x6f\x77\156", "\154\145\x66\164\137\x73\x69\x64\x65\142\x61\162"], "\155\x65\x67\x61\155\145\156\x75" => ["\163\x68\x6f\x77\137\163\165\142\143\x61\x74\x65\x67\x6f\x72\151\x65\x73"], "\x70\162\x6f\x64\x75\143\x74\x6c\151\163\164" => ["\150\157\x76\145\x72\137\x70\x72\x6f\144\165\x63\164\154\151\x73\164", "\161\165\x69\143\x6b\166\151\x65\167\x5f\x70\162\x6f\144\x75\x63\x74\154\151\163\x74", "\x62\141\x6e\156\x65\162\137\160\141\x72\141\x6c\x6c\141\x78", "\x62\x75\171\x5f\x70\x72\157\x64\x75\143\164\x6c\x69\x73\164"]]; return (object) TypeConverter::setTypes($settings, NULL, $templateBoolString, NULL, $decode); } private static function setCustomTemplateSettingsTypes($settings, $decode = null) { $boolString = ["\150\145\141\144\x65\x72\x5f\x6f\x76\x65\162\154\141\x79", "\146\x6c\157\x61\164\151\x6e\x67\x5f\146\x69\x6c\x74\145\x72\x5f\163\x69\144\x65\142\x61\162"]; $types = ["\152\x61\166\x61\163\x63\x72\151\160\x74\x5f\141\x73\x79\156\143\x5f\154\x6f\141\x64\151\x6e\x67" => "\x62\157\x6f\x6c", "\x6a\x71\x75\x65\162\x79\x5f\x61\163\171\x6e\x63\x5f\x6c\x6f\x61\x64\151\x6e\x67" => "\x62\x6f\x6f\x6c", "\163\143\162\157\x6c\x6c\137\164\x6f\x5f\x74\x6f\x70\x5f\141\143\164\x69\166\145" => "\x62\x6f\x6f\154", "\x68\x6f\166\145\x72\137\163\145\143\x6f\156\144\137\151\155\141\x67\145" => "\142\157\x6f\154", "\x73\x75\x62\143\x61\x74\x65\147\157\162\x79\x5f\143\x6f\x6c\x75\155\x6e\x5f\143\x6f\165\x6e\164" => "\x69\156\x74", "\151\x6d\x61\147\145\137\x70\x72\x65\154\157\x61\x64\x5f\141\x6e\x69\155\x61\x74\x69\157\156" => "\142\x6f\157\154", "\163\150\x6f\167\102\x72\x61\x6e\144\114\157\x67\157" => "\x62\157\x6f\154", "\x65\x6c\x65\155\145\x6e\x74\x73\104\x65\142\165\x67\115\x6f\x64\145" => "\x62\x6f\x6f\154", "\x70\x72\157\x64\165\x63\164\x47\141\x6c\x6c\x65\x72\171\105\141\x73\x79\x5a\157\157\155" => "\x62\157\x6f\x6c", "\146\x69\x78\145\x64\x41\x64\144\124\x6f\102\141\163\x6b\x65\x74" => "\142\157\157\x6c", "\146\x69\x78\x65\144\x41\x64\x64\x54\157\x42\141\x73\153\x65\164\120\x6f\163\x69\x74\151\x6f\x6e" => "\163\x74\162\151\x6e\x67", "\x63\157\x6e\146\x69\147\x75\162\141\164\157\x72\103\157\x6e\146\151\147\x47\x72\157\165\160\x49\155\x61\147\145" => "\x62\157\157\x6c", "\x63\157\156\146\x69\x67\165\162\141\x74\x6f\x72\104\x65\x73\143\x72\x69\160\x74\x69\157\x6e\103\x6f\x6c\154\x61\x70\163\145" => "\142\157\x6f\154", "\x63\157\156\146\151\147\165\162\141\x74\157\x72\101\162\x74\151\x63\154\145\104\x65\x74\x61\x69\154\x73\102\x75\164\164\x6f\x6e" => "\x62\x6f\157\154", "\x63\x6f\x6e\146\151\147\165\162\x61\164\157\162\x43\157\156\146\151\x67\101\162\164\151\143\x6c\145\111\155\x61\147\x65" => "\142\157\x6f\x6c", "\x70\162\x6f\144\x75\143\x74\x53\x6c\x69\x64\x65\162\x50\x75\162\143\150\141\163\145\106\165\x6e\143\x74\151\157\156\163" => "\142\x6f\157\x6c", "\160\x72\x6f\144\165\143\x74\x53\154\x69\x64\x65\162\121\165\x61\156\164\151\164\171\x53\x65\x6c\x65\x63\164\151\157\156" => "\142\x6f\157\154", "\x61\x72\164\x69\143\x6c\145\137\156\165\x6d\142\x65\x72\x5f\x67\141\x6c\x6c\145\x72\171" => "\142\x6f\x6f\154", "\x73\150\x69\160\x70\x69\156\x67\x50\162\x6f\x76\x69\x64\145\x72\x4c\157\147\157\163\106\x6f\157\x74\145\x72" => "\142\157\157\x6c", "\163\150\151\160\x70\x69\x6e\x67\x50\162\x6f\166\151\144\145\162\114\157\x67\157\x73\104\x65\x74\x61\151\x6c" => "\142\157\x6f\154", "\x70\x61\x79\155\x65\156\x74\x50\162\157\x76\151\144\x65\162\x4c\x6f\147\157\163\106\157\157\x74\145\x72" => "\x62\157\x6f\x6c", "\x70\141\x79\x6d\x65\156\x74\x50\162\x6f\x76\x69\144\x65\x72\114\157\x67\157\x73\104\x65\x74\x61\151\154" => "\142\157\x6f\x6c", "\x62\x6f\170\x65\144\110\145\x61\144\x65\x72" => "\142\x6f\157\x6c"]; return (object) TypeConverter::setTypes($settings, $types, $boolString, NULL, $decode); } private static function writeFile($css, $filename = "\x74\x68\x65\155\145\x2e\x63\x73\163") { $file = fopen(PFAD_ROOT . "\x74\x65\x6d\x70\x6c\x61\164\145\163\x2f\x61\144\x6d\x6f\162\162\151\x73\137\160\x72\x6f\x2f\164\150\145\x6d\145\163\x2f\x61\x64\x6d\157\x72\x72\151\163\57{$filename}", "\x77"); fwrite($file, $css); $saved = fclose($file); return $saved; } private function checkIfTableExists() { $result = $this->db->query("\x53\x45\x4c\105\103\x54\40\x43\117\x55\x4e\124\50\x2a\x29\x20\x41\123\x20\143\x6e\x74\40\106\x52\117\x4d\x20\x69\x6e\x66\x6f\x72\x6d\141\164\x69\x6f\x6e\x5f\x73\143\x68\x65\155\141\56\x74\x61\142\154\145\163\x20\x57\x48\105\x52\105\x20\164\141\x62\x6c\145\x5f\x73\x63\150\145\155\141\40\x3d\40\104\x41\x54\101\x42\x41\x53\x45\x28\51\40\x41\x4e\x44\x20\x74\x61\142\154\145\x5f\156\141\155\x65\x20\x3d\x20\x27\x78\x70\154\x75\147\x69\x6e\137\141\x64\155\x6f\162\162\x69\x73\x5f\160\x72\157\x5f\164\x65\155\x70\154\x61\x74\x65\137\163\x65\164\164\151\156\147\163\x27", ReturnType::SINGLE_OBJECT); return $result !== null && (int) $result->cnt > 0; } }