<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro; use JTL\Shop; use JTL\Pagination\Pagination; use JTL\Catalog\Product\Artikel; use Template\admorris_pro\HeaderLayout; use function Plugin\admorris_pro\cssSelector; use function Plugin\admorris_pro\groupBy; class Reorder { private $plugin; private $smarty; private $orders = null; private $assetLoader; private $headerLayout = null; public function __construct($plugin) { $this->plugin = $plugin; $this->smarty = Shop::Smarty(); $this->assetLoader = Shop::get("\x61\155\101\163\163\145\x74\114\157\141\144\145\162"); $this->smarty->assign("\141\x6d\x5f\x52\145\157\x72\144\145\x72", $this); $this->initAccountListing(); $this->addDropdown(); } public function initAccountListing() : void { if (!(Shop::getPageType() !== \PAGE_MEINKONTO || isset($_GET["\x77\x6c"]) || isset($_GET["\142\x65\163\164\x65\x6c\154\165\x6e\147\x65\x6e"]) || isset($_GET["\145\x64\x69\x74\x52\145\143\x68\x6e\165\x6e\x67\x73\x61\144\x72\145\x73\163\x65"]))) { goto JTEa6; } return; JTEa6: $boughtItemListPath = $this->plugin->getPaths()->getFrontendPath() . "\164\145\155\160\154\x61\x74\x65\x73\57\162\145\x6f\x72\144\x65\162\x2f\162\145\x6f\x72\x64\145\x72\x5f\x6c\151\163\164\x2e\164\160\x6c"; if (!isTemplateActive()) { goto W_zlr; } $templateSettings = Shop::get("\141\144\x6d\x6f\162\x72\151\x73\x2d\x63\165\x73\164\x6f\155\x2d\x74\145\155\x70\x6c\x61\x74\x65\x2d\163\145\x74\164\151\156\147\163"); $this->smarty->assign("\141\x6d\137\147\154\157\x62\141\x6c\x43\x6f\x6e\164\x61\151\156\145\162\123\151\172\x65", $templateSettings->global_container)->assign("\x61\155\x5f\122\145\x6f\162\144\145\x72", $this); W_zlr: $boughtItemList = $this->smarty->fetch($boughtItemListPath); cssSelector("\x72\x65\157\x72\144\145\x72\x5f\x73\150\157\x77\137\141\x63\143\x6f\165\x6e\x74", $boughtItemList); } public function addDropdown() : void { $this->assetLoader->addToHead($this->plugin->getPaths()->getFrontendURL() . "\x63\163\x73\57\x72\145\157\162\x64\x65\x72\56\x63\x73\x73", "\x72\x65\x6f\162\144\145\x72\x2d\144\x72\157\160\144\x6f\167\x6e"); $imageSetting = $this->plugin->getConfig()->getValue("\x61\144\x6d\x6f\162\162\151\x73\137\160\x72\157\137\155\141\x72\153\145\x74\x69\156\x67\x5f\x72\145\x6f\162\x64\145\x72\x5f\x64\x72\157\160\144\x6f\167\156\x5f\x69\155\141\x67\x65"); $dropdownItemNumber = (int) $this->plugin->getConfig()->getValue("\141\x64\155\157\x72\162\151\x73\x5f\160\162\157\137\x6d\141\162\153\x65\x74\x69\x6e\147\x5f\162\x65\157\162\x64\145\162\137\x64\162\157\x70\x64\157\167\156\x5f\x69\x74\145\155\137\154\x69\155\151\164"); $orders = $this->getCustomerOrders(); if (!empty($orders)) { goto Vpp8Z; } return; Vpp8Z: $articles = $this->lastOrderedItems($orders, false, false, $dropdownItemNumber); $variationValues = $this->getVariationValues($orders); $this->assignTemplateVars($imageSetting, $articles, $variationValues); $this->renderDropdowns(); } private function getVariationValues($orders) : array { $kWarenkorb_arr = array_column($orders, "\153\127\141\162\145\156\x6b\157\162\x62"); $warenkorbKeys = implode("\54\40", $kWarenkorb_arr); $query = "\123\x45\x4c\x45\103\124\x20\x2a\40\106\x52\x4f\115\x20\164\167\141\162\x65\156\153\x6f\x72\142\x70\x6f\163\12\40\40\40\x20\40\40\x20\40\40\x20\x20\40\x49\x4e\116\x45\122\x20\112\117\x49\x4e\x20\x74\167\141\x72\x65\156\153\x6f\x72\142\x70\x6f\x73\x65\x69\x67\145\x6e\163\143\x68\x61\x66\164\xa\x20\x20\40\x20\40\40\40\x20\40\40\40\x20\x4f\116\x20\164\x77\x61\162\145\x6e\x6b\157\x72\142\x70\157\163\x2e\153\127\x61\162\145\156\153\157\162\x62\x50\157\163\x20\x3d\40\164\167\x61\162\x65\156\153\157\x72\x62\160\x6f\x73\145\151\147\x65\156\163\x63\150\141\x66\164\x2e\153\x57\x61\x72\145\156\153\x6f\x72\142\x50\157\163\12\x20\40\40\40\40\40\40\x20\40\40\40\x20\127\110\105\122\x45\x20\x74\x77\141\162\145\x6e\x6b\x6f\162\142\160\157\163\56\153\x57\141\162\x65\x6e\x6b\157\162\x62\x20\x49\x4e\x20\x28{$warenkorbKeys}\51"; $variationValues = Shop::Container()->getDB()->executeQuery($query, 2); $variationValues = groupBy("\153\101\162\164\x69\x6b\145\x6c", $variationValues); foreach ($variationValues as $key => $article) { $variationValues[$key] = groupBy("\x6b\x57\x61\x72\145\x6e\153\157\x72\x62\120\x6f\163", $article); ekIHc: } sK_Hb: return $variationValues; } private function assignTemplateVars($imageSetting, $articles, $variationValues) : void { $this->smarty->assign("\x61\155\x5f\162\x65\157\162\144\x65\162\x56\141\x72\x69\x61\x74\x69\157\156\126\141\x6c\x75\x65\x73", $variationValues)->assign("\x61\x6d\x5f\162\x65\x6f\162\144\145\162\x49\x74\145\x6d\x54\x65\155\x70\154\141\x74\145", $this->plugin->getPaths()->getFrontendPath() . "\57\x74\145\x6d\x70\x6c\x61\164\145\163\x2f\162\145\x6f\162\x64\x65\162\57\x72\x65\x6f\x72\x64\145\x72\137\x64\162\x6f\x70\x64\157\x77\156\137\151\164\145\155\x2e\164\160\154")->assign("\141\x6d\x5f\x72\x65\157\162\x64\145\162\x44\162\157\160\x64\157\x77\156\x49\x6d\141\147\145\x53\145\164\x74\x69\x6e\147", $imageSetting)->assign("\x61\155\137\x72\145\157\162\x64\145\x72\x44\162\x6f\x70\144\x6f\x77\156\x41\x72\164\x69\x63\x6c\145\x73", $articles)->assign("\x6f\120\x6c\165\x67\x69\156\x5f\141\x64\x6d\x6f\x72\162\151\x73\x5f\160\x72\x6f", Shop::get("\x6f\x70\x6c\x75\147\x69\x6e\x5f" . getPluginId())); } private function fetchDropdownTemplate(string $layoutType, string $templatePath) : string { if (!(isTemplateActive() && class_exists("\x5c\x54\145\155\x70\154\x61\164\145\x5c\141\144\155\x6f\162\x72\151\x73\137\x70\162\157\x5c\110\145\141\x64\x65\162\114\x61\x79\157\165\x74"))) { goto kv83B; } if (!($this->headerLayout === null)) { goto AObS1; } $this->headerLayout = new HeaderLayout(); AObS1: $this->smarty->assign("\x61\x6d\x5f\162\x65\157\162\144\x65\x72\114\141\x62\x65\154\123\x65\x74\164\151\x6e\x67", $this->headerLayout->getItemSetting("\x72\145\x6f\x72\x64\145\162", "\x6c\x61\x62\x65\154", $layoutType)); kv83B: $this->smarty->assign("\141\x6d\137\x72\145\157\x72\144\145\x72\x44\x72\157\160\x64\x6f\x77\156\114\141\171\x6f\x75\164\x54\x79\x70\x65", $layoutType); return $this->smarty->fetch($templatePath); } private function renderDropdowns() : void { goto cIjg1; SNfvE: cssSelector("\x72\x65\x6f\x72\144\x65\x72\x5f\x6d\157\x62\151\154\145", $dropdownMobile); pYNer: goto sEyY8; i6NfB: $dropdownSelectorEl->replaceWith($dropdownDesktop); if (!isset($dropdownMobile)) { goto IY0cc; } $dropdownSelectorElMobile->replaceWith($dropdownMobile); IY0cc: if (!isset($dropdownOffcanvas)) { goto zCyrg; } $dropdownSelectorElOffcanvas->replaceWith($dropdownOffcanvas); goto WwUr8; Wbyn4: $mobileSelector = $this->plugin->getConfig()->getValue("\x61\144\x6d\x6f\x72\162\x69\x73\137\160\x72\157\x5f\145\x78\x70\145\162\164\137\163\145\x74\x74\151\x6e\147\163\137\x72\x65\157\x72\144\x65\162\137\x6d\x6f\x62\x69\154\145\x5f\x63\x73\x73\x5f\163\145\154\x65\x63\164\157\x72"); if (!(!isTemplateActive() && !empty($mobileSelector) || isset($dropdownSelectorElMobile) && count($dropdownSelectorElMobile) > 0)) { goto TM8DM; } $dropdownMobile = $this->fetchDropdownTemplate("\x6d\157\x62\151\154\x65\x4c\141\171\x6f\165\164", $templatePath); TM8DM: if (!(isset($dropdownSelectorElOffcanvas) && count($dropdownSelectorElOffcanvas) > 0)) { goto yDU60; } $dropdownOffcanvas = $this->fetchDropdownTemplate("\x6f\x66\146\143\141\x6e\166\x61\x73\x4c\x61\x79\157\165\164", $templatePath); yDU60: if (isTemplateActive()) { goto i6NfB; } cssSelector("\162\x65\157\x72\x64\x65\x72", $dropdownDesktop); if (!isset($dropdownMobile)) { goto pYNer; } goto SNfvE; WwUr8: zCyrg: sEyY8: goto zbZpB; cIjg1: $templatePath = $this->plugin->getPaths()->getFrontendPath() . "\164\x65\x6d\x70\154\141\164\145\163\57\162\145\157\x72\144\145\x72\x2f\x72\x65\x6f\x72\x64\145\162\137\x64\x72\157\160\144\157\x77\x6e\56\x74\x70\x6c"; $dropdownDesktop = $this->fetchDropdownTemplate("\144\145\163\x6b\x74\x6f\160\x4c\x61\171\x6f\x75\164", $templatePath); if (!isTemplateActive()) { goto fBqnc; } $dropdownSelectorEl = pq("\43\x72\x65\x6f\162\x64\x65\162\x2d\x64\145\163\x6b\x74\x6f\x70\55\x6d\145\156\x75\55\x62\165\x74\164\x6f\156"); $dropdownSelectorElMobile = pq("\43\162\145\157\x72\144\x65\162\x2d\x6d\157\142\x69\x6c\x65\x2d\155\x65\x6e\165\55\x62\165\164\x74\157\156"); $dropdownSelectorElOffcanvas = pq("\43\x72\145\157\x72\x64\x65\162\x2d\x6f\146\146\143\x61\x6e\166\141\x73\x2d\x6d\145\x6e\x75\x2d\x62\165\164\164\157\156"); if (!(count($dropdownSelectorEl) == 0 && count($dropdownSelectorElMobile) == 0 && count($dropdownSelectorElOffcanvas) == 0)) { goto MOuUb; } return; MOuUb: fBqnc: goto Wbyn4; zbZpB: } public function getCustomerOrders() { $kKunde = !empty($_SESSION["\x4b\165\x6e\x64\145"]) ? $_SESSION["\113\165\156\144\x65"]->getID() : null; if (!(!empty($kKunde) && $this->orders === null)) { goto nx9iI; } $this->orders = Shop::Container()->getDB()->query("\x53\x45\x4c\105\103\124\40\52\x20\x46\122\117\115\x20\164\x62\x65\163\164\x65\x6c\x6c\x75\156\147\x20\127\110\x45\122\105\x20\153\113\165\x6e\144\145\x20\75\x20" . (int) $kKunde, 2); nx9iI: return $this->orders; } public function lastOrderedItems($orders, $fatherArticles = true, $pagination = true, $limit = null) { if (!(count($orders) == 0)) { goto pQWmy; } return; pQWmy: $items = $this->getOrderItems($orders); $items = array_reverse($items); if (!$limit) { goto kPac7; } $items = array_slice($items, 0, $limit); kPac7: $itemKeys = $this->getItemKeys($items, $fatherArticles); $products = $this->getMyProductList(["\x6b\101\x72\x74\x69\153\145\154" => $itemKeys, "\156\x4c\151\x6d\x69\164" => 50]); $products = $this->filterProducts($products); return $this->handlePagination($products, $pagination, $limit); } private function getOrderItems($orders) : array { $kWarenkorb_arr = array_column($orders, "\153\x57\x61\162\145\x6e\153\157\162\142"); return Shop::Container()->getDB()->query("\123\105\114\x45\103\124\40\x2a\x20\x66\x72\157\x6d\x20\x74\x61\162\x74\151\153\145\154\xa\x20\40\40\40\40\40\x20\x20\x20\40\x20\40\x20\114\105\106\x54\x20\x4a\x4f\111\x4e\40\x74\x77\141\x72\x65\156\x6b\x6f\162\x62\x70\157\x73\xa\x20\40\x20\x20\40\x20\40\x20\x20\x20\40\x20\x20\x4f\x4e\x20\164\167\141\162\145\156\153\157\x72\142\160\x6f\163\x2e\153\101\x72\164\151\153\x65\x6c\x20\75\x20\164\x61\x72\x74\x69\x6b\x65\154\56\153\101\162\x74\151\x6b\x65\x6c\xa\40\x20\x20\x20\40\40\x20\40\x20\40\40\40\40\x57\110\105\122\105\x20\164\167\x61\162\x65\156\153\157\162\x62\160\157\x73\56\x6b\127\x61\x72\145\156\x6b\157\x72\142\x20\x49\x4e\40\x28" . implode("\54", $kWarenkorb_arr) . "\x29\x3b", 2); } private function getItemKeys($items, $fatherArticles) : array { $itemKeys = []; foreach ($items as $item) { if ($fatherArticles && $item->kVaterArtikel !== "\x30") { goto xdcbP; } $itemKeys[] = $item->kArtikel; goto NgDyb; xdcbP: $itemKeys[] = $item->kVaterArtikel; NgDyb: a3Gll: } INONs: return array_unique($itemKeys); } private function filterProducts($products) : array { return array_filter($products, function ($item) { return empty($item->FunktionsAttribute["\145\x78\x74\x72\141\137\x70\162\x6f\x64\165\x63\164\137\156\157\164\137\142\165\x79\141\x62\x6c\145"]); }); } private function handlePagination($products, $pagination, $limit) { if (!$pagination) { goto BeDCR; } return (new Pagination("\157\162\x64\145\162\163"))->setItemsPerPage(12)->setItemArray($products)->assemble(); BeDCR: return empty($limit) ? $products : array_slice($products, 0, $limit); } private function getMyProductList($params) : array { $nLimit = $params["\156\114\151\x6d\x69\x74"] ?? 10; $kArtikel = $params["\x6b\101\162\164\x69\153\145\x6c"] ?? null; if (!($kArtikel === null)) { goto CG09N; } return []; CG09N: $articles = []; $kArtikel = is_array($kArtikel) ? $kArtikel : [$kArtikel]; foreach ($kArtikel as $articleId) { $article = new Artikel(); $options = (object) ["\x6e\x4d\x65\162\153\x6d\141\x6c\x65" => 1, "\x6e\101\x74\x74\x72\151\142\165\x74\x65" => 1, "\156\101\162\x74\151\x6b\x65\154\x41\x74\x74\x72\x69\142\x75\x74\x65" => 1, "\x6e\113\157\x6e\x66\x69\147" => 1, "\x6e\x44\x6f\167\156\x6c\157\141\144" => 1, "\156\x56\x61\162\151\141\x74\x69\x6f\x6e\x65\156" => 1]; $article->fuelleArtikel($articleId, $options); $articles[] = $article; tRlHL: } XGIP9: return $articles; } public static function varikombiStringToArray($string) : array { $variations = explode("\73", $string); $variations = array_map(function ($variation) { return explode("\x5f", $variation); }, $variations); return $variations; } }