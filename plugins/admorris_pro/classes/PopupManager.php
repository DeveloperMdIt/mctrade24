<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro; use JTL\DB\ReturnType; use JTL\Shop; use Plugin\admorris_pro\TriggerFilter; use Plugin\admorris_pro\Utils\Image; class PopupManager { private $smarty; private $plugin; private $frontendUrl; private $frontendPath; private $triggerFilter; private $language; private $maxOnePopup; public function __construct($plugin = null) { $this->smarty = Shop::Smarty(); $this->plugin = $plugin; $this->triggerFilter = new TriggerFilter(); $this->language = $_SESSION["\153\123\160\x72\x61\x63\150\145"]; $this->maxOnePopup = true; if (!$this->plugin) { goto vEZce; } $this->frontendUrl = $this->plugin->getPaths()->getFrontendURL(); $this->frontendPath = $this->plugin->getPaths()->getFrontendPath(); vEZce: } public function loadPopups() : void { $now = date("\131\55\x6d\55\144\40\110\x3a\151\72\163"); $popupsWithTriggers = $this->loadPopupsWithTriggers($now); foreach ($popupsWithTriggers as $popup) { if ($this->maxOnePopup) { goto clLsg; } goto UoKiC; clLsg: $cookieName = "\x61\x64\155\x6f\162\x72\151\163\x5f\160\x72\157\x5f\x70\x6f\160\x75\160\137" . $popup->id; if (!isset($_COOKIE[$cookieName])) { goto w9jrA; } goto z0fBG; w9jrA: $triggerResult = true; if (empty($popup->triggerFilters)) { goto uK8k4; } $triggerResult = $this->triggerFilter->checkTrigger($popup->triggerFilters, $popup->triggerFilterOperator); uK8k4: if (!$triggerResult) { goto z7Di1; } $this->showPopup($popup); $this->maxOnePopup = false; z7Di1: z0fBG: } UoKiC: } private function loadPopupsWithTriggers(string $now) : array { $db = Shop::Container()->getDB(); $query = "\xa\40\40\40\x20\x20\40\40\x20\x20\40\40\40\x53\105\114\105\103\124\40\xa\x20\x20\x20\40\40\40\x20\40\x20\x20\40\40\40\40\40\40\x70\56\x2a\x2c\xa\x20\40\40\40\40\40\x20\40\x20\40\40\40\x20\40\x20\40\x74\146\56\151\x64\x20\x61\x73\40\x66\x69\x6c\164\145\162\x5f\151\144\x2c\x20\xa\x20\40\40\x20\40\40\40\40\40\40\40\x20\x20\40\40\x20\x74\x66\56\x74\x72\x69\147\147\x65\x72\106\151\154\164\145\162\124\171\160\145\x2c\x20\xa\x20\40\40\40\40\40\x20\40\40\x20\x20\40\x20\x20\40\x20\164\x66\56\x74\162\x69\147\147\145\162\106\x69\x6c\x74\145\x72\x56\141\x6c\x75\x65\x2c\12\x20\x20\x20\x20\40\40\x20\x20\x20\x20\x20\40\40\x20\x20\40\164\146\56\x70\x6f\x70\165\160\111\x64\12\x20\x20\x20\x20\40\x20\40\x20\40\x20\x20\40\x46\x52\117\x4d\40\x78\x70\154\x75\147\151\156\x5f\141\144\155\x6f\162\162\151\163\x5f\x70\162\x6f\137\160\x6f\160\x75\160\40\x70\12\x20\x20\40\x20\x20\x20\x20\x20\40\x20\40\x20\x4c\x45\x46\x54\40\112\117\x49\x4e\40\170\160\154\165\x67\x69\x6e\x5f\x61\x64\x6d\157\162\x72\x69\163\137\160\162\157\137\x70\x6f\160\x75\160\x5f\164\162\151\147\x67\145\x72\x5f\146\x69\x6c\x74\145\162\x20\x74\146\x20\117\x4e\40\x70\x2e\151\144\x20\75\40\164\146\x2e\x70\x6f\x70\165\x70\111\144\xa\40\x20\x20\40\x20\40\x20\x20\x20\x20\x20\40\127\110\105\122\x45\40\x70\56\x61\x63\x74\x69\x76\x65\40\75\x20\47\61\x27\40\12\40\40\x20\x20\40\40\40\40\40\x20\x20\x20\x20\x20\40\x20\101\x4e\104\40\x70\56\x6c\x61\156\x67\40\75\x20\x3a\154\141\x6e\147\40\xa\x20\x20\40\40\40\x20\x20\40\40\40\x20\x20\x20\x20\40\40\x41\116\x44\40\160\56\x73\164\x61\162\x74\124\151\x6d\145\x20\74\x3d\x20\x3a\156\157\x77\x20\xa\x20\40\x20\40\x20\40\x20\40\40\x20\40\x20\40\40\40\40\101\x4e\x44\40\160\56\x64\151\x73\x61\x62\154\145\x54\151\155\x65\x20\76\75\40\72\156\157\x77\xa\x20\x20\x20\x20\40\x20\40\40\x20\40\x20\x20\117\x52\104\105\x52\40\x42\131\40\x70\x2e\160\x72\x69\157\x72\x69\164\x79\x20\x44\105\x53\103\xa\x20\x20\40\x20\x20\x20\x20\x20"; $results = $db->queryPrepared($query, ["\x6c\141\156\x67" => $this->language, "\156\157\x77" => $now], ReturnType::ARRAY_OF_OBJECTS); if (!empty($results)) { goto kTpDm; } return []; kTpDm: $popupsMap = []; foreach ($results as $row) { $popupId = $row->id; if (isset($popupsMap[$popupId])) { goto uDAfl; } $popup = clone $row; $popup->triggerFilters = []; unset($popup->filter_id, $popup->triggerFilterType, $popup->triggerFilterValue, $popup->popupId); $popupsMap[$popupId] = $popup; uDAfl: if (!($row->filter_id !== null)) { goto Nvr1w; } $triggerFilter = (object) ["\x69\x64" => $row->filter_id, "\x74\162\x69\147\x67\x65\x72\106\x69\154\x74\x65\162\x54\x79\x70\x65" => $row->triggerFilterType, "\x74\162\151\x67\147\145\162\x46\x69\x6c\x74\x65\x72\126\141\x6c\x75\x65" => $row->triggerFilterValue, "\x70\x6f\x70\165\x70\x49\144" => $row->popupId]; $popupsMap[$popupId]->triggerFilters[] = $triggerFilter; Nvr1w: fW0cG: } jrCFT: return array_values($popupsMap); } private function showPopup(object $popup) : void { $now = new \DateTime(); $now = $now->format("\143"); $saleStartDate = new \DateTime($popup->saleStart); $saleStart = $saleStartDate->format("\143"); $saleStartTimestamp = $saleStartDate->getTimestamp(); $saleEndDate = new \DateTime($popup->saleEnd); $saleEnd = $saleEndDate->format("\143"); [$align, $justify] = $this->getPositionAlignment($popup->stylePosition); $popupData = $this->smarty->createData($this->smarty); $this->assignPopupData($popupData, $popup, ["\163\x61\x6c\x65\123\164\141\x72\164" => $saleStart, "\163\x61\154\x65\123\164\x61\162\164\124\x69\155\x65\163\164\141\155\x70" => $saleStartTimestamp, "\163\x61\154\x65\x45\156\x64" => $saleEnd, "\x63\x75\x72\162\145\156\164\104\141\164\x65" => $now, "\141\x6c\151\147\x6e" => $align, "\x6a\165\163\x74\x69\x66\x79" => $justify]); $this->handleSpecialTemplateRequirements($popup, $popupData); $this->registerImageSizeFunction(); $this->renderPopup($popup, $popupData); $this->loadPopupAssets($popup); } private function getPositionAlignment(string $stylePosition) : array { $align = "\143\145\156\x74\145\x72"; $justify = "\x63\145\156\x74\x65\x72"; switch ($stylePosition) { case "\x61\144\x6d\x6f\x72\162\151\x73\55\155\157\144\141\154\x2d\x62\x6f\x74\164\x6f\x6d\55\x63\x65\156\164\x65\162": case "\x61\x64\x6d\157\162\x72\x69\x73\x2d\155\x6f\x64\x61\x6c\x2d\x62\x6f\164\164\x6f\x6d\x2d\154\145\146\164": case "\x61\x64\155\x6f\162\x72\151\x73\55\155\157\x64\141\x6c\55\x62\x6f\x74\x74\157\155\x2d\x72\x69\x67\x68\x74": $align = "\x66\x6c\x65\170\55\x65\156\x64"; goto QjJH2; case "\141\x64\x6d\157\x72\162\151\163\55\x6d\157\x64\141\x6c\x2d\164\x6f\160\x2d\143\145\156\164\x65\162": case "\x61\144\x6d\x6f\162\162\x69\x73\x2d\155\157\x64\141\154\x2d\164\x6f\160\x2d\x6c\145\x66\164": case "\x61\144\x6d\x6f\162\162\x69\163\55\x6d\157\x64\x61\x6c\55\x74\157\x70\55\162\151\147\150\164": $align = "\x66\x6c\145\170\55\163\x74\x61\x72\164"; goto QjJH2; case "\x61\x64\x6d\157\162\162\x69\163\x2d\155\157\x64\141\x6c\55\143\145\156\x74\145\162\145\144": $align = "\143\x65\156\164\145\162"; goto QjJH2; } iYZIE: QjJH2: switch ($stylePosition) { case "\x61\x64\155\x6f\x72\x72\151\163\x2d\155\157\x64\x61\154\x2d\x63\x65\x6e\x74\x65\162\x65\x64": case "\x61\144\155\157\x72\x72\151\x73\55\x6d\x6f\144\x61\x6c\55\x74\x6f\160\x2d\143\145\x6e\164\145\x72": case "\x61\x64\x6d\157\162\162\x69\163\x2d\x6d\157\x64\141\154\x2d\142\157\x74\164\x6f\155\x2d\143\x65\x6e\x74\x65\x72": $justify = "\143\145\x6e\x74\145\x72"; goto ALWsX; case "\x61\x64\x6d\157\x72\162\151\x73\x2d\x6d\157\144\x61\x6c\x2d\164\x6f\x70\x2d\x6c\145\x66\164": case "\141\144\x6d\157\162\x72\151\163\55\155\x6f\144\x61\x6c\x2d\142\x6f\164\x74\x6f\155\55\154\x65\x66\164": $justify = "\146\x6c\x65\170\x2d\x73\x74\141\x72\164"; goto ALWsX; case "\x61\144\155\x6f\162\x72\151\x73\55\x6d\157\x64\x61\154\x2d\164\x6f\x70\55\x72\x69\147\150\164": case "\141\x64\155\x6f\x72\162\151\x73\55\155\157\144\141\x6c\x2d\142\x6f\164\x74\x6f\155\x2d\x72\x69\147\x68\164": $justify = "\146\154\145\x78\55\x65\156\x64"; goto ALWsX; } HLxP2: ALWsX: return [$align, $justify]; } private function assignPopupData($popupData, $popup, array $additionalData = []) : void { goto Wg5EV; Wg5EV: $popupData->assign("\151\144", $popup->id); $popupData->assign("\164\x72\151\x67\x67\x65\x72\124\171\x70\x65", $popup->triggerType); $popupData->assign("\164\162\x69\x67\147\x65\162\126\x61\154\x75\145", $popup->triggerValue); $popupData->assign("\143\x6f\157\153\x69\x65\114\151\146\x65\x74\x69\155\145", $popup->cookieLifetime); $popupData->assign("\x73\x74\171\x6c\145\x53\x69\172\145\127\151\144\x74\x68", $popup->styleSizeWidth); $popupData->assign("\163\164\x79\x6c\145\123\x69\x7a\145\110\145\x69\x67\150\164", $popup->styleSizeHeight); $popupData->assign("\x73\164\x79\154\145\101\x6e\151\155\x61\164\151\x6f\156", $popup->styleAnimation); $popupData->assign("\x73\x74\171\x6c\x65\x41\156\151\x6d\141\x74\151\157\x6e\x4f\x75\164", $popup->styleAnimationOut); $popupData->assign("\x73\164\171\x6c\x65\120\157\x73\151\x74\x69\x6f\156", $popup->stylePosition); $popupData->assign("\163\164\171\x6c\x65\x43\x6f\x6c\x6f\162", $popup->styleColor); goto QF0XU; QF0XU: $popupData->assign("\x73\x74\x79\x6c\145\x42\141\143\153\x64\x72\x6f\160\103\157\154\157\162", $popup->styleBackdropColor); $popupData->assign("\163\164\x79\x6c\x65\102\141\143\x6b\x64\x72\157\x70\x53\164\141\x74\151\143", $popup->styleBackdropStatic); $popupData->assign("\x73\164\171\x6c\x65\123\x68\x61\144\x6f\167", $popup->styleShadow); $popupData->assign("\x73\x74\x79\154\x65\x42\x61\143\x6b\147\162\157\x75\x6e\x64\x43\x6f\x6c\x6f\162", $popup->styleBackgroundColor); $popupData->assign("\163\164\x79\154\x65\102\x61\x63\x6b\x67\162\157\165\x6e\x64\x49\155\x61\147\145", $popup->styleBackgroundImage); $popupData->assign("\x73\x74\171\x6c\145\103\x6c\157\163\x65\102\165\x74\164\157\156", $popup->styleCloseButton); $popupData->assign("\x73\x74\x79\154\145\x53\x63\162\157\154\x6c\x62\141\x72", $popup->styleScrollbar); $popupData->assign("\163\164\171\154\x65\102\x75\164\x74\157\x6e\103\157\x6c\157\x72", $popup->styleButtonColor); $popupData->assign("\163\164\171\154\145\102\x75\x74\164\157\x6e\124\x65\170\x74\103\157\x6c\157\x72", $popup->styleButtonTextColor); $popupData->assign("\143\157\x6e\164\145\x6e\x74\x54\x69\x74\x6c\145", $popup->contentTitle); goto XLiMu; XLiMu: $popupData->assign("\143\x6f\x6e\164\145\156\164\x54\x65\x78\164\x31", $popup->contentText1); $popupData->assign("\x63\157\156\x74\x65\x6e\164\124\x65\170\x74\62", $popup->contentText2); $popupData->assign("\143\157\x6e\x74\145\x6e\x74\124\x65\x78\164\x33", $popup->contentText3); $popupData->assign("\x63\x6f\x6e\164\145\156\x74\102\x75\x74\164\157\x6e\124\145\x78\164", $popup->contentButtonText); $popupData->assign("\143\157\x6e\164\x65\x6e\164\102\x75\x74\164\x6f\x6e\114\x69\x6e\153", $popup->contentButtonLink); $popupData->assign("\143\157\x6e\164\x65\156\x74\114\x69\x6e\x6b", $popup->contentLink); $popupData->assign("\143\x6f\x6e\164\x65\156\164\123\x61\154\165\x74\141\x74\x69\157\x6e", $popup->contentSalutation); $popupData->assign("\x63\x6f\156\x74\x65\156\x74\106\x69\x72\163\x74\x4e\x61\155\145", $popup->contentFirstName); $popupData->assign("\143\x6f\x6e\x74\x65\x6e\x74\x4c\141\x73\164\116\x61\x6d\x65", $popup->contentLastName); $popupData->assign("\x63\157\x75\x6e\x74\x64\x6f\x77\x6e\x53\x74\x79\x6c\x65", $popup->countdownStyle); goto tpow6; tpow6: $popupData->assign("\143\157\x75\x6e\164\144\157\x77\156\106\157\x72\155\x61\164", $popup->countdownFormat); $popupData->assign("\x74\x65\x6d\160\x6c\141\x74\145\120\141\164\x68", $this->frontendPath . "\x74\145\155\x70\x6c\x61\164\145\163\57\x6d\141\162\x6b\x65\164\x69\156\x67\137\x70\157\160\165\160\57"); foreach ($additionalData as $key => $value) { $popupData->assign($key, $value); bErrI: } i3NVS: goto tOHYM; tOHYM: } private function handleSpecialTemplateRequirements($popup, $popupData) : void { if (!($popup->template === "\x73\x61\x6c\x65\163\x5f\143\x6f\165\156\164\x64\157\167\156\137\x70\x6f\160\165\160")) { goto AzCXp; } $imagePath = $popup->styleBackgroundImage; if (empty($imagePath)) { goto u8OXk; } $mediaStrpos = strpos($imagePath, "\57\x6d\145\144\151\141\146\x69\x6c\x65\163"); if (!($mediaStrpos > 0)) { goto qGQwF; } $imagePath = substr($imagePath, $mediaStrpos); qGQwF: $imageSize = Image::imageSize($imagePath); $imageRatio = "{$imageSize->width}\x20\57\x20{$imageSize->height}"; $popupData->assign("\151\155\x61\147\145\101\x73\160\145\x63\164\x52\141\x74\151\x6f", $imageRatio); u8OXk: AzCXp: } private function registerImageSizeFunction() : void { if (isset($this->smarty->registered_plugins["\x66\165\x6e\143\164\x69\157\x6e"]["\151\x6d\141\x67\x65\123\x69\172\x65"])) { goto oqKP_; } $this->smarty->registerPlugin("\146\165\156\x63\x74\151\157\156", "\151\155\141\147\x65\123\x69\x7a\145", function ($imagePath) { list($width, $height) = getimagesize(PFAD_ROOT . "\x2f" . $imagePath); $size = new \stdClass(); $size->width = $width; $size->height = $height; return $size; }); oqKP_: } private function renderPopup($popup, $popupData) : void { $templatePath = "\x66\x69\154\145\x3a\133\x61\144\155\120\x72\x6f\x5d\155\x61\162\x6b\x65\164\151\x6e\147\137\160\157\x70\x75\160\57" . $popup->template . "\56\164\x70\x6c"; $template = $this->smarty->createTemplate($templatePath, $popupData); pq("\x62\157\144\x79")->append($template->fetch()); } private function loadPopupAssets($popup) : void { $assetLoader = AssetLoader::getInstance(); $assetLoader->addToHead([$this->frontendUrl . "\143\163\x73\x2f\x70\x6f\x70\x75\x70\56\x63\163\163", $this->frontendUrl . "\152\163\x2f\x70\157\x70\x75\x70\124\x72\151\x67\147\145\x72\56\152\163"], "\160\157\x70\165\160\155\x61\x6e\x61\147\145\x72", "\x64\145\146\x65\x72"); if (!($popup->template === "\163\141\154\145\x73\137\143\x6f\x75\156\164\x64\x6f\167\156\137\160\157\160\x75\160")) { goto d5iFx; } $assetLoader->loadShared("\x66\x6c\151\160\x43\x6c\157\143\x6b"); d5iFx: } }