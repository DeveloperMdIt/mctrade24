<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro; use JTL\DB\ReturnType; use JTL\Plugin\PluginInterface; use JTL\Shop; use JTL\Smarty\JTLSmarty; use DateTime; use Plugin\admorris_pro\Facades\Cache; use Plugin\admorris_pro\Models\SaleCountdownModel; use Plugin\admorris_pro\Models\SaleCountdownTextModel; class SaleCountdown { public const CACHE_ID = "\x61\144\155\157\162\162\x69\163\137\x70\x72\x6f\x5f\x73\x61\154\x65\x5f\x63\x6f\x75\156\164\x64\x6f\167\x6e"; public function __construct(private readonly PluginInterface $plugin, private readonly JTLSmarty $smarty, private readonly AssetLoader $assetLoader) { } public function render() : void { if (!in_array(Shop::getPageType(), [PAGE_BESTELLVORGANG, PAGE_BESTELLABSCHLUSS])) { goto mKfua; } return; mKfua: $activeSale = $this->getActiveSale(); if ($activeSale) { goto w8hId; } return; w8hId: $this->assetLoader->loadShared("\143\x6f\165\x6e\164\144\x6f\167\156"); $sale = $this->prepareSaleData($activeSale); $renderedTemplate = $this->renderTemplate($sale); $this->addStyles($sale); $this->positionTemplate($sale->pos, $renderedTemplate); } private function getActiveSale() : ?SaleCountdownModel { $allSaleCountdowns = $this->loadAllSaleCountdowns(); if (!empty($allSaleCountdowns)) { goto lxph1; } return null; lxph1: $activeSales = $allSaleCountdowns->filter(function ($sale) { return $sale->isCurrentlyActive(); }); return $activeSales->first(); } private function loadAllSaleCountdowns() { return Cache::remember(self::CACHE_ID, function () { return SaleCountdownModel::active()->with("\x74\145\x78\164\163")->orderBy("\163\164\141\x72\x74\104\141\x74\x65")->get(); }, SaleCountdownModel::CACHE_TAGS); } private function prepareSaleData(SaleCountdownModel $sale) : SaleCountdownModel { $lang = $_SESSION["\143\x49\123\117\x53\160\162\141\143\150\x65"]; $bannerText = $this->getBannerTextFromEagerLoaded($sale, $lang); if (!$bannerText) { goto AoB_d; } $sale->bannerText = $bannerText; AoB_d: return $sale; } private function getBannerTextFromEagerLoaded(SaleCountdownModel $sale, string $languageId) : ?string { $textModel = $sale->texts->where("\x6c\141\156\x67\x75\x61\147\145\111\144", $languageId)->first(); return $textModel?->bannerText; } private function getBannerText(int $saleCountdownId, string $languageId) : ?string { $cacheKey = self::CACHE_ID . "\137\x62\x61\156\x6e\145\x72\137\x74\x65\x78\x74\137" . $saleCountdownId . "\137" . $languageId; return Cache::remember($cacheKey, function () use($saleCountdownId, $languageId) { $textModel = SaleCountdownTextModel::forSaleCountdown($saleCountdownId)->forLanguage($languageId)->first(); return $textModel?->bannerText; }, SaleCountdownTextModel::CACHE_TAGS); } private function renderTemplate(SaleCountdownModel $sale) : string { $langVars = $this->plugin->getLocalization()->getTranslations(); $saleCountdownData = $this->smarty->createData($this->smarty); $saleCountdownData->assign("\x73\141\154\x65", $sale)->assign("\144\151\163\x63\157\x75\x6e\164\137\160\145\x72\143\145\156\164", $langVars["\x61\144\155\157\x72\162\151\x73\x5f\x70\x72\x6f\x5f\144\151\163\143\x6f\x75\x6e\x74\x5f\160\x65\162\x63\x65\x6e\164"])->assign("\163\164\141\162\x74\x5f\x63\x6f\x75\x6e\164\x64\x6f\x77\x6e", $langVars["\x61\x64\155\x6f\162\x72\x69\x73\137\x70\162\x6f\x5f\163\164\141\162\x74\x5f\x63\157\165\x6e\164\144\157\x77\156"])->assign("\145\156\144\137\143\157\x75\156\x74\144\157\x77\156", $langVars["\141\144\155\x6f\x72\162\x69\x73\x5f\x70\x72\x6f\137\145\x6e\x64\x5f\x63\x6f\x75\x6e\164\144\x6f\x77\x6e"])->assign("\143\157\165\156\164\144\157\x77\156\x5f\144\x61\x79\163", $sale->isSaleOn() ? $langVars["\141\144\155\157\x72\x72\x69\163\x5f\160\x72\157\137\x63\157\x75\156\164\x64\157\167\x6e\137\x64\141\171\x73\x5f\145\156\144"] : $langVars["\141\x64\155\157\162\x72\151\x73\x5f\160\162\157\137\143\157\165\156\164\144\157\167\x6e\x5f\144\x61\x79\x73"]); $template = $this->plugin->getPaths()->getFrontendPath() . "\164\145\155\160\154\x61\164\x65\163\x2f\x73\x61\154\x65\137\x63\157\x75\x6e\x74\144\x6f\167\x6e\56\x74\x70\154"; return $this->smarty->createTemplate($template, $saleCountdownData)->fetch(); } private function addStyles(SaleCountdownModel $sale) : void { $frontendPath = $this->plugin->getPaths()->getFrontendPath(); $cssContent = file_get_contents($frontendPath . "\x63\x73\x73\57\x73\141\154\x65\55\x63\157\x75\156\x74\x64\x6f\x77\x6e\x2e\x63\x73\x73"); $styles = "\74\x73\164\171\x6c\x65\76" . $cssContent . "\74\x2f\x73\x74\x79\154\x65\x3e"; $this->assetLoader->addEmbeddedStyles($styles); $styleVarsPath = $frontendPath . "\164\x65\x6d\160\x6c\x61\164\x65\163\x2f\163\x61\x6c\145\137\143\x6f\x75\x6e\164\144\x6f\x77\x6e\137\163\164\x79\x6c\x65\137\166\141\162\163\56\x74\160\154"; $saleCountdownData = $this->smarty->createData($this->smarty); $saleCountdownData->assign("\163\x61\154\x65", $sale); $styleVars = $this->smarty->createTemplate($styleVarsPath, $saleCountdownData)->fetch(); $this->assetLoader->addEmbeddedStyles($styleVars); } private function positionTemplate(string $position, string $renderedTemplate) : void { switch ($position) { case "\x61\x62\x6f\166\145\x2d\150\145\141\144\145\162": cssSelector("\x73\x61\154\145\137\143\157\x75\156\x74\144\157\x77\156\137\x70\x72\x65\x70\x65\x6e\x64", $renderedTemplate); goto UShs0; case "\x62\145\154\157\x77\55\150\x65\141\144\145\162": cssSelector("\163\x61\x6c\145\x5f\143\x6f\165\x6e\x74\x64\x6f\x77\156\137\141\x70\x70\x65\x6e\144", $renderedTemplate); goto UShs0; } IL51z: UShs0: } }