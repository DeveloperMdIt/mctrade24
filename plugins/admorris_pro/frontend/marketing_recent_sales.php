<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro; use JTL\Shop; use stdClass; $Artikel = $smarty->getTemplateVars("\101\x72\x74\x69\153\x65\154"); $jtl_token = $_SESSION["\152\164\154\137\164\157\153\145\156"]; $mode = $oPlugin->getConfig()->getValue("\x61\144\155\157\162\162\x69\x73\137\160\x72\157\x5f\x6d\141\162\153\x65\x74\151\156\147\137\162\145\143\145\156\164\137\x73\x61\x6c\145\x73\137\155\x6f\144\165\x73"); $min_sold = $oPlugin->getConfig()->getValue("\x61\x64\x6d\157\x72\162\x69\x73\x5f\x70\x72\x6f\x5f\155\x61\x72\x6b\x65\164\x69\156\147\137\x72\145\x63\145\x6e\164\x5f\x73\x61\x6c\x65\163\x5f\155\x69\x6e\x5f\x73\157\x6c\x64"); $period = $oPlugin->getConfig()->getValue("\x61\x64\x6d\x6f\162\x72\151\x73\x5f\160\162\x6f\137\155\141\162\153\x65\164\x69\156\147\137\162\x65\143\145\x6e\x74\137\x73\141\154\x65\x73\x5f\x70\145\162\x69\157\x64"); $visit_delay = $oPlugin->getConfig()->getValue("\x61\x64\155\157\162\162\x69\163\137\160\162\157\x5f\x6d\x61\162\x6b\145\x74\x69\x6e\147\137\162\x65\x63\x65\156\x74\x5f\163\141\x6c\145\x73\x5f\166\151\163\151\x74\x5f\x64\x65\x6c\141\171"); $visit_multiplier = $oPlugin->getConfig()->getValue("\x61\x64\x6d\157\162\162\151\163\137\x70\x72\x6f\x5f\x6d\x61\162\x6b\145\164\x69\156\x67\x5f\x72\145\143\145\156\x74\137\163\x61\x6c\145\x73\x5f\166\151\x73\x69\164\x5f\x6d\165\x6c\164\x69\x70\x6c\151\x65\x72"); $period_begin_sales = new TimeOffset("\x2d\40{$period}\40\150\x6f\165\162", "\131\55\x6d\x2d\144\40\110\72\151\x3a\x73"); $period_end = new TimeOffset("\55\40{$visit_delay}\x20\x6d\151\156", "\x59\55\x6d\55\x64\x20\110\x3a\x69\x3a\x73"); $salesVars = $mode == 1 || $mode == 2 ? "\x20\163\141\154\145\163\x2e\143\x6f\165\x6e\x74\x20\x41\123\40\x73\141\154\145\163\103\157\165\156\164\x2c\x20\163\141\x6c\145\163\x2e\x6f\154\144\x65\x73\164\40\101\123\40\163\141\x6c\x65\x73\x4f\x6c\x64\x65\163\x74\x2c\40" : ''; $visitVars = $mode == 2 || $mode == 3 ? "\40\166\x69\x73\x69\164\x73\x2e\x63\x6f\165\156\164\40\x41\123\40\x76\x69\x73\151\164\163\x43\157\165\156\164\x2c\x20\166\151\x73\151\164\x73\x2e\x6f\154\x64\145\x73\x74\x20\x41\123\40\166\151\x73\x69\x74\x73\x4f\x6c\144\x65\163\164\x2c\x20" : ''; $ownVisitVars = "\x20\x6f\x77\x6e\x56\151\x73\x69\x74\56\143\x6f\165\x6e\x74\x20\101\123\40\157\x77\x6e\x56\x69\163\151\x74\103\x6f\x75\x6e\x74\x2c\40\157\x77\156\x56\151\x73\151\x74\56\x61\x63\x74\x69\157\x6e\x44\141\x74\145\x20\101\123\40\157\167\x6e\126\151\163\151\164\x44\141\x74\x65"; $salesQuery = $mode == 1 || $mode == 2 ? "\12\114\105\106\x54\40\x4a\117\111\116\40\50\12\x20\x20\x20\x20\x53\105\114\x45\x43\124\x20\40\x20\40\40\x20\x6b\101\x72\164\x69\153\145\x6c\x20\x41\123\40\153\x41\x72\164\x69\153\x65\154\54\xa\x20\x20\x20\x20\40\40\x20\40\40\x20\40\x20\x20\x20\40\40\x20\x20\x20\x20\x53\x55\x4d\50\161\165\141\156\164\x69\x74\171\x29\x20\x61\163\40\143\157\x75\156\164\x2c\40\x4d\111\116\x28\x61\143\x74\x69\157\156\104\x61\x74\145\51\x20\x61\x73\x20\x6f\x6c\x64\x65\x73\x74\12\x20\40\40\x20\12\x20\40\40\x20\x46\122\x4f\x4d\40\x20\40\40\40\x20\x20\40\170\x70\x6c\165\147\151\x6e\x5f\141\144\x6d\157\x72\162\x69\163\137\x70\x72\x6f\x5f\x72\x65\143\x65\x6e\x74\137\x73\x61\154\x65\163\xa\40\x20\40\x20\127\110\x45\122\105\x20\x20\x20\x20\40\40\40\153\101\x72\164\x69\x6b\x65\x6c\40\75\x20\47{$Artikel->kArtikel}\x27\40\101\116\x44\40\164\x79\x70\x20\75\40\x27\x6c\x69\166\145\47\x20\101\x4e\104\40\x61\143\164\x69\157\x6e\104\x61\164\145\x20\76\40\47{$period_begin_sales}\47\xa\40\40\40\x20\x47\122\x4f\x55\120\x20\x42\x59\40\40\40\40\170\160\154\x75\147\151\x6e\x5f\x61\x64\x6d\157\x72\162\x69\x73\x5f\x70\x72\x6f\137\162\x65\143\145\x6e\164\x5f\x73\141\x6c\x65\x73\56\153\101\x72\164\x69\x6b\x65\x6c\12\x20\40\40\x20\xa\x20\x20\40\x20\51\x20\101\x53\x20\163\141\154\145\163\40\12\40\40\40\40\117\116\x20\x73\141\154\145\163\56\153\101\x72\x74\151\x6b\145\x6c\40\75\40\170\160\x6c\x75\x67\x69\x6e\137\x61\144\x6d\x6f\162\162\x69\163\x5f\x70\162\157\x5f\162\x65\x63\x65\x6e\x74\x5f\x73\x61\154\x65\x73\56\x6b\101\x72\164\x69\x6b\x65\x6c" : ''; $visitsQuery = $mode == 2 || $mode == 3 ? "\xa\12\x4c\105\x46\x54\x20\x4a\x4f\111\116\40\50\xa\40\40\40\x20\x53\105\114\105\x43\124\40\40\x20\x20\40\40\x6b\x41\162\164\x69\x6b\145\x6c\x20\101\x53\x20\153\x41\x72\x74\151\153\145\x6c\54\xa\x20\40\x20\x20\40\x20\x20\40\40\40\x20\40\40\x20\x20\x20\x20\x20\40\40\123\x55\x4d\x28\161\165\141\x6e\x74\151\164\x79\x29\x20\x61\x73\x20\x63\157\165\156\x74\54\x20\x4d\x49\x4e\50\141\x63\x74\x69\157\x6e\104\141\164\x65\51\x20\x61\163\40\x6f\154\144\x65\x73\164\xa\40\40\x20\x20\12\x20\40\40\x20\106\122\x4f\115\x20\x20\40\x20\40\40\40\x20\x78\x70\x6c\x75\x67\151\156\x5f\141\x64\155\x6f\x72\x72\x69\163\137\160\162\157\x5f\162\x65\143\x65\x6e\x74\x5f\x73\x61\154\x65\163\12\40\40\x20\x20\127\x48\x45\122\105\x20\x20\40\40\x20\40\40\153\x41\x72\x74\x69\x6b\145\x6c\x20\75\x20\x27{$Artikel->kArtikel}\x27\40\x41\116\x44\40\164\171\x70\x20\x3d\x20\47\166\151\163\x69\164\x27\40\101\x4e\x44\x20\x61\143\164\x69\157\156\x44\x61\164\145\x20\76\40\47{$period_begin_sales}\47\40\101\116\x44\40\x61\143\164\151\x6f\x6e\104\x61\164\145\x20\74\x20\x27{$period_end}\47\xa\x20\x20\40\40\x47\x52\117\x55\x50\40\x42\131\40\40\40\x20\40\x78\160\x6c\x75\x67\151\x6e\137\141\144\x6d\x6f\162\162\151\x73\137\160\162\157\137\162\x65\143\x65\x6e\164\137\163\x61\x6c\145\163\x2e\x6b\101\x72\x74\x69\x6b\145\154\xa\40\40\x20\40\xa\40\x20\40\x20\51\x20\x41\x53\40\x76\151\163\151\164\x73\40\12\x20\x20\40\x20\117\x4e\40\x76\151\x73\151\x74\x73\56\153\101\x72\164\151\153\x65\x6c\40\x3d\40\x78\x70\x6c\x75\x67\x69\156\137\141\144\155\157\162\162\x69\x73\x5f\160\x72\x6f\x5f\x72\145\143\x65\156\x74\x5f\x73\141\154\145\163\56\153\101\162\x74\x69\x6b\145\x6c" : ''; $ownVisitQuery = "\xa\40\40\x20\40\x4c\105\x46\124\40\112\117\x49\x4e\x20\50\12\x20\x20\x20\x20\40\x20\x20\x20\x53\x45\x4c\105\x43\124\x20\x20\x20\x20\x20\40\x6b\x41\162\x74\151\153\x65\154\40\101\123\40\x6b\101\x72\164\151\x6b\145\154\54\12\x20\40\40\40\40\x20\40\x20\x20\40\x20\x20\40\x20\x20\x20\x20\40\x20\x20\x20\40\40\40\123\125\115\x28\x71\x75\141\156\x74\151\164\x79\51\x20\101\123\40\x63\157\165\x6e\x74\x2c\x20\141\x63\x74\x69\157\156\104\141\x74\145\x20\101\123\40\x61\x63\164\151\x6f\x6e\104\141\164\145\xa\x20\40\40\40\40\40\40\x20\12\40\x20\40\40\x20\x20\40\40\106\x52\x4f\115\x20\40\x20\40\x20\x20\x20\x20\170\x70\x6c\x75\147\x69\156\x5f\x61\144\x6d\x6f\162\x72\151\163\x5f\x70\x72\x6f\137\162\145\143\x65\156\x74\137\163\x61\x6c\x65\163\xa\x20\40\x20\40\x20\40\40\x20\127\110\x45\x52\x45\40\x20\x20\x20\40\x20\40\163\145\163\163\151\x6f\x6e\x49\x44\x20\x3d\x20\x27{$jtl_token}\47\x20\101\116\104\40\x6b\101\x72\x74\151\153\x65\x6c\x20\75\x20\47{$Artikel->kArtikel}\47\x20\x41\116\104\40\164\x79\160\x20\75\40\x27\166\151\x73\151\164\47\xa\40\40\40\x20\40\x20\40\40\x47\122\117\125\120\x20\x42\131\x20\40\x20\x20\x20\x78\160\154\x75\x67\x69\x6e\x5f\x61\144\x6d\157\162\162\x69\163\137\160\x72\157\x5f\162\145\x63\x65\x6e\164\x5f\x73\141\x6c\145\x73\56\153\x41\x72\164\151\153\145\154\12\x20\x20\40\40\40\x20\x20\40\12\40\x20\x20\40\x20\40\x20\40\x29\x20\101\x53\x20\157\167\156\126\x69\x73\151\x74\40\12\x20\40\x20\x20\x20\40\x20\40\117\x4e\x20\157\x77\156\x56\151\163\151\164\56\x6b\101\162\x74\151\x6b\x65\x6c\40\x3d\x20\170\160\154\165\147\151\156\x5f\x61\144\155\x6f\162\x72\151\x73\x5f\x70\162\157\137\162\145\x63\145\156\x74\137\163\141\154\145\x73\x2e\153\x41\x72\x74\151\153\x65\154"; $query = "\123\x45\114\x45\x43\124\40\40\170\160\154\x75\x67\151\156\137\141\x64\x6d\x6f\162\x72\151\163\x5f\x70\x72\x6f\137\x72\x65\143\x65\156\164\137\x73\x61\154\x65\x73\56\153\x41\x72\164\x69\x6b\145\x6c\40\x41\123\x20\x6b\101\x72\164\x69\x6b\145\x6c\54\12\40\x20\40\x20{$salesVars}\x20{$visitVars}\40{$ownVisitVars}\12\x20\x20\40\x20\106\x52\x4f\x4d\x20\x20\x20\x20\40\40\x20\40\x78\x70\x6c\x75\x67\x69\x6e\x5f\x61\144\155\157\x72\x72\x69\x73\137\160\162\157\137\x72\x65\143\145\156\164\137\x73\x61\x6c\x65\x73\xa\40\x20\40\40\xa\40\40\x20\x20{$salesQuery}\xa\x20\x20\x20\x20{$visitsQuery}\12\40\40\40\40{$ownVisitQuery}\xa\x20\40\x20\x20\127\x48\105\122\105\x20\x78\160\154\165\147\x69\156\x5f\x61\144\155\x6f\162\162\151\x73\x5f\x70\x72\157\137\x72\x65\143\x65\x6e\x74\137\163\141\x6c\145\x73\x2e\x6b\x41\x72\164\151\153\x65\154\x20\75\40\x27{$Artikel->kArtikel}\47\xa\x20\40\40\40\x47\122\x4f\x55\x50\40\x42\131\x20\x20\x20\x20\170\160\x6c\165\x67\x69\x6e\137\x61\x64\155\x6f\162\162\151\163\137\x70\162\x6f\x5f\162\145\x63\x65\x6e\x74\x5f\163\x61\154\x65\x73\56\153\x41\162\x74\x69\153\145\154"; $result = Shop::Container()->getDB()->query($query, 2); $ownVisit = (object) ["\143\157\165\156\x74" => $result[0]->ownVisitCount ?? 0, "\141\x63\x74\151\157\156\x44\x61\x74\145" => $result[0]->ownVisitDate ?? null]; if (!($mode == 1 || $mode == 2)) { goto RTgkj; } $real_sales = $result[0]->salesCount ?? 0; $real_sales_oldest = $result[0]->salesOldest ?? null; RTgkj: if (!($mode == 2 || $mode == 3)) { goto RIxQR; } $visit_sales = $result[0]->visitsCount ?? 0; $visit_sales_oldest = $result[0]->visitsOldest ?? null; $visit_sales = $visit_sales * $visit_multiplier; RIxQR: switch ($mode) { case 1: $total = $real_sales; $oldest_date = $real_sales_oldest; goto sgPm7; case 2: $total = $real_sales + $visit_sales; $total = floor($total); if (!empty($real_sales_oldest) && !empty($visit_sales_oldest)) { goto BZwhp; } if (!empty($real_sales_oldest)) { goto fhkIw; } if (!empty($visit_sales_oldest)) { goto BvlBi; } goto mhIRw; BZwhp: $two_oldest = [$real_sales_oldest, $visit_sales_oldest]; $oldest_date = min($two_oldest); goto mhIRw; fhkIw: $oldest_date = $real_sales_oldest; goto mhIRw; BvlBi: $oldest_date = $visit_sales_oldest; mhIRw: goto sgPm7; case 3: $total = $visit_sales; $total = floor($total); $oldest_date = $visit_sales_oldest; goto sgPm7; } y86p0: sgPm7: if (!($total != 0 && $total >= (float) $min_sold)) { goto kRYPR; } $date1 = new \DateTime(); $date2 = new \DateTime($oldest_date); $diff = $date2->diff($date1); $days = $diff->days; $hours = $diff->h; $minutes = $diff->i; if ($days >= 1) { goto T0pI5; } if ($hours >= 1) { goto W0xPS; } $text = "\40" . $oPlugin->getLocalization()->getTranslation("\x61\x64\x6d\x6f\162\162\x69\163\137\x70\x72\157\x5f\155\x61\162\x6b\x65\164\x69\x6e\x67\137\x72\x65\143\145\156\x74\137\x73\141\154\x65\163\137\163\x6f\x6c\x64\x5f\157\156\x65\x5f\x68\157\x75\x72"); goto D6nx9; T0pI5: $days = $days + 1; $text = "\40" . $oPlugin->getLocalization()->getTranslation("\x61\x64\x6d\157\x72\162\x69\x73\x5f\x70\162\157\137\x6d\x61\x72\153\145\x74\x69\x6e\147\x5f\x72\145\143\145\x6e\164\137\x73\x61\x6c\x65\x73\x5f\x73\x6f\x6c\x64") . "\40" . $days . "\40" . $oPlugin->getLocalization()->getTranslation("\x61\x64\x6d\157\x72\162\151\x73\137\x70\x72\x6f\x5f\x6d\x61\x72\x6b\145\x74\151\x6e\x67\x5f\x72\x65\143\145\x6e\x74\x5f\x73\x61\x6c\145\163\x5f\x64\141\171\x73"); goto D6nx9; W0xPS: $hours = $hours + 1; $text = "\40" . $oPlugin->getLocalization()->getTranslation("\x61\x64\155\x6f\x72\x72\x69\x73\x5f\160\162\157\x5f\155\x61\x72\153\x65\164\x69\x6e\x67\x5f\x72\145\143\x65\156\x74\x5f\x73\141\154\145\x73\137\163\157\x6c\x64") . "\40" . $hours . "\x20" . $oPlugin->getLocalization()->getTranslation("\x61\x64\155\157\162\162\x69\x73\137\x70\x72\157\x5f\155\141\162\153\145\164\x69\x6e\x67\x5f\x72\145\143\x65\x6e\x74\x5f\163\141\154\145\163\137\x68\157\x75\x72\x73"); D6nx9: Shop::Smarty()->assign("\x61\144\155\x6f\x72\162\x69\x73\x5f\160\162\x6f\137\155\x61\162\x6b\145\164\x69\156\x67\x5f\162\x65\x63\x65\156\164\x5f\x73\x61\154\145\163\137\x74\x6f\x74\x61\x6c", $total); Shop::Smarty()->assign("\x61\x64\155\157\x72\x72\151\163\137\160\162\157\x5f\x6d\x61\162\x6b\145\164\151\156\x67\x5f\x72\145\x63\145\156\164\137\163\141\154\x65\163\x5f\164\x65\170\x74", $text); Shop::Smarty()->assign("\x61\144\155\x6f\162\162\x69\x73\x5f\160\x72\157\x5f\155\x61\162\x6b\x65\164\x69\x6e\147\137\x72\145\x63\145\x6e\x74\137\163\141\x6c\145\x73\137\151\143\157\156", $oPlugin->getConfig()->getValue("\x61\144\155\x6f\162\x72\x69\x73\x5f\x70\162\157\x5f\155\141\162\x6b\x65\x74\x69\x6e\x67\x5f\x72\x65\x63\145\x6e\x74\137\163\x61\x6c\x65\163\x5f\151\x63\x6f\156")); Shop::Smarty()->assign("\141\x64\155\157\x72\162\151\x73\x5f\160\162\157\137\x6d\x61\162\153\145\x74\x69\156\147\x5f\162\145\x63\x65\156\164\137\x73\x61\154\145\163\x5f\141\156\151\x6d\x61\x74\151\157\x6e", $oPlugin->getConfig()->getValue("\141\x64\x6d\x6f\162\x72\151\163\x5f\160\162\x6f\x5f\155\141\162\x6b\145\x74\151\x6e\147\137\x72\x65\x63\x65\x6e\164\x5f\x73\141\154\x65\163\x5f\x61\156\151\x6d\141\x74\x69\x6f\x6e")); $template = $oPlugin->getPaths()->getFrontendPath() . "\x74\x65\x6d\160\154\x61\x74\x65\x73\57\155\141\162\x6b\x65\164\x69\156\x67\137\162\x65\x63\145\x6e\164\x5f\163\141\154\x65\163\x2e\x74\160\x6c"; $template = $smarty->fetch($template); cssSelector("\x72\145\x63\x65\156\164\137\x73\x61\154\x65\x73", $template); kRYPR: RecentSalesHelper::insertVisit($Artikel, $ownVisit);