<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro\frontend\controller; use JTL\Cache\JTLCacheInterface; use JTL\phpQuery\phpQuery; use JTL\Plugin\PluginInterface; use Plugin\admorris_pro\AssetLoader; use Plugin\admorris_pro\TriggerFilter; use Plugin\admorris_pro\ioHandling\cookieNoticePro\{CookieNoticeProCookies, CookieNoticeProSettings, CookieNoticeProScripts, CookieNoticeProTriggerFilters}; use Plugin\admorris_pro\Models\CookieNoticeProCookiesModel; use Plugin\admorris_pro\TemplateSettingsDTO; use JTL\Shop; class CookieNoticeProController { private array $settings; private $cookies; private array $consentStyles; private bool $consentmanagerActive; private $triggerFilter; public function __construct(private PluginInterface $plugin, private TemplateSettingsDTO $templateSettings, private ?JTLCacheInterface $cache = null) { if ($this->cache) { goto gRBFx; } $this->cache = Shop::Container()->getCache(); gRBFx: } public function execute() { $this->loadSettings(); $this->consentmanagerActive = Shop::getSettingValue(CONF_CONSENTMANAGER, "\143\157\156\163\145\x6e\x74\x5f\155\141\x6e\141\x67\x65\x72\137\x61\143\164\151\166\145") === "\x59"; if (!$this->consentmanagerActive) { goto u4QRX; } $this->consentStyles = $this->createConsentStyles(); $this->displayTemplate(); u4QRX: $this->loadCookies(); $this->handleCookieScripts(); } private function loadSettings() : void { $settingsCacheKey = CookieNoticeProSettings::CACHE_ID; $settings = $this->cache->get($settingsCacheKey); if (!($settings === false)) { goto p_lJ_; } $settings = CookieNoticeProSettings::getAll(); $this->cache->set($settingsCacheKey, $settings, [\CACHING_GROUP_PLUGIN, $this->plugin->getCache()->getGroup()]); p_lJ_: $this->settings = $settings; } private function loadCookies() : void { $cookiesCacheKey = CookieNoticeProCookiesModel::CACHE_ID; $this->cookies = $this->cache->get($cookiesCacheKey); if (!($this->cookies === false)) { goto gsLw5; } $this->cookies = CookieNoticeProCookiesModel::where("\141\143\x74\151\x76\x65", 1)->with(["\x73\143\162\x69\x70\164\x73\x2e\164\x72\x69\147\147\x65\162\106\x69\154\164\145\162\x73"])->get(); $this->cache->set($cookiesCacheKey, $this->cookies, CookieNoticeProCookiesModel::CACHE_TAGS); gsLw5: } private function createConsentStyles() : array { goto oPZSP; oPZSP: $consentStyles = array_column($this->settings, "\x73\x65\164\x74\151\156\147\126\x61\154\165\x65", "\x73\x65\164\164\x69\156\147\116\x61\155\x65"); $theme = $this->templateSettings->themeVars; if (!$consentStyles["\x75\163\145\x54\x68\145\155\145"]) { goto vllok; } $themeMapping = ["\x62\165\x74\164\157\156\103\157\154\157\162" => "\142\x74\x6e\120\x72\x69\x6d\141\162\171\x42\147", "\142\165\164\164\157\x6e\x54\x65\170\164\103\157\154\x6f\162" => "\x62\164\156\x50\x72\x69\155\141\162\171\103\x6f\154\157\x72", "\x6c\151\x6e\x6b\x43\157\x6c\x6f\x72" => "\154\x69\x6e\x6b\103\x6f\154\x6f\162", "\150\145\x61\x64\x6c\x69\156\x65\x73\x43\x6f\154\x6f\162" => "\150\x65\141\x64\x69\156\x67\x73\x43\x6f\x6c\157\162", "\x74\145\170\x74\x43\x6f\154\x6f\x72" => "\164\145\170\x74\103\157\154\157\x72", "\x62\141\143\153\147\x72\157\165\x6e\144\x43\x6f\154\x6f\x72" => "\x62\157\x64\171\x42\x67"]; foreach ($themeMapping as $consentKey => $themeKey) { $consentStyles[$consentKey] = $theme[$themeKey] ?? ''; XeJUv: } olZD1: vllok: $bannerPosition = $consentStyles["\x70\x6f\x73\151\x74\151\157\x6e"]; $modalPosition = $consentStyles["\160\x6f\163\x69\164\151\x6f\x6e\x4d\157\x64\x61\x6c"]; $consentStyles["\142\141\x6e\x6e\x65\162\115\x61\x72\147\x69\156"] = "\141\165\x74\x6f"; goto mClMg; mClMg: $consentStyles["\x62\x61\x6e\156\145\x72\x54\x6f\160"] = "\60"; $consentStyles["\x62\141\156\x6e\145\162\x42\157\x74\164\x6f\x6d"] = "\x61\165\164\x6f"; $consentStyles["\x62\x61\156\156\x65\x72\115\x61\170\x57\151\x64\164\150"] = "\x37\x35\162\x65\x6d"; if (!str_contains($modalPosition, "\162\x69\147\x68\x74")) { goto hjIQZ; } $consentStyles["\x6d\x6f\144\141\154\115\x61\x72\147\x69\x6e"] = "\x32\x72\145\x6d\40\x30\40\x30\40\141\165\164\x6f"; hjIQZ: if (!str_contains($modalPosition, "\x6c\x65\x66\x74")) { goto rIAX4; } $consentStyles["\155\157\x64\x61\x6c\x4d\x61\x72\x67\151\x6e"] = "\62\162\x65\x6d\40\141\165\164\157\x20\60\40\60"; rIAX4: if (!str_contains($modalPosition, "\x63\145\156\x74\x65\162")) { goto rlHCz; } goto fJUL6; fJUL6: $consentStyles["\x6d\x6f\144\x61\154\x4d\141\162\x67\151\156"] = "\x32\x72\145\x6d\x20\141\x75\x74\x6f\x20\x30"; rlHCz: if (!str_contains($bannerPosition, "\162\151\147\x68\164")) { goto GAN0K; } $consentStyles["\x62\141\x6e\156\145\x72\x4d\141\x72\x67\x69\156"] = "\60\x20\62\x72\x65\x6d\40\60\x20\x61\165\164\x6f"; GAN0K: if (!str_contains($bannerPosition, "\154\145\x66\x74")) { goto TGfcu; } $consentStyles["\142\141\x6e\156\x65\x72\x4d\141\x72\x67\x69\x6e"] = "\60\40\x61\165\x74\x6f\x20\60\40\62\x72\145\155"; TGfcu: if (!str_contains($bannerPosition, "\x74\x6f\160")) { goto KWjrx; } $consentStyles["\x62\x61\156\156\145\162\124\x6f\x70"] = "\62\162\x65\x6d"; goto djuOP; K8ynU: if (!($bannerPosition === "\x63\145\156\164\x65\x72")) { goto DdDns; } pq("\43\x63\x6f\x6e\x73\145\156\x74\55\155\141\x6e\x61\x67\x65\162")->addClass("\143\x6f\x6e\163\145\156\164\55\x62\141\x6e\x6e\145\162\x2d\x2d\x63\x65\x6e\164\145\x72"); pq("\x23\143\157\156\x73\x65\x6e\x74\55\x73\145\x74\x74\151\156\147\x73")->appendTo("\x2e\x63\157\x6e\x73\x65\x6e\164\55\x6d\141\156\141\147\145\162\x2d\x77\x72\141\160\x70\145\x72"); DdDns: pq("\x2e\x63\157\x6e\x73\145\156\164\x2d\155\141\x6e\141\147\145\x72\x2d\x77\162\x61\160\160\145\162")->addClass("\143\157\x6e\163\x65\x6e\164\x2d\155\141\x6e\141\147\x65\162\x2d\x77\x72\x61\160\x70\x65\x72\55\55\x63\x75\x73\x74\x6f\x6d\x2d\163\164\171\154\x65\163"); return $consentStyles; goto MLKle; djuOP: $consentStyles["\142\x61\156\156\145\162\102\157\x74\x74\157\x6d"] = "\x61\x75\164\x6f"; KWjrx: if (!str_contains($bannerPosition, "\x62\x6f\164\x74\157\x6d")) { goto weiLm; } $consentStyles["\142\x61\156\x6e\x65\162\x54\157\160"] = "\x61\165\164\157"; $consentStyles["\x62\141\x6e\x6e\145\162\x42\x6f\164\x74\x6f\155"] = "\62\x72\145\155"; weiLm: if (!str_contains($bannerPosition, "\x66\x75\154\154")) { goto tF2iL; } $consentStyles["\x62\x61\x6e\x6e\145\162\x4d\141\x78\127\151\x64\164\150"] = "\x31\60\60\45"; $consentStyles["\142\141\x6e\x6e\x65\162\x4d\x61\162\147\x69\x6e"] = "\x30\x20\61\x72\x65\x6d"; tF2iL: goto K8ynU; MLKle: } private function displayTemplate() : void { $data = Shop::Smarty()->createData(); $data->assign("\x63\x6e\160", $this->consentStyles); $template = $this->plugin->getPaths()->getFrontendPath() . "\x74\x65\x6d\x70\x6c\x61\164\x65\x73\x2f\x6d\x61\x72\x6b\145\x74\151\x6e\147\137\143\x6f\x6f\x6b\151\145\x5f\x6e\x6f\x74\151\x63\x65\137\x70\162\157\56\x74\x70\154"; $styles = Shop::Smarty()->createTemplate($template, $data)->fetch(); $assetLoader = AssetLoader::getInstance(); $assetLoader->addEmbeddedStyles($styles); $assetLoader->addToHead($this->plugin->getPaths()->getFrontendURL() . "\143\163\163\x2f\143\x75\x73\x74\x6f\x6d\x2d\143\x6f\156\163\145\156\x74\55\155\x61\156\x61\147\x65\x72\56\x63\163\163", "\x63\x75\x73\164\x6f\x6d\137\x63\157\x6e\163\x65\x6e\x74\x5f\155\x61\156\141\x67\145\162"); } private function handleCookieScripts() : void { foreach ($this->cookies as $cookie) { foreach ($cookie->scripts as $script) { $triggerResult = TriggerFilter::check($script->triggerFilters, $script->triggerFilterOperator); if (!$triggerResult) { goto Tthx3; } $this->renderScript($script->script, $script->positionNode, $script->positionType, $cookie->hiddenName); Tthx3: W4tt2: } W2aNw: TPeMG: } w7zQl: } private function activateScript(string $cookieDataName) : bool { if (!(!$this->consentmanagerActive || Shop::Container()->getConsentManager()->hasConsent($cookieDataName) === true)) { goto U33mz; } return true; U33mz: return false; } private function renderScript($script, $positionNode, $positionType, $cookieDataName) : void { try { $script = Shop::Smarty()->fetch("\x65\x76\x61\x6c\x3a" . $script); $defaultDocument = phpQuery::$defaultDocumentID; $scriptPqDocument = phpQuery::newDocumentHTML($script); $scriptNodes = pq("\x73\143\x72\151\x70\x74", $scriptPqDocument)->attr("\144\x61\x74\x61\x2d\x6e\x61\x6d\145", $cookieDataName); if ($this->activateScript($cookieDataName)) { goto vQUmi; } foreach ($scriptNodes as $domNode) { $pqNode = pq($domNode); $type = $pqNode->attr("\x74\x79\x70\x65"); if (!empty($type)) { goto vGKea; } $type = "\x61\x70\160\154\x69\143\x61\164\151\157\156\57\152\141\x76\141\x73\143\162\x69\x70\x74"; vGKea: $pqNode->attr("\x74\171\x70\x65", "\x74\x65\170\x74\x2f\x70\x6c\x61\151\156")->attr("\x64\141\x74\141\x2d\164\171\x70\x65", $type); $src = $pqNode->attr("\x73\x72\x63"); if (empty($src)) { goto IE3m1; } $pqNode->removeAttr("\163\x72\x63")->attr("\x64\141\164\141\x2d\163\162\143", $src); IE3m1: C1mSp: } pEt_s: vQUmi: phpQuery::selectDocument($defaultDocument); $execute = ["\156\157\144\x65" => null]; switch ((int) $positionNode) { case 0: $execute["\x6e\157\x64\x65"] = "\150\145\x61\144"; goto fDaH1; case 1: $execute["\156\157\144\x65"] = "\142\157\144\171"; goto fDaH1; } IUutN: fDaH1: $element = \pq($execute["\156\x6f\144\x65"]); switch ((int) $positionType) { case 0: $element->prepend($scriptPqDocument); goto gOzuW; case 1: $element->append($scriptPqDocument); goto gOzuW; } Qbh7l: gOzuW: } catch (\Exception $e) { Shop::Container()->getLogService()->error($e); } } }