<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro\frontend\controller; use JTL\Shop; use JTL\Events\Dispatcher; use JTL\Cache\JTLCacheInterface; use JTL\Catalog\Product\Artikel; use JTL\Plugin\PluginInterface; use Plugin\admorris_pro\controller\AbstractHookController; use Plugin\admorris_pro\StatusRequest; use Plugin\admorris_pro\Models\ThreeSixtyImageSettings; use Plugin\admorris_pro\controller\ThreeSixtyImageController as ThreeSixtyImageBackendController; use function Plugin\admorris_pro\isTemplateActive; class ThreeSixtyImageController extends AbstractHookController { private $frontEndURL; private $frontEndPath; private $pluginURL; private $settings; private $folderArray; protected string $configKey = "\x61\x64\x6d\x6f\x72\x72\151\163\137\160\x72\x6f\x5f\155\x61\x72\153\x65\164\151\156\x67\137\x74\x68\162\145\x65\137\163\x69\170\x74\171\x5f\151\155\x61\x67\145\163\137\141\143\x74\151\166\145"; protected int $minModuleLevel = 1; public function __construct(PluginInterface $plugin, private JTLCacheInterface $cache, Dispatcher $dispatcher, StatusRequest $statusRequest) { parent::__construct($plugin, $dispatcher, $statusRequest); } protected function init() : void { if (!(($settings = $this->cache->get(ThreeSixtyImageSettings::CACHE_ID)) === false)) { goto UBY86; } $settings = ThreeSixtyImageSettings::all()->first(); $this->cache->set(ThreeSixtyImageSettings::CACHE_ID, $settings, [\CACHING_GROUP_PLUGIN, $this->plugin->getCache()->getGroup()]); UBY86: if (!empty($settings)) { goto lg8FE; } $this->log->error("\113\x65\151\156\x65\x20\124\x68\x72\145\145\123\x69\170\x74\x79\x49\155\x61\147\145\40\x45\x69\156\x73\164\145\154\x6c\165\156\x67\145\x6e\40\147\145\146\x75\x6e\144\x65\156"); try { $settingsModel = new ThreeSixtyImageSettings(); $settingsModel->save(); $settings = ThreeSixtyImageSettings::all()->first(); } catch (\Throwable $th) { $this->log->error("\106\x65\x68\154\x65\x72\x20\x62\145\151\x6d\40\145\151\156\x66\xc3\274\x67\x65\x6e\40\144\x65\162\x20\123\164\x61\156\x64\x61\x72\x64\x65\151\x6e\163\x74\145\154\154\x75\x6e\147\145\x6e\x3a\x20" . $th); return; } lg8FE: $this->settings = $settings; $this->dispatcher->listen("\x73\150\x6f\x70\x2e\x68\157\157\153\56" . \HOOK_SMARTY_OUTPUTFILTER, $this->makePlayer(...)); } private function addScripts() { $script = "\x3c\163\x63\x72\x69\160\164\x20\x64\x65\146\145\162\x20\x73\x72\x63\75\42" . $this->frontEndURL . "\152\163\57\x74\150\162\x69\x78\x74\x79\57\x74\x68\162\151\170\x74\171\x2e\x6a\x73\x22\x3e\x3c\x2f\x73\x63\x72\151\x70\164\76"; if (isTemplateActive()) { goto E3IIC; } $script .= "\74\x73\x63\162\x69\160\164\40\144\x65\x66\x65\162\40\164\171\160\145\x3d\42\x6d\x6f\144\165\154\145\42\x20\x73\162\x63\75\x22" . $this->frontEndURL . "\x6a\x73\57\164\x68\x72\151\x78\164\171\x2f\x74\x68\162\145\145\163\x69\170\164\171\x4e\x6f\166\141\56\152\x73\42\76\74\x2f\x73\143\162\x69\x70\164\76"; goto HWPGb; E3IIC: $script .= "\74\163\x63\162\x69\x70\164\x20\144\x65\x66\x65\x72\x20\164\171\160\x65\x3d\x22\155\157\144\x75\154\145\x22\x20\x73\x72\x63\75\x22" . $this->frontEndURL . "\152\163\57\164\x68\162\x69\170\164\171\x2f\164\x68\162\145\145\163\x69\170\164\x79\x43\x75\163\164\157\155\56\152\x73\42\76\74\x2f\x73\143\x72\151\160\x74\76"; HWPGb: $this->includeIntoHead($script); } private function makePlayer() { goto uulNg; vtcX6: $customSubPath = ''; if (!$settings->subpath) { goto XkGh6; } $customSubPath = "\x2f" . $settings->subpath; XkGh6: $largeDir = $baseFolderPath . "\x2f" . $comparisonValue . $customSubPath . "\x2f\154\x61\162\147\145\x2f\106\x69\x6c\145\x6c\x69\x73\x74\56\x74\x78\164"; if (file_exists($largeDir)) { goto dF8Z0; } return; dF8Z0: $this->frontEndURL = $this->plugin->getPaths()->getFrontendURL(); $this->frontEndPath = $this->plugin->getPaths()->getFrontendPath(); goto w6xMp; w6xMp: $this->pluginURL = $this->plugin->getPaths()->getBaseURL(); $this->addScripts(); $this->addCss(); $this->addPlayer($product); $this->addThumb($product); goto hko_v; uulNg: $pageType = Shop::getPageType(); if (!($pageType !== PAGE_ARTIKEL)) { goto OaqCn; } return; OaqCn: if (!(($folderArray = $this->cache->get(ThreeSixtyImageBackendController::CACHE_ID)) === false)) { goto SmMkQ; } $folderArray = ThreeSixtyImageBackendController::getImageFolderArray($this->settings->basepath); $this->cache->set(ThreeSixtyImageBackendController::CACHE_ID, $folderArray, [\CACHING_GROUP_PLUGIN, $this->plugin->getCache()->getGroup()]); SmMkQ: if ($folderArray) { goto uakv0; } return; goto dDEqH; dDEqH: uakv0: $this->folderArray = $folderArray; $smarty = Shop::Smarty(); $product = $smarty->getTemplateVars("\x41\162\164\x69\153\145\x6c"); $comparisonValue = $this->setSearchVariable($product); $settings = $this->settings; if (!(is_null($comparisonValue) || array_search($comparisonValue, $folderArray) === false)) { goto eMEzX; } return; eMEzX: $baseFolderPath = \PFAD_ROOT . $settings->basepath; goto vtcX6; hko_v: } private function addCss() { $css = "\74\154\151\156\x6b\40\162\145\x6c\x3d\42\163\164\x79\154\x65\x73\x68\145\145\x74\x22\x20\150\x72\145\146\75\x22" . $this->frontEndURL . "\x63\163\x73\57\x74\150\x72\x69\x78\164\171\56\143\163\x73\42\40\x74\171\160\145\75\42\x74\x65\170\x74\57\143\x73\x73\42\x20\x6d\x65\144\x69\141\x3d\x22\163\143\x72\x65\x65\156\x22\x20\x2f\x3e"; $css .= "\x3c\154\151\156\153\40\x72\x65\154\75\x22\x73\x74\x79\154\x65\163\x68\x65\145\x74\42\x20\x68\x72\x65\146\75\x22" . $this->frontEndURL . "\x63\x73\x73\57\x74\150\x72\151\x78\164\x79\x2d\x63\165\163\x74\157\155\x2e\x63\x73\163\x22\x20\x74\171\160\145\75\42\164\x65\x78\x74\x2f\143\163\x73\x22\40\x6d\x65\x64\151\x61\75\x22\x73\x63\162\x65\145\x6e\x22\x20\x2f\76"; $css .= isTemplateActive() ? '' : "\74\x6c\151\156\x6b\x20\x72\145\x6c\x3d\x22\163\164\x79\154\x65\x73\150\x65\145\x74\42\x20\150\x72\x65\x66\x3d\42" . $this->frontEndURL . "\x63\163\163\57\164\x68\162\151\x78\x74\171\x2d\156\x6f\x76\x61\56\143\163\163\x22\x20\x74\171\x70\x65\75\x22\164\145\x78\164\x2f\143\x73\x73\x22\x20\155\x65\144\151\x61\75\x22\163\143\162\145\x65\156\x22\40\57\76"; $this->includeIntoHead($css); } private function addPlayer(Artikel $product) { $autoPlay = $this->settings->autoplay ? "\157\x6e" : 0; $duration = $this->settings->duration; $element = "\x3c\x64\151\x76\40\x63\x6c\141\163\163\x3d\x22\x74\150\162\x69\x78\x74\x79\x2d\167\x72\141\x70\x70\x65\162\42\76\12\40\x20\40\x20\x20\x20\x20\40\74\x64\151\166\x20\x63\x6c\x61\163\x73\x3d\42\x74\x68\x72\x69\170\164\171\40\x70\x72\x6f\x64\165\x63\x74\x2d\151\155\x61\x67\145\x22\40\x69\x64\x3d\42\164\x68\162\151\170\164\171\137\x62\157\170\x5f\61\x22\40\164\141\x62\151\x6e\x64\145\x78\x3d\x22\x30\x22\xa\x20\x20\40\x20\40\40\x20\40\x20\x20\x74\x68\x72\x69\x78\164\x79\55\x62\141\x73\145\160\141\164\x68\75\x22" . $this->getFullPath($product) . "\x2f\x22\12\40\x20\x20\40\40\x20\x20\x20\40\x20\x74\x68\x72\x69\x78\x74\171\x2d\146\151\154\145\x6c\x69\x73\164\x2d\160\141\164\x68\55\163\155\141\x6c\x6c\x3d\42\163\155\141\x6c\154\x2f\106\151\154\145\154\x69\163\164\56\x74\x78\164\42\xa\40\x20\x20\40\x20\40\x20\x20\40\40\164\x68\162\151\x78\164\x79\x2d\146\x69\154\x65\x6c\x69\x73\164\55\x70\141\x74\x68\55\154\141\162\x67\x65\x3d\42\154\141\x72\x67\x65\x2f\106\x69\x6c\x65\154\151\163\x74\x2e\164\x78\164\x22\12\x20\x20\x20\40\40\40\40\x20\x20\x20\x74\x68\162\151\x78\x74\171\x2d\x61\x75\x74\x6f\x70\154\x61\171\x3d\42" . $autoPlay . "\42\12\40\40\40\x20\40\x20\x20\40\x20\x20\164\x68\x72\x69\170\164\171\55\x63\x79\x63\x6c\145\x2d\144\x75\x72\141\x74\151\157\156\75\42" . $duration . "\42\xa\x20\x20\40\x20\x20\40\40\40\40\x20\x74\150\x72\x69\170\x74\171\55\x7a\157\x6f\x6d\x2d\155\x6f\x64\x65\75\x22\x6e\157\x6e\x65\x22\12\40\x20\40\40\x20\x20\x20\40\x20\40\x74\150\162\x69\170\x74\x79\x2d\172\157\157\155\55\155\157\x64\145\55\x6d\x6f\142\x69\x6c\145\x3d\42\156\x6f\x6e\145\x22\12\x20\40\x20\40\40\40\x20\40\x20\40\164\150\x72\151\x78\x74\x79\55\172\157\157\x6d\x2d\160\157\151\x6e\164\x65\x72\75\x22\x6d\151\x6e\x69\155\141\x70\x22\xa\40\40\x20\x20\x20\x20\x20\x20\40\40\x74\x68\162\151\x78\164\x79\x2d\x6c\x6f\143\141\x6c\x69\172\141\164\x69\157\x6e\55\x70\141\x74\150\75\42" . $this->pluginURL . "\154\x6f\143\x61\154\145\x2f\x74\x68\x72\x69\170\x74\171\x2e\x6a\x73\157\x6e\x22\xa\40\x20\40\40\40\x20\40\x20\x20\40\164\150\x72\x69\170\164\x79\x2d\141\165\x74\x6f\154\x6f\141\x64\75\x22\x6f\156\x22\12\x20\x20\40\40\40\x20\40\40\76\12\x20\x20\x20\40\x20\x20\x20\x20\74\57\144\x69\x76\76\12\x20\x20\40\40\x20\x20\x20\x20\74\x63\141\x6e\x76\x61\x73\x20\151\144\x3d\42\164\x68\x72\x69\170\x74\171\x5f\x7a\157\x6f\155\137\143\x61\x6e\x76\x61\x73\x5f\61\x22\40\143\154\x61\163\163\x3d\42\x74\x68\x72\151\170\x74\x79\137\172\x6f\157\x6d\137\143\x61\156\166\141\x73\40\x70\162\x6f\144\165\x63\164\55\x69\x6d\x61\147\x65\42\x3e"; $selector = $this->plugin->getConfig()->getValue("\x61\144\155\x6f\162\x72\151\x73\137\x70\x72\157\137\x65\x78\x70\145\162\x74\x5f\163\x65\x74\x74\x69\156\x67\163\x5f\x74\x68\x72\x65\145\137\x73\x69\x78\164\x79\x5f\151\x6d\141\x67\x65\x5f\x63\163\163\137\x73\145\x6c\145\143\164\157\x72"); $method = $this->settings->position; \pq("\142\x6f\x64\171")->prepend("\74\x64\x69\x76\40\151\144\75\x22\x74\150\162\x69\170\x74\x79\x2d\x66\x75\x6c\154\x73\x63\x72\145\145\x6e\x2d\143\157\x6e\164\141\151\x6e\x65\162\x22\x3e\74\57\x64\x69\x76\76"); \pq($selector)->{$method}($element); } private function addThumb(Artikel $product) { $smarty = Shop::Smarty(); $product = $smarty->getTemplateVars("\x41\162\x74\151\x6b\x65\154"); $images = $product->Bilder; $numberOfImages = count($images); if (!($numberOfImages === 0)) { goto o3abg; } return; o3abg: $newImage = new \stdClass(); $newImage->cUrlMini = ThreeSixtyImageBackendController::getThumbnailName($this->getFullPath($product) . "\x2f\163\x6d\141\x6c\x6c"); $newImage->cAltAttribut = "\124\x68\162\151\170\x74\x79\x20\x49\x6d\x61\147\x65"; $template = isTemplateActive() ? $this->frontEndPath . "\164\145\x6d\x70\x6c\x61\x74\145\x73\x2f\155\x61\x72\153\145\164\151\x6e\147\x5f\x74\x68\162\145\145\137\x73\x69\x78\x74\171\137\151\155\141\147\145\x73\57\164\x68\x75\x6d\x62\x2e\164\x70\x6c" : $this->frontEndPath . "\164\145\x6d\x70\154\141\x74\145\x73\57\x6d\x61\x72\153\145\x74\151\156\x67\x5f\x74\x68\162\x65\x65\137\163\x69\x78\x74\171\137\151\x6d\x61\147\145\x73\57\x74\x68\x75\155\x62\137\x6e\157\166\x61\56\164\160\154"; $singleSelector = $this->plugin->getConfig()->getValue("\x61\x64\155\157\x72\162\x69\163\x5f\160\162\157\137\x65\x78\160\145\162\164\137\163\145\164\x74\x69\x6e\147\163\x5f\x74\150\162\145\145\x5f\x73\151\x78\164\171\137\151\155\x61\x67\x65\137\x74\x68\x75\x6d\142\137\x73\151\x6e\x67\x6c\x65\137\x63\163\x73\137\x73\x65\x6c\x65\x63\164\157\x72"); $multipleSelector = $this->plugin->getConfig()->getValue("\x61\x64\x6d\x6f\x72\x72\x69\x73\137\x70\x72\x6f\x5f\x65\x78\160\x65\162\164\x5f\163\145\x74\x74\151\156\147\x73\137\x74\150\162\145\x65\137\163\151\x78\x74\171\137\x69\155\x61\147\x65\x5f\164\150\x75\155\x62\x5f\x6d\165\x6c\x74\x69\160\x6c\x65\137\x63\163\x73\x5f\x73\x65\154\x65\x63\164\x6f\x72"); $method = $this->settings->position; $smarty->assign("\x61\x64\x6d\157\162\x72\151\x73\x5f\156\165\x6d\142\x65\162\137\x6f\x66\x5f\151\155\141\x67\145\x73", $numberOfImages); $smarty->assign("\x61\144\x6d\157\162\162\x69\x73\137\x74\150\162\x65\x65\137\x73\x69\170\x74\171\137\151\155\141\x67\x65", $newImage); $smarty->assign("\141\144\x6d\x6f\162\x72\x69\163\x5f\x74\x68\x72\x65\x65\137\163\x69\170\164\171\x5f\x70\157\163\151\x74\151\x6f\156", $method); $numberOfImages == 1 ? \pq($singleSelector)->append($smarty->fetch($template)) : \pq($multipleSelector)->{$method}($smarty->fetch($template)); } private function includeIntoHead($element) { \pq("\x68\x65\x61\144")->append($element); } private function getFolderName($product) { $folderName = $this->setSearchVariable($product); return $folderName; } private function setSearchVariable($product) { if (!(isset($product->kVaterArtikel) && $product->kVaterArtikel !== 0 && $product->nIstVater === 0 && $this->settings->useFather)) { goto rx6fY; } switch ($this->settings->mode) { case "\143\x41\162\x74\x4e\x72": $fatherProduct = (new Artikel())->fuelleArtikel($product->kVaterArtikel); return $fatherProduct->cArtNr; case "\x6b\x41\x72\164\151\153\145\154": return $product->kVaterArtikel; case "\107\124\x49\x4e": $fatherProduct = (new Artikel())->fuelleArtikel($product->kVaterArtikel); return $fatherProduct->cBarcode; } t972z: ucAQU: rx6fY: switch ($this->settings->mode) { case "\x63\x41\162\x74\116\x72": return $product->cArtNr; case "\153\101\162\x74\x69\153\x65\x6c": return $product->kArtikel; case "\x47\124\x49\116": return $product->cBarcode; } RjhKP: aQDuf: } private function getFullPath($product) { $path = $this->settings->basepath . "\57" . $this->getFolderName($product); if (!($this->settings->subpath !== '')) { goto R7pCj; } $path .= "\x2f" . $this->settings->subpath; R7pCj: return $path; } }