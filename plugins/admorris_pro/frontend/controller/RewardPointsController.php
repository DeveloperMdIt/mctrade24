<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro\frontend\controller; use JTL\Shop; use JTL\Alert\Alert; use JTL\Session\Frontend; use JTL\Events\Dispatcher; use JTL\Catalog\Product\Preise; use JTL\Plugin\PluginInterface; use JTL\Cache\JTLCacheInterface; use JTL\Cart\Cart; use JTL\Cart\CartItem; use Plugin\admorris_pro\controller\AbstractHookController; use Plugin\admorris_pro\Models\RewardPointsTransactionModel; use Plugin\admorris_pro\StatusRequest; use function Plugin\admorris_pro\cssSelector; use function Plugin\admorris_pro\localizeNumberFormat; use Plugin\admorris_pro\RewardPointsVoucherCompat; use Plugin\admorris_pro\Models\RewardPointsSettings; use Plugin\admorris_pro\Models\RewardPointsCustomerGroupModel; use Plugin\admorris_pro\ioHandling\rewardPoints\CustomerRewardPoints; use Plugin\admorris_pro\ioHandling\rewardPoints\RewardPointsTransaction; use Plugin\admorris_pro\update\RewardPointsUpdater; use Plugin\admorris_pro\Utils\Utils; class RewardPointsController extends AbstractHookController { private RewardPointsSettings $settings; private CustomerRewardPoints $customerRewardPoints; private $rewardPointsValue; private $submittedRewardPoints; private RewardPointsTransaction $transaction; protected string $configKey = "\141\x64\x6d\157\162\x72\151\x73\x5f\x70\162\157\x5f\x6d\141\x72\153\x65\164\x69\156\147\x5f\x72\145\167\141\162\x64\137\160\x6f\151\156\x74\163\137\x61\x63\x74\151\166\x65"; const EXCLUDE_ARTICLE_ATTR = "\x72\145\167\141\162\x64\x5f\x70\x6f\x69\x6e\164\x73\137\145\170\x63\x6c\165\x64\145"; const EXCLUDE_ARTICLE_ATTR_FROM_EARN = "\x72\145\x77\x61\x72\x64\137\160\x6f\151\x6e\164\x73\137\x65\170\143\x6c\165\144\145\x5f\145\x61\162\x6e"; const EXCLUDE_ARTICLE_ATTR_FROM_REDEEM = "\162\145\167\141\x72\144\x5f\x70\157\151\x6e\x74\x73\x5f\145\x78\143\x6c\165\x64\145\137\162\145\x64\x65\x65\x6d"; public function __construct(PluginInterface $plugin, Dispatcher $dispatcher, StatusRequest $statusRequest, private readonly JTLCacheInterface $cache) { parent::__construct($plugin, $dispatcher, $statusRequest); } protected function init() : void { if (!(($settings = $this->cache->get(RewardPointsSettings::CACHE_ID)) === false)) { goto e07i0; } $settings = RewardPointsSettings::all()->first(); $this->cache->set(RewardPointsSettings::CACHE_ID, $settings, [\CACHING_GROUP_PLUGIN, $this->plugin->getCache()->getGroup()]); e07i0: if (!empty($settings)) { goto oQxTU; } $this->log->error("\113\145\151\x6e\x65\40\102\x6f\156\x75\163\160\x75\x6e\x6b\164\x65\40\105\x69\156\x73\x74\145\154\x6c\165\156\x67\145\x6e\x20\x67\x65\x66\165\156\144\145\156"); try { $settingsModel = new RewardPointsSettings(); $settingsModel->save(); (new RewardPointsUpdater(Shop::Container()->getDB()))->moveSettings(); $settings = RewardPointsSettings::all()->first(); } catch (\Throwable $th) { $this->log->error("\106\145\x68\x6c\145\x72\40\x62\145\151\x6d\40\x65\x69\156\146\303\274\x67\x65\156\x20\144\x65\x72\x20\x53\164\141\156\x64\141\162\144\x65\x69\x6e\163\164\145\x6c\x6c\165\156\147\145\156\72\40" . $th); return; } oQxTU: $this->settings = $settings; $this->transaction = new RewardPointsTransaction($this->plugin, $this->cache); RewardPointsVoucherCompat::init($this->dispatcher); $this->dispatcher->listen("\163\150\x6f\160\56\150\157\157\153\56" . \HOOK_SMARTY_OUTPUTFILTER, function () { $this->handleDiscountSubmit(); $this->renderTemplate(); }, 8); $this->dispatcher->listen("\163\x68\157\160\56\x68\157\x6f\153\56" . \HOOK_BESTELLABSCHLUSS_INC_BESTELLUNGINDB_ENDE, [$this, "\x63\x72\145\x61\x74\x65\103\150\x65\x63\x6b\157\165\164\124\162\x61\x6e\163\x61\x63\x74\x69\x6f\156"]); $this->dispatcher->listen("\x73\150\157\x70\x2e\x68\x6f\157\153\56" . \HOOK_BESTELLUNGEN_XML_BEARBEITESTORNO, [$this, "\x64\145\x6c\145\x74\x65\124\x72\x61\156\163\x61\143\x74\x69\x6f\x6e"]); $this->initCustomerGroupEarnFactor(); } public function renderTemplate() { goto Vv61_; cYH9j: MSYdj: SRWep: if (!(Shop::getPageType() === PAGE_WARENKORB && $this->settings->show_cart)) { goto WMP_x; } $this->renderOnCart($data); WMP_x: goto kk8D3; lZFfd: VMhS2: if (empty(Frontend::getCustomer()->kKunde)) { goto SRWep; } $this->customerRewardPoints = $this->transaction->getPoints(); $data->assign("\166\x61\154\x69\144\x5f\162\145\167\141\x72\144\x5f\x70\157\151\x6e\164\163", localizeNumberFormat($this->customerRewardPoints->valid_points)); $data->assign("\166\x61\x6c\151\x64\x5f\x72\145\167\141\162\144\137\x70\x6f\151\x6e\x74\163\x5f\x76\141\x6c\x75\x65", $this->rewardPointsToCurrencyValue($this->customerRewardPoints->valid_points)); $data->assign("\160\x65\156\144\x69\x6e\x67\x5f\x72\145\x77\141\162\144\x5f\x70\x6f\151\x6e\x74\163", $this->customerRewardPoints->pending_points); $data->assign("\160\x65\156\144\x69\x6e\147\137\x72\145\x77\x61\162\x64\137\x70\x6f\x69\x6e\164\163\x5f\166\141\154\165\145", $this->rewardPointsToCurrencyValue($this->customerRewardPoints->pending_points)); if (!(Shop::getPageType() === PAGE_WARENKORB)) { goto i9cM1; } $this->renderRedeemForm($data, "\x72\x65\167\x61\162\144\137\x70\x6f\x69\156\x74\x73\x5f\x63\x61\162\164"); i9cM1: goto IFSyO; Vv61_: $data = Shop::Smarty()->createData(Shop::Smarty()); $data->assign("\162\x6f\x75\156\144\x69\x6e\x67\137\146\x61\x63\x74\x6f\x72", $this->settings->round); $data->assign("\145\141\x72\x6e\137\x66\x61\x63\164\x6f\162", $this->settings->earn_factor); $data->assign("\162\x65\164\165\162\x6e\137\x66\x61\143\164\157\x72", $this->settings->return_factor); $data->assign("\163\150\157\167\x5f\166\x61\x6c\x75\x65", $this->settings->show_value); $data->assign("\143\x75\162\162\145\x6e\x63\x79", Frontend::getCurrency()->getHtmlEntity()); $data->assign("\x63\x75\x72\x72\145\156\143\x79\137\x66\141\x63\164\157\x72", Frontend::getCurrency()->getConversionFactor()); $data->assign("\x63\165\x72\162\x65\x6e\x63\171\103\154\x61\163\163", Frontend::getCurrency()); if (!(Shop::getPageType() === PAGE_ARTIKEL && $this->settings->show_productpage && $this->getEarnFactor() > 0)) { goto VMhS2; } $this->renderOnArticle($data); goto lZFfd; IFSyO: if (!(Shop::getPageType() === PAGE_MEINKONTO && empty($_GET) && $this->settings->show_account)) { goto q7cBx; } $this->renderOnAccount($data); q7cBx: if (!(Shop::getPageType() === PAGE_BESTELLVORGANG)) { goto MSYdj; } if (!$this->settings->show_checkout) { goto AS7KE; } $this->renderOnCart($data); AS7KE: if (!$this->settings->show_checkout_redeem_form) { goto brVEn; } $this->renderRedeemForm($data, "\x72\x65\167\141\x72\x64\x5f\160\x6f\151\156\164\x73\137\x63\x68\x65\x63\153\157\x75\164"); brVEn: goto cYH9j; kk8D3: } private function renderOnArticle($data) { $article = Shop::Smarty()->getTemplateVars("\101\x72\x74\x69\x6b\x65\154"); if (!(!is_null($article->getFunctionalAttributevalue(self::EXCLUDE_ARTICLE_ATTR)) || !is_null($article->getFunctionalAttributevalue(self::EXCLUDE_ARTICLE_ATTR_FROM_EARN)))) { goto sIJrE; } return; sIJrE: $articleRewardPoints = $this->getEarnedArticleRewardPoints($article); if (!($articleRewardPoints <= 0)) { goto UoBIV; } return; UoBIV: $data->assign("\x61\x72\x74\x69\x63\x6c\145\137\x72\x65\x77\141\162\x64\137\160\x6f\x69\x6e\164\163", $articleRewardPoints); $data->assign("\x61\x72\x74\x69\x63\x6c\145\x5f\x72\x65\167\x61\x72\144\x5f\160\157\x69\x6e\164\163\x5f\143\165\x72\162\x65\x6e\143\171\137\x76\x61\154\x75\145", $this->rewardPointsToCurrencyValue($articleRewardPoints)); $template = $this->plugin->getPaths()->getFrontendPath() . "\164\145\x6d\160\154\141\164\x65\x73\57\155\x61\x72\153\x65\x74\151\156\x67\x5f\162\145\x77\x61\x72\x64\137\160\x6f\151\156\164\163\57\x70\162\157\x64\165\x63\x74\x5f\144\145\164\141\151\x6c\56\x74\x70\x6c"; cssSelector("\x72\x65\167\141\x72\144\137\x70\157\x69\156\x74\163\137\163\150\x6f\167\x5f\160\162\157\x64\x75\x63\x74\160\x61\x67\145", Shop::Smarty()->createTemplate($template, $data)->fetch($template)); } private function renderOnCart($data) { $cartRewardPoints = $this->getEarnedCartRewardPoints(); if (!($cartRewardPoints <= 0)) { goto j0CMT; } return; j0CMT: $data->assign("\143\141\x72\x74\x5f\x72\x65\167\141\162\x64\x5f\160\x6f\151\156\164\x73", localizeNumberFormat($cartRewardPoints)); $data->assign("\143\x61\x72\x74\137\x72\x65\x77\141\162\144\137\160\157\151\156\164\163\137\143\165\x72\x72\x65\x6e\x63\x79\x5f\166\141\x6c\165\145", $this->rewardPointsToCurrencyValue($cartRewardPoints)); $selector = "\162\x65\167\x61\x72\x64\137\x70\157\151\156\164\x73\x5f\x73\x68\x6f\x77\x5f\x63\141\162\x74"; if (!(Shop::getPageType() === PAGE_BESTELLVORGANG)) { goto t3pi5; } $selector = "\x72\x65\x77\x61\162\x64\x5f\160\x6f\x69\x6e\164\163\x5f\163\x68\x6f\x77\137\x63\x68\x65\x63\153\157\x75\164"; t3pi5: $template = $this->plugin->getPaths()->getFrontendPath() . "\164\145\x6d\x70\154\x61\164\145\163\x2f\155\x61\162\x6b\145\x74\x69\x6e\147\x5f\x72\145\x77\x61\162\144\x5f\160\x6f\151\156\164\x73\x2f\143\141\x72\164\x5f\160\x6f\151\x6e\164\x73\x2e\164\x70\x6c"; cssSelector($selector, Shop::Smarty()->createTemplate($template, $data)->fetch($template), false); } private function renderOnAccount($data) { $template = $this->plugin->getPaths()->getFrontendPath() . "\x74\145\x6d\160\x6c\x61\x74\x65\x73\x2f\x6d\x61\x72\153\x65\164\x69\156\x67\137\x72\145\x77\141\162\144\x5f\x70\157\x69\156\164\x73\57\x61\x63\143\x6f\165\x6e\164\x2e\164\x70\154"; cssSelector("\162\145\x77\141\x72\x64\x5f\160\157\151\156\x74\x73\137\x73\150\157\167\x5f\x61\x63\143\x6f\x75\156\164", Shop::Smarty()->createTemplate($template, $data)->fetch($template)); } private function renderRedeemForm($data, $selector) { goto FNWEV; aWTI2: $template = $this->plugin->getPaths()->getFrontendPath() . "\164\x65\x6d\160\154\x61\164\145\163\57\x6d\x61\x72\x6b\145\x74\151\156\x67\x5f\162\x65\167\141\162\144\x5f\160\x6f\x69\156\x74\163\x2f\162\145\x64\145\145\x6d\x5f\146\157\162\155\56\164\160\154"; cssSelector($selector, Shop::Smarty()->createTemplate($template, $data)->fetch($template), false); goto TqJ9w; FNWEV: $data->assign("\162\145\x77\141\162\144\137\160\157\x69\156\x74\163\x5f\162\x6f\x75\x74\x65", "\x77\141\162\145\156\x6b\157\162\x62\56\160\150\160"); if (!(Shop::getPageType() === PAGE_BESTELLVORGANG)) { goto BXoD3; } $data->assign("\162\145\167\141\162\144\x5f\160\x6f\151\x6e\164\x73\137\162\x6f\165\x74\x65", "\142\145\x73\164\145\x6c\x6c\x76\x6f\162\147\141\156\x67\x2e\160\150\x70"); BXoD3: $validPoints = $this->customerRewardPoints->valid_points; $minLimit = $this->settings->minimum; if (!($minLimit == 0)) { goto l4M1L; } $minLimit = null; l4M1L: $data->assign("\x72\x65\x77\141\x72\144\137\x70\157\x69\x6e\x74\x73\x5f\x72\x65\x64\x65\145\x6d\137\155\151\x6e", $minLimit); goto eXCHD; eXCHD: $maxLimit = $this->settings->maximum; $redeenValue = $minLimit < $validPoints ? $minLimit : $validPoints; $data->assign("\x72\x65\x77\x61\x72\x64\137\x70\x6f\151\x6e\164\x73\x5f\162\x65\144\x65\145\155\137\166\x61\154\165\145", $redeenValue); if ($this->settings->maximum == 0) { goto ikH3r; } $maxLimit = min($validPoints, $maxLimit); goto yvkmK; ikH3r: $maxLimit = $validPoints; yvkmK: $data->assign("\x72\145\167\141\162\x64\x5f\160\157\x69\156\x74\x73\x5f\x72\x65\144\x65\x65\x6d\137\155\x61\170", $maxLimit); goto aWTI2; TqJ9w: } private function getEarnedArticleRewardPoints($currentArticle) { return $this->transaction->roundRewardPoints($currentArticle->Preise->fVKBrutto * $this->settings->earn_factor); } public function getEarnedCartRewardPoints() { $cartSum = $this->getCartSum(true); if (!($cartSum < 0)) { goto FXJ9J; } $cartSum = 0; FXJ9J: return $this->transaction->roundRewardPoints($cartSum * $this->settings->earn_factor); } private function rewardPointsToCurrencyValue($rewardPoints, $addCurrencySymbol = true) { $value = round($rewardPoints * $this->settings->return_factor * Frontend::getCurrency()->getConversionFactor(), 2); if ($addCurrencySymbol) { goto GDjPn; } return $value; GDjPn: $localizedPrice = Preise::getLocalizedPriceWithoutFactor($value); $localizedPrice = str_replace("\x20", "\x26\x6e\x62\x73\x70\x3b", $localizedPrice); return $localizedPrice; } public function getEarnFactor() { return $this->settings->earn_factor; } private function initCustomerGroupEarnFactor() : void { $customerGroup = Frontend::getCustomer()->kKundengruppe; if (!empty($customerGroup)) { goto q_z1r; } return; q_z1r: $customerGroupSettings = RewardPointsCustomerGroupModel::query()->where("\143\165\x73\x74\157\x6d\x65\x72\147\162\157\165\160\x5f\x69\144", $customerGroup)->first(); if (!(!$customerGroupSettings instanceof RewardPointsCustomerGroupModel || is_null($customerGroupSettings->earn_conversionrate))) { goto U46pd; } return; U46pd: $this->settings->earn_factor = $customerGroupSettings->earn_conversionrate; } public function createRewardPointsPos($submittedRewardPoints) { $cart = Frontend::getCart(); $this->removeRewardPointsPos(); $this->validateRewardPointsValue($submittedRewardPoints); if (!($this->submittedRewardPoints > 0)) { goto tSwDp; } $cart->erstelleSpezialPos(Utils::trans("\155\x61\x72\x6b\x65\x74\151\156\x67\137\x72\x65\x77\141\162\144\x5f\x70\157\151\156\164\163\137\x6e\x61\x6d\x65") . "\40\50" . $this->submittedRewardPoints . "\51", 1, $this->rewardPointsValue * -1, $this->settings->tax, C_WARENKORBPOS_TYP_GUTSCHEIN, false, true, '', false, 0, 0, "\x61\144\155\x6f\x72\x72\151\163\137\x70\x72\x6f\x5f\162\x65\x77\x61\162\x64\x70\x6f\x69\x6e\164\163"); tSwDp: if (!(isset($_SESSION["\141\144\x6d\114\x61\x73\164\123\165\x62\x6d\151\164\164\145\x64\122\145\x77\141\x72\144\120\x6f\x69\156\164\x73"]) && $_SESSION["\141\144\x6d\114\141\x73\x74\x53\165\142\155\151\x74\x74\x65\x64\x52\x65\167\141\162\x64\120\x6f\151\x6e\164\163"] != $this->submittedRewardPoints)) { goto FgSSB; } $alertHelper = Shop::Container()->getAlertService(); $message = Utils::trans("\155\141\162\x6b\145\164\151\156\147\x5f\162\145\167\141\162\x64\137\x70\157\x69\156\x74\163\x5f\143\150\x61\156\147\x65\x64"); $alertHelper->addAlert(Alert::TYPE_NOTE, $message, "\x6d\x61\162\153\145\x74\151\x6e\147\x5f\162\145\167\x61\162\x64\137\x70\157\151\x6e\x74\x73\x5f\143\x68\141\x6e\147\x65\x64"); FgSSB: $_SESSION["\141\144\155\x4c\141\163\x74\x53\165\x62\155\x69\164\x74\145\144\x52\x65\167\141\162\144\x50\157\x69\156\x74\x73"] = $this->submittedRewardPoints; } private function removeRewardPointsPos() { $cart = Frontend::getCart(); foreach ($cart->PositionenArr as $i => $item) { if (!($item->cResponsibility === "\141\x64\155\157\x72\162\151\x73\137\160\162\x6f\x5f\x72\145\167\x61\x72\144\x70\157\151\x6e\164\163")) { goto RpPVR; } $cart->addDeletedPosition($cart->PositionenArr[$i]); unset($cart->PositionenArr[$i]); RpPVR: BukFC: } d9uF1: $cart->PositionenArr = \array_merge($cart->PositionenArr); return $cart; } public function validateRewardPointsValue($submittedRewardPoints) { goto fA_AY; GAbK7: $this->rewardPointsValue = $this->rewardPointsToCurrencyValue($this->submittedRewardPoints, false); if (!($this->rewardPointsValue >= $cartSumTotal)) { goto NbNob; } if (!($submittedRewardPoints == 0)) { goto BlGXn; } return; BlGXn: $factor = $cartSumTotal / $this->rewardPointsValue; $this->submittedRewardPoints = self::floorDec($this->submittedRewardPoints * $factor * Frontend::getCurrency()->getConversionFactor(), 4); $this->rewardPointsValue = $cartSumTotal; NbNob: goto hprYk; tiTRI: if (!($maxLimit == 0)) { goto a_W66; } $maxLimit = $valid; a_W66: if (!($valid < $this->submittedRewardPoints)) { goto IXeVm; } $this->submittedRewardPoints = $valid; IXeVm: if (!($this->submittedRewardPoints >= $maxLimit)) { goto toJM1; } $this->submittedRewardPoints = $maxLimit; toJM1: $cartSumTotal = $this->getCartSum(false); goto GAbK7; fA_AY: if (!empty(Frontend::getCustomer()->kKunde)) { goto Lnw4C; } return; Lnw4C: $this->submittedRewardPoints = $submittedRewardPoints; $cart = Frontend::getCart(); if (!($submittedRewardPoints < $this->settings->minimum)) { goto yVyS2; } $this->submittedRewardPoints = 0; yVyS2: $maxLimit = $this->settings->maximum; $valid = $this->transaction->getPoints()->valid_points; goto tiTRI; hprYk: } public function updateRedeemedRewardPoints() { $redeemed = $this->getRedeemedCartRewardPoints(); $this->createRewardPointsPos($redeemed); } public function getRedeemedCartRewardPoints() { $cart = Frontend::getCart(); $redeemed = 0; foreach ($cart->PositionenArr as $i => $item) { if (!($item->cResponsibility === "\141\x64\155\x6f\162\162\x69\x73\x5f\x70\x72\x6f\137\162\x65\x77\x61\x72\144\x70\157\x69\156\164\163")) { goto Y9RIE; } if (is_string($item->cName)) { goto DYL3E; } $rewardPointsPosName = $item->cName[array_key_first($item->cName)]; goto WeuL7; DYL3E: $rewardPointsPosName = $item->cName; WeuL7: $rewardPointsPosName = $this->parseContentsBetweenParentheses($rewardPointsPosName); $redeemed = (float) filter_var($rewardPointsPosName, FILTER_SANITIZE_NUMBER_FLOAT, FILTER_FLAG_ALLOW_FRACTION); Y9RIE: cgp4Q: } oRoqx: return $redeemed; } private function parseContentsBetweenParentheses($inputString) { $pattern = "\x2f\x5c\x28\x28\x2e\52\x3f\x29\x5c\x29\x2f"; preg_match_all($pattern, $inputString, $matches); return $matches[1][0]; } public function handleDiscountSubmit() { if (!empty(Frontend::getCustomer()->cMail)) { goto hUflK; } return; hUflK: $this->updateRedeemedRewardPoints(); if (!(isset($_POST["\x61\x64\x6d\157\162\162\151\x73\x2d\142\157\156\x75\163\x70\165\x6e\x6b\164\x65"]) || isset($_POST["\x72\145\144\x65\x65\x6d\x2d\141\x6c\154\55\162\x65\167\141\162\x64\55\160\x6f\x69\x6e\164\163"]))) { goto AfB8x; } if (isset($_POST["\162\145\x64\x65\145\155\x2d\141\x6c\x6c\55\x72\x65\167\141\162\x64\x2d\x70\x6f\151\156\164\x73"])) { goto DlWkJ; } $submitted = (float) $_POST["\x61\x64\155\x6f\x72\x72\x69\163\x2d\142\157\156\165\x73\160\165\x6e\153\x74\x65"]; unset($_POST["\141\x64\x6d\x6f\162\x72\x69\x73\x2d\x62\x6f\x6e\165\x73\x70\x75\x6e\153\x74\145"]); goto gN9gT; DlWkJ: $submitted = $this->transaction->getPoints()->valid_points; gN9gT: $this->createRewardPointsPos($submitted); pq("\x68\145\141\x64")->append("\74\155\145\164\x61\x20\150\x74\x74\x70\55\x65\161\165\x69\166\75\x22\x72\145\146\162\145\163\150\x22\x20\143\x6f\x6e\164\x65\x6e\x74\x3d\42\60\42\76"); AfB8x: } public function createCheckoutTransaction(array $args) : void { if (!(empty(Frontend::getCustomer()->nRegistriert) || empty(Frontend::getCustomer()->cMail || $this->getEarnFactor() === 0.0))) { goto T1F35; } return; T1F35: $customerId = Frontend::getCustomer()->kKunde; $earnedPoints = $this->getEarnedCartRewardPoints(); $redeemedPoints = $this->getRedeemedCartRewardPoints(); $comment = $args["\157\x42\x65\163\x74\x65\154\x6c\165\156\x67"]->kBestellung; if (!($earnedPoints > 0)) { goto NU0aD; } $this->transaction->create($customerId, $earnedPoints, false, $comment); NU0aD: if (!($redeemedPoints > 0)) { goto w1jZw; } $this->transaction->create($customerId, $redeemedPoints * -1, true, $comment); w1jZw: } public function deleteTransaction($args) { RewardPointsTransactionModel::query()->firstWhere("\x63\x6f\x6d\155\x65\x6e\164", $args["\x6f\x42\145\x73\x74\145\x6c\x6c\165\x6e\x67"]->kBestellung)?->delete(); } public static function floorDec($val, $precision = 2) { if (!($precision < 0)) { goto MtyvS; } $precision = 0; MtyvS: $numPointPosition = intval(strpos($val, "\x2e")); if (!($numPointPosition === 0)) { goto q97oE; } return $val; q97oE: return floatval(substr($val, 0, $numPointPosition + $precision + 1)); } public function getCartSum(bool $filterTypes) : int|float { $cart = Frontend::getCart(); $hasExcludeAttribute = function (CartItem $item, $filterTypes) { $excludeFromEarnPoints = !is_null($item->Artikel?->getFunctionalAttributevalue(self::EXCLUDE_ARTICLE_ATTR_FROM_EARN)) && $filterTypes === true; $excludeFromRedeemPoints = !is_null($item->Artikel?->getFunctionalAttributevalue(self::EXCLUDE_ARTICLE_ATTR_FROM_REDEEM)) && $filterTypes === false; $excludeFromRewardPoints = !is_null($item->Artikel?->getFunctionalAttributevalue(self::EXCLUDE_ARTICLE_ATTR)); return $excludeFromRewardPoints || $excludeFromEarnPoints || $excludeFromRedeemPoints; }; $containsExcludedProducts = collect($cart->PositionenArr)->contains($hasExcludeAttribute); if (!$containsExcludedProducts) { goto W_TgN; } $positionsWithoutExcluded = collect($cart->PositionenArr)->filter(fn($item) => !$hasExcludeAttribute($item, $filterTypes))->toArray(); $cart = new Cart(); $cart->PositionenArr = $positionsWithoutExcluded; W_TgN: if ($filterTypes) { goto YcDrf; } $cartSum = $cart->gibGesamtsummeWaren(true); goto f2Qzo; YcDrf: $cartPositionTypes = [C_WARENKORBPOS_TYP_ARTIKEL, C_WARENKORBPOS_TYP_KUPON, C_WARENKORBPOS_TYP_GUTSCHEIN, C_WARENKORBPOS_TYP_NEUKUNDENKUPON]; if (empty($this->settings->shipping)) { goto gtpPo; } $cartPositionTypes[] = C_WARENKORBPOS_TYP_VERSANDPOS; gtpPo: $cartSum = $cart->gibGesamtsummeWarenExt($cartPositionTypes, true); f2Qzo: return $cartSum; } }