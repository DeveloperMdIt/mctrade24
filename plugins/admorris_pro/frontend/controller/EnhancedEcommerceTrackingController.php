<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro\frontend\controller; use JTL\Shop; use JTL\Plugin\Plugin; use JTL\Cache\JTLCacheInterface; use JTL\Consent\ManagerInterface; use JTL\Plugin\PluginInterface; use Plugin\admorris_pro\controller\AbstractHookController; use Plugin\admorris_pro\StatusRequest; use Plugin\admorris_pro\Models\EnhancedEcommerceTrackingModel as SettingsModel; use Plugin\admorris_pro\enhancedEcommerceTracking\{AbstractEcommerceTracking, GoogleAds, GoogleAnalytics, GoogleTagManager, Payload}; use Plugin\admorris_pro\update\EnhancedEcommerceUpdater; use function Plugin\admorris_pro\container; class EnhancedEcommerceTrackingController extends AbstractHookController { private SettingsModel $settings; private $trackingEntities = []; private $consentManagerActive; protected string $configKey = "\x61\x64\155\157\x72\x72\151\163\x5f\160\162\157\x5f\155\x61\x72\153\145\164\151\x6e\x67\x5f\145\156\150\141\156\x63\x65\144\x5f\145\x63\x6f\155\x6d\145\162\143\x65\137\141\143\164\x69\x76\145"; protected int $minModuleLevel = 1; function __construct(PluginInterface $plugin, private ManagerInterface $consentManager, private JTLCacheInterface $cache, \JTL\Events\Dispatcher $dispatcher, StatusRequest $statusRequest) { parent::__construct($plugin, $dispatcher, $statusRequest); } protected function init() : void { if (!(($settings = $this->cache->get(SettingsModel::CACHE_ID)) === false)) { goto JEXdP; } $settings = SettingsModel::all()->first(); $this->cache->set(SettingsModel::CACHE_ID, $settings, [\CACHING_GROUP_PLUGIN, $this->plugin->getCache()->getGroup()]); JEXdP: if (!empty($settings)) { goto yjpJ2; } $this->log->error("\x4b\x65\151\x6e\x65\40\105\x6e\x68\x61\156\143\x65\x64\x20\105\143\x6f\155\155\145\162\143\145\40\124\162\141\143\x6b\x69\156\x67\x20\x45\x69\x6e\163\x74\x65\x6c\154\x75\x6e\147\145\x6e\40\x67\145\x66\x75\x6e\144\x65\156"); try { $settingsModel = new SettingsModel(); $settingsModel->save(); (new EnhancedEcommerceUpdater(Shop::Container()->getDB()))->moveSettings(); $settings = SettingsModel::all()->first(); } catch (\Throwable $th) { $this->log->error("\106\145\150\x6c\x65\x72\40\x62\145\151\155\x20\145\x69\x6e\146\xc3\xbc\147\x65\156\x20\144\145\x72\40\123\164\x61\x6e\x64\x61\x72\144\145\x69\156\163\164\145\x6c\154\165\x6e\147\x65\156\x3a\x20" . $th); return; } yjpJ2: $this->settings = $settings; $this->consentManagerActive = Shop::getSettingValue(CONF_CONSENTMANAGER, "\143\157\156\x73\145\156\x74\x5f\155\x61\156\x61\x67\145\x72\137\141\x63\164\x69\166\x65") === "\131"; $this->dispatcher->listen("\x73\150\157\x70\56\150\x6f\157\x6b\x2e" . \HOOK_LETZTERINCLUDE_INC, function () { $smarty = Shop::Smarty(); if (!($this->settings->analytics_active || $this->settings->gtm_active)) { goto qB9KM; } $smarty->assign("\x61\144\x6d\137\164\x72\x61\143\x6b\151\156\147\x5f\x70\x61\171\154\x6f\x61\x64", Payload::class); qB9KM: }); $this->dispatcher->listen("\x73\150\157\160\x2e\x68\x6f\x6f\x6b\x2e" . \HOOK_SMARTY_OUTPUTFILTER, function () { $this->initTracking(); $this->renderScripts(); }); } public function initTracking() : void { $consentManager = $this->consentManager; $analyticsConsent = $consentManager->hasConsent(GoogleAnalytics::CONSENT_KEY); $adsConsent = $consentManager->hasConsent(GoogleAds::CONSENT_KEY); $gtmConsent = $consentManager->hasConsent(GoogleTagManager::CONSENT_KEY); $smarty = Shop::Smarty(); if (!$this->settings->analytics_active) { goto Yu1t5; } $this->trackingEntities["\141\156\x61\154\171\164\x69\143\163"] = new GoogleAnalytics($this->settings->analytics_id, $this->settings, container()->make(Payload::class, ["\160\x61\147\x65\124\x79\x70\145" => Shop::getPageType(), "\x73\145\164\x74\151\156\147\x73" => $this->settings, "\163\x6d\x61\162\164\x79" => $smarty]), $this->consentManagerActive, $analyticsConsent, Shop::getPageType(), $smarty, $this->plugin); Yu1t5: if (!$this->settings->ads_active) { goto eiwuD; } $this->trackingEntities["\x61\x64\x73"] = new GoogleAds($this->settings->ads_id, $this->settings, container()->make(Payload::class, ["\x70\x61\x67\x65\124\171\160\145" => Shop::getPageType(), "\x73\145\164\x74\x69\156\x67\x73" => $this->settings, "\163\155\x61\x72\x74\x79" => $smarty]), $this->consentManagerActive, $adsConsent, Shop::getPageType(), $smarty, $this->plugin); eiwuD: if (!$this->settings->gtm_active) { goto NCpro; } $this->trackingEntities["\x67\164\x6d"] = new GoogleTagManager($this->settings->gtm_id, $this->settings, container()->make(Payload::class, ["\x70\141\x67\145\124\171\160\x65" => Shop::getPageType(), "\163\145\x74\164\151\156\x67\x73" => $this->settings, "\163\155\x61\162\x74\x79" => $smarty]), $this->consentManagerActive, $gtmConsent, Shop::getPageType(), $smarty, $this->plugin); NCpro: } public function renderScripts() : void { foreach ($this->trackingEntities as $entity) { $scripts = $entity->getScripts(); foreach ($scripts as $script) { if (!is_null($script)) { goto OO_tM; } goto PFerw; OO_tM: $script->addScript(); PFerw: } Mo3eH: iQXAa: } ZiM55: if (!$this->consentManagerActive) { goto S_oJv; } $this->setupConsentMode(); S_oJv: } private function setupConsentMode() : void { $defaultConsentStatus = $this->buildConsentStatusArray(false, false); $script = "\40\x20\x3c\163\143\162\x69\x70\164\76\12\40\x20\167\151\156\144\157\167\x2e\x64\141\x74\141\114\x61\x79\145\x72\40\x3d\40\x77\151\156\x64\x6f\x77\x2e\144\141\164\141\114\x61\x79\x65\162\40\174\174\40\133\135\x3b\xa\40\40\x69\146\50\164\171\160\x65\x6f\x66\x20\147\x74\x61\x67\x20\41\x3d\x3d\40\x27\146\x75\156\x63\x74\x69\157\x6e\x27\51\x7b\xa\x20\x20\x20\40\146\x75\x6e\x63\x74\x69\x6f\156\x20\147\164\x61\x67\50\x29\173\40\144\x61\164\141\x4c\141\x79\x65\x72\56\160\165\163\x68\50\x61\x72\147\165\x6d\x65\x6e\164\x73\51\x3b\40\175\x3b\xa\40\x20\175\xa\xa\40\x20\x67\x74\141\x67\50\x27\143\x6f\x6e\163\145\x6e\x74\47\x2c\x20\47\x64\x65\146\141\165\x6c\x74\47\x2c\x20{$defaultConsentStatus}\51\x3b\xa\xa\x20\x20\x66\x75\156\x63\x74\x69\157\x6e\x20\x75\160\144\x61\164\145\x43\157\x6e\163\x65\x6e\x74\x53\x74\x61\x74\x75\163\x28\51\x20\173\xa\40\40\x20\40\143\x6f\x6e\163\164\x20\173\x73\x65\x74\x74\151\156\147\163\x7d\x20\75\40\112\x53\x4f\x4e\56\x70\141\162\163\145\x28\154\x6f\143\141\x6c\x53\x74\157\x72\141\x67\145\x2e\147\x65\164\x49\x74\145\x6d\50\x27\x63\157\156\x73\145\156\164\x27\51\x20\174\174\40\x27\x7b\x7d\47\51\x3b\xa\12\x20\40\x20\x20\x69\146\x20\x28\41\x73\x65\164\164\151\x6e\147\x73\x20\x7c\x7c\40\163\145\164\164\151\156\x67\x73\133\47\141\x64\155\157\162\x72\151\163\x2d\141\144\x73\47\x5d\x20\75\75\x3d\x20\165\x6e\144\x65\x66\x69\x6e\x65\144\40\x26\x26\40\163\x65\164\164\x69\156\147\163\x5b\x27\141\x64\x6d\157\x72\x72\x69\163\x2d\x61\156\x61\x6c\x79\164\151\143\163\47\x5d\40\75\75\x3d\x20\165\156\144\x65\146\x69\x6e\145\x64\x29\40\x7b\xa\40\x20\x20\40\x20\x20\162\x65\164\x75\x72\x6e\x3b\xa\40\40\40\x20\x7d\xa\12\x20\x20\40\40\143\x6f\x6e\163\x74\x20\141\144\x73\103\x6f\156\163\x65\156\164\123\164\141\x74\x75\x73\40\x3d\x20\x73\145\164\x74\x69\x6e\147\163\x5b\47\141\144\155\157\x72\162\x69\163\55\x61\x64\x73\47\135\40\77\40\47\x67\x72\141\x6e\x74\x65\x64\47\x20\x3a\40\x27\144\x65\x6e\151\x65\x64\x27\x3b\12\x20\40\x20\40\x63\x6f\156\163\x74\40\x61\156\141\154\171\x74\x69\143\x73\103\x6f\156\163\145\156\164\x53\x74\141\164\165\x73\40\x3d\40\163\145\x74\164\151\156\x67\x73\133\x27\x61\144\x6d\x6f\162\162\x69\x73\x2d\x61\156\x61\154\x79\164\x69\x63\163\47\135\40\77\x20\47\x67\162\x61\156\x74\x65\144\47\x20\72\x20\47\144\145\156\x69\x65\144\x27\x3b\12\40\x20\x20\x20\147\x74\x61\x67\50\47\x63\x6f\156\x73\x65\156\164\47\x2c\40\x27\x75\x70\144\141\164\x65\x27\54\40\x7b\12\x20\40\x20\40\40\x20\47\141\144\x5f\x73\164\157\x72\x61\x67\145\x27\x3a\x20\141\x64\163\x43\x6f\x6e\163\x65\156\x74\123\x74\x61\x74\165\x73\x2c\xa\x20\x20\x20\x20\40\x20\x27\141\144\137\165\x73\x65\x72\x5f\144\141\x74\141\47\72\x20\141\x64\x73\103\157\156\x73\145\x6e\164\123\164\x61\164\x75\163\x2c\12\x20\40\x20\x20\x20\x20\47\x61\144\137\x70\x65\162\163\x6f\156\x61\154\x69\x7a\141\x74\151\157\156\47\72\x20\141\144\163\x43\x6f\x6e\x73\x65\156\x74\x53\164\x61\164\165\163\x2c\12\40\x20\x20\x20\x20\40\x27\141\x6e\141\x6c\x79\164\x69\143\x73\x5f\x73\164\x6f\x72\x61\x67\x65\47\x3a\40\x61\x6e\141\x6c\171\x74\151\x63\163\103\157\156\163\x65\x6e\x74\123\x74\x61\164\x75\x73\54\12\40\x20\x20\x20\175\51\x3b\xa\40\40\x7d\12\12\40\x20\57\57\x20\x43\150\145\143\x6b\x20\141\x6e\x64\x20\x75\160\144\x61\x74\x65\40\x63\157\x6e\x73\145\156\x74\40\163\164\141\x74\x75\163\40\x6f\156\x20\160\141\x67\145\40\x6c\157\x61\x64\xa\40\40\165\160\x64\x61\164\x65\x43\157\x6e\163\x65\x6e\x74\x53\164\x61\164\165\x73\50\51\73\xa\xa\x20\40\x64\x6f\143\165\x6d\145\156\x74\x2e\141\144\x64\105\166\x65\x6e\164\x4c\x69\x73\x74\145\156\145\162\x28\x27\141\144\x6d\x3a\143\157\x6e\163\x65\x6e\164\56\165\160\144\141\x74\145\x64\x27\54\40\x66\165\156\x63\164\x69\157\156\50\145\51\x20\173\xa\40\x20\40\x20\x75\x70\144\x61\x74\x65\103\157\156\x73\145\x6e\x74\x53\x74\x61\164\165\163\x28\x29\73\12\x20\40\x7d\x29\73\12\x20\x20\74\x2f\x73\143\x72\x69\x70\164\76"; \pq("\150\x65\x61\x64")->prepend($script); } private function getConsentStatus() : string { $consentManager = $this->consentManager; $analyticsConsent = $consentManager->hasConsent(GoogleAnalytics::CONSENT_KEY); $adsConsent = $consentManager->hasConsent(GoogleAds::CONSENT_KEY); return $this->buildConsentStatusArray($analyticsConsent, $adsConsent); } private function buildConsentStatusArray(bool $analyticsConsent, bool $adsConsent) : string { $analyticsConsentStatus = $analyticsConsent ? "\x67\162\141\x6e\164\x65\x64" : "\x64\145\x6e\x69\145\144"; $adsConsentStatus = $adsConsent ? "\x67\x72\141\156\x74\145\x64" : "\144\x65\x6e\x69\145\144"; return json_encode(["\141\144\137\x73\x74\x6f\162\x61\x67\145" => $adsConsentStatus, "\141\144\137\x75\x73\x65\x72\x5f\x64\x61\164\141" => $adsConsentStatus, "\141\x64\137\x70\145\x72\x73\157\x6e\141\154\x69\x7a\x61\x74\151\x6f\156" => $adsConsentStatus, "\x61\156\x61\x6c\171\x74\151\x63\x73\x5f\x73\164\157\162\x61\147\145" => $analyticsConsentStatus]); } }