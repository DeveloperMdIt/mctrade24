<?php
/*   __________________________________________________
    |  Copyright by admorris.pro  |
    |__________________________________________________|
*/
 namespace Plugin\admorris_pro; use JTL\Shop; $kundendaten = $_SESSION["\113\x75\x6e\144\145"] ?? null; if (!(empty($kundendaten) || Shop::getPageType() === \PAGE_MEINKONTO)) { goto du80R; } return; du80R: require_once $oPlugin->getPaths()->getFrontendPath() . "\155\x61\x69\x6c\x63\150\151\155\160\57\x63\x6f\x6e\156\145\x63\164\x69\157\x6e\56\x70\x68\x70"; $connection_data = get_mailchimp_connection_data(); $warenkorb = $_SESSION["\127\x61\x72\145\156\153\x6f\x72\x62"]; $customerID = $kundendaten->getID(); $customer = array("\x69\144" => strval($customerID)); $positionen = $warenkorb->PositionenArr; $cartNettoTotal = 0; $cartBruttoTotal = 0; $lines = []; foreach ($positionen as $key => $position) { $line = new \stdClass(); $line->id = strval($key + 1); $line->product_id = strval($position->kArtikel); $line->product_variant_id = strval($position->kArtikel); $line->quantity = ceil($position->nAnzahl); if (empty($position->Artikel->Preise)) { goto BVd1s; } $line->price = $position->nAnzahl * $position->Artikel->Preise->fVKNetto; $cartNettoTotal = $cartNettoTotal + $position->Artikel->Preise->fVKNetto * $position->nAnzahl; $cartBruttoTotal = $cartBruttoTotal + $position->Artikel->Preise->fVKBrutto * $position->nAnzahl; BVd1s: $lines[] = $line; ZVSOK: } trCj7: $taxTotal = $cartBruttoTotal - $cartNettoTotal; $taxTotal = round($taxTotal, 2); $data = array("\151\x64" => strval($customerID), "\143\x75\x73\x74\x6f\155\x65\x72" => $customer, "\143\150\x65\x63\153\x6f\165\x74\137\x75\x72\x6c" => Shop::Container()->getLinkService()->getStaticRoute("\x77\141\162\145\156\x6b\157\x72\x62\56\160\150\160"), "\x63\165\x72\162\x65\156\x63\x79\137\143\157\144\145" => $_SESSION["\x57\x61\145\150\x72\165\156\x67"]->getCode(), "\157\162\x64\x65\162\x5f\164\157\x74\x61\154" => $cartNettoTotal, "\164\141\170\137\164\x6f\x74\x61\154" => $taxTotal, "\x6c\x69\x6e\x65\x73" => $lines); $url = "\150\x74\x74\x70\163\x3a\57\x2f" . substr($connection_data->api_key, strpos($connection_data->api_key, "\x2d") + 1) . "\x2e\x61\x70\151\x2e\155\141\x69\x6c\x63\x68\151\155\160\56\143\x6f\x6d\57\x33\x2e\60\x2f\x65\143\157\155\155\x65\162\x63\145\57\163\x74\x6f\x72\x65\x73\57" . $connection_data->store . "\x2f\143\141\x72\x74\x73\x2f{$customerID}"; $result = json_decode(rudr_mailchimp_curl_connect($url, "\104\105\114\x45\124\x45", $connection_data->api_key, $data)); $log = Shop::Container()->getLogService(); $log->debug("\141\x64\x6d\x6f\x72\x72\x69\163\x20\120\x72\x6f\40\x2d\x20\123\x42\x20\115\x61\151\x6c\143\x68\151\x6d\160\40\145\144\151\164\x20\143\141\162\164\x20\x75\162\x6c\x3a\40" . print_r($url, true)); $log->debug("\x61\144\x6d\x6f\162\x72\x69\x73\40\x50\x72\x6f\40\x2d\x20\x53\102\x20\115\141\x69\x6c\143\150\151\155\x70\40\145\144\x69\164\x20\143\141\x72\x74\40\144\x61\x74\x61\72\x20" . print_r($data, true)); $log->debug("\141\x64\155\x6f\x72\x72\x69\x73\x20\120\x72\x6f\40\55\40\x53\102\x20\115\x61\151\154\x63\150\151\155\x70\x20\145\144\x69\x74\x20\143\141\x72\164\40\x66\165\156\x63\x74\151\157\x6e\x3a\x20" . print_r($result, true)); $url = "\x68\164\x74\x70\163\x3a\x2f\57" . substr($connection_data->api_key, strpos($connection_data->api_key, "\x2d") + 1) . "\x2e\x61\x70\151\x2e\x6d\141\x69\x6c\143\150\x69\x6d\160\x2e\x63\157\x6d\x2f\x33\56\x30\57\x65\143\x6f\x6d\155\145\x72\143\145\57\x73\x74\157\162\x65\x73\x2f" . $connection_data->store . "\57\143\141\x72\x74\163\x2f"; $result = json_decode(rudr_mailchimp_curl_connect($url, "\x50\117\x53\124", $connection_data->api_key, $data)); $log->debug("\141\144\155\157\162\x72\x69\163\x20\120\x72\157\x20\55\x20\123\102\x20\115\141\151\x6c\143\150\x69\155\x70\x20\160\x6f\163\164\x20\x63\x61\162\164\40\x75\x72\x6c\x3a\40" . print_r($url, true)); $log->debug("\141\x64\x6d\x6f\162\162\x69\163\x20\120\x72\x6f\x20\x2d\40\x53\x42\40\x4d\x61\151\x6c\143\x68\151\155\160\40\160\x6f\163\164\40\x63\x61\x72\x74\x20\x66\165\x6e\x63\x74\151\x6f\x6e\72\40" . print_r($result, true));