name: Deploy to Netcup

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Enable Maintenance Mode (via SSH + MySQL)
        env:
          SSHPASS: ${{ secrets.FTP_PASSWORD }}
          SSH_USER: ${{ secrets.FTP_USERNAME }}
          SSH_HOST: ${{ secrets.FTP_SERVER }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASS: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
        run: |
          echo "UPDATE teinstellungen SET cWert='Y' WHERE cName='wartungsmodus_aktiviert';" | \
          sshpass -e ssh -o StrictHostKeyChecking=no -p 22 "$SSH_USER@$SSH_HOST" \
            "mysql -u '$DB_USER' -p'$DB_PASS' '$DB_NAME'"

      - name: Sync files via SSH/Rsync
        run: |
          sshpass -p "${{ secrets.FTP_PASSWORD }}" rsync -avz \
            --chmod=Du=rwx,Dg=rx,Do=rx,Fu=rw,Fg=r,Fo=r \
            -e "ssh -o StrictHostKeyChecking=no -p 22" \
            --exclude='.git*' \
            --exclude='node_modules' \
            --exclude='templates_c' \
            --exclude='media/image/storage' \
            --exclude='bilder' \
            --exclude='mediafiles' \
            --exclude='includes/config.JTL-Shop.ini.php' \
            --exclude='install' \
            ./ ${{ secrets.FTP_USERNAME }}@${{ secrets.FTP_SERVER }}:httpdocs/

      - name: Disable Maintenance Mode (via SSH + MySQL)
        env:
          SSHPASS: ${{ secrets.FTP_PASSWORD }}
          SSH_USER: ${{ secrets.FTP_USERNAME }}
          SSH_HOST: ${{ secrets.FTP_SERVER }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASS: ${{ secrets.DB_PASSWORD }}
          DB_NAME: ${{ secrets.DB_NAME }}
        run: |
          echo "UPDATE teinstellungen SET cWert='N' WHERE cName='wartungsmodus_aktiviert';" | \
          sshpass -e ssh -o StrictHostKeyChecking=no -p 22 "$SSH_USER@$SSH_HOST" \
          "mysql -h 127.0.0.1 -u '$DB_USER' -p'$DB_PASS' '$DB_NAME'"
