name: Deploy to Netcup

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Enable Maintenance Mode (via SSH + PHP)
        env:
          SSHPASS: ${{ secrets.FTP_PASSWORD }}
          SSH_USER: ${{ secrets.FTP_USERNAME }}
          SSH_HOST: ${{ secrets.FTP_SERVER }}
        run: |
          PHP_ON=$(printf '%s' '<?php require "/var/www/vhosts/mctrade24.com/httpdocs/includes/config.JTL-Shop.ini.php"; $pdo=new PDO("mysql:host=".DB_HOST.";dbname=".DB_NAME.";charset=utf8",DB_USER,DB_PASS); $pdo->exec("UPDATE teinstellungen SET cWert=chr(89) WHERE cName=chr(119).chr(97).chr(114).chr(116).chr(117).chr(110).chr(103).chr(115).chr(109).chr(111).chr(100).chr(117).chr(115).chr(95).chr(97).chr(107).chr(116).chr(105).chr(118).chr(105).chr(101).chr(114).chr(116)"); echo "Maintenance ON\n";' | base64 -w 0)
          sshpass -e ssh -o StrictHostKeyChecking=no -p 22 "$SSH_USER@$SSH_HOST" "echo $PHP_ON | base64 -d | php" || true

      - name: Sync files via SSH/Rsync
        run: |
          sshpass -p "${{ secrets.FTP_PASSWORD }}" rsync -avz \
            --chmod=Du=rwx,Dg=rx,Do=rx,Fu=rw,Fg=r,Fo=r \
            -e "ssh -o StrictHostKeyChecking=no -p 22" \
            --exclude='.git*' \
            --exclude='node_modules' \
            --exclude='templates_c' \
            --exclude='media/image/storage' \
            --exclude='bilder' \
            --exclude='mediafiles' \
            --exclude='includes/config.JTL-Shop.ini.php' \
            --exclude='install' \
            ./ ${{ secrets.FTP_USERNAME }}@${{ secrets.FTP_SERVER }}:httpdocs/

      - name: Disable Maintenance Mode (via SSH + PHP)
        env:
          SSHPASS: ${{ secrets.FTP_PASSWORD }}
          SSH_USER: ${{ secrets.FTP_USERNAME }}
          SSH_HOST: ${{ secrets.FTP_SERVER }}
        run: |
          PHP_OFF=$(printf '%s' '<?php require "/var/www/vhosts/mctrade24.com/httpdocs/includes/config.JTL-Shop.ini.php"; $pdo=new PDO("mysql:host=".DB_HOST.";dbname=".DB_NAME.";charset=utf8",DB_USER,DB_PASS); $pdo->exec("UPDATE teinstellungen SET cWert=chr(78) WHERE cName=chr(119).chr(97).chr(114).chr(116).chr(117).chr(110).chr(103).chr(115).chr(109).chr(111).chr(100).chr(117).chr(115).chr(95).chr(97).chr(107).chr(116).chr(105).chr(118).chr(105).chr(101).chr(114).chr(116)"); echo "Maintenance OFF\n";' | base64 -w 0)
          sshpass -e ssh -o StrictHostKeyChecking=no -p 22 "$SSH_USER@$SSH_HOST" "echo $PHP_OFF | base64 -d | php" || true
