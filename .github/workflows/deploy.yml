name: Deploy to Netcup

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *' # TÃ¤glich um 02:00 Uhr nachts

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Enable Maintenance Mode (via SSH + MySQL)
        run: |
          sshpass -p "${{ secrets.FTP_PASSWORD }}" ssh -o StrictHostKeyChecking=no -p 22 \
            ${{ secrets.FTP_USERNAME }}@${{ secrets.FTP_SERVER }} \
            "mysql -u ${{ secrets.DB_USER }} -p'${{ secrets.DB_PASSWORD }}' -h ${{ secrets.DB_HOST }} ${{ secrets.DB_NAME }} \
             -e \"UPDATE teinstellungen SET cWert='Y' WHERE cName='wartungsmodus_aktiviert';\"" || true

      - name: Sync files via SSH/Rsync
        run: |
          sshpass -p "${{ secrets.FTP_PASSWORD }}" rsync -avz --chmod=Du=rwx,Dg=rx,Do=rx,Fu=rw,Fg=r,Fo=r \
            -e "ssh -o StrictHostKeyChecking=no -p 22" \
            --exclude='.git*' \
            --exclude='node_modules' \
            --exclude='templates_c' \
            --exclude='media/image/storage' \
            --exclude='bilder' \
            --exclude='mediafiles' \
            --exclude='includes/config.JTL-Shop.ini.php' \
            --exclude='install' \
            --exclude='test_sync.php' \
            ./ ${{ secrets.FTP_USERNAME }}@${{ secrets.FTP_SERVER }}:httpdocs/

      - name: Disable Maintenance Mode (via SSH + MySQL)
        run: |
          sshpass -p "${{ secrets.FTP_PASSWORD }}" ssh -o StrictHostKeyChecking=no -p 22 \
            ${{ secrets.FTP_USERNAME }}@${{ secrets.FTP_SERVER }} \
            "mysql -u ${{ secrets.DB_USER }} -p'${{ secrets.DB_PASSWORD }}' -h ${{ secrets.DB_HOST }} ${{ secrets.DB_NAME }} \
             -e \"UPDATE teinstellungen SET cWert='N' WHERE cName='wartungsmodus_aktiviert';\"" || true
